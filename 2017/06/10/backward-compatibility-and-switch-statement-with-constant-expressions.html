<!doctype html><html lang=en><head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<link rel=stylesheet type=text/css href=https://kinoshita.eti.br/sass/main.bb12278f082614f093646fd8c21cd5db009382bf5777a5ca1b84c705f7ff5e2d.css integrity="sha256-uxInjwgmFPCTZG/YwhzV2wCTgr9Xd6XKG4THBff/Xi0=">
<title>kinow | Backward compatibility and switch statement with constant expressions</title>
</head>
<body><header role=banner class=content>
<nav id=nav aria-label=Main role=navigation class=content>
<ul><li>
<a href=/>
<i data-feather=about></i> About</a>
</li><li>
<a href=/blog/>
<i data-feather=blog></i> Blog</a>
</li><li>
<a href=/portfolio/>
<i data-feather=portfolio></i> Portfolio</a>
</li><li></li>
</ul>
</nav>
</header>
<main>
<article class=content>
<h2>Backward compatibility and switch statement with constant expressions</h2><div class=metadata>
<i data-feather=calendar></i>
<time datetime=2017-06-10>Jun 10, 2017</time>
</div>
<p>Maintaining Open Source software can be challenging. Making sure you keep backward compatibility (not only binary) can be even more challenging. <a href=https://commons.apache.org/proper/commons-lang/>Apache Commons Lang</a> 3.6 release is happening right now thanks to <a href=http://www.benediktritter.de/>Benedikt Ritter</a>, and it is on its fourth Release Candidate (i.e. RC4).</p>
<p>A previous RC2 was cancelled due to <a href=http://commons.markmail.org/thread/57sqt2hkusegda73#query:+page:1+mid:dnwo5tjqo2e5bwuo+state:results>IBM JDK 8 compatibility</a>, more specifically the lazy initialization of ArrayList&rsquo;s seems to be different in Oracle JDK and IBM JDK.</p>
<p>The RC3 was cancelled due to a <a href=https://github.com/apache/commons-lang/commit/18e692478dcf91fdceb9b9fdca7c61a1111d63aa>change</a> that could affect users using a switch statement.</p>
<p>The change was in the <em>CharEncoding</em> class. The issue was that this class has some constants, that stopped being <a href=http://docs.oracle.com/javase/specs/jls/se8/html/jls-15.html#jls-15.28>constant expressions</a>.</p>
<blockquote>A constant expression is an expression denoting a value of primitive type or a String that does not complete abruptly and is composed using only the following (...)</blockquote>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:navy;font-weight:700>public</span> <span style=color:navy;font-weight:700>class</span> CharEncoding {
    <span style=color:#080;font-style:italic>// ...
</span><span style=color:#080;font-style:italic></span>    <span style=color:navy;font-weight:700>public</span> <span style=color:navy;font-weight:700>static</span> <span style=color:navy;font-weight:700>final</span> String ISO_8859_1 = <span style=color:#00f>&#34;ISO-8859-1&#34;</span>;
    <span style=color:#080;font-style:italic>// ...
</span><span style=color:#080;font-style:italic></span>}
</code></pre></div><p>The code above contains a constant (<em>static final</em>) variable, that is a constant expression. So users can safely use it in switch statements, and the Java compiler won&rsquo;t complain about it.</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:navy;font-weight:700>public</span> <span style=color:navy;font-weight:700>class</span> CharEncoding {
    <span style=color:#080;font-style:italic>// ...
</span><span style=color:#080;font-style:italic></span>    <span style=color:navy;font-weight:700>public</span> <span style=color:navy;font-weight:700>static</span> <span style=color:navy;font-weight:700>final</span> String ISO_8859_1 = StandardCharsets.<span style=color:red>ISO_8859_1</span>.<span style=color:red>name</span>();
    <span style=color:#080;font-style:italic>// ...
</span><span style=color:#080;font-style:italic></span>}
</code></pre></div><p>The code above is from the change that caused the regression. Any user that was using the ISO_8859_1 constant variable in a switch statement would get a compilation error (e.g. <em>case expressions must be constant expressions</em>) when updating to Apache Commons Lang 3.6. That is because the constant variable is not a constant expression.</p>
<p>I think I learned that some time ago, but if you asked me what was wrong with the change, and if it would break backward compatibility, I would probably fail to spot the issue. There are tools for that now (e.g. Clirr, japicmp) though they may miss some cases too.</p>
<p>Luckily in this case a user subscribed to the Apache Commons development mailing list spotted the issue and quickly reported it. It gets easier maintaining an Open Source project with the constructive feedback of users, like this one.</p>
<p>â™¥ Open Source</p>
<aside class=links>
<a class=previous href=https://kinoshita.eti.br/2017/06/03/natural-language-processing-and-natural-language-understanding.html>&#171; Previous</a>
<a class=next href=https://kinoshita.eti.br/2017/06/14/how-to-remove-the-signature-from-e-mails-with-nlp.html>Next &#187;</a>
</aside>
</article>
</main>
<footer role=contentinfo>
<ul id=social-media-icons>
<li>
<a href=https://www.instagram.com/brunokinoshita/>
<img src=/assets/icons/instagram.png alt="Instagram link">
</a>
</li>
<li>
<a href=https://twitter.com/kinow/>
<img src=/assets/icons/twitter.png alt="Twitter link">
</a>
</li>
<li>
<a href=https://github.com/kinow/>
<img src=/assets/icons/github.png alt="GitHub link">
</a>
</li>
</ul>
</footer>
</body>
</html>