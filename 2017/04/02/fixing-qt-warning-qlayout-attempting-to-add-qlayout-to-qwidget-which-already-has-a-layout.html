<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta property="og:title" content="Fixing Qt warning &#34;QLayout: Attempting to add QLayout &#34;&#34; to QWidget &#34;&#34;, which already has a layout&#34;">
<meta property="og:description" content="If you ever started Krita 3.x in your command line, and had a look at the console output, you may noticed the following warning.
 QLayout: Attempting to add QLayout &#34;&#34; to QWidget &ldquo;&rdquo;, which already has a layout
 Krita recently announced the release of 3.1.3-alpha-2, and while testing I saw this warning and decided to investigate why this warning happens.
There was already a similar question posted on StackOverflow.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://kinoshita.eti.br/2017/04/02/fixing-qt-warning-qlayout-attempting-to-add-qlayout-to-qwidget-which-already-has-a-layout.html"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2017-04-02T00:00:00+00:00">
<meta property="article:modified_time" content="2017-04-02T00:00:00+00:00">
<link rel=stylesheet type=text/css href=https://kinoshita.eti.br/sass/main.b4ba95d89a5e09411badc5c1b726b7d80cafc4d07ce873384e99b41f20d0e27c.css integrity="sha256-tLqV2JpeCUEbrcXBtya32AyvxNB86HM4Tpm0HyDQ4nw=">
<title>kinow | Fixing Qt warning "QLayout: Attempting to add QLayout "" to QWidget "", which already has a layout"</title>
</head>
<body>
<header role=banner class=content>
<nav id=nav aria-label=Main role=navigation class=content>
<ul><li>
<a href=/><i data-feather=about></i> About</a>
</li><li>
<a href=/blog/><i data-feather=blog></i> Blog</a>
</li><li>
<a href=/portfolio/><i data-feather=portfolio></i> Portfolio</a>
</li>
</ul>
</nav>
</header>
<main>
<article class=content>
<h2>Fixing Qt warning "QLayout: Attempting to add QLayout "" to QWidget "", which already has a layout"</h2><div class=metadata>
<i data-feather=calendar></i>
<time datetime=2017-04-02>Apr 2, 2017</time>
</div>
<p>If you ever started Krita 3.x in your command line, and had a look at the console output,
you may noticed the following warning.</p>
<blockquote>
<p>QLayout: Attempting to add QLayout "" to QWidget &ldquo;&rdquo;, which already has a layout</p>
</blockquote>
<p>Krita recently <a href=https://krita.org/en/item/krita-3-1-3-alpha-released/>announced the release of 3.1.3-alpha-2</a>,
and while testing I saw this warning and
decided to investigate why this warning happens.</p>
<p>There was already
<a href=http://stackoverflow.com/a/25451334>a similar question posted on StackOverflow</a>. And the
best answer&rsquo;s initial paragraph gave me a hint of what to look for.</p>
<blockquote>
<p>When you assign a widget as the parent of a QLayout by passing it into the constructor, the layout is automatically set as the layout for that widget. In your code you are not only doing this, but explicitly calling setlayout(). This is no problem when when the widget passed is the same. If they are different you will get an error because Qt tries to assign the second layout to your widget which has already had a layout set.</p>
</blockquote>
<p>So, somewhere in Krita code, there was a a QWidget being created, and layouts
were being added to it more than once. To find where the issue was happening was quite easy. A breakpoint at
<a href=https://github.com/KDE/krita/blob/9e2b8c5b07deccd4a616ad7930a91e8cc784a85b/krita/main.cc#L141>main.cc</a>
where the application is initialized, then step through a few times, until the message appeared in the
console.</p>
<p>Further investigation led me to the History docker (the one that shows undo steps)
<a href=https://github.com/KDE/krita/blob/9e2b8c5b07deccd4a616ad7930a91e8cc784a85b/plugins/dockers/historydocker/HistoryDock.cpp#L33>constructor</a>.</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++>    QVBoxLayout *vl = <span style=color:navy;font-weight:700>new</span> QVBoxLayout(page); <span style=color:#080;font-style:italic>// layout being set to page
</span><span style=color:#080;font-style:italic></span>    m_undoView = <span style=color:navy;font-weight:700>new</span> KisUndoView(<span style=color:navy;font-weight:700>this</span>);
    vl-&gt;addWidget(m_undoView);
    QHBoxLayout *hl = <span style=color:navy;font-weight:700>new</span> QHBoxLayout(page); <span style=color:#080;font-style:italic>// layout being set to page again
</span><span style=color:#080;font-style:italic></span>    hl-&gt;addSpacerItem(<span style=color:navy;font-weight:700>new</span> QSpacerItem(<span style=color:#00f>10</span>, <span style=color:#00f>1</span>,  QSizePolicy::Expanding, QSizePolicy::Fixed));
    m_bnConfigure = <span style=color:navy;font-weight:700>new</span> QToolButton(page);
    m_bnConfigure-&gt;setIcon(KisIconUtils::loadIcon(<span style=color:#00f>&#34;configure&#34;</span>));
    connect(m_bnConfigure, SIGNAL(clicked(<span style=color:navy;font-weight:700>bool</span>)), SLOT(configure()));
    hl-&gt;addWidget(m_bnConfigure);
    vl-&gt;addItem(hl);

    setWidget(page);
    setWindowTitle(i18n(<span style=color:#00f>&#34;Undo History&#34;</span>));
</code></pre></div><p>Here the QWidget created receives both QHBoxLayout and QVBoxLayout. Again, searching the Internet
a little bit, then came across this post with a good example of a QWidget with
QHBoxLayout and QVBoxLayout. Here&rsquo;s what the constructor looks after the
<a href="https://bugs.kde.org/show_bug.cgi?id=378313">patch</a>
has been <a href=https://github.com/KDE/krita/commit/1d2343c0cacfb0b105fbe86c2bcef975a09b1041>applied</a>.</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++>    QVBoxLayout *vl = <span style=color:navy;font-weight:700>new</span> QVBoxLayout(page); <span style=color:#080;font-style:italic>// layout being set to page
</span><span style=color:#080;font-style:italic></span>    m_undoView = <span style=color:navy;font-weight:700>new</span> KisUndoView(<span style=color:navy;font-weight:700>this</span>);
    vl-&gt;addWidget(m_undoView);
    QHBoxLayout *hl = <span style=color:navy;font-weight:700>new</span> QHBoxLayout();
    hl-&gt;addSpacerItem(<span style=color:navy;font-weight:700>new</span> QSpacerItem(<span style=color:#00f>10</span>, <span style=color:#00f>1</span>,  QSizePolicy::Expanding, QSizePolicy::Fixed));
    m_bnConfigure = <span style=color:navy;font-weight:700>new</span> QToolButton(page);
    m_bnConfigure-&gt;setIcon(KisIconUtils::loadIcon(<span style=color:#00f>&#34;configure&#34;</span>));
    connect(m_bnConfigure, SIGNAL(clicked(<span style=color:navy;font-weight:700>bool</span>)), SLOT(configure()));
    hl-&gt;addWidget(m_bnConfigure);
    vl-&gt;addItem(hl);
    vl-&gt;addLayout(hl); <span style=color:#080;font-style:italic>// horizontal layout added to the vertical layout
</span><span style=color:#080;font-style:italic></span>
    setWidget(page);
    setWindowTitle(i18n(<span style=color:#00f>&#34;Undo History&#34;</span>));
</code></pre></div><p>That&rsquo;s it. Learned something new in Qt. Not as important and useful as learning about
<a href=http://doc.qt.io/qt-4.8/signalsandslots.html>signals and slots</a>, but now I can focus
on other warnings in the console output of Krita.</p>
<p>And you? Have you tested <a href=https://krita.org/en/item/krita-3-1-3-alpha-released/>Krita 3.1.3 alpha</a> already?
What are you waiting for? :-)</p>
<p>â™¥ Open Source</p>
<aside class=links>
<a class=previous href=https://kinoshita.eti.br/2017/03/26/simulating-less-memory-with-ulimit.html>&#171; Previous</a>
<a class=next href=https://kinoshita.eti.br/2017/04/14/writing-a-binary-parser-in-python-numpy-vs.-construct.html>Next &#187;</a>
</aside>
</article>
</main>
<footer role=contentinfo>
<ul id=social-media-icons>
<li>
<a href=https://www.instagram.com/brunokinoshita/>
<img src=/assets/icons/instagram.png alt="Instagram link">
</a>
</li>
<li>
<a href=https://twitter.com/kinow/>
<img src=/assets/icons/twitter.png alt="Twitter link">
</a>
</li>
<li>
<a href=https://github.com/kinow/>
<img src=/assets/icons/github.png alt="GitHub link">
</a>
</li>
<li>
<a href=/feed.xml>
<img src=/assets/icons/news.png alt="RSS feed link">
</a>
</li>
</ul>
</footer>
</body>
</html>