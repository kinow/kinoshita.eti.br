  
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head profile="http://gmpg.org/xfn/11">
    <title>Bruno P. Kinoshita &mdash; Fixing Qt warning "QLayout: Attempting to add QLayout "" to QWidget "", which already has a layout"</title> 
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="description" content="Bruno de Paula Kinoshita personal web site" />
    <meta name="keywords"
        content="kinoshita, bruno de paula kinoshita, geek, geek stuff, java, python, c, c++, msn now playing, neural network, mackenzie, sao paulo, brasil, brazil, nerd, nerd stuff, cool, jenkins, illustration, quadrinhos, machine learning, linguistic, apache, open source, codigo livre, codigo aberto" />
    <meta name="author" content="" />
    <meta name="generator" content="PieCrust 3.2.1" />
    <meta name="template-engine" content="Twig" />
    <meta name="robots" content="all=index,follow" />
    <meta name="revisit-after" content="15 days" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta name="distribution" content="Global" />
    <meta name="url" content="/" />
    <meta name="copyright" content="Bruno de Paula Kinoshita" />
    <meta name="Googlebot" content="all" />
    <meta name="rating" content="general" />
    <meta http-equiv="expires" content="0" />
    <meta name="city" content="Sao Paulo" />
    <meta name="state" content="Brasil, Sao Paulo" />
    <meta http-equiv="content-language" content="en" />
    <meta http-equiv="imagetoolbar" content="no" />
    <meta id="page_favicon" href="/favicon.ico" rel="icon" type="image/x-icon" />
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link rel="alternate" type="application/rss+xml" title="Bruno P. Kinoshita &raquo; Feed" href="/feed.xml" />
    <link rel="stylesheet" href="/css/semantic/dist/semantic.min.css" type="text/css" media="screen, projection" />
    <link rel="stylesheet" href="/css/style.css" type="text/css" media="screen, projection" />
    <!--[if lt IE 8]>
    <link rel="stylesheet" href="/css/blueprint/ie.css" type="text/css" media="screen, projection" />
    <![endif]-->
    <link rel="stylesheet" href="/css/prettyPhoto.css" type="text/css" media="all" />
</head>
<body id="body">
    <div class="ui vertical sidebar menu" id="toc">
        <nav class="menu" role="navigation">
    <div class="item">
        <a href="/" class="main-link">Kinoshita</a>
    </div>
    <div class="item">
        <a href="/art">Art</a>
    </div>
    <div class="item">
      <a href="/presentations/">Presentations</a>
    </div>
    <div class="item">
        <a href="/contact/">Contact</a>
    </div>
</nav>
<a href="/about/"><img src="/img/bruno.jpg" title="Hmmmm" alt="My picture" width="134px" height="215px" /></a>
    </div>
    <div class="ui black big launch right attached fixed button">
        <i class="content icon"></i>
        <span class="text">Menu</span>
    </div>
    <div class="ui fixed inverted main menu">
        <div class="ui container">
            <a class="launch icon item">
                <i class="content icon"></i>
            </a>
            <div class="item">
                Fixing Qt warning "QLayout: Attempting to add QLayout "" to QWidget "", which already has a layout"
            </div>
        </div>
    </div>
    <div class="pusher">
        <div class="full height">
            <div class="toc">
                <div class="ui vertical sticky fixed top menu">
                    <nav class="menu" role="navigation">
    <div class="item">
        <a href="/" class="main-link">Kinoshita</a>
    </div>
    <div class="item">
        <a href="/art">Art</a>
    </div>
    <div class="item">
      <a href="/presentations/">Presentations</a>
    </div>
    <div class="item">
        <a href="/contact/">Contact</a>
    </div>
</nav>
<a href="/about/"><img src="/img/bruno.jpg" title="Hmmmm" alt="My picture" width="134px" height="215px" /></a>
                </div>
            </div>
            <div class="article">
                <div class="main container" role="main">

                
<div class="ui raised padded container segment">
  <h1 class='post-topic'>Fixing Qt warning "QLayout: Attempting to add QLayout "" to QWidget "", which already has a layout"</h1>
  <small>kinow</small> @
	<small>2017-04-02&nbsp;12:01:03 (<span class='stardate' data-input-date='2017-04-02'></span>)</small>
  <div class="entry">
    





<a href="https://twitter.com/share" class="twitter-share-button" data-url="https://kinoshita.eti.br/2017/04/02/fixing-qt-warning-qlayout-attempting-to-add-qlayout-to-qwidget-which-already-has-a-layout" data-text="Fixing Qt warning &#34;QLayout: Attempting to add QLayout &#34;&#34; to QWidget &#34;&#34;, which already has a layout&#34;" data-via="kinow" data-hashtags="opensource">Tweet</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p='https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

	  <p>If you ever started Krita 3.x in your command line, and had a look at the console output,
you may noticed the following warning.</p>
<blockquote>
<p>QLayout: Attempting to add QLayout &#8220;&#8221; to QWidget &#8220;&#8221;, which already has a layout</p>
</blockquote>
<p>Krita recently <a href="https://krita.org/en/item/krita-3-1-3-alpha-released/">announced the release of 3.1.3-alpha-2</a>,
and while testing I saw this warning and
decided to investigate why this warning happens.</p>
<p>There was already
<a href="http://stackoverflow.com/a/25451334">a similar question posted on StackOverflow</a>. And the
best answer&#8217;s initial paragraph gave me a hint of what to look for.</p>
<blockquote>
<p>When you assign a widget as the parent of a QLayout by passing it into the constructor, the layout is automatically set as the layout for that widget. In your code you are not only doing this, but explicitly calling setlayout(). This is no problem when when the widget passed is the same. If they are different you will get an error because Qt tries to assign the second layout to your widget which has already had a layout set.</p>
</blockquote>
<p>So, somewhere in Krita code, there was a a QWidget being created, and layouts
were being added to it more than once. To find where the issue was happening was quite easy. A breakpoint at
<a href="https://github.com/KDE/krita/blob/9e2b8c5b07deccd4a616ad7930a91e8cc784a85b/krita/main.cc#L141">main.cc</a>
where the application is initialized, then step through a few times, until the message appeared in the
console.</p>
<p>Further investigation led me to the History docker (the one that shows undo steps)
<a href="https://github.com/KDE/krita/blob/9e2b8c5b07deccd4a616ad7930a91e8cc784a85b/plugins/dockers/historydocker/HistoryDock.cpp#L33">constructor</a>.</p>
<div class="highlight"><pre><span></span>    <span class="n">QVBoxLayout</span> <span class="o">*</span><span class="n">vl</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="n">page</span><span class="p">);</span> <span class="c1">// layout being set to page</span>
    <span class="n">m_undoView</span> <span class="o">=</span> <span class="k">new</span> <span class="n">KisUndoView</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="n">vl</span><span class="o">-&gt;</span><span class="n">addWidget</span><span class="p">(</span><span class="n">m_undoView</span><span class="p">);</span>
    <span class="n">QHBoxLayout</span> <span class="o">*</span><span class="n">hl</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QHBoxLayout</span><span class="p">(</span><span class="n">page</span><span class="p">);</span> <span class="c1">// layout being set to page again</span>
    <span class="n">hl</span><span class="o">-&gt;</span><span class="n">addSpacerItem</span><span class="p">(</span><span class="k">new</span> <span class="n">QSpacerItem</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>  <span class="n">QSizePolicy</span><span class="o">::</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">::</span><span class="n">Fixed</span><span class="p">));</span>
    <span class="n">m_bnConfigure</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QToolButton</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
    <span class="n">m_bnConfigure</span><span class="o">-&gt;</span><span class="n">setIcon</span><span class="p">(</span><span class="n">KisIconUtils</span><span class="o">::</span><span class="n">loadIcon</span><span class="p">(</span><span class="s">&quot;configure&quot;</span><span class="p">));</span>
    <span class="n">connect</span><span class="p">(</span><span class="n">m_bnConfigure</span><span class="p">,</span> <span class="n">SIGNAL</span><span class="p">(</span><span class="n">clicked</span><span class="p">(</span><span class="kt">bool</span><span class="p">)),</span> <span class="n">SLOT</span><span class="p">(</span><span class="n">configure</span><span class="p">()));</span>
    <span class="n">hl</span><span class="o">-&gt;</span><span class="n">addWidget</span><span class="p">(</span><span class="n">m_bnConfigure</span><span class="p">);</span>
    <span class="n">vl</span><span class="o">-&gt;</span><span class="n">addItem</span><span class="p">(</span><span class="n">hl</span><span class="p">);</span>

    <span class="n">setWidget</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
    <span class="n">setWindowTitle</span><span class="p">(</span><span class="n">i18n</span><span class="p">(</span><span class="s">&quot;Undo History&quot;</span><span class="p">));</span>
</pre></div>

<p>Here the QWidget created receives both QHBoxLayout and QVBoxLayout. Again, searching the Internet
a little bit, then came across this post with a good example of a QWidget with
QHBoxLayout and QVBoxLayout. Here&#8217;s what the constructor looks after the
<a href="https://bugs.kde.org/show_bug.cgi?id=378313">patch</a>
has been <a href="https://github.com/KDE/krita/commit/1d2343c0cacfb0b105fbe86c2bcef975a09b1041">applied</a>.</p>
<div class="highlight"><pre><span></span>    <span class="n">QVBoxLayout</span> <span class="o">*</span><span class="n">vl</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QVBoxLayout</span><span class="p">(</span><span class="n">page</span><span class="p">);</span> <span class="c1">// layout being set to page</span>
    <span class="n">m_undoView</span> <span class="o">=</span> <span class="k">new</span> <span class="n">KisUndoView</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="n">vl</span><span class="o">-&gt;</span><span class="n">addWidget</span><span class="p">(</span><span class="n">m_undoView</span><span class="p">);</span>
    <span class="n">QHBoxLayout</span> <span class="o">*</span><span class="n">hl</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QHBoxLayout</span><span class="p">();</span>
    <span class="n">hl</span><span class="o">-&gt;</span><span class="n">addSpacerItem</span><span class="p">(</span><span class="k">new</span> <span class="n">QSpacerItem</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>  <span class="n">QSizePolicy</span><span class="o">::</span><span class="n">Expanding</span><span class="p">,</span> <span class="n">QSizePolicy</span><span class="o">::</span><span class="n">Fixed</span><span class="p">));</span>
    <span class="n">m_bnConfigure</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QToolButton</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
    <span class="n">m_bnConfigure</span><span class="o">-&gt;</span><span class="n">setIcon</span><span class="p">(</span><span class="n">KisIconUtils</span><span class="o">::</span><span class="n">loadIcon</span><span class="p">(</span><span class="s">&quot;configure&quot;</span><span class="p">));</span>
    <span class="n">connect</span><span class="p">(</span><span class="n">m_bnConfigure</span><span class="p">,</span> <span class="n">SIGNAL</span><span class="p">(</span><span class="n">clicked</span><span class="p">(</span><span class="kt">bool</span><span class="p">)),</span> <span class="n">SLOT</span><span class="p">(</span><span class="n">configure</span><span class="p">()));</span>
    <span class="n">hl</span><span class="o">-&gt;</span><span class="n">addWidget</span><span class="p">(</span><span class="n">m_bnConfigure</span><span class="p">);</span>
    <span class="n">vl</span><span class="o">-&gt;</span><span class="n">addItem</span><span class="p">(</span><span class="n">hl</span><span class="p">);</span>
    <span class="n">vl</span><span class="o">-&gt;</span><span class="n">addLayout</span><span class="p">(</span><span class="n">hl</span><span class="p">);</span> <span class="c1">// horizontal layout added to the vertical layout</span>

    <span class="n">setWidget</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
    <span class="n">setWindowTitle</span><span class="p">(</span><span class="n">i18n</span><span class="p">(</span><span class="s">&quot;Undo History&quot;</span><span class="p">));</span>
</pre></div>

<p>That&#8217;s it. Learned something new in Qt. Not as important and useful as learning about
<a href="http://doc.qt.io/qt-4.8/signalsandslots.html">signals and slots</a>, but now I can focus
on other warnings in the console output of Krita.</p>
<p>And you? Have you tested <a href="https://krita.org/en/item/krita-3-1-3-alpha-released/">Krita 3.1.3 alpha</a> already?
What are you waiting for? :-)</p>
<p>&hearts; Open Source</p>
  </div>
  <p class="postmetadata">
    
    <small>tags [&nbsp;<a href="/tag/c%2B%2B" rel="tag">c++</a>&nbsp;]&nbsp;[&nbsp;<a href="/tag/krita" rel="tag">krita</a>&nbsp;]&nbsp;[&nbsp;<a href="/tag/programming" rel="tag">programming</a>&nbsp;]&nbsp;[&nbsp;<a href="/tag/opensource" rel="tag">opensource</a>&nbsp;]&nbsp;</small>
    
    
    <br/>
    <small>posted in [&nbsp;<a href="/blog" title="View all posts in blog" rel="category tag">blog</a>&nbsp;]&nbsp; category </small>
    
  </p>
  
</div>

                </div>
            </div>
        </div>
        <div class="ui vertical footer segment">
            <div class="ui center aligned container">
                           <div id="copy" class="">
                <p>&copy; <a href="/about"><span
                            class="b">Bru</span><span
                            class="r">no de</span> <span
                            class="a">Paula</span> <span
                            class="s"></span><span
                            class="i">Kinos</span><span
                            class="l">hita</span></a>
                </p>
            </div>
            </div>
         </div>
    </div>
</body>
</html>
<script src="/js/jquery-2.2.3.min.js"  type="text/javascript"></script>
<script src="/css/semantic/dist/semantic.min.js"  type="text/javascript"></script>
<script src="/js/jquery.prettyPhoto.js"></script>
<script src="/js/site.js"></script>