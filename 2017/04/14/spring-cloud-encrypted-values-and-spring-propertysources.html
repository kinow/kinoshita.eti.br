<!doctype html><html lang=en><head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<link rel=stylesheet type=text/css href=https://kinoshita.eti.br/sass/main.bb12278f082614f093646fd8c21cd5db009382bf5777a5ca1b84c705f7ff5e2d.css integrity="sha256-uxInjwgmFPCTZG/YwhzV2wCTgr9Xd6XKG4THBff/Xi0=">
<title>kinow | Spring Cloud encrypted values and Spring PropertySources</title>
</head>
<body><header role=banner class=content>
<nav id=nav aria-label=Main role=navigation class=content>
<ul><li>
<a href=/>
<i data-feather=about></i> About</a>
</li><li>
<a href=/blog/>
<i data-feather=blog></i> Blog</a>
</li><li>
<a href=/portfolio/>
<i data-feather=portfolio></i> Portfolio</a>
</li><li></li>
</ul>
</nav>
</header>
<main>
<article class=content>
<h2>Spring Cloud encrypted values and Spring PropertySources</h2><div class=metadata>
<i data-feather=calendar></i>
<time datetime=2017-04-14>Apr 14, 2017</time>
</div>
<p>As I could not find any documentation for that, I decided to write it as a note to myself
in case I use the
<a href=https://cloud.spring.io/spring-cloud-config/spring-cloud-config.html#_encryption_and_decryption>encryption and decryption</a>
with Spring Cloud again.</p>
<p>In Spring and Spring Boot, you normally have multiple sources of properties, like multiple
properties files, environment properties and variables, and so it goes. In the Spring API,
these are represented as
<a href=http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/context/annotation/PropertySource.html>PropertySource</a>&rsquo;s.</p>
<p>In a Spring Boot application, you would be used to overriding certain properties
by defining environments and using an application-production.properties file, or
overriding values with environment properties.</p>
<p>This is common in
<a href=https://aws.amazon.com/blogs/devops/deploying-a-spring-boot-application-on-aws-using-aws-elastic-beanstalk/>Spring Boot applications deployed to Amazon Elastic Beanstalk</a>.</p>
<p>Some time ago another team at work found that overriding did not always work when you have
encrypted values in your properties files. Even if you specified new values in the
Amazon Elastic Beanstalk application configuration.</p>
<p>Yesterday, while debugging the issue and reading Spring Cloud source code, I found its
<a href=https://github.com/spring-cloud/spring-cloud-commons/blob/9675df02f6a2c01766711f7dee3c4d2818b7d716/spring-cloud-context/src/main/java/org/springframework/cloud/bootstrap/encrypt/EnvironmentDecryptApplicationInitializer.java#L44>EnvironmentDecryptApplicationInitializer</a>.</p>
<p>It basically iterates through all loaded property sources, looking for values that start with
{cipher}. Then it calls the
<a href=http://docs.spring.io/spring-security/site/docs/current/apidocs/org/springframework/security/crypto/encrypt/TextEncryptor.html>Spring Security TextEncryptor</a>
defined in the application.</p>
<p>Finally, it creates a new property source, called decrypted, with the decrypted values. So when
your application looks for a property called XPTO, and if it has been encrypted, it will
find the value in the decrypted propery source, regardless of whether you tried to override it or
not.</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#080;font-style:italic># Property sources listed in Eclipse IDE</span>

[
  servletConfigInitParams,
  servletContextInitParams,
  systemProperties,
  systemEnvironment,
  random,
  applicationConfigurationProperties,
  springCloudClientHostInfo,
  defaultProperties
]

<span style=color:#080;font-style:italic># When using encrypted values</span>

[
  decrypted, &lt;-------- created by Spring Cloud, with decrypted values. Prepended to the list of property sources
  servletConfigInitParams,
  servletContextInitParams,
  systemProperties,
  systemEnvironment,
  random,
  applicationConfigurationProperties,
  springCloudClientHostInfo,
  defaultProperties
]
</code></pre></div><p>So in case you have encrypted values in your Spring application (and you are using Spring Cloud,
of course) remember that these values will have higher priority, and can only be overriden by other
encrypted values.</p>
<p>â™¥ Open Source</p>
<aside class=links>
<a class=previous href=https://kinoshita.eti.br/2017/04/14/writing-a-binary-parser-in-python-numpy-vs.-construct.html>&#171; Previous</a>
<a class=next href=https://kinoshita.eti.br/2017/04/17/troubleshooting-a-jenkins-plug-in-compatibility-issue.html>Next &#187;</a>
</aside>
</article>
</main>
<footer role=contentinfo>
<ul id=social-media-icons>
<li>
<a href=https://www.instagram.com/brunokinoshita/>
<img src=/assets/icons/instagram.png alt="Instagram link">
</a>
</li>
<li>
<a href=https://twitter.com/kinow/>
<img src=/assets/icons/twitter.png alt="Twitter link">
</a>
</li>
<li>
<a href=https://github.com/kinow/>
<img src=/assets/icons/github.png alt="GitHub link">
</a>
</li>
</ul>
</footer>
</body>
</html>