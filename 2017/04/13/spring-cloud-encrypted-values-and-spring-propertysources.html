<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Spring Cloud encrypted values and Spring PropertySources | Bruno P. Kinoshita</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Spring Cloud encrypted values and Spring PropertySources" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="As I could not find any documentation for that, I decided to write it as a note to myself in case I use the encryption and decryption with Spring Cloud again. In Spring and Spring Boot, you normally have multiple sources of properties, like multiple properties files, environment properties and variables, and so it goes. In the Spring API, these are represented as PropertySource’s. In a Spring Boot application, you would be used to overriding certain properties by defining environments and using an application-production.properties file, or overriding values with environment properties. This is common in Spring Boot applications deployed to Amazon Elastic Beanstalk. Some time ago another team at work found that overriding did not always work when you have encrypted values in your properties files. Even if you specified new values in the Amazon Elastic Beanstalk application configuration. Yesterday, while debugging the issue and reading Spring Cloud source code, I found its EnvironmentDecryptApplicationInitializer. It basically iterates through all loaded property sources, looking for values that start with {cipher}. Then it calls the Spring Security TextEncryptor defined in the application. Finally, it creates a new property source, called decrypted, with the decrypted values. So when your application looks for a property called XPTO, and if it has been encrypted, it will find the value in the decrypted propery source, regardless of whether you tried to override it or not. # Property sources listed in Eclipse IDE [ servletConfigInitParams, servletContextInitParams, systemProperties, systemEnvironment, random, applicationConfigurationProperties, springCloudClientHostInfo, defaultProperties ] # When using encrypted values [ decrypted, &lt;-------- created by Spring Cloud, with decrypted values. Prepended to the list of property sources servletConfigInitParams, servletContextInitParams, systemProperties, systemEnvironment, random, applicationConfigurationProperties, springCloudClientHostInfo, defaultProperties ] So in case you have encrypted values in your Spring application (and you are using Spring Cloud, of course) remember that these values will have higher priority, and can only be overriden by other encrypted values. ♥ Open Source" />
<meta property="og:description" content="As I could not find any documentation for that, I decided to write it as a note to myself in case I use the encryption and decryption with Spring Cloud again. In Spring and Spring Boot, you normally have multiple sources of properties, like multiple properties files, environment properties and variables, and so it goes. In the Spring API, these are represented as PropertySource’s. In a Spring Boot application, you would be used to overriding certain properties by defining environments and using an application-production.properties file, or overriding values with environment properties. This is common in Spring Boot applications deployed to Amazon Elastic Beanstalk. Some time ago another team at work found that overriding did not always work when you have encrypted values in your properties files. Even if you specified new values in the Amazon Elastic Beanstalk application configuration. Yesterday, while debugging the issue and reading Spring Cloud source code, I found its EnvironmentDecryptApplicationInitializer. It basically iterates through all loaded property sources, looking for values that start with {cipher}. Then it calls the Spring Security TextEncryptor defined in the application. Finally, it creates a new property source, called decrypted, with the decrypted values. So when your application looks for a property called XPTO, and if it has been encrypted, it will find the value in the decrypted propery source, regardless of whether you tried to override it or not. # Property sources listed in Eclipse IDE [ servletConfigInitParams, servletContextInitParams, systemProperties, systemEnvironment, random, applicationConfigurationProperties, springCloudClientHostInfo, defaultProperties ] # When using encrypted values [ decrypted, &lt;-------- created by Spring Cloud, with decrypted values. Prepended to the list of property sources servletConfigInitParams, servletContextInitParams, systemProperties, systemEnvironment, random, applicationConfigurationProperties, springCloudClientHostInfo, defaultProperties ] So in case you have encrypted values in your Spring application (and you are using Spring Cloud, of course) remember that these values will have higher priority, and can only be overriden by other encrypted values. ♥ Open Source" />
<link rel="canonical" href="https://kinoshita.eti.br/2017/04/13/spring-cloud-encrypted-values-and-spring-propertysources.html" />
<meta property="og:url" content="https://kinoshita.eti.br/2017/04/13/spring-cloud-encrypted-values-and-spring-propertysources.html" />
<meta property="og:site_name" content="Bruno P. Kinoshita" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-04-13T17:21:03-05:00" />
<script type="application/ld+json">
{"datePublished":"2017-04-13T17:21:03-05:00","headline":"Spring Cloud encrypted values and Spring PropertySources","description":"As I could not find any documentation for that, I decided to write it as a note to myself in case I use the encryption and decryption with Spring Cloud again. In Spring and Spring Boot, you normally have multiple sources of properties, like multiple properties files, environment properties and variables, and so it goes. In the Spring API, these are represented as PropertySource’s. In a Spring Boot application, you would be used to overriding certain properties by defining environments and using an application-production.properties file, or overriding values with environment properties. This is common in Spring Boot applications deployed to Amazon Elastic Beanstalk. Some time ago another team at work found that overriding did not always work when you have encrypted values in your properties files. Even if you specified new values in the Amazon Elastic Beanstalk application configuration. Yesterday, while debugging the issue and reading Spring Cloud source code, I found its EnvironmentDecryptApplicationInitializer. It basically iterates through all loaded property sources, looking for values that start with {cipher}. Then it calls the Spring Security TextEncryptor defined in the application. Finally, it creates a new property source, called decrypted, with the decrypted values. So when your application looks for a property called XPTO, and if it has been encrypted, it will find the value in the decrypted propery source, regardless of whether you tried to override it or not. # Property sources listed in Eclipse IDE [ servletConfigInitParams, servletContextInitParams, systemProperties, systemEnvironment, random, applicationConfigurationProperties, springCloudClientHostInfo, defaultProperties ] # When using encrypted values [ decrypted, &lt;-------- created by Spring Cloud, with decrypted values. Prepended to the list of property sources servletConfigInitParams, servletContextInitParams, systemProperties, systemEnvironment, random, applicationConfigurationProperties, springCloudClientHostInfo, defaultProperties ] So in case you have encrypted values in your Spring application (and you are using Spring Cloud, of course) remember that these values will have higher priority, and can only be overriden by other encrypted values. ♥ Open Source","mainEntityOfPage":{"@type":"WebPage","@id":"https://kinoshita.eti.br/2017/04/13/spring-cloud-encrypted-values-and-spring-propertysources.html"},"@type":"BlogPosting","url":"https://kinoshita.eti.br/2017/04/13/spring-cloud-encrypted-values-and-spring-propertysources.html","dateModified":"2017-04-13T17:21:03-05:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/main.css"><link type="application/atom+xml" rel="alternate" href="https://kinoshita.eti.br/feed.xml" title="Bruno P. Kinoshita" /></head>
<body>
<div id="wrapper">
  <div id="sidebar"><div id="menu">
  <ul class="menu">
    <li class="item">
      <a href="/" aria-label="Home page link">
        <svg id="svg8" version="1.1" viewBox="0 0 58.208 9.2604" xmlns="http://www.w3.org/2000/svg" role="img"
             aria-labelledby="svg-logo-title svg-logo-desc">
          <title id="svg-logo-title">KINOSHITA image</title>
          <desc id="svg-logo-desc">A logo with the word KINOSHITA</desc>
          <g id="layer1" transform="translate(0 -287.74)">
            <g id="text817" transform="translate(-2.4568 -.23624)">
              <g id="logo" transform="matrix(2.6585 0 0 2.5911 -63.587 100.56)" fill="#000000" stroke-width=".26458px">
                <path role="presentation" id="path819"
                      d="m25.178 72.637h0.54187v2.9633h-0.54187zm0.5842 1.397 1.0964-1.397h0.635l-1.1049 1.397 1.1049 1.5663h-0.635z"/>
                <path role="presentation" id="path821" d="m27.832 72.637h0.54187v2.9633h-0.54187z"/>
                <path role="presentation" id="path823"
                      d="m29.023 72.637h0.5334l1.2658 1.9135v-1.9135h0.54187v2.9633h-0.4445l-1.3547-2.032v2.032h-0.54187z"/>
                <path role="presentation" id="path825"
                      d="m33.298 75.66q-0.4191 0-0.75353-0.1905-0.3302-0.19473-0.5207-0.54187-0.18627-0.35137-0.18627-0.80857t0.18627-0.80433q0.1905-0.35137 0.5207-0.54187 0.33443-0.19473 0.75353-0.19473t0.7493 0.19473q0.33443 0.1905 0.5207 0.54187 0.1905 0.34713 0.1905 0.80433t-0.1905 0.80857q-0.18627 0.34713-0.5207 0.54187-0.3302 0.1905-0.7493 0.1905zm0-0.52493q0.4318 0 0.6604-0.2794 0.23283-0.2794 0.23283-0.7366t-0.23283-0.7366q-0.2286-0.2794-0.6604-0.2794t-0.66463 0.2794q-0.2286 0.2794-0.2286 0.7366t0.2286 0.7366q0.23283 0.2794 0.66463 0.2794z"/>
                <path role="presentation" id="path827"
                      d="m36.091 75.66q-0.24977 0-0.53763-0.06773-0.28363-0.06773-0.4445-0.14817l0.0635-0.57573q0.5588 0.27093 0.98213 0.27093 0.22437 0 0.35137-0.08467 0.127-0.0889 0.127-0.25823 0-0.127-0.07197-0.20743-0.06773-0.08467-0.19897-0.1397-0.13123-0.05927-0.4191-0.16087-0.27093-0.09313-0.44873-0.19473-0.1778-0.10583-0.28363-0.2667-0.1016-0.1651-0.1016-0.40217 0-0.381 0.2794-0.61383t0.8001-0.23283q0.24553 0 0.48683 0.05503 0.24553 0.05503 0.44873 0.13547l-0.05503 0.55457q-0.26247-0.1143-0.4826-0.16933-0.2159-0.05927-0.4318-0.05927-0.2413 0-0.3683 0.08043t-0.127 0.23283q0 0.11853 0.06773 0.19473t0.18203 0.127q0.11853 0.0508 0.34713 0.12277 0.51223 0.16087 0.74507 0.37253 0.23707 0.20743 0.23707 0.5715 0 0.34713-0.2413 0.60537t-0.90593 0.25823z"/>
                <path role="presentation" id="path829"
                      d="m37.688 72.637h0.54187v1.1726h1.3547v-1.1726h0.54187v2.9633h-0.54187v-1.2827h-1.3547v1.2827h-0.54187z"/>
                <path role="presentation" id="path831" d="m40.78 72.637h0.54187v2.9633h-0.54187z"/>
                <path role="presentation" id="path833"
                      d="m42.546 73.162h-0.8382v-0.52493h2.2183v0.52493h-0.8382v2.4384h-0.54187z"/>
                <path role="presentation" id="path835"
                      d="m45.632 74.898h-1.0795l-0.24553 0.70273h-0.52493l1.0541-2.9633h0.51223l1.0541 2.9633h-0.52493zm-0.16933-0.47413-0.3683-1.0583-0.37253 1.0583z"/>
              </g>
            </g>
          </g>
        </svg>
      </a>
    </li>
    <li class="item">
      <a href="/blog/" class="">Blog</a>
      <ul>
        <li class="item">
          <a href="/blog/drawing/">Drawing</a>
        </li>
        <li class="item">
          <a href="/blog/languages/">Languages</a>
        </li>
        <li class="item">
          <a href="/blog/music/">Music</a>
        </li>
        <li class="item">
          <a href="/blog/writing/">Writing</a>
        </li>
      </ul>
    </li>
    <li class="item">
      <a href="/art/" class="">Illustrations</a>
    </li>
    <li class="item">
      <a href="/maps/" class="">Maps</a>
    </li>
  </ul>
  <div id="menu-bottom">
    <p id="feed-subscribe">
      <a href="/feed.xml">
        <svg id="feed-icon" xmlns="http://www.w3.org/2000/svg" version="1.1" width="128px" height="128px"
             viewBox="0 0 256 256">
          <circle cx="68" cy="189" r="24" fill="rgba(255, 255, 255, .2)"/>
          <path d="M160 213h-34a82 82 0 0 0 -82 -82v-34a116 116 0 0 1 116 116z" fill="rgba(255, 255, 255, .2)"/>
          <path d="M184 213A140 140 0 0 0 44 73 V 38a175 175 0 0 1 175 175z" fill="rgba(255, 255, 255, .2)"/>
        </svg>
      </a>
    </p>
  </div>
</div>
</div>
  <div id="content">
    <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Spring Cloud encrypted values and Spring PropertySources</h1>
    <spab class="post-meta">
      <time class="dt-published" datetime="2017-04-13T17:21:03-05:00" itemprop="datePublished">Apr 13, 2017
      </time>
      <span>&mdash; star date: -305638.36</span></spab>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>As I could not find any documentation for that, I decided to write it as a note to myself
in case I use the
<a href="https://cloud.spring.io/spring-cloud-config/spring-cloud-config.html#_encryption_and_decryption">encryption and decryption</a>
with Spring Cloud again.</p>

<p>In Spring and Spring Boot, you normally have multiple sources of properties, like multiple
properties files, environment properties and variables, and so it goes. In the Spring API,
these are represented as
<a href="http://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/context/annotation/PropertySource.html">PropertySource</a>’s.</p>

<p>In a Spring Boot application, you would be used to overriding certain properties
by defining environments and using an application-production.properties file, or
overriding values with environment properties.</p>

<p>This is common in
<a href="https://aws.amazon.com/blogs/devops/deploying-a-spring-boot-application-on-aws-using-aws-elastic-beanstalk/">Spring Boot applications deployed to Amazon Elastic Beanstalk</a>.</p>

<p>Some time ago another team at work found that overriding did not always work when you have
encrypted values in your properties files. Even if you specified new values in the
Amazon Elastic Beanstalk application configuration.</p>

<p>Yesterday, while debugging the issue and reading Spring Cloud source code, I found its
<a href="https://github.com/spring-cloud/spring-cloud-commons/blob/9675df02f6a2c01766711f7dee3c4d2818b7d716/spring-cloud-context/src/main/java/org/springframework/cloud/bootstrap/encrypt/EnvironmentDecryptApplicationInitializer.java#L44">EnvironmentDecryptApplicationInitializer</a>.</p>

<p>It basically iterates through all loaded property sources, looking for values that start with
{cipher}. Then it calls the
<a href="http://docs.spring.io/spring-security/site/docs/current/apidocs/org/springframework/security/crypto/encrypt/TextEncryptor.html">Spring Security TextEncryptor</a>
defined in the application.</p>

<p>Finally, it creates a new property source, called decrypted, with the decrypted values. So when
your application looks for a property called XPTO, and if it has been encrypted, it will
find the value in the decrypted propery source, regardless of whether you tried to override it or
not.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Property sources listed in Eclipse IDE</span>

<span class="o">[</span>
  servletConfigInitParams,
  servletContextInitParams,
  systemProperties,
  systemEnvironment,
  random,
  applicationConfigurationProperties,
  springCloudClientHostInfo,
  defaultProperties
<span class="o">]</span>

<span class="c"># When using encrypted values</span>

<span class="o">[</span>
  decrypted, &lt;<span class="nt">--------</span> created by Spring Cloud, with decrypted values. Prepended to the list of property sources
  servletConfigInitParams,
  servletContextInitParams,
  systemProperties,
  systemEnvironment,
  random,
  applicationConfigurationProperties,
  springCloudClientHostInfo,
  defaultProperties
<span class="o">]</span>
</code></pre></div></div>

<p>So in case you have encrypted values in your Spring application (and you are using Spring Cloud, 
of course) remember that these values will have higher priority, and can only be overriden by other
encrypted values.</p>

<p>♥ Open Source</p>

  </div>

  <div class="tags"><a class="label" href="/tags#java">java</a><a class="label" href="/tags#programming">programming</a><a class="label" href="/tags#opensource">opensource</a></div>

  <a class="u-url" href="/2017/04/13/spring-cloud-encrypted-values-and-spring-propertysources.html" hidden></a>
</article>

  </div>
</div>
</body>
</html>
