<!doctype html><html lang=en><head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<link rel=stylesheet type=text/css href=https://kinoshita.eti.br/sass/main.5770a4bbb94587745388ea30c6a21828c384682fd7a84b8d636265cbd651d758.css integrity="sha256-V3Cku7lFh3RTiOowxqIYKMOEaC/XqEuNY2Jly9ZR11g=">
<title>kinow | Order of containers in Docker Compose</title>
</head>
<body><header role=banner class=content>
<nav id=nav aria-label=Main role=navigation class=content>
<ul><li>
<a href=/>
<i data-feather=about></i> About</a>
</li><li>
<a href=/blog/>
<i data-feather=blog></i> Blog</a>
</li><li>
<a href=/portfolio/>
<i data-feather=portfolio></i> Portfolio</a>
</li><li></li>
</ul>
</nav>
</header>
<main>
<article class=content>
<h2>Order of containers in Docker Compose</h2><div class=metadata>
<i data-feather=calendar></i>
<time datetime=2017-03-14>Mar 14, 2017</time>
</div>
<p>In Docker Compose you are able to control the startup order of the containers via
the <em>depends_on</em> statement. This is documented in <a href=https://docs.docker.com/compose/startup-order/>Controlling startup order in Compose</a>.</p>
<p>If you have a simple setup, with Tomcat and Postgres, sometimes Postgres will start first, but Compose
will initialize Tomcat before Postgres has fully booted. When that happens, you may receive 401, 404, or other
application errors.</p>
<p>You can fix it by combining <em>depends_on</em> with a <em>healthcheck</em>. For example:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#080;font-style:italic># File: docker-compose.yml</span>
version: <span style=color:#00f>&#39;2.1&#39;</span>
services:
  db:
    container_name: twpg
    build:
      context: .
      dockerfile: Dockerfile.postgres
    restart: always
    ports:
      - <span style=color:#00f>&#34;5432:5432&#34;</span>
    healthcheck:
      test: <span style=color:#00f>&#34;pg_isready -h localhost -p 5432 -q -U postgres&#34;</span>
      interval: 10s
      timeout: 5s
      retries: <span style=color:#00f>5</span>

  web:
    container_name: twtc
    build:
      context: .
      dockerfile: Dockerfile.tomcat
    restart: always
    depends_on:
      db:
        condition: service_healthy
    links:
      - db
    ports:
      - <span style=color:#00f>&#34;80:8080&#34;</span>
</code></pre></div><p>In the example docker-compose.yml, there are two containers, <em>db</em> and <em>web</em>. web is running
a Tomcat, and db is running Postgres. Web depends on db (see depends_on), and uses a condition
<em>service_healthy</em>. Which indicates it depends that that container is healthy.</p>
<p>The <em>healthcheck</em> entry under the db container settings define how to check whether Postgres
is running or not. In this case, we are using <em>pg_isready</em>, which is available in the
vanilla Postgres 9 container.</p>
<p>It will try 5 times, with a 10 seconds interval, and will time out after 5 seconds. You may
have to tune these parameters for your application.</p>
<p>This code snippet is from a
<a href=https://github.com/Foxoncz/docker-thingworx/pull/3/files>pull request submitted to Foxoncz/docker-thingworx</a>.</p>
<p>â™¥ Open Source</p>
<aside class=links>
<a class=previous href=https://kinoshita.eti.br/2017/02/28/using-aws-mfa-without-a-mobile-phone.html>&#171; Previous</a>
<a class=next href=https://kinoshita.eti.br/2017/03/15/using-google-natural-language-api-in-an-aws-elastic-beanstalk-application.html>Next &#187;</a>
</aside>
</article>
</main>
<footer role=contentinfo>
<ul id=social-media-icons>
<li>
<a href=https://www.instagram.com/brunokinoshita/>
<img src=/assets/icons/instagram.png alt="Instagram link">
</a>
</li>
<li>
<a href=https://twitter.com/kinow/>
<img src=/assets/icons/twitter.png alt="Twitter link">
</a>
</li>
<li>
<a href=https://github.com/kinow/>
<img src=/assets/icons/github.png alt="GitHub link">
</a>
</li>
</ul>
</footer>
</body>
</html>