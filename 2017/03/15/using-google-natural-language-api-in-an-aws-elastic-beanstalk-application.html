<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta property="og:title" content="Using Google Natural Language API in an AWS Elastic Beanstalk application">
<meta property="og:description" content="Besides providing an API for users and developers, Google also provides a series of (very well-written) client implementation, in several programming languages. That&rsquo;s the case for Google Storage, Google Vision, and for Google Natural Language API&rsquo;s.
I recently had to use the latter in a POC at work, and ran into an interesting issue with our AWS Elastic Beanstalk environment.
Google Language API requires that clients authenticate before sending requests. If you use their google-cloud-java, you can define the GOOGLE_APPLICATION_CREDENTIALS.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://kinoshita.eti.br/2017/03/15/using-google-natural-language-api-in-an-aws-elastic-beanstalk-application.html"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2017-03-15T00:00:00+00:00">
<meta property="article:modified_time" content="2017-03-15T00:00:00+00:00">
<link rel=stylesheet type=text/css href=https://kinoshita.eti.br/sass/main.de6eddbd022e2ff31c7675270a2ccd00d63fa2c52ca6dc77e1a974bc7b0b7103.css integrity="sha256-3m7dvQIuL/McdnUnCizNANY/osUsptx34al0vHsLcQM=">
<title>kinow | Using Google Natural Language API in an AWS Elastic Beanstalk application</title>
</head>
<body>
<header role=banner class=content>
<nav id=nav aria-label=Main role=navigation class=content>
<ul><li>
<a href=/><i data-feather=about></i> About</a>
</li><li>
<a href=/blog/><i data-feather=blog></i> Blog</a>
</li><li>
<a href=/portfolio/><i data-feather=portfolio></i> Portfolio</a>
</li>
</ul>
</nav>
</header>
<main>
<article class=content>
<h1>Using Google Natural Language API in an AWS Elastic Beanstalk application</h1><div class=metadata>
<i data-feather=calendar></i>
<time datetime=2017-03-15>Mar 15, 2017</time>
</div>
<p>Besides providing an API for users and developers, Google also provides a series of
(very well-written) client implementation, in several programming languages. That&rsquo;s the
case for Google Storage, Google Vision, and for Google Natural Language API&rsquo;s.</p>
<p>I recently had to use the latter in a POC at work, and ran into an interesting issue with
our AWS Elastic Beanstalk environment.</p>
<p>Google Language API requires that clients authenticate before sending requests. If you use their <a href=https://github.com/GoogleCloudPlatform/google-cloud-java>google-cloud-java</a>, you can define the GOOGLE_APPLICATION_CREDENTIALS. This environment variable must point to a JSON file with the Google Language API credentials.</p>
<p>The issue is that while Google Language API (or more precisely
<a href=https://github.com/google/google-auth-library-java/blob/ae9735c576fd8593636e155ccb26e454576bc2cd/oauth2_http/java/com/google/auth/oauth2/DefaultCredentialsProvider.java#L124>google-auth-library-java</a>)
looks for an environment variable, in Elastic Beanstalk you are able to
specify only system properties (unless you want to try something with ebextensions,
maybe some JNI&mldr;).</p>
<p>A workaround for this issue in Google Natural Language API, is to create and pass a
<a href=http://googlecloudplatform.github.io/google-cloud-java/0.8.0/apidocs/com/google/cloud/language/spi/v1/LanguageServiceSettings.html>LanguageServiceSettings</a>
to your <a href=http://googlecloudplatform.github.io/google-cloud-java/0.8.0/apidocs/com/google/cloud/language/spi/v1/LanguageServiceClient.html>LanguageServiceClient</a>.
This settings object, when created, must be given a
<a href=http://googleapis.github.io/gax-java/0.2.0/apidocs/com/google/api/gax/grpc/ChannelProvider.html>channel provider</a>
with a <a href=http://googleapis.github.io/gax-java/0.2.0/apidocs/com/google/api/gax/core/FixedCredentialsProvider.html>FixedCredentialsProvider</a>.</p>
<p>Of course reading code is way easier than reading this workaround description.</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#080;font-style:italic>// File: GoogleNaturalLanguageService.java
</span><span style=color:#080;font-style:italic>// ...
</span><span style=color:#080;font-style:italic></span>    <span style=color:#080;font-style:italic>// envvar or property used to specify the Google Application Credentials
</span><span style=color:#080;font-style:italic></span>    <span style=color:navy;font-weight:700>private</span> <span style=color:navy;font-weight:700>final</span> <span style=color:navy;font-weight:700>static</span> String GOOGLE_APPLICATION_CREDENTIALS = <span style=color:#00f>&#34;GOOGLE_APPLICATION_CREDENTIALS&#34;</span>;

    <span style=color:#080;font-style:italic>/**
</span><span style=color:#080;font-style:italic>     * Google Natural Language API.
</span><span style=color:#080;font-style:italic>     */</span>
    <span style=color:navy;font-weight:700>private</span> LanguageServiceClient languageServiceClient;

    @PostConstruct
    <span style=color:navy;font-weight:700>public</span> <span style=color:navy;font-weight:700>void</span> init() <span style=color:navy;font-weight:700>throws</span> Exception {
        <span style=color:#080;font-style:italic>// Elastic Beanstalk supports Properties, not Environment Variables.
</span><span style=color:#080;font-style:italic></span>        <span style=color:#080;font-style:italic>// Google credentials library will load
</span><span style=color:#080;font-style:italic></span>        <span style=color:#080;font-style:italic>// the JSON location for the service to authenticate from an envVar. So
</span><span style=color:#080;font-style:italic></span>        <span style=color:#080;font-style:italic>// we need to fix that here.
</span><span style=color:#080;font-style:italic></span>        String googleApplicationCredentials = System.<span style=color:red>getenv</span>(GOOGLE_APPLICATION_CREDENTIALS);
        LOGGER.<span style=color:red>info</span>(String.<span style=color:red>format</span>(<span style=color:#00f>&#34;GOOGLE_APPLICATION_CREDENTIALS in environment variable: %s&#34;</span>, googleApplicationCredentials));
        <span style=color:navy;font-weight:700>if</span> (StringUtils.<span style=color:red>isBlank</span>(googleApplicationCredentials)) {
            googleApplicationCredentials = System.<span style=color:red>getProperty</span>(GOOGLE_APPLICATION_CREDENTIALS);
            LOGGER.<span style=color:red>info</span>(String.<span style=color:red>format</span>(<span style=color:#00f>&#34;GOOGLE_APPLICATION_CREDENTIALS in JVM property: %s&#34;</span>, googleApplicationCredentials));
        }

        <span style=color:navy;font-weight:700>if</span> (googleApplicationCredentials == <span style=color:navy;font-weight:700>null</span>) {
            <span style=color:navy;font-weight:700>throw</span> <span style=color:navy;font-weight:700>new</span> RuntimeException(<span style=color:#00f>&#34;Could not locate GOOGLE_APPLICATION_CREDENTIALS variable!&#34;</span>);
        }

        <span style=color:navy;font-weight:700>final</span> LanguageServiceSettings languageServiceSettings;
        <span style=color:navy;font-weight:700>try</span> (InputStream is = <span style=color:navy;font-weight:700>new</span> FileInputStream(<span style=color:navy;font-weight:700>new</span> File(googleApplicationCredentials))) {
            <span style=color:navy;font-weight:700>final</span> GoogleCredentials myCredentials = GoogleCredentials
                    .<span style=color:red>fromStream</span>(is)
                    .<span style=color:red>createScoped</span>(
                            Collections.<span style=color:red>singleton</span>(<span style=color:#00f>&#34;https://www.googleapis.com/auth/cloud-platform&#34;</span>)
                    );
            <span style=color:navy;font-weight:700>final</span> CredentialsProvider credentialsProvider = FixedCredentialsProvider.<span style=color:red>create</span>(myCredentials);

            <span style=color:navy;font-weight:700>final</span> InstantiatingChannelProvider channelProvider = LanguageServiceSettings
                    .<span style=color:red>defaultChannelProviderBuilder</span>()
                    .<span style=color:red>setCredentialsProvider</span>(credentialsProvider)
                    .<span style=color:red>build</span>();
            languageServiceSettings = LanguageServiceSettings
                    .<span style=color:red>defaultBuilder</span>()
                    .<span style=color:red>setChannelProvider</span>(channelProvider)
                    .<span style=color:red>build</span>();
        } <span style=color:navy;font-weight:700>catch</span> (IOException ioe) {
            LOGGER.<span style=color:red>error</span>(String.<span style=color:red>format</span>(<span style=color:#00f>&#34;IO error creating Google NLP settings: %s&#34;</span>, ioe.<span style=color:red>getMessage</span>()), ioe);
            <span style=color:navy;font-weight:700>throw</span> ioe;
        }

        <span style=color:#080;font-style:italic>// Create Google API client
</span><span style=color:#080;font-style:italic></span>        <span style=color:navy;font-weight:700>this</span>.<span style=color:red>languageServiceClient</span> = LanguageServiceClient.<span style=color:red>create</span>(languageServiceSettings);
    }

    @PreDestroy
    <span style=color:navy;font-weight:700>public</span> <span style=color:navy;font-weight:700>void</span> destroy() <span style=color:navy;font-weight:700>throws</span> Exception {
        <span style=color:navy;font-weight:700>if</span> (LOGGER.<span style=color:red>isDebugEnabled</span>()) {
            LOGGER.<span style=color:red>debug</span>(<span style=color:#00f>&#34;Destroying Google NLP API client&#34;</span>);
        }
        <span style=color:#080;font-style:italic>// Close Google API executors and channels
</span><span style=color:#080;font-style:italic></span>        <span style=color:navy;font-weight:700>this</span>.<span style=color:red>languageServiceClient</span>.<span style=color:red>close</span>();
    }
<span style=color:#080;font-style:italic>// ...
</span></code></pre></div><p>That way you should be able to use the API with AWS Elastic Beanstalk
without having to hack your environment to provide the GOOGLE_APPLICATION_CREDENTIALS
environment variable.</p>
<p>An alternative would be google-auth-library-java to look for an environment variable
<em>and</em> a system property. Or maybe Amazon AWS add a way to provide environment variables.</p>
<p>Note also that I included the @PostConstruct and @PreDestroy annotated methods. The
API will start an executor thread pool, so if you do not want to risk to have problems
re-deploying your application, then remember to close your streams.</p>
<p>♥ Open Source</p>
<aside class=links>
<a class=previous href=https://kinoshita.eti.br/2017/03/14/order-of-containers-in-docker-compose.html>&#171; Previous</a>
<a class=next href=https://kinoshita.eti.br/2017/03/26/simulating-less-memory-with-ulimit.html>Next &#187;</a>
</aside>
</article>
</main>
<footer role=contentinfo>
<ul id=social-media-icons>
<li>
<a href=https://www.instagram.com/brunokinoshita/>
<img src=/assets/icons/instagram.png alt="Instagram link">
</a>
</li>
<li>
<a href=https://twitter.com/kinow/>
<img src=/assets/icons/twitter.png alt="Twitter link">
</a>
</li>
<li>
<a href=https://github.com/kinow/>
<img src=/assets/icons/github.png alt="GitHub link">
</a>
</li>
<li>
<a href=/feed.xml>
<img src=/assets/icons/news.png alt="RSS feed link">
</a>
</li>
</ul>
</footer>
</body>
</html>