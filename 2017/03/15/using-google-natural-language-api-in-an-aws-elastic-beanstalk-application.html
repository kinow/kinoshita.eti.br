<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta property="og:title" content="Using Google Natural Language API in an AWS Elastic Beanstalk application">
<meta property="og:description" content="Besides providing an API for users and developers, Google also provides a series of (very well-written) client implementation, in several programming languages. That&rsquo;s the case for Google Storage, Google Vision, and for Google Natural Language API&rsquo;s.
I recently had to use the latter in a POC at work, and ran into an interesting issue with our AWS Elastic Beanstalk environment.
Google Language API requires that clients authenticate before sending requests. If you use their google-cloud-java, you can define the GOOGLE_APPLICATION_CREDENTIALS.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://kinoshita.eti.br/2017/03/15/using-google-natural-language-api-in-an-aws-elastic-beanstalk-application.html"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2017-03-15T00:00:00+00:00">
<meta property="article:modified_time" content="2024-04-07T17:48:34+02:00">
<link rel=alternate type=application/rss+xml href=https://kinoshita.eti.br/2017/03/15/using-google-natural-language-api-in-an-aws-elastic-beanstalk-application/feed.xml title=kinow>
<link rel=stylesheet type=text/css href=https://kinoshita.eti.br/sass/main.09b56b6037e962b67cf7a7701bf2a9ee5da840a4f74b74139c4731f2156a5917.css integrity="sha256-CbVrYDfpYrZ896dwG/Kp7l2oQKT3S3QTnEcx8hVqWRc=">
<title>kinow | Using Google Natural Language API in an AWS Elastic Beanstalk application</title>
</head>
<body>
<header role=banner class=content>
<nav id=nav aria-label=Main role=navigation class=content>
<ul><li>
<a href=/><i data-feather=about></i> About</a>
</li><li>
<a href=/blog/><i data-feather=blog></i> Blog</a>
</li><li>
<a href=/portfolio/><i data-feather=portfolio></i> Portfolio</a>
</li>
</ul>
</nav>
</header>
<main>
<article class=content>
<h1>Using Google Natural Language API in an AWS Elastic Beanstalk application</h1><div class=metadata>
<i data-feather=calendar></i>
<time datetime=2017-03-15>Mar 15, 2017</time>
</div>
<aside>
<nav id=TableOfContents></nav>
</aside>
<p>Besides providing an API for users and developers, Google also provides a series of
(very well-written) client implementation, in several programming languages. That&rsquo;s the
case for Google Storage, Google Vision, and for Google Natural Language API&rsquo;s.</p>
<p>I recently had to use the latter in a POC at work, and ran into an interesting issue with
our AWS Elastic Beanstalk environment.</p>
<p>Google Language API requires that clients authenticate before sending requests. If you use their <a href=https://github.com/GoogleCloudPlatform/google-cloud-java>google-cloud-java</a>, you can define the GOOGLE_APPLICATION_CREDENTIALS. This environment variable must point to a JSON file with the Google Language API credentials.</p>
<p>The issue is that while Google Language API (or more precisely
<a href=https://github.com/google/google-auth-library-java/blob/ae9735c576fd8593636e155ccb26e454576bc2cd/oauth2_http/java/com/google/auth/oauth2/DefaultCredentialsProvider.java#L124>google-auth-library-java</a>)
looks for an environment variable, in Elastic Beanstalk you are able to
specify only system properties (unless you want to try something with ebextensions,
maybe some JNI&mldr;).</p>
<p>A workaround for this issue in Google Natural Language API, is to create and pass a
<a href=http://googlecloudplatform.github.io/google-cloud-java/0.8.0/apidocs/com/google/cloud/language/spi/v1/LanguageServiceSettings.html>LanguageServiceSettings</a>
to your <a href=http://googlecloudplatform.github.io/google-cloud-java/0.8.0/apidocs/com/google/cloud/language/spi/v1/LanguageServiceClient.html>LanguageServiceClient</a>.
This settings object, when created, must be given a
<a href=http://googleapis.github.io/gax-java/0.2.0/apidocs/com/google/api/gax/grpc/ChannelProvider.html>channel provider</a>
with a <a href=http://googleapis.github.io/gax-java/0.2.0/apidocs/com/google/api/gax/core/FixedCredentialsProvider.html>FixedCredentialsProvider</a>.</p>
<p>Of course reading code is way easier than reading this workaround description.</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#177500>// File: GoogleNaturalLanguageService.java
</span><span style=color:#177500>// ...
</span><span style=color:#177500></span>    <span style=color:#177500>// envvar or property used to specify the Google Application Credentials
</span><span style=color:#177500></span>    <span style=color:#a90d91>private</span> <span style=color:#a90d91>final</span> <span style=color:#a90d91>static</span> <span style=color:#000>String</span> <span style=color:#000>GOOGLE_APPLICATION_CREDENTIALS</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;GOOGLE_APPLICATION_CREDENTIALS&#34;</span><span style=color:#000>;</span>

    <span style=color:#177500>/**
</span><span style=color:#177500>     * Google Natural Language API.
</span><span style=color:#177500>     */</span>
    <span style=color:#a90d91>private</span> <span style=color:#000>LanguageServiceClient</span> <span style=color:#000>languageServiceClient</span><span style=color:#000>;</span>

    <span style=color:#000>@PostConstruct</span>
    <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>init</span><span style=color:#000>()</span> <span style=color:#a90d91>throws</span> <span style=color:#000>Exception</span> <span style=color:#000>{</span>
        <span style=color:#177500>// Elastic Beanstalk supports Properties, not Environment Variables.
</span><span style=color:#177500></span>        <span style=color:#177500>// Google credentials library will load
</span><span style=color:#177500></span>        <span style=color:#177500>// the JSON location for the service to authenticate from an envVar. So
</span><span style=color:#177500></span>        <span style=color:#177500>// we need to fix that here.
</span><span style=color:#177500></span>        <span style=color:#000>String</span> <span style=color:#000>googleApplicationCredentials</span> <span style=color:#000>=</span> <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>getenv</span><span style=color:#000>(</span><span style=color:#000>GOOGLE_APPLICATION_CREDENTIALS</span><span style=color:#000>);</span>
        <span style=color:#000>LOGGER</span><span style=color:#000>.</span><span style=color:#836c28>info</span><span style=color:#000>(</span><span style=color:#000>String</span><span style=color:#000>.</span><span style=color:#836c28>format</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;GOOGLE_APPLICATION_CREDENTIALS in environment variable: %s&#34;</span><span style=color:#000>,</span> <span style=color:#000>googleApplicationCredentials</span><span style=color:#000>));</span>
        <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>StringUtils</span><span style=color:#000>.</span><span style=color:#836c28>isBlank</span><span style=color:#000>(</span><span style=color:#000>googleApplicationCredentials</span><span style=color:#000>))</span> <span style=color:#000>{</span>
            <span style=color:#000>googleApplicationCredentials</span> <span style=color:#000>=</span> <span style=color:#000>System</span><span style=color:#000>.</span><span style=color:#836c28>getProperty</span><span style=color:#000>(</span><span style=color:#000>GOOGLE_APPLICATION_CREDENTIALS</span><span style=color:#000>);</span>
            <span style=color:#000>LOGGER</span><span style=color:#000>.</span><span style=color:#836c28>info</span><span style=color:#000>(</span><span style=color:#000>String</span><span style=color:#000>.</span><span style=color:#836c28>format</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;GOOGLE_APPLICATION_CREDENTIALS in JVM property: %s&#34;</span><span style=color:#000>,</span> <span style=color:#000>googleApplicationCredentials</span><span style=color:#000>));</span>
        <span style=color:#000>}</span>

        <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>googleApplicationCredentials</span> <span style=color:#000>==</span> <span style=color:#a90d91>null</span><span style=color:#000>)</span> <span style=color:#000>{</span>
            <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>RuntimeException</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;Could not locate GOOGLE_APPLICATION_CREDENTIALS variable!&#34;</span><span style=color:#000>);</span>
        <span style=color:#000>}</span>

        <span style=color:#a90d91>final</span> <span style=color:#000>LanguageServiceSettings</span> <span style=color:#000>languageServiceSettings</span><span style=color:#000>;</span>
        <span style=color:#a90d91>try</span> <span style=color:#000>(</span><span style=color:#000>InputStream</span> <span style=color:#000>is</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>FileInputStream</span><span style=color:#000>(</span><span style=color:#a90d91>new</span> <span style=color:#000>File</span><span style=color:#000>(</span><span style=color:#000>googleApplicationCredentials</span><span style=color:#000>)))</span> <span style=color:#000>{</span>
            <span style=color:#a90d91>final</span> <span style=color:#000>GoogleCredentials</span> <span style=color:#000>myCredentials</span> <span style=color:#000>=</span> <span style=color:#000>GoogleCredentials</span>
                    <span style=color:#000>.</span><span style=color:#836c28>fromStream</span><span style=color:#000>(</span><span style=color:#000>is</span><span style=color:#000>)</span>
                    <span style=color:#000>.</span><span style=color:#836c28>createScoped</span><span style=color:#000>(</span>
                            <span style=color:#000>Collections</span><span style=color:#000>.</span><span style=color:#836c28>singleton</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;https://www.googleapis.com/auth/cloud-platform&#34;</span><span style=color:#000>)</span>
                    <span style=color:#000>);</span>
            <span style=color:#a90d91>final</span> <span style=color:#000>CredentialsProvider</span> <span style=color:#000>credentialsProvider</span> <span style=color:#000>=</span> <span style=color:#000>FixedCredentialsProvider</span><span style=color:#000>.</span><span style=color:#836c28>create</span><span style=color:#000>(</span><span style=color:#000>myCredentials</span><span style=color:#000>);</span>

            <span style=color:#a90d91>final</span> <span style=color:#000>InstantiatingChannelProvider</span> <span style=color:#000>channelProvider</span> <span style=color:#000>=</span> <span style=color:#000>LanguageServiceSettings</span>
                    <span style=color:#000>.</span><span style=color:#836c28>defaultChannelProviderBuilder</span><span style=color:#000>()</span>
                    <span style=color:#000>.</span><span style=color:#836c28>setCredentialsProvider</span><span style=color:#000>(</span><span style=color:#000>credentialsProvider</span><span style=color:#000>)</span>
                    <span style=color:#000>.</span><span style=color:#836c28>build</span><span style=color:#000>();</span>
            <span style=color:#000>languageServiceSettings</span> <span style=color:#000>=</span> <span style=color:#000>LanguageServiceSettings</span>
                    <span style=color:#000>.</span><span style=color:#836c28>defaultBuilder</span><span style=color:#000>()</span>
                    <span style=color:#000>.</span><span style=color:#836c28>setChannelProvider</span><span style=color:#000>(</span><span style=color:#000>channelProvider</span><span style=color:#000>)</span>
                    <span style=color:#000>.</span><span style=color:#836c28>build</span><span style=color:#000>();</span>
        <span style=color:#000>}</span> <span style=color:#a90d91>catch</span> <span style=color:#000>(</span><span style=color:#000>IOException</span> <span style=color:#000>ioe</span><span style=color:#000>)</span> <span style=color:#000>{</span>
            <span style=color:#000>LOGGER</span><span style=color:#000>.</span><span style=color:#836c28>error</span><span style=color:#000>(</span><span style=color:#000>String</span><span style=color:#000>.</span><span style=color:#836c28>format</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;IO error creating Google NLP settings: %s&#34;</span><span style=color:#000>,</span> <span style=color:#000>ioe</span><span style=color:#000>.</span><span style=color:#836c28>getMessage</span><span style=color:#000>()),</span> <span style=color:#000>ioe</span><span style=color:#000>);</span>
            <span style=color:#a90d91>throw</span> <span style=color:#000>ioe</span><span style=color:#000>;</span>
        <span style=color:#000>}</span>

        <span style=color:#177500>// Create Google API client
</span><span style=color:#177500></span>        <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>languageServiceClient</span> <span style=color:#000>=</span> <span style=color:#000>LanguageServiceClient</span><span style=color:#000>.</span><span style=color:#836c28>create</span><span style=color:#000>(</span><span style=color:#000>languageServiceSettings</span><span style=color:#000>);</span>
    <span style=color:#000>}</span>

    <span style=color:#000>@PreDestroy</span>
    <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>destroy</span><span style=color:#000>()</span> <span style=color:#a90d91>throws</span> <span style=color:#000>Exception</span> <span style=color:#000>{</span>
        <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>LOGGER</span><span style=color:#000>.</span><span style=color:#836c28>isDebugEnabled</span><span style=color:#000>())</span> <span style=color:#000>{</span>
            <span style=color:#000>LOGGER</span><span style=color:#000>.</span><span style=color:#836c28>debug</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;Destroying Google NLP API client&#34;</span><span style=color:#000>);</span>
        <span style=color:#000>}</span>
        <span style=color:#177500>// Close Google API executors and channels
</span><span style=color:#177500></span>        <span style=color:#a90d91>this</span><span style=color:#000>.</span><span style=color:#836c28>languageServiceClient</span><span style=color:#000>.</span><span style=color:#836c28>close</span><span style=color:#000>();</span>
    <span style=color:#000>}</span>
<span style=color:#177500>// ...
</span></code></pre></div><p>That way you should be able to use the API with AWS Elastic Beanstalk
without having to hack your environment to provide the GOOGLE_APPLICATION_CREDENTIALS
environment variable.</p>
<p>An alternative would be google-auth-library-java to look for an environment variable
<em>and</em> a system property. Or maybe Amazon AWS add a way to provide environment variables.</p>
<p>Note also that I included the @PostConstruct and @PreDestroy annotated methods. The
API will start an executor thread pool, so if you do not want to risk to have problems
re-deploying your application, then remember to close your streams.</p>
<p>♥ Open Source</p>
<p>
Categories:
<a href=/categories/blog.html>blog</a>
</p>
<p>
Tags:
<a href=/tags/aws.html>aws</a>,
<a href=/tags/natural-language-processing.html>natural language processing</a>
</p>
<aside class=links>
<a class=previous href=https://kinoshita.eti.br/2017/03/14/order-of-containers-in-docker-compose.html>&#171; Previous</a>
<a class=next href=https://kinoshita.eti.br/2017/03/26/simulating-less-memory-with-ulimit.html>Next &#187;</a>
</aside>
</article>
</main>
<footer role=contentinfo>
<ul id=social-media-icons>
<li>
<a href=https://www.instagram.com/brunokinoshita/>
<img src=/assets/icons/instagram.png alt="Instagram link">
</a>
</li>
<li>
<a href=https://twitter.com/kinow/>
<img src=/assets/icons/twitter.png alt="Twitter link">
</a>
</li>
<li>
<a href=https://github.com/kinow/>
<img src=/assets/icons/github.png alt="GitHub link">
</a>
</li>
<li>
<a href=/feed.xml>
<img src=/assets/icons/news.png alt="RSS feed link">
</a>
</li>
</ul>
</footer>
</body>
</html>