<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta property="og:title" content="Replacing a HashSet with a BitSet">
<meta property="og:description" content="I always read the messages in the Apache dev mailing lists, including Apache Commons dev mailing list. And you should too. There are always interesting discussions. Sometimes you participate, other times you only watch what's happening, but in the end you always learn something new.





  
  




A few days ago, I found an issue where it was being proposed to replace an unnecessary HashSet in ArrayUtils#removeElements() by a BitSet. Here's how the code looked like: ">
<meta property="og:type" content="article">
<meta property="og:url" content="https://kinoshita.eti.br/2012/10/20/replacing-a-hashset-with-a-bitset.html"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2012-10-20T00:00:00+00:00">
<meta property="article:modified_time" content="2012-10-20T00:00:00+00:00">
<link rel=stylesheet type=text/css href=https://kinoshita.eti.br/sass/main.2429da8e5a84798d4406e4f3e3de2d7bfac6ef5d368b361aa61640e1c654f7c1.css integrity="sha256-JCnajlqEeY1EBuTz494te/rG7102izYaphZA4cZU98E=">
<title>kinow | Replacing a HashSet with a BitSet</title>
</head>
<body>
<header role=banner class=content>
<nav id=nav aria-label=Main role=navigation class=content>
<ul><li>
<a href=/><i data-feather=about></i> About</a>
</li><li>
<a href=/blog/><i data-feather=blog></i> Blog</a>
</li><li>
<a href=/portfolio/><i data-feather=portfolio></i> Portfolio</a>
</li>
</ul>
</nav>
</header>
<main>
<article class=content>
<h1>Replacing a HashSet with a BitSet</h1><div class=metadata>
<i data-feather=calendar></i>
<time datetime=2012-10-20>Oct 20, 2012</time>
</div>
<p>I always read the messages in the <a href=http://www.apache.org/foundation/mailinglists.html title="Apache mailing lists">Apache dev mailing lists</a>, including Apache Commons <a href=http://commons.apache.org/mail-lists.html title="Apache Commons mailing lists">dev mailing list</a>. And you should too. There are always interesting discussions. Sometimes you participate, other times you only watch what's happening, but in the end <strong>you always learn something new</strong>.</p>
<figure class=feature>
<img src=/assets/posts/2012-10-20-replacing-a-hashset-with-a-bitset/feather_small.gif alt title width height>
<figcaption></figcaption>
</figure>
<p>A few days ago, I found <a href=https://issues.apache.org/jira/browse/LANG-839 title=LANG-839>an issue</a> where it was being proposed to replace an unnecessary <a href=http://docs.oracle.com/javase/6/docs/api/java/util/HashSet.html title=HashSet>HashSet</a> in <a href=http://commons.apache.org/lang/api-release/org/apache/commons/lang3/ArrayUtils.html title=ArrayUtils>ArrayUtils</a>#removeElements() by a <a href=http://docs.oracle.com/javase/6/docs/api/java/util/BitSet.html title=BitSet>BitSet</a>. Here's how the code looked like: </p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>HashSet&lt;Integer&gt; toRemove = <span style=color:navy;font-weight:700>new</span> HashSet&lt;Integer&gt;();
<span style=color:navy;font-weight:700>for</span> (Map.<span style=color:red>Entry</span>&lt;Character, MutableInt&gt; e : occurrences.<span style=color:red>entrySet</span>()) {
    Character v = e.<span style=color:red>getKey</span>();
    <span style=color:navy;font-weight:700>int</span> found = 0;
    <span style=color:navy;font-weight:700>for</span> (<span style=color:navy;font-weight:700>int</span> i = 0, ct = e.<span style=color:red>getValue</span>().<span style=color:red>intValue</span>(); i &lt; ct; i++) {
        found = indexOf(array, v.<span style=color:red>charValue</span>(), found);
        <span style=color:navy;font-weight:700>if</span> (found &lt; 0) {
            <span style=color:navy;font-weight:700>break</span>;
        }
        toRemove.<span style=color:red>add</span>(found++);
    }
}
<span style=color:navy;font-weight:700>return</span> (<span style=color:navy;font-weight:700>char</span>[]) removeAll((Object)array, extractIndices(toRemove));
</code></pre></div><p>The HashSet created at line 1, in the code above, was used to store the array index of the elements that should be removed. And at line 13 there is a call to removeAll method, passing the indexes to be removed. And here's how the new code looks like: </p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>BitSet toRemove = <span style=color:navy;font-weight:700>new</span> BitSet();
<span style=color:navy;font-weight:700>for</span> (Map.<span style=color:red>Entry</span>&lt;Character, MutableInt&gt; e : occurrences.<span style=color:red>entrySet</span>()) {
    Character v = e.<span style=color:red>getKey</span>();
    <span style=color:navy;font-weight:700>int</span> found = 0;
    <span style=color:navy;font-weight:700>for</span> (<span style=color:navy;font-weight:700>int</span> i = 0, ct = e.<span style=color:red>getValue</span>().<span style=color:red>intValue</span>(); i &lt; ct; i++) {
        found = indexOf(array, v.<span style=color:red>charValue</span>(), found);
        <span style=color:navy;font-weight:700>if</span> (found &lt; 0) {
            <span style=color:navy;font-weight:700>break</span>;
        }
        toRemove.<span style=color:red>set</span>(found++);
    }
}
<span style=color:navy;font-weight:700>return</span> (<span style=color:navy;font-weight:700>char</span>[]) removeAll(array, toRemove);
</code></pre></div><p>The first difference is at line 1. Instead of a HashSet, it is now using a BitSet. And at line 10, instead of adding a new element to the HashSet, now it "sets" a bit in the set (the bit at the specified position is now true). But there are important changes at line 13. The method removeAll was changed, and now the array doesn't require a cast anymore. And the it is not necessary to cast the elements from HashSet anymore, as now the bit in the index position of the set is set to true. So the extractIndices method could be removed.</p>
<p>The code got simpler. But that's not all. At <a href=http://www.apache.org title="Apache Software Foundation">Apache Software Foundation</a> you can find a lot of talented developers - that's why I got so excited after joining them. Besides simplifying the code, the developer responsible for these changes (<strong>sebb</strong>) also pointed out that the new code <strong>consumes less memory and is faster</strong>. Ah! And he also wrote <strong>unit tests</strong>
<aside class=links>
<a class=previous href=https://kinoshita.eti.br/2012/10/16/adding-coverage-reports-in-jenkins-with-googletest-and-gcovr.html>&#171; Previous</a>
<a class=next href=https://kinoshita.eti.br/2012/10/25/a-quick-view-on-wordpress-mantis-and-jenkins-plug-in-api.html>Next &#187;</a>
</aside>
</article>
</main>
<footer role=contentinfo>
<ul id=social-media-icons>
<li>
<a href=https://www.instagram.com/brunokinoshita/>
<img src=/assets/icons/instagram.png alt="Instagram link">
</a>
</li>
<li>
<a href=https://twitter.com/kinow/>
<img src=/assets/icons/twitter.png alt="Twitter link">
</a>
</li>
<li>
<a href=https://github.com/kinow/>
<img src=/assets/icons/github.png alt="GitHub link">
</a>
</li>
<li>
<a href=/feed.xml>
<img src=/assets/icons/news.png alt="RSS feed link">
</a>
</li>
</ul>
</footer>
</body>
</html>