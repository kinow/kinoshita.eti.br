<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1" /><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Autosubmit Docker Cluster | kinow</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Autosubmit Docker Cluster" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Bruno Kinoshita “kinow” personal home page" />
<meta property="og:description" content="Bruno Kinoshita “kinow” personal home page" />
<link rel="canonical" href="https://kinoshita.eti.br/notes/autosubmit/docker-cluster.html" />
<meta property="og:url" content="https://kinoshita.eti.br/notes/autosubmit/docker-cluster.html" />
<meta property="og:site_name" content="kinow" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Autosubmit Docker Cluster" />
<script type="application/ld+json">
{"description":"Bruno Kinoshita “kinow” personal home page","@type":"WebPage","url":"https://kinoshita.eti.br/notes/autosubmit/docker-cluster.html","headline":"Autosubmit Docker Cluster","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/main.css" /><link type="application/atom+xml" rel="alternate" href="https://kinoshita.eti.br/feed.xml" title="kinow" /><link href="https://unpkg.com/pattern.css" rel="stylesheet" />

</head>
<body>
<div id="mobile-menu"><div class="menu">
  <ul class="menu">
    <li class="item">
      <h1 id="kinow">KINOW</h1>
    </li>
    <li class="item">
      <a href="/" class="">About</a>
    </li>
    <li class="item">
      <a href="/blog/" class="">Blog</a>
    </li>
    <li class="item">
      <a href="/portfolio/" class="">Portfolio</a>
    </li>
    <li class="item social-media-item">
      <a href="https://www.instagram.com/brunokinoshita/" class="inline-link">
        <img src="/assets/icons/instagram.png" class="inverted-image"  alt="Instagram link" />
      </a>
      <a href="https://twitter.com/kinow/" class="inline-link">
        <img src="/assets/icons/twitter.png" class="inverted-image" alt="Twitter link" />
      </a>
      <a href="https://github.com/kinow/" class="inline-link">
        <img src="/assets/icons/github.png" class="inverted-image" alt="GitHub link" />
      </a>
    </li>
  </ul>
</div>
</div>
<div id="wrapper">
  <div id="sidebar"><div class="menu">
  <ul class="menu">
    <li class="item">
      <h1 id="kinow">KINOW</h1>
    </li>
    <li class="item">
      <a href="/" class="">About</a>
    </li>
    <li class="item">
      <a href="/blog/" class="">Blog</a>
    </li>
    <li class="item">
      <a href="/portfolio/" class="">Portfolio</a>
    </li>
    <li class="item social-media-item">
      <a href="https://www.instagram.com/brunokinoshita/" class="inline-link">
        <img src="/assets/icons/instagram.png" class="inverted-image"  alt="Instagram link" />
      </a>
      <a href="https://twitter.com/kinow/" class="inline-link">
        <img src="/assets/icons/twitter.png" class="inverted-image" alt="Twitter link" />
      </a>
      <a href="https://github.com/kinow/" class="inline-link">
        <img src="/assets/icons/github.png" class="inverted-image" alt="GitHub link" />
      </a>
    </li>
  </ul>
</div>
</div>
  <div id="content">
    <article class="post">
  <h1 class="ui header" id="top">Autosubmit Docker Cluster</h1><ul>
  <li><a href="#autosubmit-docker-cluster">Autosubmit Docker Cluster</a>
    <ul>
      <li><a href="#host-prerequisites">Host prerequisites</a></li>
      <li><a href="#autosubmit-container">Autosubmit container</a></li>
      <li><a href="#ssh-worker">SSH worker</a></li>
      <li><a href="#docker-compose-cluster">Docker Compose cluster</a></li>
      <li><a href="#running-the-cluster">Running the cluster</a></li>
    </ul>
  </li>
</ul>

  <h1 id="autosubmit-docker-cluster">Autosubmit Docker Cluster</h1>

<p>All the files and directories created must be placed in the same base directory.</p>

<pre><code class="language-mermaid">graph TD;
Host--Docker--&gt;autosubmit;
Host -.- Docker/SSH -.-&gt;worker;
autosubmit--SSH--&gt;worker;
</code></pre>

<p>Workflows will be run from both the Host node and from the Autosubmit node.
The platform <code class="language-plaintext highlighter-rouge">local</code> will be configured to use the <code class="language-plaintext highlighter-rouge">worker</code> node via SSH.
The dotted line in the graph above shows that it is optional to interact with
Autosubmit from the host node (i.e. it could be a Windows machine without
Autosubmit, connected to the <code class="language-plaintext highlighter-rouge">autosubmit</code> container running workflows using
the cluster).</p>

<h2 id="host-prerequisites">Host prerequisites</h2>

<pre><code class="language-mermaid">graph TD;
Host;
</code></pre>

<ol>
  <li>A host computer with Docker (e.g. Ubuntu Linux LTS, Docker version 20.10.18, build b40c2f6;</li>
  <li><code class="language-plaintext highlighter-rouge">docker-compose</code> (e.g. docker-compose version 1.23.1, build b02f1306);</li>
  <li>Autosubmit pre-installed in the host computer (not a strong requirement, as you could use
the <code class="language-plaintext highlighter-rouge">autosubmit</code> container exclusively, but it tests more of the system that way; must be the
same version as in the rest of the cluster, e.g. v3.14.0);</li>
  <li>Autosubmit configured correctly (i.e. <code class="language-plaintext highlighter-rouge">configure</code> and <code class="language-plaintext highlighter-rouge">install</code> executed);</li>
  <li>An Autosubmit workflow created (e.g. <code class="language-plaintext highlighter-rouge">autosubmit expid -H local -d "Docker example"</code>, we
assume the workflow created is called “<code class="language-plaintext highlighter-rouge">a000</code>”, change it if needed);</li>
  <li>The workflow must have its platform correctly set up for the Docker example (more below).</li>
</ol>

<p><em><code class="language-plaintext highlighter-rouge">platforms_a000.conf</code></em></p>

<div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[local]</span>
<span class="py">TYPE</span> <span class="p">=</span> <span class="s">ps</span>
<span class="py">HOST</span> <span class="p">=</span> <span class="s">worker</span>
<span class="py">USER</span> <span class="p">=</span> <span class="s">autosubmit</span>
<span class="py">PROJECT</span> <span class="p">=</span> <span class="s">test</span>
<span class="py">TEMP_DIR</span> <span class="p">=</span> <span class="s">/tmp</span>
<span class="py">SCRATCH_DIR</span> <span class="p">=</span> <span class="s">/tmp</span>
</code></pre></div></div>

<h2 id="autosubmit-container">Autosubmit container</h2>

<pre><code class="language-mermaid">graph TD;
autosubmit;
</code></pre>

<p>This container will be called <code class="language-plaintext highlighter-rouge">autosubmit</code> and contains the <code class="language-plaintext highlighter-rouge">autosubmit</code> command.
It is the equivalent to a virtual machine with Autosubmit used to submit workflows.</p>

<p>The <code class="language-plaintext highlighter-rouge">Dockerfile</code> for Autosubmit, based on Airflow (thanks!). This file can be saved
somewhere, like <code class="language-plaintext highlighter-rouge">autosubmit/docker/</code> (i.e. inside the Autosubmit checked out source
code). If saved in a non-empty directory, remember to keep the context to a minimum
(i.e. use a <code class="language-plaintext highlighter-rouge">.dockerignore</code> file for security and performance):</p>

<p><em><code class="language-plaintext highlighter-rouge">Dockerfile</code></em></p>

<details>
<summary>Click to expand</summary>

```docker
# syntax=docker/dockerfile:1.4
#
# Copyright (C) 2022
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.

# Used bits of old images written, as well as the airflow (Apache License 2) production
# Docker image. Credits to the Airflow team.
# Note that ALv2 and GPLv3 are compatible for this case:
# https://www.apache.org/licenses/GPL-compatibility.html
# Also giving back to Airflow; little but hopefully shows some appreciation
# for their work: https://github.com/apache/airflow/pull/24397 :^)

# Note: Always review if they changed anything in the Docker best practices document;
#       https://docs.docker.com/develop/develop-images/dockerfile_best-practices/

ARG AUTOSUBMIT_USER=autosubmit
ARG AUTOSUBMIT_USER_HOME_DIR=/home/autosubmit
ARG AUTOSUBMIT_BRANCH=master
ARG AUTOSUBMIT_GIT_REPOSITORY=https://earth.bsc.es/gitlab/es/autosubmit.git
ARG AUTOSUBMIT_UID=2000
ARG AUTOSUBMIT_GID=2000

ARG PYTHON_BASE_IMAGE="python:2.7.18-slim-buster"

##############################################################################################
# Base image. We can create scripts and other requirements in this base image.
##############################################################################################

FROM scratch as base-image

##############################################################################################
# Autosubmit build image. This will be larger, our workbench to create the container.
# We will discard most of the content here, keeping only the necessary for autosubmit
# in another layer.
##############################################################################################

FROM ${PYTHON_BASE_IMAGE} as autosubmit-build-image

ARG AUTOSUBMIT_USER_HOME_DIR
ARG AUTOSUBMIT_GIT_REPOSITORY
ARG AUTOSUBMIT_BRANCH
ARG AUTOSUBMIT_UID
ARG AUTOSUBMIT_GID

ARG PYTHON_BASE_IMAGE
ENV PYTHON_BASE_IMAGE=${PYTHON_BASE_IMAGE} \
    DEBIAN_FRONTEND=noninteractive LANGUAGE=C.UTF-8 LANG=C.UTF-8 LC_ALL=C.UTF-8 \
    LC_CTYPE=C.UTF-8 LC_MESSAGES=C.UTF-8

ARG DEV_APT_DEPS="\
  apt-transport-https \
  apt-utils \
  git"

# Copy anything from the base image
# e.g. COPY --from=base-image setup.sh /opt/.../

ENV DEV_APT_DEPS=${DEV_APT_DEPS}

# System dependencies layer
RUN apt-get update &amp;&amp; \
    apt-get install -y --no-install-recommends \
      ${DEV_APT_DEPS} &amp;&amp; \
    apt-get autoremove -yqq --purge &amp;&amp; \
    apt-get clean &amp;&amp; \
    rm -rf /var/lib/apt/lists/*

# Container user
RUN groupadd -g "${AUTOSUBMIT_GID}" autosubmit &amp;&amp; \
    adduser --gecos "First Last,RoomNumber,WorkPhone,HomePhone" --disabled-password \
      --quiet "autosubmit" --uid "${AUTOSUBMIT_UID}" --gid "${AUTOSUBMIT_GID}" --home "${AUTOSUBMIT_USER_HOME_DIR}" &amp;&amp; \
    mkdir -pv "${AUTOSUBMIT_USER_HOME_DIR}" &amp;&amp; \
    chown -R "autosubmit:autosubmit" "${AUTOSUBMIT_USER_HOME_DIR}" &amp;&amp; \
    chmod -R g+rw "${AUTOSUBMIT_USER_HOME_DIR}"

USER autosubmit
WORKDIR ${AUTOSUBMIT_USER_HOME_DIR}

# Autosubmit layer
# TODO: requests is a transitive dependency, but apparently not listed in Autosubmit's
#       install_requires dependencies list.
RUN pip install --no-cache-dir --user --upgrade pip &amp;&amp; \
    pip install --no-cache-dir --user requests &amp;&amp; \
    pip install --no-cache-dir --user git+${AUTOSUBMIT_GIT_REPOSITORY}@${AUTOSUBMIT_BRANCH}

# At this point, autosubmit must be installed and available from ~/.local/site-packages/...

##############################################################################################
# Actual Autosubmit image, much smaller than the build image.
##############################################################################################

FROM ${PYTHON_BASE_IMAGE} as main

# TODO: update labels later...
LABEL maintainer="Bruno P. Kinoshita"

ARG AUTOSUBMIT_USER_HOME_DIR
ARG AUTOSUBMIT_BRANCH
ARG AUTOSUBMIT_UID
ARG AUTOSUBMIT_GID
ARG PYTHON_BASE_IMAGE

ENV PYTHON_BASE_IMAGE=${PYTHON_BASE_IMAGE} \
    DEBIAN_FRONTEND=noninteractive LANGUAGE=C.UTF-8 LANG=C.UTF-8 LC_ALL=C.UTF-8 \
    LC_CTYPE=C.UTF-8 LC_MESSAGES=C.UTF-8

RUN apt-get update &amp;&amp; \
    apt-get install -y --no-install-recommends \
      git \
      graphviz \
      ssh \
      sqlite3 &amp;&amp; \
    apt-get autoremove -yqq --purge &amp;&amp; \
    apt-get clean &amp;&amp; \
    rm -rf /var/lib/apt/lists/*

ENV PATH="${AUTOSUBMIT_USER_HOME_DIR}/.local/bin:${PATH}" \
    AUTOSUBMIT_UID=${AUTOSUBMIT_UID} \
    AUTOSUBMIT_GID=${AUTOSUBMIT_GID} \
    AUTOSUBMIT_USER_HOME_DIR=${AUTOSUBMIT_USER_HOME_DIR} \
    AUTOSUBMIT_BRANCH=${AUTOSUBMIT_BRANCH}

# Container user
RUN groupadd -g "${AUTOSUBMIT_GID}" autosubmit &amp;&amp; \
    adduser --gecos "First Last,RoomNumber,WorkPhone,HomePhone" --disabled-password \
      --quiet "autosubmit" --uid "${AUTOSUBMIT_UID}" --gid "${AUTOSUBMIT_GID}" --home "${AUTOSUBMIT_USER_HOME_DIR}" &amp;&amp; \
    mkdir -pv "${AUTOSUBMIT_USER_HOME_DIR}" &amp;&amp; \
    mkdir -pv "${AUTOSUBMIT_USER_HOME_DIR}/autosubmit" &amp;&amp; \
    chown -R "autosubmit:autosubmit" "${AUTOSUBMIT_USER_HOME_DIR}" &amp;&amp; \
    chmod -R g+rw "${AUTOSUBMIT_USER_HOME_DIR}" &amp;&amp; \
    find "${AUTOSUBMIT_USER_HOME_DIR}" -executable -print0 | xargs --null chmod g+x

COPY --from=autosubmit-build-image --chown=autosubmit:autosubmit \
     "${AUTOSUBMIT_USER_HOME_DIR}/.local" "${AUTOSUBMIT_USER_HOME_DIR}/.local"

ENTRYPOINT ["autosubmit"]
```
</details>

<p>The Docker <code class="language-plaintext highlighter-rouge">autosubmit</code> container will need its own <code class="language-plaintext highlighter-rouge">.autosubmitrc</code> file, as that RC
file specifies file locations that vary for each server:</p>

<p><em><code class="language-plaintext highlighter-rouge">.autosubmitrc</code></em></p>

<pre><code class="language-rc">[database]
path = /home/autosubmit/autosubmit
filename = autosubmit.db

[local]
path = /home/autosubmit/autosubmit

[globallogs]
path = /home/autosubmit/autosubmit/logs

[structures]
path = /home/autosubmit/autosubmit/metadata/structures

[historicdb]
path = /home/autosubmit/autosubmit/metadata/data

[historiclog]
path = /home/autosubmit/autosubmit/metadata/logs

[autosubmitapi]
url = http://127.0.0.1:8081 # Replace me?
</code></pre>

<h2 id="ssh-worker">SSH worker</h2>

<pre><code class="language-mermaid">graph TD;
worker;
</code></pre>

<p>This is a worker node. It is an Alpine based Linux that comes with SSH
and is very customizable. In real life this worker node would have a
batch system like Slurm installed, or contain GPU’s, or the utilities
used by the tools executed in the Autosubmit workflow.</p>

<p>A Linux Server OpenSSH <a href="https://github.com/linuxserver/docker-openssh-server">docker image</a>.
The image by default uses port <code class="language-plaintext highlighter-rouge">2222</code>, which is an issue as Autosubmit
only supports the port <code class="language-plaintext highlighter-rouge">22</code> for all the Paramiko based platforms. We
can bypass it by customizing the initialization of the OpenSSH (instead
of doing something more complex like port-forwarding).</p>

<p>Create the file <code class="language-plaintext highlighter-rouge">./custom-cont-init.d/custom-port.sh</code>. The Linux Server
maintainers create images that load scripts in the <code class="language-plaintext highlighter-rouge">/custom-cont-init.d/</code>
folder. We will create a volume to bind our <code class="language-plaintext highlighter-rouge">custom-port.sh</code> to that
location later:</p>

<p><em><code class="language-plaintext highlighter-rouge">./custom-cont-init.d/custom-port.sh</code></em></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="c"># Replace 22 with your custom port</span>
<span class="nb">sed</span> <span class="nt">-i</span> <span class="nt">-e</span> <span class="s1">'s/^USER_NAME=.*/USER_NAME=root/'</span> <span class="nt">-e</span> <span class="s1">'s/2222$/22/'</span> /etc/services.d/openssh-server/run

<span class="c"># Source: https://github.com/linuxserver/docker-openssh-server/issues/30</span>
</code></pre></div></div>

<p>We also need to create the directory used for the workflow platform. We can create
another file inside <code class="language-plaintext highlighter-rouge">./custom-cont-ini.d</code> for that:</p>

<p><em><code class="language-plaintext highlighter-rouge">./custom-cont-init.d/autosubmit-remote-init.sh</code></em></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="c"># Every remote worker needs to have the project folder created.</span>
<span class="c"># /tmp/ is the SCRATCH_DIR; test is the PROJECT; autosubmit is the USER.</span>
<span class="nb">mkdir</span> <span class="nt">-pv</span> /tmp/test/autosubmit/
<span class="nb">chown</span> <span class="nt">-R</span> autosubmit: /tmp/test/
</code></pre></div></div>

<h2 id="docker-compose-cluster">Docker Compose cluster</h2>

<p>This cluster uses the Linux Server OpenSSH worker node, and a container for Autosubmit.
Note that both containers <strong>were created to be as ephemeral as possible</strong>. This means that
they are not supposed to retain state, data, or any tools of importance, and can be
destroyed and replaced by new containers at any time (which is useful for cloud environments
like AWS, OpenStack, Kubernetes, etc.).</p>

<blockquote>
  <p><strong>NOTE</strong>: The whole cluster runs without <code class="language-plaintext highlighter-rouge">root</code> users and without using <code class="language-plaintext highlighter-rouge">sudo</code>, another
Docker best practice. It also helps to migrate it to Singularity, charliecloud, etc.</p>
</blockquote>

<p>The <code class="language-plaintext highlighter-rouge">docker-compose.yml</code> file below can be used without any <a href="https://docs.docker.com/compose/extends/">override files</a>
(which can be used, if needed). And it also does not uses <a href="https://docs.docker.com/compose/compose-file/deploy/">replicas</a>
(another possibility, if needed):</p>

<p><em><code class="language-plaintext highlighter-rouge">docker-compose.yml</code></em></p>

<details>
<summary>Click to expand</summary>

```yaml
version: "3.7"
# Autosubmit example cluster.
services:
  # A worker node.
  worker:
    image: lscr.io/linuxserver/openssh-server:latest
    container_name: worker
    hostname: worker
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=UTC
      # - PUBLIC_KEY=yourpublickey #optional
      # - PUBLIC_KEY_FILE=/path/to/file #optional
      # - PUBLIC_KEY_DIR=/path/to/directory/containing/_only_/pubkeys #optional
      # This is pulling my SSH keys from GitHub, just to make sure it never accesses
      # my local files in the container. The linuxserver image offers other
      # alternatives for fetching the SSH key.
      - PUBLIC_KEY_URL=https://github.com/kinow.keys #optional
      - SUDO_ACCESS=false #optional
      - PASSWORD_ACCESS=false #optional
      # - USER_PASSWORD=password #optional
      # - USER_PASSWORD_FILE=/path/to/file #optional
      - USER_NAME=autosubmit #optional
    volumes:
      - type: bind
        source: ./custom-cont-init.d
        target: /custom-cont-init.d
        read_only: true
    ports:
      - "2222:2222"
    restart: unless-stopped
  # Autosubmit server to submit experiments.
  autosubmit:
    container_name: autosubmit
    hostname: autosubmit
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - AUTOSUBMIT_UID=1000
        - AUTOSUBMIT_GID=1000
        - AUTOSUBMIT_BRANCH=v3.14.0
    user: autosubmit
    # Just to keep the container running.
    entrypoint: "tail -f /dev/null"
    # N.B.: The autosubmit container can operate in isolation.
    # ports:
    depends_on:
      - worker
    # Here we define the SSH socket agent location.
    environment:
      - SSH_AUTH_SOCK=/ssh-agent
    volumes:
      # The .autosubmitrc configuration file, indicating where location
      # of files such as the SQLite database file.
      - type: bind
        source: ./.autosubmitrc
        target: /home/autosubmit/.autosubmitrc
        read_only: true
      # The directory that holds the Autosubmit experiments.
      - type: bind
        source: ${HOME}/autosubmit
        target: /home/autosubmit/autosubmit
        read_only: false
      # The SSH agent file, from the host. This prevents copying secrets like SSH keys inside the container.
      # e.g. https://dille.name/slides/2020-01-22/110_ecosystem/ssh_forwarding/slides.final/
      - type: bind
        source: ${SSH_AUTH_SOCK}
        target: /ssh-agent
        read_only: true
    restart: unless-stopped
```
</details>

<p>There are two services defined in this Docker Compose file. One for Autosubmit,
using the <code class="language-plaintext highlighter-rouge">Dockerfile</code>. That container can be used as a permanent VM/container
to submit jobs (although users can also submit jobs locally directly to workers).</p>

<p>It uses a <code class="language-plaintext highlighter-rouge">tail -f /dev/null</code> entrypoint so that Docker Composer sees the container
as a permanent daemon (otherwise <code class="language-plaintext highlighter-rouge">autosubmit</code> default entrypoint would exit
immediately).</p>

<p>The other service is the Worker node, that is configured via environment variables
to fetch a public SSH key from GitHub (there are other ways to add the <strong>public</strong>
SSH key to the container) and configure it for the cluster.</p>

<h2 id="running-the-cluster">Running the cluster</h2>

<p>Here’s a preview of what your directory structure must look like:</p>

<ol>
  <li>First the Host computer with the experiment created, and the platform configured:</li>
</ol>

<p><img src="https://user-images.githubusercontent.com/304786/193985919-c69bf9bf-4d13-4422-be38-189f25e7c210.png" alt="image" /></p>

<ol>
  <li>The cluster configuration files, created inside the Git project of Autosubmit (can be created anywhere actually):</li>
</ol>

<p><img src="https://user-images.githubusercontent.com/304786/193986080-c9598944-9056-408f-bcfe-35f8f1e79469.png" alt="image" /></p>

<ol>
  <li>Both host and cluster running the same version of Autosubmit:</li>
</ol>

<p><img src="https://user-images.githubusercontent.com/304786/193986274-be744526-8076-40ff-9a05-fadbdd12a408.png" alt="image" /></p>

<p>To start the cluster, open one terminal and execute:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker-compose up
<span class="nv">$ </span><span class="c"># you can optionally use -d to run it as a daemon</span>
</code></pre></div></div>

<p>That should start the Autosubmit and the OpenSSH containers. You will have to upgrade
Paramiko due to an issue with an old version of Paramiko imported by Autosubmit
when using SSH agents.</p>

<p><img src="https://user-images.githubusercontent.com/304786/193986741-5b48e0d0-ed18-41e8-828e-e593891e08f2.png" alt="image" /></p>

<p>With the cluster running, you can confirm the two containers/services are up with
<code class="language-plaintext highlighter-rouge">docker-compose ps</code>. Then run the following commands to start a terminal in the
<code class="language-plaintext highlighter-rouge">autosubmit</code> container and to upgrade Paramiko.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker-compose <span class="nb">exec </span>autosubmit /bin/bash
autosubmit@autosubmit:/<span class="nv">$ </span>pip <span class="nb">install </span><span class="nv">paramiko</span><span class="o">==</span>2.11.0
autosubmit@autosubmit:/<span class="nv">$ </span><span class="nb">sed</span> <span class="nt">-i</span> <span class="nt">-e</span> <span class="s1">'s/paramiko.*$/paramiko/'</span> /home/autosubmit/.local/lib/python2.7/site-packages/autosubmit-3.14.0.dist-info/METADATA 
</code></pre></div></div>

<p>As you are already running a terminal inside the <code class="language-plaintext highlighter-rouge">autosubmit</code> node,
now try describing the workflow.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>autosubmit@autosubmit:/<span class="nv">$ </span>autosubmit describe a000
/home/autosubmit/.local/lib/python2.7/site-packages/paramiko/transport.py:33: CryptographyDeprecationWarning: Python 2 is no longer supported by the Python core team. Support <span class="k">for </span>it is now deprecated <span class="k">in </span>cryptography, and will be removed <span class="k">in </span>the next release.
  from cryptography.hazmat.backends import default_backend
<span class="nb">id</span>: ‘eadmin’: no such user
Autosubmit is running with 3.14.0
Describing a000

Checking configuration files...
expdef_a000.conf OK
platforms_a000.conf OK
jobs_a000.conf OK
wrappers OK
autosubmit_a000.conf OK
Configuration files OK

Owner: autosubmit
Created: 2022-10-05 01:48:27.571154
Model: Not Found
Branch: Not Found
HPC: <span class="nb">local</span>
</code></pre></div></div>

<p>If you run the same command in your Host node (i.e. in your laptop or computer)
you should get the same output. Now run the workflow from inside the Docker container.</p>

<p>That should start the workflow that by default has each task running a <code class="language-plaintext highlighter-rouge">sleep 5</code>
command. While the workflow is running, you can monitor it from your Host,
for instance:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>autosubmit monitor a000
</code></pre></div></div>

<p><img src="https://user-images.githubusercontent.com/304786/193987635-bc70cfc8-9ec6-47cd-9acb-4d70939ba9de.png" alt="image" /></p>

<p>TODO: Use an X server in the Autosubmit container so <code class="language-plaintext highlighter-rouge">monitor</code> works with plots inside the container</p>

</article>

  </div>
</div>
</body>
</html>
