<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta property="og:title" content="Cyclic Workflows with Prefect">
<meta property="og:description" content="
  




  
  





Last month I wrote about
Cyclic Workflows with Cylc and StackStorm
and how few workflow managers support cyclic workflows.
I was surprised today while reading Prefect documentation to see this paragraph:

Most workflow frameworks act as if looping is impossible (stressing the Acyclic part of the DAG),
but it&rsquo;s actually trivial to implement. We simply dynamically unroll the loop, similar to how RNN
gradients are sometimes computed.
">
<meta property="og:type" content="article">
<meta property="og:url" content="https://kinoshita.eti.br/2021/11/08/cyclic-workflows-with-prefect.html"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-11-08T00:00:00+00:00">
<meta property="article:modified_time" content="2021-11-08T00:00:00+00:00">
<link rel=stylesheet type=text/css href=https://kinoshita.eti.br/sass/main.09b56b6037e962b67cf7a7701bf2a9ee5da840a4f74b74139c4731f2156a5917.css integrity="sha256-CbVrYDfpYrZ896dwG/Kp7l2oQKT3S3QTnEcx8hVqWRc=">
<title>kinow | Cyclic Workflows with Prefect</title>
</head>
<body>
<header role=banner class=content>
<nav id=nav aria-label=Main role=navigation class=content>
<ul><li>
<a href=/><i data-feather=about></i> About</a>
</li><li>
<a href=/blog/><i data-feather=blog></i> Blog</a>
</li><li>
<a href=/portfolio/><i data-feather=portfolio></i> Portfolio</a>
</li>
</ul>
</nav>
</header>
<main>
<article class=content>
<h1>Cyclic Workflows with Prefect</h1><div class=metadata>
<i data-feather=calendar></i>
<time datetime=2021-11-08>Nov 8, 2021</time>
</div>
<aside>
<nav id=TableOfContents></nav>
</aside>
<div style="width:50%;margin:0 auto">
<figure class=feature>
<img src=/assets/posts/2021-11-08-cyclic-workflows-with-prefect/prefect.svg alt="Prefect logo" title="Prefect logo" width height>
<figcaption></figcaption>
</figure>
</div>
<p>Last month I wrote about
<a href=/2021/10/01/cyclic-workflows-with-cylc-and-stackstorm.html>Cyclic Workflows with Cylc and StackStorm</a>
and how few workflow managers support cyclic workflows.</p>
<p>I was surprised today while reading Prefect documentation to see this paragraph:</p>
<blockquote>
<p>Most workflow frameworks act as if looping is impossible (stressing the Acyclic part of the DAG),
but it&rsquo;s actually trivial to implement. We simply dynamically unroll the loop, similar to how RNN
gradients are sometimes computed.</p>
</blockquote>
<figure class=feature>
<img src=/assets/posts/2021-11-08-cyclic-workflows-with-prefect/Example-of-Unrolled-RNN-on-the-forward-pass.png alt="Example of Unrolled RNN on the forward-pass (image from https://machinelearningmastery.com/rnn-unrolling/)" title="Example of Unrolled RNN on the forward-pass (image from https://machinelearningmastery.com/rnn-unrolling/)" width height>
<figcaption>Image source: <a href=https://machinelearningmastery.com/rnn-unrolling/>A Gentle Introduction to RNN Unrolling</a></figcaption>
</figure>
<p>The API for cyclic workflows of Prefect appears to be limited when compared with Cylc and
StackStorm, but they have a lot of integrations, and good documentation.</p>
<p>I had to re-work the example from the previous post a bit, as using <code>prep</code> as entry point
resulted in <code>prep</code> present in every cycle. Their dependency and constraints algorithm is
probably re-executing the whole cycle, or there may be another way to have optional tasks
that I couldn&rsquo;t find.</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#177500>#!/bin/bash</span>
<span style=color:#177500># file: workflow.py</span>
<span style=color:#a90d91>import</span> <span style=color:#000>prefect</span>
<span style=color:#a90d91>from</span> <span style=color:#000>prefect</span> <span style=color:#a90d91>import</span> <span style=color:#000>task</span>, <span style=color:#000>Flow</span>
<span style=color:#a90d91>from</span> <span style=color:#000>prefect.engine.signals</span> <span style=color:#a90d91>import</span> <span style=color:#000>LOOP</span>
<span style=color:#a90d91>import</span> <span style=color:#000>time</span>

<span style=color:#000>INTERVAL</span><span style=color:#000>=</span><span style=color:#1c01ce>1</span>


<span style=color:#000>@task</span>
<span style=color:#a90d91>def</span> <span style=color:#000>prep</span>():
    <span style=color:#000>cycle</span> <span style=color:#000>=</span> <span style=color:#000>prefect</span><span style=color:#000>.</span><span style=color:#000>context</span><span style=color:#000>.</span><span style=color:#000>get</span>(<span style=color:#c41a16>&#34;task_loop_count&#34;</span>, <span style=color:#1c01ce>1</span>)
    <span style=color:#000>logger</span> <span style=color:#000>=</span> <span style=color:#000>prefect</span><span style=color:#000>.</span><span style=color:#000>context</span><span style=color:#000>.</span><span style=color:#000>get</span>(<span style=color:#c41a16>&#34;logger&#34;</span>)
    <span style=color:#000>time</span><span style=color:#000>.</span><span style=color:#000>sleep</span>(<span style=color:#000>INTERVAL</span>)
    <span style=color:#000>logger</span><span style=color:#000>.</span><span style=color:#000>info</span>(<span style=color:#c41a16>f</span><span style=color:#c41a16>&#34;prep.</span><span style=color:#c41a16>{</span><span style=color:#000>cycle</span><span style=color:#c41a16>}</span><span style=color:#c41a16> says hi!&#34;</span>)

<span style=color:#000>@task</span>
<span style=color:#a90d91>def</span> <span style=color:#000>foo</span>():
    <span style=color:#000>cycle</span> <span style=color:#000>=</span> <span style=color:#000>prefect</span><span style=color:#000>.</span><span style=color:#000>context</span><span style=color:#000>.</span><span style=color:#000>get</span>(<span style=color:#c41a16>&#34;task_loop_count&#34;</span>, <span style=color:#1c01ce>1</span>)
    <span style=color:#a90d91>if</span> <span style=color:#000>cycle</span> <span style=color:#000>==</span> <span style=color:#1c01ce>1</span>:
        <span style=color:#000>prep</span><span style=color:#000>.</span><span style=color:#000>run</span>()
    <span style=color:#000>logger</span> <span style=color:#000>=</span> <span style=color:#000>prefect</span><span style=color:#000>.</span><span style=color:#000>context</span><span style=color:#000>.</span><span style=color:#000>get</span>(<span style=color:#c41a16>&#34;logger&#34;</span>)
    <span style=color:#000>time</span><span style=color:#000>.</span><span style=color:#000>sleep</span>(<span style=color:#000>INTERVAL</span>)
    <span style=color:#000>logger</span><span style=color:#000>.</span><span style=color:#000>info</span>(<span style=color:#c41a16>f</span><span style=color:#c41a16>&#34;foo.</span><span style=color:#c41a16>{</span><span style=color:#000>cycle</span><span style=color:#c41a16>}</span><span style=color:#c41a16> says hi!&#34;</span>)
    <span style=color:#000>bar</span><span style=color:#000>.</span><span style=color:#000>run</span>()
    <span style=color:#a90d91>raise</span> <span style=color:#000>LOOP</span>()

<span style=color:#000>@task</span>
<span style=color:#a90d91>def</span> <span style=color:#000>bar</span>():
    <span style=color:#000>cycle</span> <span style=color:#000>=</span> <span style=color:#000>prefect</span><span style=color:#000>.</span><span style=color:#000>context</span><span style=color:#000>.</span><span style=color:#000>get</span>(<span style=color:#c41a16>&#34;task_loop_count&#34;</span>, <span style=color:#1c01ce>1</span>)
    <span style=color:#000>logger</span> <span style=color:#000>=</span> <span style=color:#000>prefect</span><span style=color:#000>.</span><span style=color:#000>context</span><span style=color:#000>.</span><span style=color:#000>get</span>(<span style=color:#c41a16>&#34;logger&#34;</span>)
    <span style=color:#000>time</span><span style=color:#000>.</span><span style=color:#000>sleep</span>(<span style=color:#000>INTERVAL</span>)
    <span style=color:#000>logger</span><span style=color:#000>.</span><span style=color:#000>info</span>(<span style=color:#c41a16>f</span><span style=color:#c41a16>&#34;bar.</span><span style=color:#c41a16>{</span><span style=color:#000>cycle</span><span style=color:#c41a16>}</span><span style=color:#c41a16> says hi!&#34;</span>)


<span style=color:#a90d91>with</span> <span style=color:#000>Flow</span>(<span style=color:#c41a16>&#34;hello-flow&#34;</span>) <span style=color:#a90d91>as</span> <span style=color:#000>flow</span>:
    <span style=color:#000>foo</span>()

<span style=color:#000>flow</span><span style=color:#000>.</span><span style=color:#000>run</span>()
<span style=color:#177500>#flow.visualize() # need to pip install prefect[&#39;viz&#39;]</span>
</code></pre></div><p>Running the workflow is really simple (simpler than both
Cylc and StackStorm): <code>python workflow.py</code></p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#000>(</span>venv<span style=color:#000>)</span> kinow@ranma:/tmp$ python workflow.py 
<span style=color:#000>[</span>2021-11-08 21:37:20+1300<span style=color:#000>]</span> INFO - prefect.FlowRunner | Beginning Flow run <span style=color:#a90d91>for</span> <span style=color:#c41a16>&#39;hello-flow&#39;</span>
<span style=color:#000>[</span>2021-11-08 21:37:20+1300<span style=color:#000>]</span> INFO - prefect.TaskRunner | Task <span style=color:#c41a16>&#39;foo&#39;</span>: Starting task run...
<span style=color:#000>[</span>2021-11-08 21:37:21+1300<span style=color:#000>]</span> INFO - prefect.foo | prep.1 says hi!
<span style=color:#000>[</span>2021-11-08 21:37:22+1300<span style=color:#000>]</span> INFO - prefect.foo | foo.1 says hi!
<span style=color:#000>[</span>2021-11-08 21:37:23+1300<span style=color:#000>]</span> INFO - prefect.foo | bar.1 says hi!
<span style=color:#000>[</span>2021-11-08 21:37:24+1300<span style=color:#000>]</span> INFO - prefect.foo | foo.2 says hi!
<span style=color:#000>[</span>2021-11-08 21:37:25+1300<span style=color:#000>]</span> INFO - prefect.foo | bar.2 says hi!
<span style=color:#000>[</span>2021-11-08 21:37:26+1300<span style=color:#000>]</span> INFO - prefect.foo | foo.3 says hi!
<span style=color:#000>[</span>2021-11-08 21:37:27+1300<span style=color:#000>]</span> INFO - prefect.foo | bar.3 says hi!
<span style=color:#000>[</span>2021-11-08 21:37:28+1300<span style=color:#000>]</span> INFO - prefect.foo | foo.4 says hi!
<span style=color:#000>[</span>2021-11-08 21:37:29+1300<span style=color:#000>]</span> INFO - prefect.foo | bar.4 says hi!
...
</code></pre></div><p>I had seen the RNN graph unrolling algorithm mentioned in their documentation
while working on <a href=https://github.com/kinow/decyclify>decyclify</a>. I believe more
workflow managers will start supporting cyclic workflows soon. It adds some
complexity to the code, but so does add dependency management, good logging,
configuration, distributed execution, and so on.</p>
<figure class=feature>
<img src=/assets/posts/2021-11-08-cyclic-workflows-with-prefect/graph-unroll.png alt="Decyclify algorithm (image from https://github.com/kinow/decyclify)" title="Decyclify algorithm (image from https://github.com/kinow/decyclify)" width height>
<figcaption></figcaption>
</figure>
<p>I am not sure if the way I linked tasks is following best practices for Prefect. There
may be better ways so that Prefect can handle restarting workflows, for instance. But
if you want to run cyclic workflows, now you have —at least— three options.</p>
<aside class=links>
<a class=previous href=https://kinoshita.eti.br/2021/10/22/removing-invisible-unread-github-notifications.html>&#171; Previous</a>
<a class=next href=https://kinoshita.eti.br/2022/10/26/r/functionalprogramming-turned-10.html>Next &#187;</a>
</aside>
</article>
</main>
<footer role=contentinfo>
<ul id=social-media-icons>
<li>
<a href=https://www.instagram.com/brunokinoshita/>
<img src=/assets/icons/instagram.png alt="Instagram link">
</a>
</li>
<li>
<a href=https://twitter.com/kinow/>
<img src=/assets/icons/twitter.png alt="Twitter link">
</a>
</li>
<li>
<a href=https://github.com/kinow/>
<img src=/assets/icons/github.png alt="GitHub link">
</a>
</li>
<li>
<a href=/feed.xml>
<img src=/assets/icons/news.png alt="RSS feed link">
</a>
</li>
</ul>
</footer>
</body>
</html>