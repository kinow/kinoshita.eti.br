  
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head profile="http://gmpg.org/xfn/11">
    <title>Bruno P. Kinoshita</title> 
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="description" content="Bruno de Paula Kinoshita personal web site" />
    <meta name="keywords"
        content="kinoshita, bruno de paula kinoshita, geek, geek stuff, java, python, c, c++, msn now playing, neural network, mackenzie, sao paulo, brasil, brazil, nerd, nerd stuff, cool, jenkins, illustration, quadrinhos, machine learning, linguistic, apache, open source, codigo livre, codigo aberto" />
    <meta name="author" content="" />
    <meta name="generator" content="PieCrust 3.2.0" />
    <meta name="template-engine" content="Twig" />
    <meta name="robots" content="all=index,follow" />
    <meta name="revisit-after" content="15 days" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta name="distribution" content="Global" />
    <meta name="url" content="/" />
    <meta name="copyright" content="Bruno de Paula Kinoshita" />
    <meta name="Googlebot" content="all" />
    <meta name="rating" content="general" />
    <meta http-equiv="expires" content="0" />
    <meta name="city" content="Sao Paulo" />
    <meta name="state" content="Brasil, Sao Paulo" />
    <meta http-equiv="content-language" content="en" />
    <meta http-equiv="imagetoolbar" content="no" />
    <meta id="page_favicon" href="/favicon.ico" rel="icon" type="image/x-icon" />
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link rel="alternate" type="application/rss+xml" title="Bruno P. Kinoshita &raquo; Feed" href="/feed.xml" />
    <link rel="stylesheet" href="/css/semantic/dist/semantic.min.css" type="text/css" media="screen, projection" />
    <link rel="stylesheet" href="/css/style.css" type="text/css" media="screen, projection" />
    <!--[if lt IE 8]>
    <link rel="stylesheet" href="/css/blueprint/ie.css" type="text/css" media="screen, projection" />
    <![endif]-->
    <link rel="stylesheet" href="/css/prettyPhoto.css" type="text/css" media="all" />
</head>
<body id="body">
    <div class="ui vertical sidebar menu" id="toc">
        <nav class="menu" role="navigation">
    <div class="item">
        <a href="/" class="main-link">Kinoshita</a>
    </div>
    <div class="item">
        <a href="/art">Art</a>
    </div>
    <div class="item">
        <a href="/articles/">Articles</a>
    </div>
    <div class="item">
        <a href="/books/">Books</a>
    </div>
    <div class="item">
      <a href="/presentations/">Presentations</a>
    </div>
    <div class="item">
        <a href="/software/">Software</a>
    </div>
    <div class="item">
        <a href="/contact/">Contact</a>
    </div>
    <div class="item">
        <a href="/about/">About &#038; CV</a>
    </div>
</nav>
<img src="/img/bruno.jpg" title="Hmmmm" alt="My picture" width="134px" height="215px" />
    </div>
    <div class="ui black big launch right attached fixed button">
        <i class="content icon"></i>
        <span class="text">Menu</span>
    </div>
    <div class="ui fixed inverted main menu">
        <div class="ui container">
            <a class="launch icon item">
                <i class="content icon"></i>
            </a>
            <div class="item">
                
            </div>
        </div>
    </div>
    <div class="pusher">
        <div class="full height">
            <div class="toc">
                <div class="ui vertical sticky fixed top menu">
                    <nav class="menu" role="navigation">
    <div class="item">
        <a href="/" class="main-link">Kinoshita</a>
    </div>
    <div class="item">
        <a href="/art">Art</a>
    </div>
    <div class="item">
        <a href="/articles/">Articles</a>
    </div>
    <div class="item">
        <a href="/books/">Books</a>
    </div>
    <div class="item">
      <a href="/presentations/">Presentations</a>
    </div>
    <div class="item">
        <a href="/software/">Software</a>
    </div>
    <div class="item">
        <a href="/contact/">Contact</a>
    </div>
    <div class="item">
        <a href="/about/">About &#038; CV</a>
    </div>
</nav>
<img src="/img/bruno.jpg" title="Hmmmm" alt="My picture" width="134px" height="215px" />
                </div>
            </div>
            <div class="article">
                <div class="main container" role="main">
                    <!-- right fixed menu -->
                    <div class="ui dividing right rail" id="taxonomy">
                        <div class="ui sticky fixed top">
                            <br/>
                            <h4>Blog Taxonomy</h4>
                            <nav id="tag-cloud" class="sidebar-box" role="complementary">
                              
                              <span style="font-size: 22.5pt"><a href="/tag/apache%20software%20foundation">apache software foundation</a></span>&nbsp;(25)
                              
                              <span style="font-size: 12.5pt"><a href="/tag/articles">articles</a></span>&nbsp;(5)
                              
                              <span style="font-size: 11.5pt"><a href="/tag/aws">aws</a></span>&nbsp;(3)
                              
                              <span style="font-size: 13.5pt"><a href="/tag/c%2B%2B">c++</a></span>&nbsp;(7)
                              
                              <span style="font-size: 13.0pt"><a href="/tag/cylc">cylc</a></span>&nbsp;(6)
                              
                              <span style="font-size: 12.0pt"><a href="/tag/docker">docker</a></span>&nbsp;(4)
                              
                              <span style="font-size: 12.5pt"><a href="/tag/events">events</a></span>&nbsp;(5)
                              
                              <span style="font-size: 11.5pt"><a href="/tag/functional%20programming">functional programming</a></span>&nbsp;(3)
                              
                              <span style="font-size: 16.5pt"><a href="/tag/illustrations">illustrations</a></span>&nbsp;(13)
                              
                              <span style="font-size: 27.5pt"><a href="/tag/java">java</a></span>&nbsp;(35)
                              
                              <span style="font-size: 13.0pt"><a href="/tag/jena">jena</a></span>&nbsp;(6)
                              
                              <span style="font-size: 23.0pt"><a href="/tag/jenkins">jenkins</a></span>&nbsp;(26)
                              
                              <span style="font-size: 12.5pt"><a href="/tag/krita">krita</a></span>&nbsp;(5)
                              
                              <span style="font-size: 12.0pt"><a href="/tag/natural%20language%20processing">natural language processing</a></span>&nbsp;(4)
                              
                              <span style="font-size: 28.5pt"><a href="/tag/opensource">opensource</a></span>&nbsp;(37)
                              
                              <span style="font-size: 26.5pt"><a href="/tag/programming">programming</a></span>&nbsp;(33)
                              
                              <span style="font-size: 16.5pt"><a href="/tag/python">python</a></span>&nbsp;(13)
                              
                              <span style="font-size: 11.5pt"><a href="/tag/r">r</a></span>&nbsp;(3)
                              
                              <span style="font-size: 12.5pt"><a href="/tag/security">security</a></span>&nbsp;(5)
                              
                              <span style="font-size: 12.5pt"><a href="/tag/shell%20script">shell script</a></span>&nbsp;(5)
                              
                              <span style="font-size: 24.5pt"><a href="/tag/software%20quality">software quality</a></span>&nbsp;(29)
                              
                              <span style="font-size: 12.0pt"><a href="/tag/sparql">sparql</a></span>&nbsp;(4)
                              
                              <span style="font-size: 13.5pt"><a href="/tag/test%20anything%20protocol">test anything protocol</a></span>&nbsp;(7)
                              
                              <span style="font-size: 16.5pt"><a href="/tag/testlink">testlink</a></span>&nbsp;(13)
                              
                            </nav>
                            
                        </div>
                    </div>
                

Posts tagged with 'docker'




<div class="ui raised padded container segment">
    <h2><a href="/2018/08/04/creating-a-docker-container-to-run-as-a-command" title="Permanent link">Creating a Docker container to run as a command</a></h2>
    <p><small>kinow</small> @ <small>Aug 04, 2018&nbsp;22:00:36</small></p>
    
    





<a href="https://twitter.com/share" class="twitter-share-button" data-url="https://kinoshita.eti.br/2018/08/04/creating-a-docker-container-to-run-as-a-command" data-text="Creating a Docker container to run as a command" data-via="kinow" data-hashtags="opensource">Tweet</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p='https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>


    <p>For the past two weeks at work I have been assigned to work on PHP projects. Though I used
PHP some time ago - especially with Code Igniter and Laravel - I have not used it in a few
years. And have been doing mostly Java nowadays.</p>
<p>The complete project setup was done by co-workers. I had a PHP project, using Symfony, several
bundles and libraries, and Postgres. But it required just running a few commands to set up
AWS settings, and then fire up Docker Compose.</p>
<p>Besides Docker Compose starting a web container, and another Postgres container, we used the
web container to run <a href="https://getcomposer.org/">Composer</a>. In the past, I would see the PHP
project mapped as a folder in the running container, and then composer would be executed
in the host.</p>
<p>I noticed then that I could do the same to an image I created in 2016 to run
<a href="https://cylc.github.io/cylc/">Cylc</a>. The <a href="https://github.com/kinow/docker/blob/d1cc1771ac53b8efd37b5e4c4401b74ebd294a2b/cylc/Dockerfile">previous version</a>
would be used to start a container in a terminal, then run some commands
while maintaining the state within the container.</p>
<p>The <a href="https://github.com/kinow/cylc-docker">new version</a>
now maps a volume to the version of cylc, installs the dependencies, and
then allows the state to be maintained solely in the mapped volume.</p>
<p>Furthermore, the entrypoint of the image is the <code>cylc</code> command. Which means that
you do not have to execute a terminal in order to run commands to the container
(or change the command/entrypoint).</p>
<div class="highlight"><pre>...
VOLUME <span class="s2">&quot;/opt/cylc&quot;</span> <span class="s2">&quot;/tmp&quot;</span> <span class="s2">&quot;/run&quot;</span> <span class="s2">&quot;/var/run&quot;</span> <span class="c"># we have the state stored only in /opt/cylc</span>
WORKDIR <span class="s2">&quot;/opt/cylc&quot;</span>
ENV PATH /opt/cylc/bin:<span class="nv">$PATH</span>
WORKDIR /opt/cylc
ENTRYPOINT <span class="o">[</span><span class="s2">&quot;cylc&quot;</span><span class="o">]</span> <span class="c"># here&#39;s the trick!</span>
</pre></div>

<p>It uses the same approach from the PHP image I am using for Composer, with a few
additional improvements from the <a href="https://docs.docker.com/develop/develop-images/dockerfile_best-practices/">Best practices for writing Dockerfiles</a> documentation.</p>
<div class="highlight"><pre><span class="nv">$ </span>docker run -ti -v <span class="s2">&quot;</span><span class="k">$(</span><span class="nb">pwd</span> -P<span class="k">)</span><span class="s2">&quot;</span>/cylc:/opt/cylc cylc validate /opt/cylc/etc/examples/tutorial/oneoff/basic/
Valid <span class="k">for</span> cylc-7.7.2
<span class="nv">$ </span>docker run -ti -v <span class="s2">&quot;</span><span class="k">$(</span><span class="nb">pwd</span> -P<span class="k">)</span><span class="s2">&quot;</span>/cylc:/opt/cylc cylc register /opt/cylc/etc/examples/tutorial/oneoff/basic/
REGISTER /opt/cylc/etc/examples/tutorial/oneoff/basic/
<span class="nv">$ </span>docker run -ti -v <span class="s2">&quot;</span><span class="k">$(</span><span class="nb">pwd</span> -P<span class="k">)</span><span class="s2">&quot;</span>/cylc:/opt/cylc cylc start --non-daemon --debug /opt/cylc/etc/examples/tutorial/oneoff/basic/
            ._.                                                       
            <span class="p">|</span> <span class="p">|</span>                 The Cylc Suite Engine <span class="o">[</span>7.7.2<span class="o">]</span>         
._____._. ._<span class="p">|</span> <span class="p">|</span>_____.           Copyright <span class="o">(</span>C<span class="o">)</span> 2008-2018 NIWA          
<span class="p">|</span> .___<span class="p">|</span> <span class="p">|</span> <span class="p">|</span> <span class="p">|</span> <span class="p">|</span> .___<span class="p">|</span>  _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
<span class="p">|</span> !___<span class="p">|</span> !_! <span class="p">|</span> <span class="p">|</span> !___.  This program comes with ABSOLUTELY NO WARRANTY<span class="p">;</span>
!_____!___. <span class="p">|</span>_!_____!  see <span class="sb">`</span>cylc warranty<span class="sb">`</span>.  It is free software, you 
      .___! <span class="p">|</span>           are welcome to redistribute it under certain  
      !_____!                conditions<span class="p">;</span> see <span class="sb">`</span>cylc conditions<span class="sb">`</span>.       
2018-07-30T12:10:32Z INFO - Suite starting: <span class="nv">server</span><span class="o">=</span>3714d1a17999:43040 <span class="nv">pid</span><span class="o">=</span>1
2018-07-30T12:10:32Z INFO - Cylc version: 7.7.2
2018-07-30T12:10:32Z INFO - Run mode: live
2018-07-30T12:10:32Z INFO - Initial point: 1
2018-07-30T12:10:32Z INFO - Final point: 1
2018-07-30T12:10:32Z INFO - Cold Start 1
2018-07-30T12:10:32Z DEBUG - <span class="o">[</span>hello.1<span class="o">]</span> -released to the task pool
2018-07-30T12:10:32Z DEBUG - BEGIN TASK PROCESSING
2018-07-30T12:10:32Z DEBUG - <span class="o">[</span>hello.1<span class="o">]</span> -waiting <span class="o">=</span>&gt; queued
2018-07-30T12:10:32Z DEBUG - <span class="m">1</span> task<span class="o">(</span>s<span class="o">)</span> de-queued
2018-07-30T12:10:32Z INFO - <span class="o">[</span>hello.1<span class="o">]</span> -submit-num<span class="o">=</span>1, owner@host<span class="o">=</span>localhost
2018-07-30T12:10:32Z DEBUG - <span class="o">[</span>hello.1<span class="o">]</span> -queued <span class="o">=</span>&gt; ready
2018-07-30T12:10:32Z DEBUG - END TASK PROCESSING <span class="o">(</span>took 0.00642895698547 seconds<span class="o">)</span>
2018-07-30T12:10:32Z DEBUG - <span class="o">[</span><span class="s1">&#39;cylc&#39;</span>, <span class="s1">&#39;jobs-submit&#39;</span>, <span class="s1">&#39;--debug&#39;</span>, <span class="s1">&#39;--&#39;</span>, <span class="s1">&#39;/opt/cylc/etc/examples/tutorial/oneoff/basic/log/job&#39;</span>, <span class="s1">&#39;1/hello/01&#39;</span><span class="o">]</span>
2018-07-30T12:10:33Z DEBUG - <span class="o">[</span>client-connect<span class="o">]</span> root@3714d1a17999:cylc-message <span class="nv">privilege</span><span class="o">=</span><span class="s1">&#39;full-control&#39;</span> 7b05596a-5971-4733-82de-28528f702ff0
2018-07-30T12:10:33Z INFO - <span class="o">[</span>client-command<span class="o">]</span> put_messages root@3714d1a17999:cylc-message 7b05596a-5971-4733-82de-28528f702ff0
2018-07-30T12:10:33Z DEBUG - <span class="o">[</span><span class="nb">jobs</span>-submit cmd<span class="o">]</span> cylc <span class="nb">jobs</span>-submit --debug -- /opt/cylc/etc/examples/tutorial/oneoff/basic/log/job 1/hello/01
    <span class="o">[</span><span class="nb">jobs</span>-submit ret_code<span class="o">]</span> 0
    <span class="o">[</span><span class="nb">jobs</span>-submit out<span class="o">]</span>
    <span class="o">[</span>TASK JOB SUMMARY<span class="o">]</span>2018-07-30T12:10:32Z<span class="p">|</span>1/hello/01<span class="p">|</span>0<span class="p">|</span>61
    <span class="o">[</span>TASK JOB COMMAND<span class="o">]</span>2018-07-30T12:10:32Z<span class="p">|</span>1/hello/01<span class="p">|</span><span class="o">[</span>STDOUT<span class="o">]</span> 61
2018-07-30T12:10:33Z INFO - <span class="o">[</span>hello.1<span class="o">]</span> -<span class="o">(</span>current:ready<span class="o">)</span> submitted at 2018-07-30T12:10:32Z
2018-07-30T12:10:33Z INFO - <span class="o">[</span>hello.1<span class="o">]</span> -job<span class="o">[</span>01<span class="o">]</span> submitted to localhost:background<span class="o">[</span>61<span class="o">]</span>
2018-07-30T12:10:33Z DEBUG - <span class="o">[</span>hello.1<span class="o">]</span> -ready <span class="o">=</span>&gt; submitted
2018-07-30T12:10:33Z INFO - <span class="o">[</span>hello.1<span class="o">]</span> -health check settings: submission <span class="nv">timeout</span><span class="o">=</span>None
2018-07-30T12:10:33Z DEBUG - BEGIN TASK PROCESSING
2018-07-30T12:10:33Z DEBUG - <span class="m">0</span> task<span class="o">(</span>s<span class="o">)</span> de-queued
2018-07-30T12:10:33Z DEBUG - <span class="o">[</span>hello.1<span class="o">]</span> -forced spawning
2018-07-30T12:10:33Z DEBUG - END TASK PROCESSING <span class="o">(</span>took 0.000992059707642 seconds<span class="o">)</span>
2018-07-30T12:10:33Z INFO - <span class="o">[</span>hello.1<span class="o">]</span> -<span class="o">(</span>current:submitted<span class="o">)</span>&gt; started at 2018-07-30T12:10:33Z
2018-07-30T12:10:33Z DEBUG - <span class="o">[</span>hello.1<span class="o">]</span> -submitted <span class="o">=</span>&gt; running
2018-07-30T12:10:33Z INFO - <span class="o">[</span>hello.1<span class="o">]</span> -health check settings: execution <span class="nv">timeout</span><span class="o">=</span>None
2018-07-30T12:10:34Z DEBUG - BEGIN TASK PROCESSING
2018-07-30T12:10:34Z DEBUG - <span class="m">0</span> task<span class="o">(</span>s<span class="o">)</span> de-queued
2018-07-30T12:10:34Z DEBUG - END TASK PROCESSING <span class="o">(</span>took 0.000984191894531 seconds<span class="o">)</span>
2018-07-30T12:10:43Z DEBUG - <span class="o">[</span>client-connect<span class="o">]</span> root@3714d1a17999:cylc-message <span class="nv">privilege</span><span class="o">=</span><span class="s1">&#39;full-control&#39;</span> 524d658e-9932-4135-9523-3c2ace3990cf
2018-07-30T12:10:43Z INFO - <span class="o">[</span>client-command<span class="o">]</span> put_messages root@3714d1a17999:cylc-message 524d658e-9932-4135-9523-3c2ace3990cf
2018-07-30T12:10:43Z INFO - <span class="o">[</span>hello.1<span class="o">]</span> -<span class="o">(</span>current:running<span class="o">)</span>&gt; succeeded at 2018-07-30T12:10:43Z
2018-07-30T12:10:43Z DEBUG - <span class="o">[</span>hello.1<span class="o">]</span> -running <span class="o">=</span>&gt; succeeded
2018-07-30T12:10:43Z INFO - Suite shutting down - AUTOMATIC
2018-07-30T12:10:44Z INFO - DONE
<span class="err">$</span>
</pre></div>

<p>If you have a utility in your computer that requires a few dependencies, but that
can store the state/data in a mapped volume, the same kind of container may be
useful.</p><!-- html -->
    
<p class="postmetadata">
    
    <small>tags 
     [&nbsp;<a
        href="/tag/cylc"
        rel="tag">cylc</a>&nbsp;]&nbsp;
    
     [&nbsp;<a
        href="/tag/docker"
        rel="tag">docker</a>&nbsp;]&nbsp;
    
     [&nbsp;<a
        href="/tag/opensource"
        rel="tag">opensource</a>&nbsp;]&nbsp;
    
    </small>
    
    
</p>
</div>




<div class="ui raised padded container segment">
    <h2><a href="/2017/03/14/order-of-containers-in-docker-compose" title="Permanent link">Order of containers in Docker Compose</a></h2>
    <p><small>kinow</small> @ <small>Mar 14, 2017&nbsp;21:22:03</small></p>
    
    





<a href="https://twitter.com/share" class="twitter-share-button" data-url="https://kinoshita.eti.br/2017/03/14/order-of-containers-in-docker-compose" data-text="Order of containers in Docker Compose" data-via="kinow" data-hashtags="opensource">Tweet</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p='https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>


    <p>In Docker Compose you are able to control the startup order of the containers via
the <em>depends_on</em> statement. This is documented in <a href="https://docs.docker.com/compose/startup-order/">Controlling startup order in Compose</a>.</p>
<p>If you have a simple setup, with Tomcat and Postgres, sometimes Postgres will start first, but Compose
will initialize Tomcat before Postgres has fully booted. When that happens, you may receive 401, 404, or other
application errors.</p>
<p>You can fix it by combining <em>depends_on</em> with a <em>healthcheck</em>. For example:</p>
<div class="highlight"><pre><span class="c"># File: docker-compose.yml</span>
version: <span class="s1">&#39;2.1&#39;</span>
services:
  db:
    container_name: twpg
    build:
      context: .
      dockerfile: Dockerfile.postgres
    restart: always
    ports:
      - <span class="s2">&quot;5432:5432&quot;</span>
    healthcheck:
      <span class="nb">test</span>: <span class="s2">&quot;pg_isready -h localhost -p 5432 -q -U postgres&quot;</span>
      interval: 10s
      timeout: 5s
      retries: 5

  web:
    container_name: twtc
    build:
      context: .
      dockerfile: Dockerfile.tomcat
    restart: always
    depends_on:
      db:
        condition: service_healthy
    links:
      - db
    ports:
      - <span class="s2">&quot;80:8080&quot;</span>
</pre></div>

<p>In the example docker-compose.yml, there are two containers, <em>db</em> and <em>web</em>. web is running
a Tomcat, and db is running Postgres. Web depends on db (see depends_on), and uses a condition
<em>service_healthy</em>. Which indicates it depends that that container is healthy.</p>
<p>The <em>healthcheck</em> entry under the db container settings define how to check whether Postgres
is running or not. In this case, we are using <em>pg_isready</em>, which is available in the
vanilla Postgres 9 container.</p>
<p>It will try 5 times, with a 10 seconds interval, and will time out after 5 seconds. You may
have to tune these parameters for your application.</p>
<p>This code snippet is from a
<a href="https://github.com/Foxoncz/docker-thingworx/pull/3/files">pull request submitted to Foxoncz/docker-thingworx</a>.</p>
<p>&hearts; Open Source</p><!-- html -->
    
<p class="postmetadata">
    
    <small>tags 
     [&nbsp;<a
        href="/tag/docker"
        rel="tag">docker</a>&nbsp;]&nbsp;
    
    </small>
    
    
    <br/>
    <small>posted in 
    [&nbsp;<a
        href="/blog"
        title="View all posts in blog"
        rel="category tag">blog</a>&nbsp;]&nbsp;
    category </small>
    
</p>
</div>




<div class="ui raised padded container segment">
    <h2><a href="/2016/04/17/trying-saltstack-with-docker" title="Permanent link">Trying SaltStack with Docker</a></h2>
    <p><small>kinow</small> @ <small>Apr 17, 2016&nbsp;22:06:03</small></p>
    
    





<a href="https://twitter.com/share" class="twitter-share-button" data-url="https://kinoshita.eti.br/2016/04/17/trying-saltstack-with-docker" data-text="Trying SaltStack with Docker" data-via="kinow" data-hashtags="opensource">Tweet</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p='https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>


    <p>Some weeks ago I started learning <a href="http://saltstack.com/">SaltStack</a> for a project at work. But I couldn&#8217;t
find a good Docker image for that and I had to ask the Ops team for some VM&#8217;s. We
are having a rainy weekend in Auckland, so I decided to have another look at the
<a href="https://wiki.jenkins-ci.org/display/JENKINS/saltstack-plugin">Jenkins SaltStack Plug-in</a>.</p>
<p>But now since I was at home, I couldn&#8217;t use the VM&#8217;s that I had access to at
work. So decided to look again at Docker or Vagrant images. After playing
with a few images, I found <a href="https://hub.docker.com/r/bbinet/salt-master/">bbinet/salt-master</a>.
It not only sets up a master, but also provides an easy way to enable the cherrypy
API (necessary for the Jenkins plug-in).</p>
<p>This post describes the steps that I took to have a running Salt Master with the API
enabled. First you need to create some directories and files to use with the image.</p>
<div class="highlight"><pre>shell<span class="nv">$ </span>mkdir ~/master <span class="o">&amp;&amp;</span> <span class="nb">cd</span> ~/master
shell<span class="nv">$ </span>mkdir -p config/master.d/
shell<span class="nv">$ </span>vim config/master.d/api.conf
</pre></div>

<p>The api.conf contains the SaltStack API configuration. You can change port, user
and other settings if necessary. Just remember to add a credential in Jenkins
for the plug-in.</p>
<div class="highlight"><pre><span class="c"># File: api.conf</span>
external_auth:
  pam:
    saltapiuser:
      - .*
      - <span class="s1">&#39;@runner&#39;</span>
      - <span class="s1">&#39;@wheel&#39;</span>
      - <span class="s1">&#39;@jobs&#39;</span>
rest_cherrypy:
  port: 8000
  host: 0.0.0.0
  disable_ssl: True
  static: /opt/molten
  static_path: /assets
  app: /opt/molten/index.html
  app_path: /molten
</pre></div>

<p>The image also conveniently provides a script that is executed before the
entry point (if provided). So we can also create a user for the API automatically
when the image is created.</p>
<div class="highlight"><pre>shell<span class="nv">$ </span>vim config/before-exec.sh
</pre></div>

<div class="highlight"><pre><span class="c">#!/bin/bash</span>
<span class="c"># File: before-exec.sh</span>
useradd saltapiuser
<span class="nb">echo</span> -e <span class="s2">&quot;nosecret\nnosecret\n&quot;</span> <span class="p">|</span> passwd saltapiuser
<span class="nb">exit </span>0
</pre></div>

<p>Also make the script executable.</p>
<div class="highlight"><pre>chmod +x config/before-exec.sh
</pre></div>

<p>And finally start the container.</p>
<div class="highlight"><pre>docker run --name salt-master -v <span class="nv">$PWD</span>/config:/config <span class="se">\</span>
    -p 4505:4505 -p 4506:4506 -p 443:443 -p 8000:8000 <span class="se">\</span>
    bbinet/salt-master
</pre></div>

<p>Once the container is running, you can go to http://localhost:8000 and
log in as saltapiuser:nosecret, and also configure your plug-in
in Jenkins.</p>
<p>Happy hacking!</p><!-- html -->
    
<p class="postmetadata">
    
    <small>tags 
     [&nbsp;<a
        href="/tag/jenkins"
        rel="tag">jenkins</a>&nbsp;]&nbsp;
    
     [&nbsp;<a
        href="/tag/docker"
        rel="tag">docker</a>&nbsp;]&nbsp;
    
     [&nbsp;<a
        href="/tag/saltstack"
        rel="tag">saltstack</a>&nbsp;]&nbsp;
    
    </small>
    
    
    <br/>
    <small>posted in 
    [&nbsp;<a
        href="/blog"
        title="View all posts in blog"
        rel="category tag">blog</a>&nbsp;]&nbsp;
    category </small>
    
</p>
</div>




<div class="ui raised padded container segment">
    <h2><a href="/2016/03/20/deploying-war-files-to-tomcat-with-jenkins" title="Permanent link">Deploying WAR files to Tomcat with Jenkins</a></h2>
    <p><small>kinow</small> @ <small>Mar 20, 2016&nbsp;15:29:03</small></p>
    
    





<a href="https://twitter.com/share" class="twitter-share-button" data-url="https://kinoshita.eti.br/2016/03/20/deploying-war-files-to-tomcat-with-jenkins" data-text="Deploying WAR files to Tomcat with Jenkins" data-via="kinow" data-hashtags="opensource">Tweet</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p='https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>


    <p><strong>Table of Contents</strong></p>
<ul>
<li><a href="#1-deploying-with-custom-scripts">Deploying with custom scripts</a></li>
<li><a href="#2-deploying-with-a-build-tool">Deploying with a build tool</a></li>
<li><a href="#3-deploying-with-a-build-server">Deploying with a build server</a></li>
<li><a href="#final-thoughts">Final thoughts</a></li>
</ul>
<p>A co-worker asked me this week about how to deploy a WAR file to Tomcat with Jenkins. In my team we are
currently maintaining and deploying about 10 Java web systems, but we have no consistent way of deploying
the applications to Tomcat yet. In the past I used Ant, Maven, Cargo, Grunt, and Jenkins, so I
decided to write this short post to show a few different ways it can be achieved, &agrave; la
<a href="https://en.wikipedia.org/wiki/There's_more_than_one_way_to_do_it">Perl&#8217;s TMTOWTDI</a> motto.</p>
<h2><a name="1-deploying-with-custom-scripts" style="color: #222222;">#1 Deploying with custom scripts</a></h2>

<p>At first you may be tempted to write your own script to deploy to Tomcat with some Shell, Perl, Python
or Java. But I think I would choose this option only because either I needed some feature that is not
available in the other options, or in order to call other tasks or debug some problem.</p>
<p>Example:</p>
<div class="highlight"><pre><span class="nv">$ </span>docker run -d -p 8888:8080 jeanblanchard/tomcat:8
<span class="nv">$ </span>git clone https://github.com/spring-projects/spring-petclinic.git <span class="o">&amp;&amp;</span> <span class="nb">cd </span>spring-petclinic <span class="o">&amp;&amp;</span> mvn package
<span class="nv">$ </span>curl --upload-file target/petclinic.war <span class="s2">&quot;http://admin:admin@localhost:8888/manager/text/deploy?path=/spring-petclinic&amp;update=true&quot;</span>
OK - Deployed application at context path /spring-petclinic
</pre></div>

<!-- html -->
    
    <p>( <a href="/2016/03/20/deploying-war-files-to-tomcat-with-jenkins" >Read more ...</a> )</p>
    
<p class="postmetadata">
    
    <small>tags 
     [&nbsp;<a
        href="/tag/jenkins"
        rel="tag">jenkins</a>&nbsp;]&nbsp;
    
     [&nbsp;<a
        href="/tag/tomcat"
        rel="tag">tomcat</a>&nbsp;]&nbsp;
    
     [&nbsp;<a
        href="/tag/docker"
        rel="tag">docker</a>&nbsp;]&nbsp;
    
    </small>
    
    
    <br/>
    <small>posted in 
    [&nbsp;<a
        href="/blog"
        title="View all posts in blog"
        rel="category tag">blog</a>&nbsp;]&nbsp;
    category </small>
    
</p>
</div>






               </div>
            </div>
        </div>
        <div class="ui vertical footer segment">
            <div class="ui center aligned container">
                           <div id="copy" class="">
                <p>&copy; <a href="/about"><span
                            class="b">Bru</span><span
                            class="r">no de</span> <span
                            class="a">Paula</span> <span
                            class="s"></span><span
                            class="i">Kinos</span><span
                            class="l">hita</span></a>
                </p>
            </div>
            </div>
         </div>
    </div>
</body>
</html>
<script src="/js/jquery-2.2.3.min.js"  type="text/javascript"></script>
<script src="/css/semantic/dist/semantic.min.js"  type="text/javascript"></script>
<script src="/js/jquery.prettyPhoto.js"></script>
<script src="/js/site.js"></script>