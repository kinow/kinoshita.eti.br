  
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head profile="http://gmpg.org/xfn/11">
    <title>Bruno P. Kinoshita</title> 
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="description" content="Bruno de Paula Kinoshita personal web site" />
    <meta name="keywords"
        content="kinoshita, bruno de paula kinoshita, geek, geek stuff, java, python, c, c++, msn now playing, neural network, mackenzie, sao paulo, brasil, brazil, nerd, nerd stuff, cool, jenkins, illustration, quadrinhos, machine learning, linguistic, apache, open source, codigo livre, codigo aberto" />
    <meta name="author" content="" />
    <meta name="generator" content="PieCrust 3.2.1" />
    <meta name="template-engine" content="Twig" />
    <meta name="robots" content="all=index,follow" />
    <meta name="revisit-after" content="15 days" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta name="distribution" content="Global" />
    <meta name="url" content="/" />
    <meta name="copyright" content="Bruno de Paula Kinoshita" />
    <meta name="Googlebot" content="all" />
    <meta name="rating" content="general" />
    <meta http-equiv="expires" content="0" />
    <meta name="city" content="Sao Paulo" />
    <meta name="state" content="Brasil, Sao Paulo" />
    <meta http-equiv="content-language" content="en" />
    <meta http-equiv="imagetoolbar" content="no" />
    <meta id="page_favicon" href="/favicon.ico" rel="icon" type="image/x-icon" />
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link rel="alternate" type="application/rss+xml" title="Bruno P. Kinoshita &raquo; Feed" href="/feed.xml" />
    <link rel="stylesheet" href="/css/semantic/dist/semantic.min.css" type="text/css" media="screen, projection" />
    <link rel="stylesheet" href="/css/style.css" type="text/css" media="screen, projection" />
    <!--[if lt IE 8]>
    <link rel="stylesheet" href="/css/blueprint/ie.css" type="text/css" media="screen, projection" />
    <![endif]-->
    <link rel="stylesheet" href="/css/prettyPhoto.css" type="text/css" media="all" />
</head>
<body id="body">
    <div class="ui vertical sidebar menu" id="toc">
        <nav class="menu" role="navigation">
    <div class="item">
        <a href="/" class="main-link">Kinoshita</a>
    </div>
    <div class="item">
        <a href="/art">Art</a>
    </div>
    <div class="item">
        <a href="/contact/">Contact</a>
    </div>
    <div class="item">
        <a href="/about/">About</a>
    </div>
</nav>
<img src="/img/bruno.jpg" title="Hmmmm" alt="My picture" width="134px" height="215px" />
    </div>
    <div class="ui black big launch right attached fixed button">
        <i class="content icon"></i>
        <span class="text">Menu</span>
    </div>
    <div class="ui fixed inverted main menu">
        <div class="ui container">
            <a class="launch icon item">
                <i class="content icon"></i>
            </a>
            <div class="item">
                
            </div>
        </div>
    </div>
    <div class="pusher">
        <div class="full height">
            <div class="toc">
                <div class="ui vertical sticky fixed top menu">
                    <nav class="menu" role="navigation">
    <div class="item">
        <a href="/" class="main-link">Kinoshita</a>
    </div>
    <div class="item">
        <a href="/art">Art</a>
    </div>
    <div class="item">
        <a href="/contact/">Contact</a>
    </div>
    <div class="item">
        <a href="/about/">About</a>
    </div>
</nav>
<img src="/img/bruno.jpg" title="Hmmmm" alt="My picture" width="134px" height="215px" />
                </div>
            </div>
            <div class="article">
                <div class="main container" role="main">
                    <!-- right fixed menu -->
                    <div class="ui dividing right rail" id="taxonomy">
                        <div class="ui sticky fixed top">
                            <br/>
                            <h4>Blog Taxonomy</h4>
                            <nav id="tag-cloud" class="sidebar-box" role="complementary">
                              
                              <span style="font-size: 23.0pt"><a href="/tag/apache%20software%20foundation">apache software foundation</a></span>&nbsp;(26)
                              
                              <span style="font-size: 14.0pt"><a href="/tag/cylc">cylc</a></span>&nbsp;(8)
                              
                              <span style="font-size: 17.0pt"><a href="/tag/illustrations">illustrations</a></span>&nbsp;(14)
                              
                              <span style="font-size: 27.5pt"><a href="/tag/java">java</a></span>&nbsp;(35)
                              
                              <span style="font-size: 23.0pt"><a href="/tag/jenkins">jenkins</a></span>&nbsp;(26)
                              
                              <span style="font-size: 30.0pt"><a href="/tag/opensource">opensource</a></span>&nbsp;(40)
                              
                              <span style="font-size: 26.5pt"><a href="/tag/programming">programming</a></span>&nbsp;(33)
                              
                              <span style="font-size: 18.0pt"><a href="/tag/python">python</a></span>&nbsp;(16)
                              
                              <span style="font-size: 24.5pt"><a href="/tag/software%20quality">software quality</a></span>&nbsp;(29)
                              
                              <span style="font-size: 16.5pt"><a href="/tag/testlink">testlink</a></span>&nbsp;(13)
                              
                            </nav>
                            
                        </div>
                    </div>
                

Posts tagged with 'python'




<div class="ui raised padded container segment">
    <h2><a href="/2018/07/14/cylc-scheduler-internals-part-1" title="Permanent link">Cylc Scheduler Internals - Part 1</a></h2>
    <p><small>kinow</small> @ <small>Jul 14, 2018&nbsp;22:42:47</small></p>
    
    





<a href="https://twitter.com/share" class="twitter-share-button" data-url="https://kinoshita.eti.br/2018/07/14/cylc-scheduler-internals-part-1" data-text="Cylc Scheduler Internals - Part 1" data-via="kinow" data-hashtags="opensource">Tweet</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p='https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>


    <p>This is the first post in a series of three (or maybe four later) based on diagrams
I collected while debugging the Cylc scheduler. The scheduler is called by the <code>cylc start</code>
utility.</p>
<p><em>NB: this is a post to remember things, not really expecting to give someone enough
information to be able to hack the Cylc Scheduler (though you can and would have fun!).</em></p>
<p>Instead of going at length on what happens (and there is quite a bit happening when
you run <code>cylc start my.suite</code>), I will use the following diagram, followed by a few paragraphs
to highlight certain parts. The code used was based on <a href="https://github.com/cylc/cylc/tree/7.7.1">Cylc 7.7.1</a>.</p>
<p style='text-align: center;'>
<a href="/2018/07/14/cylc-scheduler-internals-part-1/cylc-scheduler_cli-workflow.png">
<img style="display: inline; width: 100%;" class="ui image" src="/2018/07/14/cylc-scheduler-internals-part-1/cylc-scheduler_cli-workflow.png"  />
</a>
</p>

<p>When a Cylc command like <code>cylc start</code> is invoked, it actually gets translated into
<code>bin/cylc-$command_name</code>. <code>cylc-start</code> is a Shell file, that will simply call <code>cylc-run</code>.
<code>cylc-run</code> then imports <code>scheduler_cli</code>&#8230; but what you need to know is that in the end
<code>scheduler_cli</code> will create an instance of <code>Scheduler</code> with the right constructor
arguments, and call its <code>start</code> method.</p>
<p>After that point, you are at the left-most lifeline, on the <code>Scheduler</code> constructor
(i.e. the <strong>init</strong> method of the scheduler.py&#8217;s Scheduler class).</p>
<p>If you follow the method calls - which are hopefully easy to understand and follow -
you will find that the constructor merely creates a few objects, prepares the suite
information, and the suite database.</p>
<p>Then the <code>start</code> method kicks things off, interacting with previously created objects,
but also with some singletons for logging and configuration. Oh, that <code>Cylc</code> banner
is also printed here (in case you would like to customize it as in SpringBoot).</p>
<p>After that, if you are running the suite as daemon, it will be
<a href="http://code.activestate.com/recipes/66012-fork-a-daemon-process-on-unix/">daemonized</a>,
by forking the current process, but with Python.</p>
<p>One important step that happens here, is the initialization of the HTTP Server. This server
will be used to communicate with the <strong>Suite Server Program</strong>. It will be listening to
connections with the right endpoints available only after the <code>configure</code> method.</p>
<p>Lastly, we have <code>configure</code> and <code>run</code> methods, which are two very important methods to be discussed
in the next part of this series, as they are quite extensive, and deserve their own diagrams.</p>
<p>You can download the <a href="/2018/07/14/cylc-scheduler-internals-part-1/cylc-scheduler_cli-workflow-src.xml">source file</a> for the diagram used in this post, and edit it
with <a href="https://draw.io">draw.io</a>.</p><!-- html -->
    
<p class="postmetadata">
    
    <small>tags 
     [&nbsp;<a
        href="/tag/cylc"
        rel="tag">cylc</a>&nbsp;]&nbsp;
    
     [&nbsp;<a
        href="/tag/python"
        rel="tag">python</a>&nbsp;]&nbsp;
    
     [&nbsp;<a
        href="/tag/opensource"
        rel="tag">opensource</a>&nbsp;]&nbsp;
    
    </small>
    
    
</p>
</div>




<div class="ui raised padded container segment">
    <h2><a href="/2018/07/10/import-error-when-debugging-cylc-in-eclipse" title="Permanent link">ImportError when debugging cylc in Eclipse</a></h2>
    <p><small>kinow</small> @ <small>Jul 10, 2018&nbsp;00:47:13</small></p>
    
    





<a href="https://twitter.com/share" class="twitter-share-button" data-url="https://kinoshita.eti.br/2018/07/10/import-error-when-debugging-cylc-in-eclipse" data-text="ImportError when debugging cylc in Eclipse" data-via="kinow" data-hashtags="opensource">Tweet</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p='https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>


    <p>Since I started reading cylc&#8217;s source code in Eclipse to create some
sequence diagrams, I have not been able to debug it properly without
hitting errors in some part of the program execution.</p>
<p>The error message was <strong><em>&ldquo;ImportError: cannot import name _remove_dead_weakref&rdquo;</em></strong>,
which was a bit enigmatic as I never heard about that function, but it seemed to be
something internal, or at least not from the project code base. And searching the Internet
did not help much.</p>
<p>Here is the complete console output in Eclipse.</p>
<div class="highlight"><pre><span></span>pydev debugger: starting <span class="o">(</span>pid: <span class="m">15124</span><span class="o">)</span>
timeout <span class="m">10</span> ps -opid,args <span class="m">13640</span>  <span class="c1"># return 1</span>

            ._.                                                       
            <span class="p">|</span> <span class="p">|</span>            The Cylc Suite Engine <span class="o">[</span><span class="m">7</span>.7.1-37-g09c8a<span class="o">]</span>    
._____._. ._<span class="p">|</span> <span class="p">|</span>_____.           Copyright <span class="o">(</span>C<span class="o">)</span> <span class="m">2008</span>-2018 NIWA          
<span class="p">|</span> .___<span class="p">|</span> <span class="p">|</span> <span class="p">|</span> <span class="p">|</span> <span class="p">|</span> .___<span class="p">|</span>  _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
<span class="p">|</span> !___<span class="p">|</span> !_! <span class="p">|</span> <span class="p">|</span> !___.  This program comes with ABSOLUTELY NO WARRANTY<span class="p">;</span>
!_____!___. <span class="p">|</span>_!_____!  see <span class="sb">`</span>cylc warranty<span class="sb">`</span>.  It is free software, you 
      .___! <span class="p">|</span>           are welcome to redistribute it under certain  
      !_____!                conditions<span class="p">;</span> see <span class="sb">`</span>cylc conditions<span class="sb">`</span>.       
<span class="m">2018</span>-07-10T01:00:47+12 INFO - Suite starting: <span class="nv">server</span><span class="o">=</span>localhost:44444 <span class="nv">pid</span><span class="o">=</span><span class="m">15124</span>
<span class="m">2018</span>-07-10T01:00:47+12 INFO - Cylc version: <span class="m">7</span>.7.1-37-g09c8a
<span class="m">2018</span>-07-10T01:00:47+12 INFO - Run mode: live
<span class="m">2018</span>-07-10T01:00:47+12 INFO - Initial point: <span class="m">1</span>
<span class="m">2018</span>-07-10T01:00:47+12 INFO - Final point: None
<span class="m">2018</span>-07-10T01:00:47+12 INFO - Cold Start <span class="m">1</span>
<span class="m">2018</span>-07-10T01:00:47+12 DEBUG - <span class="o">[</span>hello.1<span class="o">]</span> -released to the task pool
<span class="m">2018</span>-07-10T01:00:47+12 DEBUG - BEGIN TASK PROCESSING
<span class="m">2018</span>-07-10T01:00:47+12 DEBUG - <span class="o">[</span>hello.1<span class="o">]</span> -waiting <span class="o">=</span>&gt; queued
<span class="m">2018</span>-07-10T01:00:47+12 DEBUG - <span class="m">1</span> task<span class="o">(</span>s<span class="o">)</span> de-queued
<span class="m">2018</span>-07-10T01:00:47+12 INFO - <span class="o">[</span>hello.1<span class="o">]</span> -submit-num<span class="o">=</span><span class="m">1</span>, owner@host<span class="o">=</span>localhost
<span class="m">2018</span>-07-10T01:00:47+12 DEBUG - <span class="o">[</span>hello.1<span class="o">]</span> -queued <span class="o">=</span>&gt; ready
<span class="m">2018</span>-07-10T01:00:47+12 DEBUG - END TASK PROCESSING <span class="o">(</span>took <span class="m">0</span>.023609161377 seconds<span class="o">)</span>
<span class="m">2018</span>-07-10T01:00:48+12 DEBUG - <span class="o">[</span><span class="s1">&#39;cylc&#39;</span>, <span class="s1">&#39;jobs-submit&#39;</span>, <span class="s1">&#39;--debug&#39;</span>, <span class="s1">&#39;--&#39;</span>, <span class="s1">&#39;/home/kinow/Development/python/workspace/example-suite/log/job&#39;</span>, <span class="s1">&#39;1/hello/01&#39;</span><span class="o">]</span>
<span class="m">2018</span>-07-10T01:00:48+12 ERROR - <span class="o">[</span>jobs-submit cmd<span class="o">]</span> cylc jobs-submit --debug -- /home/kinow/Development/python/workspace/example-suite/log/job <span class="m">1</span>/hello/01
    <span class="o">[</span>jobs-submit ret_code<span class="o">]</span> <span class="m">1</span>
    <span class="o">[</span>jobs-submit err<span class="o">]</span>
    Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
      File <span class="s2">&quot;/home/kinow/Development/python/workspace/cylc/bin/cylc-jobs-submit&quot;</span>, line <span class="m">52</span>, in &lt;module&gt;
        from cylc.batch_sys_manager import BatchSysManager
      File <span class="s2">&quot;/home/kinow/Development/python/workspace/cylc/lib/cylc/batch_sys_manager.py&quot;</span>, line <span class="m">114</span>, in &lt;module&gt;
        from cylc.task_message import <span class="o">(</span>
      File <span class="s2">&quot;/home/kinow/Development/python/workspace/cylc/lib/cylc/task_message.py&quot;</span>, line <span class="m">26</span>, in &lt;module&gt;
        from logging import getLevelName, WARNING, ERROR, CRITICAL
      File <span class="s2">&quot;/home/kinow/Development/python/anaconda2/lib/python2.7/logging/__init__.py&quot;</span>, line <span class="m">26</span>, in &lt;module&gt;
        import sys, os, time, cStringIO, traceback, warnings, weakref, collections
      File <span class="s2">&quot;/home/kinow/Development/python/anaconda2/lib/python2.7/weakref.py&quot;</span>, line <span class="m">14</span>, in &lt;module&gt;
        from _weakref import <span class="o">(</span>
    ImportError: cannot import name _remove_dead_weakref
<span class="m">2018</span>-07-10T01:00:48+12 ERROR - <span class="o">[</span>jobs-submit cmd<span class="o">]</span> cylc jobs-submit --debug -- /home/kinow/Development/python/workspace/example-suite/log/job <span class="m">1</span>/hello/01
    <span class="o">[</span>jobs-submit ret_code<span class="o">]</span> <span class="m">1</span>
    <span class="o">[</span>jobs-submit out<span class="o">]</span> <span class="m">2018</span>-07-10T01:00:48+12<span class="p">|</span><span class="m">1</span>/hello/01<span class="p">|</span><span class="m">1</span>
<span class="m">2018</span>-07-10T01:00:48+12 INFO - <span class="o">[</span>hello.1<span class="o">]</span> -<span class="o">(</span>current:ready<span class="o">)</span> submission failed at <span class="m">2018</span>-07-10T01:00:48+12
<span class="m">2018</span>-07-10T01:00:48+12 ERROR - <span class="o">[</span>hello.1<span class="o">]</span> -submission failed
<span class="m">2018</span>-07-10T01:00:48+12 DEBUG - <span class="o">[</span>hello.1<span class="o">]</span> -ready <span class="o">=</span>&gt; submit-failed
<span class="m">2018</span>-07-10T01:00:48+12 DEBUG - BEGIN TASK PROCESSING
<span class="m">2018</span>-07-10T01:00:48+12 DEBUG - <span class="m">0</span> task<span class="o">(</span>s<span class="o">)</span> de-queued
<span class="m">2018</span>-07-10T01:00:48+12 DEBUG - END TASK PROCESSING <span class="o">(</span>took <span class="m">0</span>.00175499916077 seconds<span class="o">)</span>
<span class="m">2018</span>-07-10T01:00:49+12 WARNING - suite stalled
</pre></div>

<p>As the current diagram I am working on has quite a few <code>if</code>&#8216;s and <code>else</code>&#8216;s, I decided
to investigate why this error was occurring. Then, after some elimination I found that
it was due to the missing Anaconda 2 entry in my <code>$PATH</code> environment variable.</p>
<p>I had this variable configured in a custom script I load whenever I decide to use
Anaconda 2. And reproducing the same behaviour in Eclipse was easy.</p>
<p style='text-align: center;'>
<img style="display: inline" class="ui image" src="/2018/07/10/import-error-when-debugging-cylc-in-eclipse/screenshot1.png" alt="A screen shot of Eclipse with source code" title="Locating the bug" />
<br/>
<small>Locating the bug</small>
</p>

<p>Et voil&agrave;! Eclipse was happily debugging again!</p>
<p style='text-align: center;'>
<img style="display: inline" class="ui image" src="/2018/07/10/import-error-when-debugging-cylc-in-eclipse/screenshot2.png" alt="A screen shot of Eclipse with source code" title="Locating the bug" />
<br/>
<small>Locating the bug</small>
</p>

<p>So if you have a similar problem, try comparing your environment variables and check if you
have some entries missing, and try adding them in Eclipse Debug configuration.</p>
<p>Happy cycling!</p><!-- html -->
    
<p class="postmetadata">
    
    <small>tags 
     [&nbsp;<a
        href="/tag/cylc"
        rel="tag">cylc</a>&nbsp;]&nbsp;
    
     [&nbsp;<a
        href="/tag/python"
        rel="tag">python</a>&nbsp;]&nbsp;
    
     [&nbsp;<a
        href="/tag/opensource"
        rel="tag">opensource</a>&nbsp;]&nbsp;
    
    </small>
    
    
</p>
</div>




<div class="ui raised padded container segment">
    <h2><a href="/2018/07/08/a-simple-cylc-suite" title="Permanent link">A simple cylc suite</a></h2>
    <p><small>kinow</small> @ <small>Jul 08, 2018&nbsp;18:59:13</small></p>
    
    





<a href="https://twitter.com/share" class="twitter-share-button" data-url="https://kinoshita.eti.br/2018/07/08/a-simple-cylc-suite" data-text="A simple cylc suite" data-via="kinow" data-hashtags="opensource">Tweet</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p='https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>


    <p>I have been writing more suites for <a href="https://cylc.github.io/cylc/">cylc</a> lately, and found
an example that has proved to be useful for debugging certain parts of the code.</p>
<p>It is an extremely simple suite, similar to what is in cylc&#8217;s documentation. It
sleeps for N seconds, and prints a message.</p>
<p>What makes it extra simpler, is that it cycles through integers, and has
a limit of 1 maximum active points.</p>
<p>It is essentially the same as running the command in your shell session. With
the difference that it will run through all cylc&#8217;s internal, only once, and
allow you to debug and diagnostic parts nor related to cycling and graphs
(as for these parts you would probably need a more elaborate example).</p>
<div class="highlight"><pre><span></span><span class="p">[</span><span class="n">scheduling</span><span class="p">]</span>
    <span class="n">cycling</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">integer</span>
    <span class="n">initial</span> <span class="n">cycle</span> <span class="n">point</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="nb">max</span> <span class="n">active</span> <span class="n">cycle</span> <span class="n">points</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="p">[[</span><span class="n">dependencies</span><span class="p">]]</span>
        <span class="p">[[[</span><span class="n">P1</span><span class="p">]]]</span>
            <span class="n">graph</span> <span class="o">=</span> <span class="s2">&quot;hello&quot;</span>
<span class="p">[</span><span class="n">runtime</span><span class="p">]</span>
    <span class="p">[[</span><span class="n">hello</span><span class="p">]]</span>
        <span class="n">script</span> <span class="o">=</span> <span class="s2">&quot;sleep 10; echo PING&quot;</span>
</pre></div>

<p>I also combine this suite with the following <code>global.rc</code>.</p>
<div class="highlight"><pre><span></span><span class="p">[</span><span class="n">editors</span><span class="p">]</span> 
    <span class="n">terminal</span> <span class="o">=</span> <span class="n">vim</span> 
    <span class="n">gui</span> <span class="o">=</span> <span class="n">gvim</span> <span class="o">-</span><span class="n">f</span>

<span class="p">[</span><span class="n">communication</span><span class="p">]</span>
    <span class="n">base</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">44444</span>
    <span class="n">method</span> <span class="o">=</span> <span class="n">http</span>
    <span class="n">maximum</span> <span class="n">number</span> <span class="n">of</span> <span class="n">ports</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>

<p>With &#8220;base port&#8221; set to 44444, and the maximum number of ports to 1, I will
be able to run only one task. But that way I can configure Wireshark and other
tools to default to 44444/HTTP, for ease of debugging.</p>
<p>Then initialize the suite with something like: <code>cylc start --non-daemon --debug /home/kinow/Development/python/workspace/example-suite/</code></p>
<p>Happy cycling!</p><!-- html -->
    
<p class="postmetadata">
    
    <small>tags 
     [&nbsp;<a
        href="/tag/cylc"
        rel="tag">cylc</a>&nbsp;]&nbsp;
    
     [&nbsp;<a
        href="/tag/python"
        rel="tag">python</a>&nbsp;]&nbsp;
    
     [&nbsp;<a
        href="/tag/opensource"
        rel="tag">opensource</a>&nbsp;]&nbsp;
    
    </small>
    
    
</p>
</div>




<div class="ui raised padded container segment">
    <h2><a href="/2017/09/09/enabling-markdown-extension-tables-for-piecrust" title="Permanent link">Enabling Markdown Extension Tables For Piecrust</a></h2>
    <p><small>kinow</small> @ <small>Sep 09, 2017&nbsp;20:35:01</small></p>
    
    





<a href="https://twitter.com/share" class="twitter-share-button" data-url="https://kinoshita.eti.br/2017/09/09/enabling-markdown-extension-tables-for-piecrust" data-text="Enabling Markdown Extension Tables For Piecrust" data-via="kinow" data-hashtags="opensource">Tweet</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p='https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>


    <p><a href="https://github.com/ludovicchabant/PieCrust2">PieCrust</a> is a Python static site generator.
It allows users to write content in Markdown. But if you try adding a table, the content by
default will be generated as plain text.</p>
<p>You have to enable <a href="https://pythonhosted.org/Markdown/extensions/tables.html">Markdown extension tables</a>.
PieCrust will <a href="https://github.com/ludovicchabant/PieCrust2/blob/6462e052045552d2ba164f4965370d84ddb54946/piecrust/formatting/markdownformatter.py#L29">load it</a>
when creating the Markdown instance.</p>
<div class="highlight"><pre><span></span><span class="c1"># config.yml</span>
<span class="l l-Scalar l-Scalar-Plain">markdown</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">extensions</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">tables</span>
</pre></div>

<p>Et, voil&agrave;! Happy blogging!</p>
<p>&hearts; Open Source</p><!-- html -->
    
<p class="postmetadata">
    
    <small>tags 
     [&nbsp;<a
        href="/tag/programming"
        rel="tag">programming</a>&nbsp;]&nbsp;
    
     [&nbsp;<a
        href="/tag/python"
        rel="tag">python</a>&nbsp;]&nbsp;
    
     [&nbsp;<a
        href="/tag/opensource"
        rel="tag">opensource</a>&nbsp;]&nbsp;
    
    </small>
    
    
</p>
</div>




<div class="ui raised padded container segment">
    <h2><a href="/2017/06/14/how-to-remove-the-signature-from-emails-with-nlp" title="Permanent link">How to remove the signature from e-mails with NLP?</a></h2>
    <p><small>kinow</small> @ <small>Jun 14, 2017&nbsp;13:59:33</small></p>
    
    





<a href="https://twitter.com/share" class="twitter-share-button" data-url="https://kinoshita.eti.br/2017/06/14/how-to-remove-the-signature-from-emails-with-nlp" data-text="How to remove the signature from e-mails with NLP?" data-via="kinow" data-hashtags="opensource">Tweet</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p='https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>


    <p>Some time ago I stumbled across <a href="https://github.com/mynameisvinn/EmailParser">EmailParser</a>, a Python utility to remove e-mail signatures. Here&#8217;s a sample input e-mail from the project documentation.</p>
<div class="highlight"><pre><span></span>Wendy – thanks for the intro! Moving you to bcc.

Hi Vincent – nice to meet you over email. Apologize for the late reply, I was on PTO for a couple weeks and this is my first week back in office. As Wendy mentioned, I am leading an AR/VR taskforce at Foobar Retail Solutions. The goal of the taskforce is to better understand how AR/VR can apply to retail/commerce and if/what is the role of a shopping center in AR/VR applications for retail.

Wendy mentioned that you would be a great person to speak to since you are close to what is going on in this space. Would love to set up some time to chat via phone next week. What does your availability look like on Monday or Wednesday?

Best,
Joe Smith

Joe Smith | Strategy &amp; Business Development
111 Market St. Suite 111| San Francisco, CA 94103
M: 111.111.1111| joe@foobar.com
</pre></div>

<p>And here&#8217;s what it looks like afterwards.</p>
<div class="highlight"><pre><span></span>Wendy – thanks for the intro! Moving you to bcc.

Hi Vincent – nice to meet you over email. Apologize for the late reply, I was on PTO for a couple weeks and this is my first week back in office. As Wendy mentioned, I am leading an AR/VR taskforce at Foobar Retail Solutions. The goal of the taskforce is to better understand how AR/VR can apply to retail/commerce and if/what is the role of a shopping center in AR/VR applications for retail.

Wendy mentioned that you would be a great person to speak to since you are close to what is going on in this space. Would love to set up some time to chat via phone next week. What does your availability look like on Monday or Wednesday?
</pre></div>

<p>As you can see, it removed all the lines after the main part of the message (i.e. after the three paragraphs). Here&#8217;s what the Python code looks like.</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">Parser</span> <span class="kn">import</span> <span class="n">read_email</span><span class="p">,</span> <span class="n">strip</span><span class="p">,</span> <span class="n">prob_block</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">spacy.en</span> <span class="kn">import</span> <span class="n">English</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">English</span><span class="p">()</span>  <span class="c1"># part-of-speech tagger</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">msg_raw</span> <span class="o">=</span> <span class="n">read_email</span><span class="p">(</span><span class="s1">&#39;emails/test1.txt&#39;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">msg_stripped</span> <span class="o">=</span> <span class="n">strip</span><span class="p">(</span><span class="n">msg_raw</span><span class="p">)</span>  <span class="c1"># preprocessing text before POS tagging</span>

<span class="c1"># iterate through lines, write to file if not signature block</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">generate_text</span><span class="p">(</span><span class="n">msg_stripped</span><span class="p">,</span> <span class="o">.</span><span class="mi">9</span><span class="p">,</span> <span class="n">pos_tagger</span><span class="p">,</span> <span class="s1">&#39;emails/test1_clean.txt&#39;</span><span class="p">)</span>
</pre></div>

<p>What got me interested about this utility was the use of NLP. I couldn&#8217;t imagine how someone could use NLP for that. And I liked the simplicity of the approach, which is not perfect, but can be useful someday.</p>
<p>After the imports in the code, it creates a <a href="https://en.wikipedia.org/wiki/Part_of_speech">Part of Speech</a> tagger using <a href="https://spacy.io/">spaCy</a> NLP library, reads the e-mail from a file, and sripts and creates an array with each paragraph of the message.</p>
<p>The magic happens in the <code>generate_text</code> function, which receives the <strong>array of paragraphs</strong>, a <strong>threshold</strong>, the <strong>POS tagger</strong>, and the <strong>output destination</strong>. Here&#8217;s what the function does.</p>
<div class="highlight"><pre><span></span>for each message
    if probability ( signature block | message ) &lt; threshold
        write to output file
</pre></div>

<p>And the formula for calculating the probability is quite simple too.</p>
<div class="highlight"><pre><span></span>1. For a given paragraph (message block), find all the sentences in it.
2. Then for each word (token) in the sentence, count the number of times a non-verb appears.
3. Return the proportion of non-verbs per sentence, i.e. number of non-verbs / number of sentences.
</pre></div>

<p>In summary, it discards blocks that do not contain enough verbs to be considered a message block, being treated as signature blocks instead.</p>
<p>Never thought about using an approach like this. It may definitely be helpful when doing data analysis, information retrieval, or scraping data from the web. Not necessarily with e-mails and signatures, but you got the gist of it.</p>
<p>&hearts; Open Source</p><!-- html -->
    
<p class="postmetadata">
    
    <small>tags 
     [&nbsp;<a
        href="/tag/python"
        rel="tag">python</a>&nbsp;]&nbsp;
    
     [&nbsp;<a
        href="/tag/programming"
        rel="tag">programming</a>&nbsp;]&nbsp;
    
     [&nbsp;<a
        href="/tag/natural%20language%20processing"
        rel="tag">natural language processing</a>&nbsp;]&nbsp;
    
     [&nbsp;<a
        href="/tag/opensource"
        rel="tag">opensource</a>&nbsp;]&nbsp;
    
    </small>
    
    
</p>
</div>




<div id="navigation">
    
        &larr;&nbsp;<a href="/tag/python/3" id="navigation-next">Older Entries</a>
    
    
        &mdash; <a href="/tag/python" id="navigation-next">Newer Entries</a>&nbsp;&rarr;
    
</div>



               </div>
            </div>
        </div>
        <div class="ui vertical footer segment" id="footer">
            <div class="ui center aligned container">
                           <div id="copy" class="">
                <p>&copy; <a href="/about"><span
                            class="b">Bru</span><span
                            class="r">no de</span> <span
                            class="a">Paula</span> <span
                            class="s"></span><span
                            class="i">Kinos</span><span
                            class="l">hita</span></a>
                </p>
            </div>
            </div>
         </div>
    </div>
</body>
</html>
<script src="/js/jquery-2.2.3.min.js"  type="text/javascript"></script>
<script src="/css/semantic/dist/semantic.min.js"  type="text/javascript"></script>
<script src="/js/jquery.prettyPhoto.js"></script>
<script src="/js/site.js"></script>