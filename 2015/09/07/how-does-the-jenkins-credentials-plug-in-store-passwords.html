<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta property="og:title" content="How does the Jenkins Credentials Plug-in store passwords?">
<meta property="og:description" content="Jenkins Credentials Plug-in manages credentials stored in Jenkins. These credentials can be used in many jobs and by plug-ins for executing SSH commands, authenticating to systems, or running other commands that need some sort of authentication or authorisation.
I recently used its API for the first time in the BioUno figshare Plug-in to store OAuth 1.0 credentials (consumer key, consumer secret, token key, token secret). This blog post has more details about how we used the plug-in, but this post is specifically on how the passwords are stored by Jenkins.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://kinoshita.eti.br/2015/09/07/how-does-the-jenkins-credentials-plug-in-store-passwords.html"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2015-09-07T00:00:00+00:00">
<meta property="article:modified_time" content="2015-09-07T00:00:00+00:00">
<link rel=stylesheet type=text/css href=https://kinoshita.eti.br/sass/main.d0c0e1ab7ed40e27e85fb9acbf415173c83aa709e80fa6e8cbe84888ed8502e0.css integrity="sha256-0MDhq37UDifoX7msv0FRc8g6pwnoD6boy+hIiO2FAuA=">
<title>kinow | How does the Jenkins Credentials Plug-in store passwords?</title>
</head>
<body>
<header role=banner class=content>
<nav id=nav aria-label=Main role=navigation class=content>
<ul><li>
<a href=/><i data-feather=about></i> About</a>
</li><li>
<a href=/blog/><i data-feather=blog></i> Blog</a>
</li><li>
<a href=/portfolio/><i data-feather=portfolio></i> Portfolio</a>
</li>
</ul>
</nav>
</header>
<main>
<article class=content>
<h1>How does the Jenkins Credentials Plug-in store passwords?</h1><div class=metadata>
<i data-feather=calendar></i>
<time datetime=2015-09-07>Sep 7, 2015</time>
</div>
<p><a href=https://wiki.jenkins-ci.org/display/JENKINS/Credentials+Plugin>Jenkins Credentials Plug-in</a> manages credentials stored in Jenkins. These credentials can be used in many jobs and by plug-ins for executing SSH commands, authenticating to systems, or running other commands that need some sort of authentication or authorisation.</p>
<p>I recently used its API for the first time in the <a href=https://github.com/biouno/figshare-plugin>BioUno figshare Plug-in</a> to store OAuth 1.0 credentials (consumer key, consumer secret, token key, token secret). This <a href=http://biouno.org/2015/09/05/using_jenkins_credentials_plugin_to_create_the_biouno_figshare_plugin/>blog post</a> has more details about how we used the plug-in, but this post is specifically on how the passwords are stored by Jenkins.</p>
<h2 id=secret-and-ciphers>Secret and ciphers</h2>
<p>Jenkins stores its configuration on disk as XML using the XStream library. Plug-in developers using the Credentials Plug-in API must use the <strong>Secret</strong> class to encrypt sensitive information.</p>
<p>The <code>Secret.fromString</code> method is responsible for creating a cipher from a given String. As in the Secret Javadoc, <em>&ldquo;this is not meant as a protection against code running in the same VM, nor against an attacker who has local file system access on Jenkins master&rdquo;</em>. But at least makes things more complicated :-)</p>
<ul>
<li><a href=http://javadoc.jenkins-ci.org/hudson/util/Secret.html>Secret Javadoc</a></li>
<li><a href=https://github.com/jenkinsci/jenkins/blob/master/core/src/main/java/hudson/util/Secret.java>Secret source code</a></li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:navy;font-weight:700>public</span> <span style=color:navy;font-weight:700>static</span> Secret fromString(String data) {
    data = Util.<span style=color:red>fixNull</span>(data);
    Secret s = decrypt(data);
    <span style=color:navy;font-weight:700>if</span>(s==<span style=color:navy;font-weight:700>null</span>) s=<span style=color:navy;font-weight:700>new</span> Secret(data);
    <span style=color:navy;font-weight:700>return</span> s;
}
</code></pre></div><p>The first line simply replaces a null string by an empty &ldquo;&rdquo;, or keeps the current value of not null.</p>
<p>After that, the decrypt method is called.</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:navy;font-weight:700>public</span> <span style=color:navy;font-weight:700>static</span> Secret decrypt(String data) {
    <span style=color:navy;font-weight:700>if</span>(data==<span style=color:navy;font-weight:700>null</span>)      <span style=color:navy;font-weight:700>return</span> <span style=color:navy;font-weight:700>null</span>;
    <span style=color:navy;font-weight:700>try</span> {
        <span style=color:navy;font-weight:700>byte</span>[] in = Base64.<span style=color:red>decode</span>(data.<span style=color:red>toCharArray</span>());
        Secret s = tryDecrypt(KEY.<span style=color:red>decrypt</span>(), in);
        <span style=color:navy;font-weight:700>if</span> (s!=<span style=color:navy;font-weight:700>null</span>)    <span style=color:navy;font-weight:700>return</span> s;

        <span style=color:#080;font-style:italic>// try our historical key for backward compatibility
</span><span style=color:#080;font-style:italic></span>        Cipher cipher = getCipher(<span style=color:#00f>&#34;AES&#34;</span>);
        cipher.<span style=color:red>init</span>(Cipher.<span style=color:red>DECRYPT_MODE</span>, getLegacyKey());
        <span style=color:navy;font-weight:700>return</span> tryDecrypt(cipher, in);
    } <span style=color:navy;font-weight:700>catch</span> (GeneralSecurityException e) {
        <span style=color:navy;font-weight:700>return</span> <span style=color:navy;font-weight:700>null</span>;
    } <span style=color:navy;font-weight:700>catch</span> (UnsupportedEncodingException e) {
        <span style=color:navy;font-weight:700>throw</span> <span style=color:navy;font-weight:700>new</span> Error(e); <span style=color:#080;font-style:italic>// impossible
</span><span style=color:#080;font-style:italic></span>    } <span style=color:navy;font-weight:700>catch</span> (IOException e) {
        <span style=color:navy;font-weight:700>return</span> <span style=color:navy;font-weight:700>null</span>;
    }
}
</code></pre></div><p>The <code>KEY.decrypt()</code> call will return a <a href=http://docs.oracle.com/javase/8/docs/api/javax/crypto/Cipher.html><code>javax.crypto.Cipher</code></a>. The Cipher class is handled in <a href=https://github.com/jenkinsci/jenkins/blob/93dfe3377ec8d430818f5b9073f16c677343adb4/core/src/main/java/jenkins/security/CryptoConfidentialKey.java>CryptoConfidentialKey</a> in Jenkins API, where it defines the algorithm used to create the cipher: <a href=https://en.wikipedia.org/wiki/Advanced_Encryption_Standard>AES</a>.</p>
<p>Jenkins has also a <a href=https://github.com/jenkinsci/jenkins/blob/93dfe3377ec8d430818f5b9073f16c677343adb4/core/src/main/java/jenkins/security/ConfidentialStore.java#L63>ConfidentialStore</a>, that is required to create the cipher. This class must be initialized before someone tries to create or read a cipher. This extra step also increases security, though access to the JVM is still a problem.</p>
<p>It is a bit late, so it is all for today. In summary: the credentials plug-in gives you a central place to manage credentials, but it is up to plug-in developers to use it. Sensitive values can be encrypted with AES on disk. So it is important that your file permissions, ACL and system auditing processes are in place and well maintained and monitored.</p>
<p>Happy hacking!</p>
<aside class=links>
<a class=previous href=https://kinoshita.eti.br/2015/06/23/modeling-observation-data-in-sos-sensor-observation-service.html>&#171; Previous</a>
<a class=next href=https://kinoshita.eti.br/2016/02/27/learning-afl-and-testing-mapserver.html>Next &#187;</a>
</aside>
</article>
</main>
<footer role=contentinfo>
<ul id=social-media-icons>
<li>
<a href=https://www.instagram.com/brunokinoshita/>
<img src=/assets/icons/instagram.png alt="Instagram link">
</a>
</li>
<li>
<a href=https://twitter.com/kinow/>
<img src=/assets/icons/twitter.png alt="Twitter link">
</a>
</li>
<li>
<a href=https://github.com/kinow/>
<img src=/assets/icons/github.png alt="GitHub link">
</a>
</li>
<li>
<a href=/feed.xml>
<img src=/assets/icons/news.png alt="RSS feed link">
</a>
</li>
</ul>
</footer>
</body>
</html>