<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Page 6 of 28 for Blog - page 6 | Bruno P. Kinoshita</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Blog - page 6" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Bruno P. Kinoshita personal home page" />
<meta property="og:description" content="Bruno P. Kinoshita personal home page" />
<link rel="canonical" href="https://kinoshita.eti.br/blog/page/6/" />
<meta property="og:url" content="https://kinoshita.eti.br/blog/page/6/" />
<meta property="og:site_name" content="Bruno P. Kinoshita" />
<link rel="prev" href="https://kinoshita.eti.br/blog/page/5/" />
<link rel="next" href="https://kinoshita.eti.br/blog/page/7/" />
<script type="application/ld+json">
{"description":"Bruno P. Kinoshita personal home page","@type":"WebPage","url":"https://kinoshita.eti.br/blog/page/6/","headline":"Blog - page 6","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/main.css"><link type="application/atom+xml" rel="alternate" href="https://kinoshita.eti.br/feed.xml" title="Bruno P. Kinoshita" /><link href="https://unpkg.com/pattern.css" rel="stylesheet">

</head>
<body>
<div id="mobile-menu"><div class="menu">
  <ul class="menu">
    <li class="item">
      <h1 id="kinow">KINOW</h1>
    </li>
    <li class="item">
      <a href="/" class="">About</a>
    </li>
    <li class="item">
      <a href="/blog/" class="">Blog</a>
    </li>
    <li class="item">
      <a href="/portfolio/" class="">Portfolio</a>
    </li>
  </ul>
</div>
</div>
<div id="wrapper">
  <div id="sidebar"><div class="menu">
  <ul class="menu">
    <li class="item">
      <h1 id="kinow">KINOW</h1>
    </li>
    <li class="item">
      <a href="/" class="">About</a>
    </li>
    <li class="item">
      <a href="/blog/" class="">Blog</a>
    </li>
    <li class="item">
      <a href="/portfolio/" class="">Portfolio</a>
    </li>
  </ul>
</div>
</div>
  <div id="content">
    <h1 class="page-heading">Blog - page 6</h1>

<div class="blog"><div class="post">
  <h3 class="post-header">
    <a class="post-link" href="/2018/05/29/what-happens-when-you-create-a-new-dataset-in-apache-jena-fuseki.html">
      What happens when you create a new dataset in Apache Jena Fuseki
    </a>
  </h3><span class="post-meta">May 29, 2018<span>&mdash; star date: -304509.59.</span></span>
  <span class="post-meta">Number of words: 0.</span><p><a href="/2018/05/27/what-happens-when-you-upload-a-turtle-file-in-apache-jena-fuseki.html">Last post</a>
was about what happens when you upload a Turtle file to Apache Jena Fuseki. And now today’s post will be about
what happens when you create a new dataset in Apache Jena Fuseki.</p>

<p>In theory, that happens before you upload a Turtle file, but this post series won’t follow a logical order.
It will be more based on what I find interesting.</p>

<p>Oh, the dataset created is <strong>an in-memory dataset</strong>. Here’s a simplified sequence diagram. Again,
these articles are more brain-dumps, used by myself for later reference.</p>

<p><img style="display: inline; width: 100%;" class="ui image" src="/assets/posts/2018-05-29-what-happens-when-you-create-a-new-dataset-in-apache-jena-fuseki/sequence-diagram.png" /></p>

<p class="more-link">
    <a class="post-link" href="/2018/05/29/what-happens-when-you-create-a-new-dataset-in-apache-jena-fuseki.html">Continue reading&hellip;</a>
  </p></div>
<div class="post">
  <h3 class="post-header">
    <a class="post-link" href="/2018/05/27/what-happens-when-you-upload-a-turtle-file-in-apache-jena-fuseki.html">
      What happens when you upload a Turtle file in Apache Jena Fuseki
    </a>
  </h3><span class="post-meta">May 27, 2018<span>&mdash; star date: -304515.07.</span></span>
  <span class="post-meta">Number of words: 0.</span><p>I am working on <a href="https://github.com/NatLibFi/Skosmos/issues/738">an issue for Skosmos</a>
that involves preparing some <a href="https://www.w3.org/TR/turtle/">Turtle</a> files and uploading
them using Apache Jena Fuseki’s web interface.</p>

<p>The issue is now pending feedback, which gives me a moment to have fun with
something else. So I decided to dig down the rabbit hole and start learning more
about certain parts of the Apache Jena code base.</p>

<p style="text-align: center;">
<img style="display: inline; width: 600px;" class="ui image" src="/assets/posts/2018-05-27-what-happens-when-you-upload-a-turtle-file-in-apache-jena-fuseki/browser.png" />
</p>

<p>This post will be useful to myself in the future, as a note-taking in a series, so that I
remember how things work - you never know right? But hopefully this will be useful
to other wanting to understand more about the code of Apache Jena.</p>

<h3 id="where-upload-happens---sparql_upload-and-upload-fuseki-core">Where upload happens - SPARQL_Upload and Upload (Fuseki Core)</h3>

<p>Knowing a bit of the code base, I went straight to the <code class="language-plaintext highlighter-rouge">SPARQL_Upload</code> class,
from the Fuseki Core module. Set up a couple of breakpoints, uploaded my file,
but nothing. Then tried on its package-neighbour class, <code class="language-plaintext highlighter-rouge">Upload</code>.</p>

<p>Actually, it is easier to understand seeing the class hierarchy, and knowing
that when I run the application in Eclipse, it is running with Jetty, serving
servlets (there is no framework like Wicket, Struts, etc, involved).</p>

<p style="text-align: center;">
<img style="display: inline; width: 600px;" class="ui image" src="/assets/posts/2018-05-27-what-happens-when-you-upload-a-turtle-file-in-apache-jena-fuseki/class-hierarchy.png" />
</p>

<p>Several filters are applied to the HTTP request too, like Cross Origin, Shiro, and
the <code class="language-plaintext highlighter-rouge">FusekiFilter</code>. The latter looks at the requests to see if it includes a dataset.
If a dataset is found - it is in our case - then it hands the request over to
the right class to handle it.</p>

<p>REST_Quads_RW will take care of the upload action, using the <code class="language-plaintext highlighter-rouge">Upload</code> class where my
breakpoint stopped.</p>

<h3 id="uploadincomingdata-fuseki-core">Upload#incomingData() (Fuseki Core)</h3>

<p><code class="language-plaintext highlighter-rouge">Upload#incomingData()</code> starts by checking the Content Type from the request. In my case
it is a <code class="language-plaintext highlighter-rouge">multipart/form-data</code>. Then it calls its other method <code class="language-plaintext highlighter-rouge">#fileUploadWorker()</code>.</p>

<p><code class="language-plaintext highlighter-rouge">#fileUploadWorker()</code> creates a <code class="language-plaintext highlighter-rouge">ServletFilterUpload</code>, from Apache Commons FileUpload.
With that, it opens a stream for the file, retrieves its name and other information,
such as the content type.</p>

<p>Ah, the content type is interesting too. It defaults to <code class="language-plaintext highlighter-rouge">RDFXML</code>, but what’s interesting
is the comment.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="o">(</span> <span class="n">lang</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">)</span>
    <span class="c1">// Desperate.</span>
    <span class="n">lang</span> <span class="o">=</span> <span class="nc">RDFLanguages</span><span class="o">.</span><span class="na">RDFXML</span> <span class="o">;</span>
</code></pre></div></div>

<p>Well, in this case we are getting a <code class="language-plaintext highlighter-rouge">Lang:Turtle</code>. So it now knows that it has a Turtle
file, but it still needs to parse it.</p>

<h3 id="actionlibparse-fuseki-core">ActionLib#parse() (Fuseki Core)</h3>

<p><code class="language-plaintext highlighter-rouge">Upload</code> calls <code class="language-plaintext highlighter-rouge">ActionLib#parse()</code>, which uses <code class="language-plaintext highlighter-rouge">RDFParserBuilder</code> to build a parser.
It applies a nice fluent API design when doing that.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">RDFParser</span><span class="o">.</span><span class="na">create</span><span class="o">()</span>
    <span class="o">.</span><span class="na">errorHandler</span><span class="o">(</span><span class="n">errorHandler</span><span class="o">)</span>
    <span class="o">.</span><span class="na">source</span><span class="o">(</span><span class="n">input</span><span class="o">)</span>
    <span class="o">.</span><span class="na">lang</span><span class="o">(</span><span class="n">lang</span><span class="o">)</span>
    <span class="o">.</span><span class="na">base</span><span class="o">(</span><span class="n">base</span><span class="o">)</span>
    <span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">dest</span><span class="o">);</span>
</code></pre></div></div>

<blockquote>Side note to self: the `RDFParser` has a `canUse` flag. It seems to indicate
the parser can be used just once. Though it looks actually it works until the stream
is closed...</blockquote>

<p>So <code class="language-plaintext highlighter-rouge">RDFParserBuilder</code> will call <code class="language-plaintext highlighter-rouge">RDFParser</code>, which in turn will use the
classes <code class="language-plaintext highlighter-rouge">LangTurtle</code> and <code class="language-plaintext highlighter-rouge">LangTurtleBase</code>.</p>

<h3 id="langturtle-arq">LangTurtle (ARQ)</h3>

<p>ARQ is a low level module in Jena, responsible for parsing queries, and also
some of the interaction with graphs and datasets.</p>

<p><code class="language-plaintext highlighter-rouge">LangTurtle</code> extends <code class="language-plaintext highlighter-rouge">LangTurtleBase</code>. Their task starts by populating
the <code class="language-plaintext highlighter-rouge">prefixMap</code>, which contains all those prefixes used in queries like
<code class="language-plaintext highlighter-rouge">rdfs</code>, <code class="language-plaintext highlighter-rouge">void</code>, <code class="language-plaintext highlighter-rouge">skos</code>, <code class="language-plaintext highlighter-rouge">etc</code>.</p>

<p>Then it will keep parsing <strong>triples</strong> until it finds an <code class="language-plaintext highlighter-rouge">EOF</code>. For every
triple, after the <em>Predicate-Object-List</em> is found, it calls
<code class="language-plaintext highlighter-rouge">LangTurtle#emit()</code>.</p>

<p>The <code class="language-plaintext highlighter-rouge">#emit()</code>method creates a <code class="language-plaintext highlighter-rouge">Triple</code> object (Jena Core, graph package).
And also a <code class="language-plaintext highlighter-rouge">StreamRDFCountingBase</code> to keep track of statistics to display
back to the user.</p>

<p style="text-align: center;">
<img style="display: inline; width: 600px;" class="ui image" src="/assets/posts/2018-05-27-what-happens-when-you-upload-a-turtle-file-in-apache-jena-fuseki/eclipse.png" />
</p>

<p><code class="language-plaintext highlighter-rouge">StreamRDFCountingBase</code> extends <code class="language-plaintext highlighter-rouge">StreamRDFWrapper</code>, and wraps - as per name -
other <code class="language-plaintext highlighter-rouge">StreamRDF</code>’s, such as <code class="language-plaintext highlighter-rouge">ParserOutputDataset</code>.</p>

<p><code class="language-plaintext highlighter-rouge">ParserOutputDataset</code> holds a reference to the <code class="language-plaintext highlighter-rouge">DatasetGraph</code> and also to the
<code class="language-plaintext highlighter-rouge">prefixMap</code> populated earlier in <code class="language-plaintext highlighter-rouge">LangTurtle</code>. For each <code class="language-plaintext highlighter-rouge">Triple</code> that we have
it will call the <code class="language-plaintext highlighter-rouge">DatasetGraph#add</code> method, creating a new <em>Quad</em> with the
default graph name.</p>

<h3 id="conclusion">Conclusion</h3>

<p>Finally, readers and streams are closed. An <code class="language-plaintext highlighter-rouge">UploadDetails</code> object is created
holding stats collected in <code class="language-plaintext highlighter-rouge">StreamRDFCountingBase</code>, which are also used for
logging.</p>

<p><code class="language-plaintext highlighter-rouge">Upload#incomingPath()</code> will return the <code class="language-plaintext highlighter-rouge">UploadDetails</code>. If there are no errors
then the transaction will be committed. It involves again classes from ARQ and
TDB (for journaling), but that will be for another post.</p>

<p>The final method called in the <code class="language-plaintext highlighter-rouge">Upload</code> class will be <code class="language-plaintext highlighter-rouge">detailsJson()</code>, which
returns the object as JSON. This JSON string is then finally returned to the
user.</p>

<p>So that’s it. Probably the next step will be to learn how <code class="language-plaintext highlighter-rouge">DatasetGraph</code> works,
or maybe more about transactions in Jena.</p>

<p>Happy hacking !</p>
</div>
<div class="post">
  <h3 class="post-header">
    <a class="post-link" href="/2018/04/28/learning-more-about-sparql-and-jena-internals.html">
      Learning more about SPARQL and Jena internals
    </a>
  </h3><span class="post-meta">Apr 28, 2018<span>&mdash; star date: -304597.26.</span></span>
  <span class="post-meta">Number of words: 0.</span><p style="text-align: center;">
<a href="https://kinow.deviantart.com/art/O-Corvo-742473382"><img style="display: inline; width: 600px;" class="ui image" src="/assets/posts/2018-04-28-learning-more-about-sparql-and-jena-internals/ocorvo.jpg" alt="O Corvo" /></a>
<br />
<small><a href="https://kinow.deviantart.com/art/O-Corvo-742473382">O Corvo</a></small>
</p>

<p>Recently a <a href="https://github.com/apache/jena/pull/114/">pull request</a> for Apache Jena
that I started three years ago got merged. Even though it has been three years since
that pull request, there are still many parts of the project code base that I am
not familiar with.</p>

<p>And not only the code, but there are also many concepts about SPARQL, other standards
used in Jena, and internals about triple stores.</p>

<p>The following list contains some presentations and posts that I am reading right now,
while I try to improve my knowledge of SPARQL and Jena internals.</p>

<ul>
  <li><a href="https://www.slideshare.net/olafhartig/the-semantics-of-sparql">The Semantics of SPARQL</a>
    <ul>
      <li>Slides with information from Query parsing to Algebra and evaluating the Query</li>
    </ul>
  </li>
  <li><a href="https://wiki.blazegraph.com/wiki/index.php/SPARQL_Order_Matters">SPARQL Order Matters</a>
    <ul>
      <li>Short but great post from Blazegraph about order in SPARQL queries with JOIN’s
  and LEFT JOIN’s</li>
    </ul>
  </li>
  <li><a href="https://gregheartsfield.com/2012/08/26/jena-arq-query-performance.html">Jena ARQ Query Performance</a>
    <ul>
      <li>Old post, but still very useful. Related to the post above, as it also talks about
  query performances due to the order of statements</li>
    </ul>
  </li>
  <li><a href="http://oracle.readthedocs.io/en/latest/sql/indexes/predicates-lhs-vs-rhs.html">Predicates: LHS vs RHS</a>
    <ul>
      <li>Oracle post for SQL, but this part applies to SPARQL, at least terminology-wise. LHS
  and RHS appear in <a href="https://issues.apache.org/jira/browse/JENA-1534">some SPARQL related tickets</a>
  /documentation too</li>
    </ul>
  </li>
</ul>
</div>
<div class="post">
  <h3 class="post-header">
    <a class="post-link" href="/2018/02/03/r-shiny-plus-ansible-equals-shinynzossorgnz.html">
      R Shiny + Ansible = shiny.nzoss.org.nz
    </a>
  </h3><span class="post-meta">Feb 3, 2018<span>&mdash; star date: -304832.88.</span></span>
  <span class="post-meta">Number of words: 0.</span><p><strong>R Shiny + Ansible = shiny.nzoss.org.nz</strong></p>

<div class="row">
<div class="ui embed">
<iframe src="https://kinow.github.io/auckland-r-meetup-shiny-talk/" frameborder="0" allowfullscreen=""></iframe>
</div>
</div>

<dl>
<dt>Event</dt>
<dd><a href="https://www.meetup.com/Auckland-R-Users-Group-AKLRUG/events/247400612/">R Shiny + Ansible = shiny.nzoss.org.nz</a></dd>
<dt>Where ?</dt>
<dd><a href="https://www.google.com/maps/search/?api=1&amp;query=38+Princes+Street%2C+The+University+of+Auckland%2C+Auckland%2C+nz">Auckland, New Zealand</a></dd>
<dt>When ?</dt>
<dd>2018-02-08</dd>
</dl>
</div>
<div class="post">
  <h3 class="post-header">
    <a class="post-link" href="/2017/12/25/exif-odd-offsets.html">
      Exif Odd Offsets
    </a>
  </h3><span class="post-meta">Dec 25, 2017<span>&mdash; star date: -305934.25.</span></span>
  <span class="post-meta">Number of words: 0.</span><p>A file format like JPEG may contain metadata in JFIF, <a href="https://en.wikipedia.org/wiki/Exif">Exif</a>,
or a vendor proprietary format. The Exif format is based - or uses parts of - on the TIFF format.</p>

<p>Within an Exif metadata block, you should see directories, with several entries. The entries have fields
like description, value, and also an offset. The offset indicates the offset to the next entry.</p>

<p>The Exif specification defines that <strong>implementers must make sure to keep the offset an even number,
within 4 bytes</strong>.</p>

<p>I recently worked on <a href="https://issues.apache.org/jira/browse/IMAGING-205">IMAGING-205</a>, a ticket
about odd offsets in files with Exif metadata. This issue was exactly to address that when files
were rewritten with Apache Commons Imaging, even though the image initially had no odd offsets,
after the entries were rearranged, we could have odd offsets.</p>

<p>The fix was simply checking for odd offsets, adding +1, and later it would be put within the
4 bytes limit.</p>

<p style="text-align: center;">
<img style="display: inline" class="ui image" src="/assets/posts/2017-12-25-exif-odd-offsets/screenshot.png" alt="A screen shot of Eclipse with source code" title="Locating the bug" />
<br />
<small>Locating the bug</small>
</p>

<p>One interesting point, however, is that this is in the standard, but not all software that read
and write Exif follow the specification. So it is quite common to find images with odd offsets.</p>

<p>Which means you could take a picture with your phone, that contains some Exif metadata, and
be surprised to analyze it with <code class="language-plaintext highlighter-rouge">exiftool</code> and get warnings about odd offsets. Most viewers
handle odd and even offsets, so it should work for most cases, unless you have a strict reader/viewer.</p>

<p>Happy hacking!</p>

<p>&amp;heart; Open Source</p>
</div>
<!-- Pagination links -->
  <div class="pagination">
    <p>
      
      <a href="/blog/page/5/" class="icon item">
        <i class="left chevron icon"></i>Previous
      </a>
      
      <span class="page_number ">Page: 6 of 28</span>
      
      <a href="/blog/page/7/" class="next">
        Next<i class="right chevron icon"></i>
      </a>
      
    </p>
  </div></div>

  </div>
</div>
</body>
</html>
