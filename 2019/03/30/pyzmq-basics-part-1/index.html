  
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head profile="http://gmpg.org/xfn/11">
    <title>Bruno P. Kinoshita &mdash; PyZMQ Basics - Part 1</title> 
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="description" content="Bruno de Paula Kinoshita personal web site" />
    <meta name="keywords"
        content="kinoshita, bruno de paula kinoshita, geek, geek stuff, java, python, c, c++, msn now playing, neural network, mackenzie, sao paulo, brasil, brazil, nerd, nerd stuff, cool, jenkins, illustration, quadrinhos, machine learning, linguistic, apache, open source, codigo livre, codigo aberto" />
    <meta name="author" content="" />
    <meta name="generator" content="PieCrust 3.2.1" />
    <meta name="template-engine" content="Twig" />
    <meta name="robots" content="all=index,follow" />
    <meta name="revisit-after" content="15 days" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta name="distribution" content="Global" />
    <meta name="url" content="/" />
    <meta name="copyright" content="Bruno de Paula Kinoshita" />
    <meta name="Googlebot" content="all" />
    <meta name="rating" content="general" />
    <meta http-equiv="expires" content="0" />
    <meta name="city" content="Sao Paulo" />
    <meta name="state" content="Brasil, Sao Paulo" />
    <meta http-equiv="content-language" content="en" />
    <meta http-equiv="imagetoolbar" content="no" />
    <meta id="page_favicon" href="/favicon.ico" rel="icon" type="image/x-icon" />
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link rel="alternate" type="application/rss+xml" title="Bruno P. Kinoshita &raquo; Feed" href="/feed.xml" />
    <link rel="stylesheet" href="/css/semantic/dist/semantic.min.css" type="text/css" media="screen, projection" />
    <link rel="stylesheet" href="/css/style.css" type="text/css" media="screen, projection" />
    <!--[if lt IE 8]>
    <link rel="stylesheet" href="/css/blueprint/ie.css" type="text/css" media="screen, projection" />
    <![endif]-->
    <link rel="stylesheet" href="/css/prettyPhoto.css" type="text/css" media="all" />
</head>
<body id="body">
    <div class="ui vertical sidebar menu" id="toc">
        <nav class="menu" role="navigation">
    <div class="item">
        <a href="/" class="main-link">Kinoshita</a>
    </div>
    <div class="item">
        <a href="/art">Art</a>
    </div>
    <div class="item">
        <a href="/contact/">Contact</a>
    </div>
    <div class="item">
        <a href="/about/">About</a>
    </div>
</nav>
<img src="/img/bruno.jpg" title="Hmmmm" alt="My picture" width="134px" height="215px" />
    </div>
    <div class="ui black big launch right attached fixed button">
        <i class="content icon"></i>
        <span class="text">Menu</span>
    </div>
    <div class="ui fixed inverted main menu">
        <div class="ui container">
            <a class="launch icon item">
                <i class="content icon"></i>
            </a>
            <div class="item">
                PyZMQ Basics - Part 1
            </div>
        </div>
    </div>
    <div class="pusher">
        <div class="full height">
            <div class="toc">
                <div class="ui vertical sticky fixed top menu">
                    <nav class="menu" role="navigation">
    <div class="item">
        <a href="/" class="main-link">Kinoshita</a>
    </div>
    <div class="item">
        <a href="/art">Art</a>
    </div>
    <div class="item">
        <a href="/contact/">Contact</a>
    </div>
    <div class="item">
        <a href="/about/">About</a>
    </div>
</nav>
<img src="/img/bruno.jpg" title="Hmmmm" alt="My picture" width="134px" height="215px" />
                </div>
            </div>
            <div class="article">
                <div class="main container" role="main">

                
<div class="ui raised padded container segment">
  <h1 class='post-topic'>PyZMQ Basics - Part 1</h1>
  <small>kinow</small> @
	<small>2019-03-30&nbsp;16:32:17 (<span class='stardate' data-input-date='2019-03-30'></span>)</small>
  <div class="entry">
    





<a href="https://twitter.com/share" class="twitter-share-button" data-url="https://kinoshita.eti.br/2019/03/30/pyzmq-basics-part-1" data-text="PyZMQ Basics - Part 1" data-via="kinow" data-hashtags="opensource">Tweet</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p='https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

	  <p><a href="https://www.deviantart.com/kinow/art/Old-man-1-657521623" style="float: left;">
<img class="ui fluid image" src="/2019/03/30/pyzmq-basics-part-1/old-man-1.png" /></a></p>
<p>I am working <a href="https://cylc.github.io">on a project</a> that is adopting <a href="http://zeromq.org/">ZeroMQ</a>.
This post series is for self understanding of PyZMQ, a ZeroMQ
<a href="https://github.com/zeromq/libzmq"><code>libzmq</code></a> binding for Python.</p></p>
<p><br style="clear: both" /></p>
<!--more-->

<h2>What is ZeroMQ?</h2>
<p>ZeroMQ (or 0MQ, or ØMQ) is an Open Source library that provides building blocks for
communication in distributed applications. The communication can be between the threads
of a process, between process (inter-process), or via network protocols such as
TCP and UDP.</p>
<p>It is optimized for performance, and has been used in many applications, giving users
a solid foundation to be used in their projects.</p>
<p>The maintainers of the project provide low level C++ projects such as <code>libzmq</code> (GPL v3),
<code>zyre</code>, <code>czmq</code>, etc. But the most important project to get started with is <code>libzmq</code>.</p>
<p><code>libzmq</code> is the core of ZeroMQ, and the community maintains bindings to other languages.
There is a Python binding, <a href="https://pyzmq.readthedocs.io/en/latest/"><code>pyzmq</code></a>,
as well as a Java <code>jzmq</code>, a Node.JS, PHP, etc.</p>
<h2>More than just sockets</h2>
<p>At its core, ZeroMQ handles sockets for you, but what you get when you create
&ldquo;sockets&rdquo; in ZeroMQ, are actually ZeroMQ abstractions of sockets.</p>
<p>As example in this section, we will use two code snippets from the ZeroMQ documentation.</p>
<div class="highlight"><pre><span></span><span class="c1"># helloworld_server.py</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">zmq</span>

<span class="n">context</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span>
<span class="n">socket</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">REP</span><span class="p">)</span>
<span class="n">socket</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s2">&quot;tcp://*:5555&quot;</span><span class="p">)</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="c1">#  Wait for next request from client</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Received request: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>

    <span class="c1">#  Do some &#39;work&#39;</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1">#  Send reply back to client</span>
    <span class="n">socket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;World&quot;</span><span class="p">)</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="c1"># helloworld_client.py</span>
<span class="c1">#</span>
<span class="c1">#   Hello World client in Python</span>
<span class="c1">#   Connects REQ socket to tcp://localhost:5555</span>
<span class="c1">#   Sends &quot;Hello&quot; to server, expects &quot;World&quot; back</span>
<span class="c1">#</span>

<span class="kn">import</span> <span class="nn">zmq</span>

<span class="n">context</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span>

<span class="c1">#  Socket to talk to server</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&quot;Connecting to hello world server…&quot;</span><span class="p">)</span>
<span class="n">socket</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">REQ</span><span class="p">)</span>
<span class="n">socket</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;tcp://localhost:5555&quot;</span><span class="p">)</span>

<span class="c1">#  Do 10 requests, waiting each time for a response</span>
<span class="k">for</span> <span class="n">request</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Sending request </span><span class="si">%s</span><span class="s2"> …&quot;</span> <span class="o">%</span> <span class="n">request</span><span class="p">)</span>
    <span class="n">socket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;Hello&quot;</span><span class="p">)</span>

    <span class="c1">#  Get the reply.</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Received reply </span><span class="si">%s</span><span class="s2"> [ </span><span class="si">%s</span><span class="s2"> ]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">message</span><span class="p">))</span>
</pre></div>

<p>You can start the server, and then start the client, and you should see
the server printing the messages received, and in the client terminal you
should see the loop iteration and the messages sent to the server as well.</p>
<p>With a normal socket, you would expect starting the client before the server
to fail, but it works with ZeroMQ. Because ZeroMQ uses an abstraction to
help developers, not exposing a bare socket.</p>
<p>It is important to note that <strong>there are socket types in ZeroMQ</strong>. We have, for
example, the <em>REPLY</em> socket, and the <em>REQUEST</em> socket. Our example uses both, 
a <em>REPLY</em> socket in the server_, as it is replying to messages. And a <em>REQUEST</em>
socket in the client, which is used to send requests to the server.</p>
<p>When you run both scripts, the communication is happening through a socket, but at a higher
level, there is a protocol used by ZeroMQ to serialize messages. You can send
raw messages too, but that is not the vanilla way.</p>
<p>So you cannot use ZeroMQ to replace a web server listening on port 80, and expect
browsers or other HTTP clients to be able to talk to this server. You would need
to write a client for it.</p>
<h2>Combining Socket Types</h2>
<p>Another powerful feature in ZeroMQ, is the possibility to combine different
socket types. The previous example uses the REQ-REP duo. With this combination,
the <em>REQ</em> endpoint is expected to send a message to the other endpoint, the <em>REP</em>.
The latter then produces a reply message, or none.</p>
<p>But sending two <em>REQ</em> messages, the second would return an error. So if you modified
the example from the previous section to send two messages, first a &#8220;Hello&#8221;, and
then &#8220;World&#8221;, you would get an error in your terminal.</p>
<div class="highlight"><pre><span></span>Connecting to hello world server…
Sending request <span class="m">0</span> ...
Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
  File <span class="s2">&quot;helloworld_client.py&quot;</span>, line <span class="m">22</span>, in &lt;module&gt;
    socket.send<span class="o">(</span>b<span class="s2">&quot;World&quot;</span><span class="o">)</span>
  File <span class="s2">&quot;/home/kinow/Development/python/anaconda3/lib/python3.7/site-packages/zmq/sugar/socket.py&quot;</span>, line <span class="m">392</span>, in send
    <span class="k">return</span> super<span class="o">(</span>Socket, self<span class="o">)</span>.send<span class="o">(</span>data, <span class="nv">flags</span><span class="o">=</span>flags, <span class="nv">copy</span><span class="o">=</span>copy, <span class="nv">track</span><span class="o">=</span>track<span class="o">)</span>
  File <span class="s2">&quot;zmq/backend/cython/socket.pyx&quot;</span>, line <span class="m">725</span>, in zmq.backend.cython.socket.Socket.send
  File <span class="s2">&quot;zmq/backend/cython/socket.pyx&quot;</span>, line <span class="m">772</span>, in zmq.backend.cython.socket.Socket.send
  File <span class="s2">&quot;zmq/backend/cython/socket.pyx&quot;</span>, line <span class="m">247</span>, in zmq.backend.cython.socket._send_copy
  File <span class="s2">&quot;zmq/backend/cython/socket.pyx&quot;</span>, line <span class="m">242</span>, in zmq.backend.cython.socket._send_copy
  File <span class="s2">&quot;zmq/backend/cython/checkrc.pxd&quot;</span>, line <span class="m">25</span>, in zmq.backend.cython.checkrc._check_rc
zmq.error.ZMQError: Operation cannot be accomplished in current state
</pre></div>

<p>That is because each combination of socket types has its own way to send and
receive messages. These combinations are called <strong>Messaging Patterns</strong>, and they
allow you to go beyond the basic TCP one-to-one communication model.</p>
<p>These patterns are like recipes, that you can use in your project. <code>libzmq</code> comes
with four patterns.</p>
<ul>
<li>Request-Reply: a set of clients connects to a set of servers, similar to Remote Procedure Call (RPC).</li>
<li>Pub-Sub: a set of publishers connects to a set of subscribers, similar to messaging queues, and JMS.</li>
<li>Pipeline: nodes are connected in fan-out/fan-in pattern, with multiple steps and loops, similar to parallel task distribution, map-reduce.</li>
<li>Exclusive pair: two sockets are connected exclusively. This is used for connecting two threads in a process.</li>
</ul>
<h2>Conclusion</h2>
<p>For now I will continue reading about ZeroMQ and checking out the examples
to understand more about the messaging patterns. But the most important
gotchas from this part, are:</p>
<ul>
<li>ZeroMQ gives us an abstraction of sockets</li>
<li>Sockets have types in ZeroMQ</li>
<li>It provides recipes that can be used in a software architecture by combining socket types</li>
<li>Each combination will have its own operation mode, limitations, etc</li>
</ul>
<p>And finally, a useful quote from their documentation.</p>
<blockquote>
<p>Let&#8217;s recap briefly what ZeroMQ does for you. It delivers blobs of data (messages) to nodes, quickly and efficiently. You can map nodes to threads, processes, or nodes. ZeroMQ gives your applications a single socket API to work with, no matter what the actual transport (like in-process, inter-process, TCP, or multicast). It automatically reconnects to peers as they come and go. It queues messages at both sender and receiver, as needed. It limits these queues to guard processes against running out of memory. It handles socket errors. It does all I/O in background threads. It uses lock-free techniques for talking between nodes, so there are never locks, waits, semaphores, or deadlocks.</p>
</blockquote>
  </div>
  <p class="postmetadata">
    
    <small>tags [&nbsp;<a href="/tag/zmq" rel="tag">zmq</a>&nbsp;]&nbsp;[&nbsp;<a href="/tag/python" rel="tag">python</a>&nbsp;]&nbsp;[&nbsp;<a href="/tag/opensource" rel="tag">opensource</a>&nbsp;]&nbsp;[&nbsp;<a href="/tag/programming" rel="tag">programming</a>&nbsp;]&nbsp;</small>
    
    
  </p>
  
</div>

                </div>
            </div>
        </div>
        <div class="ui vertical footer segment">
            <div class="ui center aligned container">
                           <div id="copy" class="">
                <p>&copy; <a href="/about"><span
                            class="b">Bru</span><span
                            class="r">no de</span> <span
                            class="a">Paula</span> <span
                            class="s"></span><span
                            class="i">Kinos</span><span
                            class="l">hita</span></a>
                </p>
            </div>
            </div>
         </div>
    </div>
</body>
</html>
<script src="/js/jquery-2.2.3.min.js"  type="text/javascript"></script>
<script src="/css/semantic/dist/semantic.min.js"  type="text/javascript"></script>
<script src="/js/jquery.prettyPhoto.js"></script>
<script src="/js/site.js"></script>