<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta property="og:title" content="A look at the first implementation of GraphQL in Cylc">
<meta property="og:description" content="

  
  




For Cylc 8 we are adding an initial implementation of GraphQL, to replace the previous REST API.
Besides the technologies in the API&rsquo;s, another difference is that for the REST API, its main
consumer was a PyGTK GUI.
The new GraphQL API, on the other hand, will be used mainly by a Vue.js Web application. So a
few things need to be done in a different way due to the jump from Desktop GUI to Web GUI.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://kinoshita.eti.br/2019/05/17/a-look-at-the-first-implementation-of-graphql-in-cylc.html"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2019-05-17T00:00:00+00:00">
<meta property="article:modified_time" content="2024-04-06T10:45:18+02:00">
<link rel=alternate type=application/rss+xml href=https://kinoshita.eti.br/2019/05/17/a-look-at-the-first-implementation-of-graphql-in-cylc/feed.xml title=kinow>
<link rel=stylesheet type=text/css href=https://kinoshita.eti.br/sass/main.09b56b6037e962b67cf7a7701bf2a9ee5da840a4f74b74139c4731f2156a5917.css integrity="sha256-CbVrYDfpYrZ896dwG/Kp7l2oQKT3S3QTnEcx8hVqWRc=">
<title>kinow | A look at the first implementation of GraphQL in Cylc</title>
</head>
<body>
<header role=banner class=content>
<nav id=nav aria-label=Main role=navigation class=content>
<ul><li>
<a href=/><i data-feather=about></i> About</a>
</li><li>
<a href=/blog/><i data-feather=blog></i> Blog</a>
</li><li>
<a href=/portfolio/><i data-feather=portfolio></i> Portfolio</a>
</li>
</ul>
</nav>
</header>
<main>
<article class=content>
<h1>A look at the first implementation of GraphQL in Cylc</h1><div class=metadata>
<i data-feather=calendar></i>
<time datetime=2019-05-17>May 17, 2019</time>
</div>
<aside>
<nav id=TableOfContents>
<ul>
<li><a href=#protobuf-model>Protobuf model</a></li>
<li><a href=#state-management>State management</a></li>
<li><a href=#pyzmq-layer>PyZMQ layer</a></li>
<li><a href=#conclusion>Conclusion</a></li>
</ul>
</nav>
</aside>
<figure class=feature>
<img src=/assets/posts/2019-05-17-a-look-at-the-first-implementation-of-graphql-in-cylc/fancy-hands2.png alt title style=float:right;width:40% width height>
<figcaption></figcaption>
</figure>
<p>For Cylc 8 we are adding an initial implementation of GraphQL, to replace the previous REST API.
Besides the technologies in the API&rsquo;s, another difference is that for the REST API, its main
consumer was a PyGTK GUI.</p>
<p>The new GraphQL API, on the other hand, will be used mainly by a Vue.js Web application. So a
few things need to be done in a different way due to the jump from Desktop GUI to Web GUI.</p>
<h2 id=protobuf-model>Protobuf model</h2>
<p>The current implementation is under review in a pull request at the moment. It includes
Python libraries for GraphQL, as it is expected, but also a Protobuf data model that
can be visualized in the figure below.</p>
<figure class=feature>
<img src=/assets/posts/2019-05-17-a-look-at-the-first-implementation-of-graphql-in-cylc/cylc-graphql-protobuf.png alt title width height>
<figcaption></figcaption>
</figure>
<h2 id=state-management>State management</h2>
<p>In Cylc, the <code>Scheduler</code> object is responsible for managing Tasks in a Workflow. It does so in its
<em>main loop</em>, which is similar to the main loops in game engines. It runs periodically checking the
state of several objects, and updates them.</p>
<p>A new class <code>JobPool</code> is being added in Cylc 8 to maintain a pool of jobs and their states. This <code>JobPool</code>
is used by the <code>Scheduler</code> to update the jobs, similarly to how it does for tasks.</p>
<p>Every time the main loop runs, it calls a method (<code>Scheduler.update_data_structure</code>) to update the data
structures used by Cylc, including the data structures used by the GraphQL engine in Cylc. Other methods
that are responsible for updating the state of Tasks are now updating the state of Jobs too.</p>
<p>The method <code>update_data_structure</code> uses <code>WsDataMgr</code>, another new object being added. <code>WsDataMgr</code>
is where the Workflow Tasks, their parent Tasks, Task Families, and other objects required for
the Workflow such as Prerequisites and Conditions are calculated, and organized into dictionaries.</p>
<figure class=feature>
<img src=/assets/posts/2019-05-17-a-look-at-the-first-implementation-of-graphql-in-cylc/graphql.svg.png.jpg alt title width height>
<figcaption></figcaption>
</figure>
<p>These dictionaries are kept in memory, updated periodically by <code>Scheduler</code>, and accessed by the
PyZMQ layer.</p>
<h2 id=pyzmq-layer>PyZMQ layer</h2>
<p>After the initial run of the main loop, we are ready to serve GraphQL data from our workflow
in Cylc. That is done by the <code>SuiteRuntimeServer</code>, a PyZMQ server. It got a new method
<code>pb_entire_workflow</code> that populates the <code>PbEntireWorkflow</code> object, and serializes it back to the client.</p>
<p>This method will be used by another project that uses <a href=https://github.com/graphql-python/graphene>Python Graphene</a>
and <a href=https://github.com/tornadoweb/tornado>Tornado</a> for the backend, and
<a href=https://github.com/vuejs/vue>Vue.js</a> for the frontend.</p>
<h2 id=conclusion>Conclusion</h2>
<p>Cylc uses a SQLite database for part of the workflow state (e.g. recovery) but for
the GraphQL we are not really accessing any database directly.</p>
<p>So the implementation in Cylc is probably different than what most blogs and tutorials
use as example.</p>
<p>It is still early work, and many things may change, but Cylc 8 is getting near its first alpha release
with GraphQL. Check out <a href=https://github.com/cylc/cylc-flow>https://github.com/cylc/cylc-flow</a> for more.</p>
<p>The following references are useful to track the rationale behind this work in Cylc:</p>
<ul>
<li><a href=https://github.com/cylc/cylc-flow/issues/2900>cylc-flow#2900 - PoC - GraphQL endpoint Design & Implementation</a></li>
<li><a href=https://github.com/cylc/cylc-flow/pull/3122>cylc-flow#3122 - UI Server graphql protobuf feed</a></li>
<li><a href=https://github.com/cylc/cylc-uiserver/pull/34>cylc-uiserver#34 - WS-UIS data and GraphQL integration</a></li>
</ul>
<p>
Categories:
<a href=/categories/blog.html>blog</a>
</p>
<p>
Tags:
<a href=/tags/python.html>python</a>,
<a href=/tags/cylc.html>cylc</a>,
<a href=/tags/graphql.html>graphql</a>,
<a href=/tags/workflows.html>workflows</a>,
<a href=/tags/programming.html>programming</a>,
<a href=/tags/opensource.html>opensource</a>
</p>
<aside class=links>
<a class=previous href=https://kinoshita.eti.br/2019/04/07/running-fuzzers-to-find-bugs.html>&#171; Previous</a>
<a class=next href=https://kinoshita.eti.br/2019/07/28/generating-diagrams-from-a-sqlite-database-with-python.html>Next &#187;</a>
</aside>
</article>
</main>
<footer role=contentinfo>
<ul id=social-media-icons>
<li>
<a href=https://www.instagram.com/brunokinoshita/>
<img src=/assets/icons/instagram.png alt="Instagram link">
</a>
</li>
<li>
<a href=https://twitter.com/kinow/>
<img src=/assets/icons/twitter.png alt="Twitter link">
</a>
</li>
<li>
<a href=https://github.com/kinow/>
<img src=/assets/icons/github.png alt="GitHub link">
</a>
</li>
<li>
<a href=/feed.xml>
<img src=/assets/icons/news.png alt="RSS feed link">
</a>
</li>
</ul>
</footer>
</body>
</html>