<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>A look at the first implementation of GraphQL in Cylc | Bruno P. Kinoshita</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="A look at the first implementation of GraphQL in Cylc" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="For Cylc 8 we are adding an initial implementation of GraphQL, to replace the previous REST API. Besides the technologies in the API’s, another difference is that for the REST API, its main consumer was a PyGTK GUI. The new GraphQL API, on the other hand, will be used mainly by a Vue.js Web application. So a few things need to be done in a different way due to the jump from Desktop GUI to Web GUI." />
<meta property="og:description" content="For Cylc 8 we are adding an initial implementation of GraphQL, to replace the previous REST API. Besides the technologies in the API’s, another difference is that for the REST API, its main consumer was a PyGTK GUI. The new GraphQL API, on the other hand, will be used mainly by a Vue.js Web application. So a few things need to be done in a different way due to the jump from Desktop GUI to Web GUI." />
<link rel="canonical" href="https://kinoshita.eti.br/2019/05/17/a-look-at-the-first-implementation-of-graphql-in-cylc.html" />
<meta property="og:url" content="https://kinoshita.eti.br/2019/05/17/a-look-at-the-first-implementation-of-graphql-in-cylc.html" />
<meta property="og:site_name" content="Bruno P. Kinoshita" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-05-17T00:00:00-05:00" />
<script type="application/ld+json">
{"datePublished":"2019-05-17T00:00:00-05:00","headline":"A look at the first implementation of GraphQL in Cylc","description":"For Cylc 8 we are adding an initial implementation of GraphQL, to replace the previous REST API. Besides the technologies in the API’s, another difference is that for the REST API, its main consumer was a PyGTK GUI. The new GraphQL API, on the other hand, will be used mainly by a Vue.js Web application. So a few things need to be done in a different way due to the jump from Desktop GUI to Web GUI.","mainEntityOfPage":{"@type":"WebPage","@id":"https://kinoshita.eti.br/2019/05/17/a-look-at-the-first-implementation-of-graphql-in-cylc.html"},"@type":"BlogPosting","url":"https://kinoshita.eti.br/2019/05/17/a-look-at-the-first-implementation-of-graphql-in-cylc.html","dateModified":"2019-05-17T00:00:00-05:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/main.css"><link type="application/atom+xml" rel="alternate" href="https://kinoshita.eti.br/feed.xml" title="Bruno P. Kinoshita" /></head>
<body>
<div id="mobile-menu"><div class="menu">
  <ul class="menu">
    <li class="item">
      <a href="/" aria-label="Home page link">
        <svg id="svg8" version="1.1" viewBox="0 0 58.208 9.2604" xmlns="http://www.w3.org/2000/svg" role="img"
             aria-labelledby="svg-logo-title svg-logo-desc">
          <title id="svg-logo-title">KINOSHITA image</title>
          <desc id="svg-logo-desc">A logo with the word KINOSHITA</desc>
          <g id="layer1" transform="translate(0 -287.74)">
            <g id="text817" transform="translate(-2.4568 -.23624)">
              <g id="logo" transform="matrix(2.6585 0 0 2.5911 -63.587 100.56)" fill="#000000" stroke-width=".26458px">
                <path role="presentation" id="path819"
                      d="m25.178 72.637h0.54187v2.9633h-0.54187zm0.5842 1.397 1.0964-1.397h0.635l-1.1049 1.397 1.1049 1.5663h-0.635z"/>
                <path role="presentation" id="path821" d="m27.832 72.637h0.54187v2.9633h-0.54187z"/>
                <path role="presentation" id="path823"
                      d="m29.023 72.637h0.5334l1.2658 1.9135v-1.9135h0.54187v2.9633h-0.4445l-1.3547-2.032v2.032h-0.54187z"/>
                <path role="presentation" id="path825"
                      d="m33.298 75.66q-0.4191 0-0.75353-0.1905-0.3302-0.19473-0.5207-0.54187-0.18627-0.35137-0.18627-0.80857t0.18627-0.80433q0.1905-0.35137 0.5207-0.54187 0.33443-0.19473 0.75353-0.19473t0.7493 0.19473q0.33443 0.1905 0.5207 0.54187 0.1905 0.34713 0.1905 0.80433t-0.1905 0.80857q-0.18627 0.34713-0.5207 0.54187-0.3302 0.1905-0.7493 0.1905zm0-0.52493q0.4318 0 0.6604-0.2794 0.23283-0.2794 0.23283-0.7366t-0.23283-0.7366q-0.2286-0.2794-0.6604-0.2794t-0.66463 0.2794q-0.2286 0.2794-0.2286 0.7366t0.2286 0.7366q0.23283 0.2794 0.66463 0.2794z"/>
                <path role="presentation" id="path827"
                      d="m36.091 75.66q-0.24977 0-0.53763-0.06773-0.28363-0.06773-0.4445-0.14817l0.0635-0.57573q0.5588 0.27093 0.98213 0.27093 0.22437 0 0.35137-0.08467 0.127-0.0889 0.127-0.25823 0-0.127-0.07197-0.20743-0.06773-0.08467-0.19897-0.1397-0.13123-0.05927-0.4191-0.16087-0.27093-0.09313-0.44873-0.19473-0.1778-0.10583-0.28363-0.2667-0.1016-0.1651-0.1016-0.40217 0-0.381 0.2794-0.61383t0.8001-0.23283q0.24553 0 0.48683 0.05503 0.24553 0.05503 0.44873 0.13547l-0.05503 0.55457q-0.26247-0.1143-0.4826-0.16933-0.2159-0.05927-0.4318-0.05927-0.2413 0-0.3683 0.08043t-0.127 0.23283q0 0.11853 0.06773 0.19473t0.18203 0.127q0.11853 0.0508 0.34713 0.12277 0.51223 0.16087 0.74507 0.37253 0.23707 0.20743 0.23707 0.5715 0 0.34713-0.2413 0.60537t-0.90593 0.25823z"/>
                <path role="presentation" id="path829"
                      d="m37.688 72.637h0.54187v1.1726h1.3547v-1.1726h0.54187v2.9633h-0.54187v-1.2827h-1.3547v1.2827h-0.54187z"/>
                <path role="presentation" id="path831" d="m40.78 72.637h0.54187v2.9633h-0.54187z"/>
                <path role="presentation" id="path833"
                      d="m42.546 73.162h-0.8382v-0.52493h2.2183v0.52493h-0.8382v2.4384h-0.54187z"/>
                <path role="presentation" id="path835"
                      d="m45.632 74.898h-1.0795l-0.24553 0.70273h-0.52493l1.0541-2.9633h0.51223l1.0541 2.9633h-0.52493zm-0.16933-0.47413-0.3683-1.0583-0.37253 1.0583z"/>
              </g>
            </g>
          </g>
        </svg>
      </a>
    </li>
    <li class="item">
      <a href="/blog/" class="">Blog</a>
      <ul>
        <li class="item">
          <a href="/blog/drawing/">Drawing</a>
        </li>
        <li class="item">
          <a href="/blog/languages/">Languages</a>
        </li>
        <li class="item">
          <a href="/blog/music/">Music</a>
        </li>
        <li class="item">
          <a href="/blog/writing/">Writing</a>
        </li>
      </ul>
    </li>
    <li class="item">
      <a href="/art/" class="">Illustrations</a>
    </li>
    <li class="item">
      <a href="/maps/" class="">Maps</a>
    </li>
  </ul>
  <div id="menu-bottom">
    <p id="feed-subscribe">
      <a href="/feed.xml">
        <svg id="feed-icon" xmlns="http://www.w3.org/2000/svg" version="1.1" width="128px" height="128px"
             viewBox="0 0 256 256">
          <circle cx="68" cy="189" r="24" fill="rgba(255, 255, 255, .2)"/>
          <path d="M160 213h-34a82 82 0 0 0 -82 -82v-34a116 116 0 0 1 116 116z" fill="rgba(255, 255, 255, .2)"/>
          <path d="M184 213A140 140 0 0 0 44 73 V 38a175 175 0 0 1 175 175z" fill="rgba(255, 255, 255, .2)"/>
        </svg>
      </a>
    </p>
  </div>
</div>
</div>
<div id="wrapper">
  <div id="sidebar"><div class="menu">
  <ul class="menu">
    <li class="item">
      <a href="/" aria-label="Home page link">
        <svg id="svg8" version="1.1" viewBox="0 0 58.208 9.2604" xmlns="http://www.w3.org/2000/svg" role="img"
             aria-labelledby="svg-logo-title svg-logo-desc">
          <title id="svg-logo-title">KINOSHITA image</title>
          <desc id="svg-logo-desc">A logo with the word KINOSHITA</desc>
          <g id="layer1" transform="translate(0 -287.74)">
            <g id="text817" transform="translate(-2.4568 -.23624)">
              <g id="logo" transform="matrix(2.6585 0 0 2.5911 -63.587 100.56)" fill="#000000" stroke-width=".26458px">
                <path role="presentation" id="path819"
                      d="m25.178 72.637h0.54187v2.9633h-0.54187zm0.5842 1.397 1.0964-1.397h0.635l-1.1049 1.397 1.1049 1.5663h-0.635z"/>
                <path role="presentation" id="path821" d="m27.832 72.637h0.54187v2.9633h-0.54187z"/>
                <path role="presentation" id="path823"
                      d="m29.023 72.637h0.5334l1.2658 1.9135v-1.9135h0.54187v2.9633h-0.4445l-1.3547-2.032v2.032h-0.54187z"/>
                <path role="presentation" id="path825"
                      d="m33.298 75.66q-0.4191 0-0.75353-0.1905-0.3302-0.19473-0.5207-0.54187-0.18627-0.35137-0.18627-0.80857t0.18627-0.80433q0.1905-0.35137 0.5207-0.54187 0.33443-0.19473 0.75353-0.19473t0.7493 0.19473q0.33443 0.1905 0.5207 0.54187 0.1905 0.34713 0.1905 0.80433t-0.1905 0.80857q-0.18627 0.34713-0.5207 0.54187-0.3302 0.1905-0.7493 0.1905zm0-0.52493q0.4318 0 0.6604-0.2794 0.23283-0.2794 0.23283-0.7366t-0.23283-0.7366q-0.2286-0.2794-0.6604-0.2794t-0.66463 0.2794q-0.2286 0.2794-0.2286 0.7366t0.2286 0.7366q0.23283 0.2794 0.66463 0.2794z"/>
                <path role="presentation" id="path827"
                      d="m36.091 75.66q-0.24977 0-0.53763-0.06773-0.28363-0.06773-0.4445-0.14817l0.0635-0.57573q0.5588 0.27093 0.98213 0.27093 0.22437 0 0.35137-0.08467 0.127-0.0889 0.127-0.25823 0-0.127-0.07197-0.20743-0.06773-0.08467-0.19897-0.1397-0.13123-0.05927-0.4191-0.16087-0.27093-0.09313-0.44873-0.19473-0.1778-0.10583-0.28363-0.2667-0.1016-0.1651-0.1016-0.40217 0-0.381 0.2794-0.61383t0.8001-0.23283q0.24553 0 0.48683 0.05503 0.24553 0.05503 0.44873 0.13547l-0.05503 0.55457q-0.26247-0.1143-0.4826-0.16933-0.2159-0.05927-0.4318-0.05927-0.2413 0-0.3683 0.08043t-0.127 0.23283q0 0.11853 0.06773 0.19473t0.18203 0.127q0.11853 0.0508 0.34713 0.12277 0.51223 0.16087 0.74507 0.37253 0.23707 0.20743 0.23707 0.5715 0 0.34713-0.2413 0.60537t-0.90593 0.25823z"/>
                <path role="presentation" id="path829"
                      d="m37.688 72.637h0.54187v1.1726h1.3547v-1.1726h0.54187v2.9633h-0.54187v-1.2827h-1.3547v1.2827h-0.54187z"/>
                <path role="presentation" id="path831" d="m40.78 72.637h0.54187v2.9633h-0.54187z"/>
                <path role="presentation" id="path833"
                      d="m42.546 73.162h-0.8382v-0.52493h2.2183v0.52493h-0.8382v2.4384h-0.54187z"/>
                <path role="presentation" id="path835"
                      d="m45.632 74.898h-1.0795l-0.24553 0.70273h-0.52493l1.0541-2.9633h0.51223l1.0541 2.9633h-0.52493zm-0.16933-0.47413-0.3683-1.0583-0.37253 1.0583z"/>
              </g>
            </g>
          </g>
        </svg>
      </a>
    </li>
    <li class="item">
      <a href="/blog/" class="">Blog</a>
      <ul>
        <li class="item">
          <a href="/blog/drawing/">Drawing</a>
        </li>
        <li class="item">
          <a href="/blog/languages/">Languages</a>
        </li>
        <li class="item">
          <a href="/blog/music/">Music</a>
        </li>
        <li class="item">
          <a href="/blog/writing/">Writing</a>
        </li>
      </ul>
    </li>
    <li class="item">
      <a href="/art/" class="">Illustrations</a>
    </li>
    <li class="item">
      <a href="/maps/" class="">Maps</a>
    </li>
  </ul>
  <div id="menu-bottom">
    <p id="feed-subscribe">
      <a href="/feed.xml">
        <svg id="feed-icon" xmlns="http://www.w3.org/2000/svg" version="1.1" width="128px" height="128px"
             viewBox="0 0 256 256">
          <circle cx="68" cy="189" r="24" fill="rgba(255, 255, 255, .2)"/>
          <path d="M160 213h-34a82 82 0 0 0 -82 -82v-34a116 116 0 0 1 116 116z" fill="rgba(255, 255, 255, .2)"/>
          <path d="M184 213A140 140 0 0 0 44 73 V 38a175 175 0 0 1 175 175z" fill="rgba(255, 255, 255, .2)"/>
        </svg>
      </a>
    </p>
  </div>
</div>
</div>
  <div id="content">
    <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">A look at the first implementation of GraphQL in Cylc</h1><div class="note"><p>This is based on a WIP pull request, and what is being described here may be outdated by the time the pull request has been reviewed and merged. But it should still give you an idea of what we are working on.</p>
</div>
    <spab class="post-meta">
      <time class="dt-published" datetime="2019-05-17T00:00:00-05:00" itemprop="datePublished">May 17, 2019
      </time>
      <span>&mdash; star date: -303542.47</span></spab>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p><img class="ui image" src="/assets/posts/2019-05-17-a-look-at-the-first-implementation-of-graphql-in-cylc/fancy-hands2.png" style="float: right; width: 40%;" /></p>

<p>For Cylc 8 we are adding an initial implementation of GraphQL, to replace the previous REST API.
Besides the technologies in the API’s, another difference is that for the REST API, its main
consumer was a PyGTK GUI.</p>

<p>The new GraphQL API, on the other hand, will be used mainly by a Vue.js Web application. So a
few things need to be done in a different way due to the jump from Desktop GUI to Web GUI.</p>

<!--more-->

<h2 id="protobuf-model">Protobuf model</h2>

<p>The current implementation is under review in a pull request at the moment. It includes
Python libraries for GraphQL, as it is expected, but also a Protobuf data model that
can be visualized in the figure below.</p>

<p><img class="ui fluid image" src="/assets/posts/2019-05-17-a-look-at-the-first-implementation-of-graphql-in-cylc/cylc-graphql-protobuf.png" /></p>

<h2 id="state-management">State management</h2>

<p>In Cylc, the <code class="language-plaintext highlighter-rouge">Scheduler</code> object is responsible for managing Tasks in a Workflow. It does so in its
<em>main loop</em>, which is similar to the main loops in game engines. It runs periodically checking the
state of several objects, and updates them.</p>

<p>A new class <code class="language-plaintext highlighter-rouge">JobPool</code> is being added in Cylc 8 to maintain a pool of jobs and their states. This <code class="language-plaintext highlighter-rouge">JobPool</code>
is used by the <code class="language-plaintext highlighter-rouge">Scheduler</code> to update the jobs, similarly to how it does for tasks.</p>

<p>Every time the main loop runs, it calls a method (<code class="language-plaintext highlighter-rouge">Scheduler.update_data_structure</code>) to update the data
structures used by Cylc, including the data structures used by the GraphQL engine in Cylc. Other methods
that are responsible for updating the state of Tasks are now updating the state of Jobs too.</p>

<p>The method <code class="language-plaintext highlighter-rouge">update_data_structure</code> uses <code class="language-plaintext highlighter-rouge">WsDataMgr</code>, another new object being added. <code class="language-plaintext highlighter-rouge">WsDataMgr</code>
is where the Workflow Tasks, their parent Tasks, Task Families, and other objects required for
the Workflow such as Prerequisites and Conditions are calculated, and organized into dictionaries.</p>

<p><img class="ui fluid image" src="/assets/posts/2019-05-17-a-look-at-the-first-implementation-of-graphql-in-cylc/graphql.svg.png.jpg" /></p>

<p>These dictionaries are kept in memory, updated periodically by <code class="language-plaintext highlighter-rouge">Scheduler</code>, and accessed by the
PyZMQ layer.</p>

<h2 id="pyzmq-layer">PyZMQ layer</h2>

<p>After the initial run of the main loop, we are ready to serve GraphQL data from our workflow
in Cylc. That is done by the <code class="language-plaintext highlighter-rouge">SuiteRuntimeServer</code>, a PyZMQ server. It got a new method
<code class="language-plaintext highlighter-rouge">pb_entire_workflow</code> that populates the <code class="language-plaintext highlighter-rouge">PbEntireWorkflow</code> object, and serializes it back to the client.</p>

<p>This method will be used by another project that uses <a href="https://github.com/graphql-python/graphene">Python Graphene</a>
and <a href="https://github.com/tornadoweb/tornado">Tornado</a> for the backend, and
<a href="https://github.com/vuejs/vue">Vue.js</a> for the frontend.</p>

<h2 id="conclusion">Conclusion</h2>

<p>Cylc uses a SQLite database for part of the workflow state (e.g. recovery) but for
the GraphQL we are not really accessing any database directly.</p>

<p>So the implementation in Cylc is probably different than what most blogs and tutorials
use as example.</p>

<p>It is still early work, and many things may change, but Cylc 8 is getting near its first alpha release
with GraphQL. Check out <a href="https://github.com/cylc/cylc-flow">https://github.com/cylc/cylc-flow</a> for more.</p>

<p>The following references are useful to track the rationale behind this work in Cylc:</p>

<ul>
  <li><a href="https://github.com/cylc/cylc-flow/issues/2900">cylc-flow#2900 - PoC - GraphQL endpoint Design &amp; Implementation</a></li>
  <li><a href="https://github.com/cylc/cylc-flow/pull/3122">cylc-flow#3122 - UI Server graphql protobuf feed</a></li>
  <li><a href="https://github.com/cylc/cylc-uiserver/pull/34">cylc-uiserver#34 -  WS-UIS data and GraphQL integration</a></li>
</ul>

  </div>

  <div class="tags"><a class="label" href="/tags#python">python</a><a class="label" href="/tags#cylc">cylc</a><a class="label" href="/tags#graphql">graphql</a></div>

  <a class="u-url" href="/2019/05/17/a-look-at-the-first-implementation-of-graphql-in-cylc.html" hidden></a>
</article>

  </div>
</div>
</body>
</html>
