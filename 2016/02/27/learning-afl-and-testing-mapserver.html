<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:url" content="https://kinoshita.eti.br/2016/02/27/learning-afl-and-testing-mapserver.html"><meta property="og:site_name" content="kinow"><meta property="og:title" content="Learning afl and testing MapServer"><meta property="og:description" content="afl is a fuzzer, an application that combines a series of algorithms in order to try invoking programs with several different input values. It then analyses the application execution flow given different test case scenarios. You can read more about fuzzing at this OWASP page, or in other blogs that I also used while learning about afl 1 2
At work we are using MapServer for serving WFS and WMS. And I am using it for the NZ OpenStreetMap maps too. MapServer is written in C++ and is normally exposed as a CGI script, so I thought it was worth learning about afl and trying it on MapServer, as in case it finds any interesting bug I can submit it to the MapServer project.
"><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2016-02-27T00:00:00+00:00"><meta property="article:modified_time" content="2024-09-30T12:31:45+02:00"><meta property="article:tag" content="Fuzzing"><meta property="article:tag" content="Security"><meta property="article:tag" content="Software Quality"><meta property="og:image" content="https://kinoshita.eti.br/assets/photos/about/2023-me-closeup.png"><meta property="fb:admins" content="bruno.kinoshita"><meta name=twitter:title content="Learning afl and testing MapServer"><meta name=twitter:description content="afl is a fuzzer, an application that combines a series of algorithms
in order to try invoking programs with several different input values. It then analyses the application
execution flow given different test case scenarios.
You can read more about fuzzing at this OWASP page, or in other
blogs that I also used while learning about afl 1 2
At work we are using MapServer for serving WFS and WMS. And I am using it for the
NZ OpenStreetMap maps too. MapServer is written in C++ and is normally
exposed as a CGI script, so I thought it was worth learning about afl and trying it on MapServer,
as in case it finds any interesting bug I can submit it to the MapServer project."><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://kinoshita.eti.br/assets/photos/about/2023-me-closeup.png"><meta name=twitter:site content="@kinow"><link rel=alternate type=application/rss+xml href=https://kinoshita.eti.br/2016/02/27/learning-afl-and-testing-mapserver/feed.xml title=kinow><link rel=stylesheet type=text/css href=https://kinoshita.eti.br/sass/main.ecb27dc5d5ced6616f17336fdf32a78aff8278ec4b599f9e5cdc5bb8a09a9f28.css integrity="sha256-7LJ9xdXO1mFvFzNv3zKniv+CeOxLWZ+eXNxbuKCanyg="><title>kinow | Learning afl and testing MapServer</title><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","articleSection":"posts","name":"Learning afl and testing MapServer","headline":"Learning afl and testing MapServer","alternativeHeadline":"","description":"\u003cp\u003e\u003ca href=\u0022http:\/\/lcamtuf.coredump.cx\/afl\/\u0022\u003eafl\u003c\/a\u003e is a fuzzer, an application that combines a series of algorithms\nin order to try invoking programs with several different input values. It then analyses the application\nexecution flow given different test case scenarios.\nYou can read more about fuzzing at \u003ca href=\u0022https:\/\/www.owasp.org\/index.php\/Fuzzing\u0022\u003ethis OWASP page\u003c\/a\u003e, or in other\nblogs that I also used while learning about afl \u003ca href=\u0022%22#1%22\u0022\u003e1\u003c\/a\u003e \u003ca href=\u0022%22#2%22\u0022\u003e2\u003c\/a\u003e\u003c\/p\u003e\n\u003cp\u003eAt work we are using MapServer for serving WFS and WMS. And I am using it for the\n\u003ca href=\u0022http:\/\/maps.nzoss.org.nz\u0022\u003eNZ OpenStreetMap maps\u003c\/a\u003e too. MapServer is written in C\u002b\u002b and is normally\nexposed as a CGI script, so I thought it was worth learning about afl and trying it on MapServer,\nas in case it finds any interesting bug I can submit it to the MapServer project.\u003c\/p\u003e","inLanguage":"en-us","isFamilyFriendly":"true","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/kinoshita.eti.br\/2016\/02\/27\/learning-afl-and-testing-mapserver.html"},"author":{"@type":"Person","name":""},"creator":{"@type":"Person","name":""},"accountablePerson":{"@type":"Person","name":""},"copyrightHolder":"kinow","copyrightYear":"2016","dateCreated":"2016-02-27T00:00:00.00Z","datePublished":"2016-02-27T00:00:00.00Z","dateModified":"2024-09-30T12:31:45.00Z","publisher":{"@type":"Organization","name":"kinow","url":"https://kinoshita.eti.br/","logo":{"@type":"ImageObject","url":"https:\/\/kinoshita.eti.br\/","width":"32","height":"32"}},"image":"https://kinoshita.eti.br/","url":"https:\/\/kinoshita.eti.br\/2016\/02\/27\/learning-afl-and-testing-mapserver.html","wordCount":"614","genre":["software quality","fuzzing","security","software quality"],"keywords":[]}</script></head><body><header role=banner class=content><nav id=nav aria-label=Main role=navigation class=content><ul style=position:relative><li><a href=/><i data-feather=about></i> About</a></li><li><a href=/blog/><i data-feather=blog></i> Blog</a></li><li><a href=/portfolio/><i data-feather=portfolio></i> Portfolio</a></li><li style=position:absolute;right:0;bottom:-.75rem;text-align:right><span style=text-transform:uppercase;font-weight:700;font-size:3rem;color:#fffefa;line-height:normal;letter-spacing:-.1rem>Kinow</span></li></ul></nav></header><main><article class=content><h1>Learning afl and testing MapServer</h1><div class=metadata><i data-feather=calendar></i>
<time datetime=2016-02-27>Feb 27, 2016</time></div><aside><nav id=TableOfContents><ul><li><a href=#download-and-build-mapserver-source-code>Download and build MapServer source code</a></li><li><a href=#creating-a-shapefile-mapfile>Creating a shapefile mapfile</a></li><li><a href=#running-afl>Running afl</a></li></ul></nav></aside><p><a href=http://lcamtuf.coredump.cx/afl/>afl</a> is a fuzzer, an application that combines a series of algorithms
in order to try invoking programs with several different input values. It then analyses the application
execution flow given different test case scenarios.
You can read more about fuzzing at <a href=https://www.owasp.org/index.php/Fuzzing>this OWASP page</a>, or in other
blogs that I also used while learning about afl <a href=%22#1%22>1</a> <a href=%22#2%22>2</a></p><p>At work we are using MapServer for serving WFS and WMS. And I am using it for the
<a href=http://maps.nzoss.org.nz>NZ OpenStreetMap maps</a> too. MapServer is written in C++ and is normally
exposed as a CGI script, so I thought it was worth learning about afl and trying it on MapServer,
as in case it finds any interesting bug I can submit it to the MapServer project.</p><h2 id=download-and-build-mapserver-source-code>Download and build MapServer source code</h2><p>MapServer code is hosted on <a href=https://github.com/mapserver/mapserver>GitHub</a> and once you have cloned it a look
at the Travis CI configuration file will give you some hints on which dependencies you must have
installed on your operating system in order to build it. I will omit the steps to make this post shorter.</p><p>Once you have successfully built mapserv binary you will need to remove the generated files, and execute
CMake again but now using afl&rsquo;s compiler. This way the application will be instrumented and afl can
analyse its execution flow.</p><p>You can do that by exporting these two variables before running CMake.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a90d91>export</span> <span style=color:#000>CXX</span><span style=color:#000>=</span>/opt/afl-2.05b/afl-g++
</span></span><span style=display:flex><span><span style=color:#a90d91>export</span> <span style=color:#000>CC</span><span style=color:#000>=</span>/opt/afl-2.05b/afl-gcc
</span></span></code></pre></div><p>After this you can run CMake and GNU make again. That should create a binary instrumented mapserv,
that can be tested with afl.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a90d91>cd</span> /home/kinow/Development/cpp/workspace/mapserver/
</span></span><span style=display:flex><span>mkdir build <span style=color:#000>&amp;&amp;</span> <span style=color:#a90d91>cd</span> build
</span></span><span style=display:flex><span>cmake ..
</span></span><span style=display:flex><span>make
</span></span><span style=display:flex><span>./mapserv -v
</span></span></code></pre></div><h2 id=creating-a-shapefile-mapfile>Creating a shapefile mapfile</h2><p>The easiest way to test MapServer locally, without Postgres or Postgis, is probably by
creating a single layer mapfile. LINZ provides shapefiles for New Zealand
(<a href=https://data.linz.govt.nz/layer/1153-nz-coastlines-and-islands-polygons-topo-150k/>here&rsquo;s an example</a>)
that I used for this experiment.</p><figure class=feature><img src=/assets/posts/2016-02-27-learning-afl-and-testing-mapserver/qgis_settings.png alt title width height><figcaption></figcaption></figure><p>I used <a href=http://www.qgis.org/en/site/>QGIS</a> to load the shapefile, take a look at the map,
and get the bounding area and projection. Here&rsquo;s the final mapfile.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>MAP
</span></span><span style=display:flex><span>  IMAGETYPE      JPEG
</span></span><span style=display:flex><span>  EXTENT         -97.238976 41.619778 -82.122902 49.385620
</span></span><span style=display:flex><span>  SIZE           <span style=color:#1c01ce>400</span> <span style=color:#1c01ce>300</span>
</span></span><span style=display:flex><span>  SHAPEPATH      <span style=color:#c41a16>&#34;/home/kinow/Downloads/linz-shp&#34;</span>
</span></span><span style=display:flex><span>  IMAGECOLOR     <span style=color:#1c01ce>255</span> <span style=color:#1c01ce>255</span> <span style=color:#1c01ce>255</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  WEB
</span></span><span style=display:flex><span>    METADATA
</span></span><span style=display:flex><span>      <span style=color:#c41a16>&#34;wms_title&#34;</span>           <span style=color:#c41a16>&#34;WMS Fake Server&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#c41a16>&#34;wms_onlineresource&#34;</span>  <span style=color:#c41a16>&#34;http://127.0.0.1/cgi-bin/mapserv?map=wms.map&amp;&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#c41a16>&#34;wms_srs&#34;</span>             <span style=color:#c41a16>&#34;EPSG:4167&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#c41a16>&#34;wms_enable_request&#34;</span>  <span style=color:#c41a16>&#34;*&#34;</span>
</span></span><span style=display:flex><span>    END
</span></span><span style=display:flex><span>  END
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  PROJECTION
</span></span><span style=display:flex><span>    <span style=color:#c41a16>&#34;init=epsg:4167&#34;</span>
</span></span><span style=display:flex><span>  END
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  LAYER <span style=color:#177500># States polygon layer begins here</span>
</span></span><span style=display:flex><span>    NAME         nz-coastlines-and-islands-polygons-topo-150k
</span></span><span style=display:flex><span>    DATA         nz-coastlines-and-islands-polygons-topo-150k
</span></span><span style=display:flex><span>    STATUS       OFF
</span></span><span style=display:flex><span>    TYPE         POLYGON
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    CLASS
</span></span><span style=display:flex><span>      NAME       <span style=color:#c41a16>&#34;NZ Topo LINZ map&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      STYLE
</span></span><span style=display:flex><span>        COLOR        <span style=color:#1c01ce>232</span> <span style=color:#1c01ce>232</span> <span style=color:#1c01ce>232</span>
</span></span><span style=display:flex><span>        OUTLINECOLOR <span style=color:#1c01ce>32</span> <span style=color:#1c01ce>32</span> <span style=color:#1c01ce>32</span>
</span></span><span style=display:flex><span>      END
</span></span><span style=display:flex><span>    END
</span></span><span style=display:flex><span>  END
</span></span><span style=display:flex><span>END
</span></span></code></pre></div><p>Then you can finally execute MapServer binary program and output to a local image file.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a90d91>export</span> <span style=color:#000>MS_ERRORFILE</span><span style=color:#000>=</span><span style=color:#c41a16>&#34;stderr&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>export</span> <span style=color:#000>MS_MAPFILE</span><span style=color:#000>=</span>/home/kinow/Development/cpp/workspace/mapserver/nztopo1.map
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>./mapserv -nh <span style=color:#000>QUERY_STRING</span><span style=color:#000>=</span><span style=color:#c41a16>&#34;VERSION=1.1.0&amp;REQUEST=GetMap&amp;LAYERS=nz-coastlines-and-islands-polygons-topo-150k&amp;SRS=EPSG:4167&amp;SERVICE=WMS&amp;TEMPLATE=OpenLayers&amp;BBOX=165.869,-52.6209,183.846,-29.2313&amp;FORMAT=image/jpeg&amp;HEIGHT=800&amp;WIDTH=800&#34;</span> 2&gt;/dev/null &gt; /tmp/nzmap.jpg
</span></span></code></pre></div><h2 id=running-afl>Running afl</h2><p>I decided to use a RAM disk while running afl as suggested
<a href=http://www.cipherdyne.org/blog/2014/12/ram-disks-and-saving-your-ssd-from-afl-fuzzing.html>in this blog post</a>
to avoid a lot of writes in my SSD disk. Then moved MapServer there and fired afl.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a90d91>cd</span> /tmp/afl-ramdisk/mapserver
</span></span><span style=display:flex><span>mkdir fuzz-input fuzz-output
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>/opt/afl-2.05b/afl-fuzz -m <span style=color:#1c01ce>500</span> -i fuzz-input/ -o fuzz-output/ -t <span style=color:#1c01ce>2000</span> ./mapserv <span style=color:#000>QUERY_STRING</span><span style=color:#000>=</span><span style=color:#c41a16>&#34;VERSION=1.1.0&amp;REQUEST=GetMap&amp;LAYERS=nz-coastlines-and-islands-polygons-topo-150k&amp;SRS=EPSG:4167&amp;SERVICE=WMS&amp;TEMPLATE=OpenLayers&amp;BBOX=165.869,-52.6209,183.846,-29.2313&amp;FORMAT=image/jpeg&amp;HEIGHT=800&amp;WIDTH=800&#34;</span>
</span></span></code></pre></div><figure class=feature><img src=/assets/posts/2016-02-27-learning-afl-and-testing-mapserver/afl_testing_mapserver.png alt title width height><figcaption></figcaption></figure><p>However, it is not mutating the program input as I didn&rsquo;t use &ldquo;@@&rdquo; nor a dictionary. When you use @@, afl will replace
it by the location of a file that it generated. Or by using &ldquo;-x&rdquo; you can provide a dictionary used to generate
variations of parameters.</p><p>During the next days I will give it another go at work, and will investigate how to test MapServer without having to write
a wrapper in Shell or C/C++. You can still test other programs that are shipped with MapServer though.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#a90d91>cd</span> /tmp/afl-ramdisk/mapserver
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>/opt/afl-2.05b/afl-fuzz -m <span style=color:#1c01ce>512</span> -i fuzz-input -o fuzz-output -f /tmp/afl-ramdisk/input ./shp2img -m @@ -l nz-coastlines-and-islands-polygons-topo-150k -i image/jpeg -o /tmp/afl-ramdisk/nzmap.jpg -e 165.869 -52.6209 183.846 -29.2313
</span></span></code></pre></div><p>I hope it helps you get started with afl in case you are learning about it too :-) Happy hacking!</p><br><br><sup><a name=1>1</a>
<a href=https://fuzzing-project.org/tutorial3.html>https://fuzzing-project.org/tutorial3.html</a></sup><p><sup><a name=2>2</a>
<a href=https://www.nettitude.co.uk/fuzzing-with-american-fuzzy-lop-afl/><a href=https://www.nettitude.co.uk/fuzzing-with-american-fuzzy-lop-afl/>https://www.nettitude.co.uk/fuzzing-with-american-fuzzy-lop-afl/</a></a></sup></p><p>Categories:
<a href=/categories/blog.html>Blog</a></p><p>Tags:
<a href=/tags/fuzzing.html>Fuzzing</a>,
<a href=/tags/security.html>Security</a>,
<a href=/tags/software-quality.html>Software Quality</a></p><aside class=links><a class=previous href=https://kinoshita.eti.br/2015/09/07/how-does-the-jenkins-credentials-plug-in-store-passwords.html>&#171; Previous</a><a class=next href=https://kinoshita.eti.br/2016/03/20/drawing-sketch-cheese.html>Next &#187;</a></aside></article></main><footer role=contentinfo><ul id=social-media-icons><li><a href=https://www.instagram.com/brunokinoshita/><img src=/assets/icons/instagram.png alt="Instagram link"></a></li><li><a href=https://twitter.com/kinow/><img src=/assets/icons/twitter.png alt="Twitter link"></a></li><li><a href=https://github.com/kinow/><img src=/assets/icons/github.png alt="GitHub link"></a></li><li><a href=/feed.xml><img src=/assets/icons/news.png alt="RSS feed link"></a></li></ul></footer></body></html>