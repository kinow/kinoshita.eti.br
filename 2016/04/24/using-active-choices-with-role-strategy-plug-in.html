<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:url" content="https://kinoshita.eti.br/2016/04/24/using-active-choices-with-role-strategy-plug-in.html"><meta property="og:site_name" content="kinow"><meta property="og:title" content="Using Active Choices with Role Strategy Plug-in"><meta property="og:description" content="Having worked in Open Source for a few years, one of my favorite things is when you can share experience with other people that you meet. Andrew Gray has worked with .NET and Jenkins for years, and we met through Open Source. He has helped me in the past with Jenkins and .NET, and also maintains the blog Jenkins.NET.
A couple of days ago he sent me an interesting question. He asked me if that would be possible to use Active Choices Plug-in with the Role Strategy Plug-in. This plug-in lets you define roles, define which permissions a role has, and then assign users to the roles.
"><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2016-04-24T00:00:00+00:00"><meta property="article:modified_time" content="2024-12-30T23:56:20+01:00"><meta property="article:tag" content="Jenkins"><meta property="og:image" content="https://kinoshita.eti.br/assets/photos/about/2023-me-closeup.png"><meta property="fb:admins" content="bruno.kinoshita"><meta name=twitter:title content="Using Active Choices with Role Strategy Plug-in"><meta name=twitter:description content="Having worked in Open Source for a few years, one of my favorite things is when you can
share experience with other people that you meet. Andrew Gray
has worked with .NET and Jenkins for years, and we met through Open Source. He has helped me
in the past with Jenkins and .NET, and also maintains the blog
Jenkins.NET.
A couple of days ago he sent me an interesting question. He asked me if that would be possible
to use Active Choices Plug-in with the Role Strategy Plug-in.
This plug-in lets you define roles, define which permissions a role has, and then assign users to the roles."><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://kinoshita.eti.br/assets/photos/about/2023-me-closeup.png"><meta name=twitter:site content="@kinow"><link rel=alternate type=application/rss+xml href=https://kinoshita.eti.br/2016/04/24/using-active-choices-with-role-strategy-plug-in/feed.xml title=kinow><link rel=stylesheet type=text/css href=https://kinoshita.eti.br/sass/main.ecb27dc5d5ced6616f17336fdf32a78aff8278ec4b599f9e5cdc5bb8a09a9f28.css integrity="sha256-7LJ9xdXO1mFvFzNv3zKniv+CeOxLWZ+eXNxbuKCanyg="><title>kinow | Using Active Choices with Role Strategy Plug-in</title><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","articleSection":"posts","name":"Using Active Choices with Role Strategy Plug-in","headline":"Using Active Choices with Role Strategy Plug-in","alternativeHeadline":"","description":"\u003cp\u003eHaving worked in Open Source for a few years, one of my favorite things is when you can\nshare experience with other people that you meet. \u003ca href=\u0022https:\/\/github.com\/agray\u0022\u003eAndrew Gray\u003c\/a\u003e\nhas worked with .NET and Jenkins for years, and we met through Open Source. He has helped me\nin the past with Jenkins and .NET, and also maintains the blog\n\u003ca href=\u0022http:\/\/jenkinsheaven.blogspot.co.nz\/\u0022\u003eJenkins.NET\u003c\/a\u003e.\u003c\/p\u003e\n\u003cp\u003eA couple of days ago he sent me an interesting question. He asked me if that would be possible\nto use Active Choices Plug-in with the \u003ca href=\u0022https:\/\/wiki.jenkins-ci.org\/display\/JENKINS\/Role\u002bStrategy\u002bPlugin\u0022\u003eRole Strategy Plug-in\u003c\/a\u003e.\nThis plug-in lets you define roles, define which permissions a role has, and then assign users to the roles.\u003c\/p\u003e","inLanguage":"en-us","isFamilyFriendly":"true","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/kinoshita.eti.br\/2016\/04\/24\/using-active-choices-with-role-strategy-plug-in.html"},"author":{"@type":"Person","name":""},"creator":{"@type":"Person","name":""},"accountablePerson":{"@type":"Person","name":""},"copyrightHolder":"kinow","copyrightYear":"2016","dateCreated":"2016-04-24T00:00:00.00Z","datePublished":"2016-04-24T00:00:00.00Z","dateModified":"2024-12-30T23:56:20.00Z","publisher":{"@type":"Organization","name":"kinow","url":"https://kinoshita.eti.br/","logo":{"@type":"ImageObject","url":"https:\/\/kinoshita.eti.br\/","width":"32","height":"32"}},"image":"https://kinoshita.eti.br/","url":"https:\/\/kinoshita.eti.br\/2016\/04\/24\/using-active-choices-with-role-strategy-plug-in.html","wordCount":"671","genre":["jenkins"],"keywords":[]}</script></head><body><header role=banner class=content><nav id=nav aria-label=Main role=navigation class=content><ul style=position:relative><li><a href=/><i data-feather=about></i> About</a></li><li><a href=/blog/><i data-feather=blog></i> Blog</a></li><li><a href=/portfolio/><i data-feather=portfolio></i> Portfolio</a></li><li style=position:absolute;right:0;bottom:-.75rem;text-align:right><span style=text-transform:uppercase;font-weight:700;font-size:3rem;color:#fffefa;line-height:normal;letter-spacing:-.1rem>Kinow</span></li></ul></nav></header><main><article class=content><h1>Using Active Choices with Role Strategy Plug-in</h1><div class=metadata><i data-feather=calendar></i>
<time datetime=2016-04-24>Apr 24, 2016</time></div><aside><nav id=TableOfContents><ul><li><a href=#to-the-code>To the code</a></li><li><a href=#what-the-result-looks-like-in-jenkins>What the result looks like in Jenkins</a></li><li><a href=#where-can-you-find-this-script>Where can you find this script?</a></li></ul></nav></aside><p>Having worked in Open Source for a few years, one of my favorite things is when you can
share experience with other people that you meet. <a href=https://github.com/agray>Andrew Gray</a>
has worked with .NET and Jenkins for years, and we met through Open Source. He has helped me
in the past with Jenkins and .NET, and also maintains the blog
<a href=http://jenkinsheaven.blogspot.co.nz/>Jenkins.NET</a>.</p><p>A couple of days ago he sent me an interesting question. He asked me if that would be possible
to use Active Choices Plug-in with the <a href=https://wiki.jenkins-ci.org/display/JENKINS/Role+Strategy+Plugin>Role Strategy Plug-in</a>.
This plug-in lets you define roles, define which permissions a role has, and then assign users to the roles.</p><p>The idea was to show a set of parameters that would vary according to the user roles. So, say that the user
is a tester. Then s/he would see certain parameters. But if s/he was a manager, other parameters would be
displayed.</p><h2 id=to-the-code>To the code</h2><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>hudson.model.User</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>hudson.model.Hudson</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>hudson.security.AuthorizationStrategy</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>hudson.security.Permission</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>com.michelin.cio.hudson.plugins.rolestrategy.RoleBasedAuthorizationStrategy</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>com.michelin.cio.hudson.plugins.rolestrategy.RoleMap</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>AuthorizationStrategy</span> <span style=color:#000>strategy</span> <span style=color:#000>=</span> <span style=color:#000>Hudson</span>.<span style=color:#836c28>getInstance</span>().<span style=color:#836c28>getAuthorizationStrategy</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>jobs</span> <span style=color:#000>=</span> <span style=color:#000>[]</span>
</span></span><span style=display:flex><span><span style=color:#000>user</span> <span style=color:#000>=</span> <span style=color:#000>User</span>.<span style=color:#836c28>current</span>()
</span></span><span style=display:flex><span><span style=color:#000>userId</span> <span style=color:#000>=</span> <span style=color:#000>user</span>.<span style=color:#836c28>getId</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a90d91>if</span> (<span style=color:#000>strategy</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span> <span style=color:#000>&amp;&amp;</span> <span style=color:#000>strategy</span> <span style=color:#a90d91>instanceof</span> <span style=color:#000>com</span>.<span style=color:#836c28>michelin</span>.<span style=color:#836c28>cio</span>.<span style=color:#836c28>hudson</span>.<span style=color:#836c28>plugins</span>.<span style=color:#836c28>rolestrategy</span>.<span style=color:#836c28>RoleBasedAuthorizationStrategy</span>) {
</span></span><span style=display:flex><span>    <span style=color:#000>roleStrategy</span> <span style=color:#000>=</span> (<span style=color:#000>RoleBasedAuthorizationStrategy</span>) <span style=color:#000>strategy</span>;
</span></span><span style=display:flex><span>    <span style=color:#177500>// not very straightforward to get the groups for a given user</span>
</span></span><span style=display:flex><span>    <span style=color:#000>roles</span> <span style=color:#000>=</span> <span style=color:#000>roleStrategy</span>.<span style=color:#836c28>getGrantedRoles</span>(<span style=color:#c41a16>&#34;globalRoles&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a90d91>for</span> (<span style=color:#000>entry</span> <span style=color:#000>in</span> <span style=color:#000>roles</span>) {
</span></span><span style=display:flex><span>        <span style=color:#000>role</span> <span style=color:#000>=</span> <span style=color:#000>entry</span>.<span style=color:#836c28>key</span>
</span></span><span style=display:flex><span>        <span style=color:#000>users</span> <span style=color:#000>=</span> <span style=color:#000>entry</span>.<span style=color:#836c28>value</span>
</span></span><span style=display:flex><span>        <span style=color:#000>if</span> (<span style=color:#000>role</span>.<span style=color:#836c28>getName</span>().<span style=color:#836c28>equals</span>(<span style=color:#c41a16>&#34;tester&#34;</span>)) {
</span></span><span style=display:flex><span>            <span style=color:#a90d91>if</span> (<span style=color:#000>userId</span> <span style=color:#000>in</span> <span style=color:#000>users</span>) {
</span></span><span style=display:flex><span>                <span style=color:#000>jobs</span> <span style=color:#000>=</span> <span style=color:#000>[</span><span style=color:#c41a16>&#34;PROJECT_FOR_TESTERS1&#34;</span>, <span style=color:#c41a16>&#34;PROJECT_FOR_TESTERS2&#34;</span><span style=color:#000>]</span>
</span></span><span style=display:flex><span>                <span style=color:#a90d91>break</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        } <span style=color:#a90d91>else</span> <span style=color:#a90d91>if</span> (<span style=color:#000>role</span>.<span style=color:#836c28>getName</span>().<span style=color:#836c28>equals</span>(<span style=color:#c41a16>&#34;admin&#34;</span>)) {
</span></span><span style=display:flex><span>            <span style=color:#a90d91>if</span> (<span style=color:#000>userId</span> <span style=color:#000>in</span> <span style=color:#000>users</span>) {
</span></span><span style=display:flex><span>                <span style=color:#000>jobs</span> <span style=color:#000>=</span> <span style=color:#000>[</span><span style=color:#c41a16>&#34;PROJECT_FOR_ADMINS1&#34;</span>, <span style=color:#c41a16>&#34;PROJECT_FOR_ADMINS2&#34;</span><span style=color:#000>]</span>
</span></span><span style=display:flex><span>                <span style=color:#a90d91>break</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a90d91>return</span> <span style=color:#000>jobs</span>
</span></span><span style=display:flex><span><span style=color:#177500>// TODO: handle anonymous user ;-)</span>
</span></span></code></pre></div><p>And now let&rsquo;s dissect the code.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>hudson.model.User</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>hudson.model.Hudson</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>hudson.security.AuthorizationStrategy</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>hudson.security.Permission</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>com.michelin.cio.hudson.plugins.rolestrategy.RoleBasedAuthorizationStrategy</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>com.michelin.cio.hudson.plugins.rolestrategy.RoleMap</span>
</span></span></code></pre></div><p>You start by importing the classes that you need.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>AuthorizationStrategy</span> <span style=color:#000>strategy</span> <span style=color:#000>=</span> <span style=color:#000>Hudson</span>.<span style=color:#836c28>getInstance</span>().<span style=color:#836c28>getAuthorizationStrategy</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>jobs</span> <span style=color:#000>=</span> <span style=color:#000>[]</span>
</span></span><span style=display:flex><span><span style=color:#000>user</span> <span style=color:#000>=</span> <span style=color:#000>User</span>.<span style=color:#836c28>current</span>()
</span></span><span style=display:flex><span><span style=color:#000>userId</span> <span style=color:#000>=</span> <span style=color:#000>user</span>.<span style=color:#836c28>getId</span>()
</span></span></code></pre></div><p>The first line gets the current <a href=https://github.com/jenkinsci/jenkins/blob/f6e431b80c4d162560419fa51633224a9724bb0d/core/src/main/java/hudson/security/AuthorizationStrategy.java>AuthorizationStrategy</a>
used in Jenkins.</p><p>Then we create an empty array of jobs, which is the value returned by default. And get the current
logged in user ID.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>if</span> (<span style=color:#000>strategy</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span> <span style=color:#000>&amp;&amp;</span> <span style=color:#000>strategy</span> <span style=color:#a90d91>instanceof</span> <span style=color:#000>com</span>.<span style=color:#836c28>michelin</span>.<span style=color:#836c28>cio</span>.<span style=color:#836c28>hudson</span>.<span style=color:#836c28>plugins</span>.<span style=color:#836c28>rolestrategy</span>.<span style=color:#836c28>RoleBasedAuthorizationStrategy</span>) {
</span></span><span style=display:flex><span>    <span style=color:#000>roleStrategy</span> <span style=color:#000>=</span> (<span style=color:#000>RoleBasedAuthorizationStrategy</span>) <span style=color:#000>strategy</span>;
</span></span><span style=display:flex><span>    <span style=color:#177500>// not very straightforward to get the groups for a given user</span>
</span></span><span style=display:flex><span>    <span style=color:#000>roles</span> <span style=color:#000>=</span> <span style=color:#000>roleStrategy</span>.<span style=color:#836c28>getGrantedRoles</span>(<span style=color:#c41a16>&#34;globalRoles&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a90d91>for</span> (<span style=color:#000>entry</span> <span style=color:#000>in</span> <span style=color:#000>roles</span>) {
</span></span><span style=display:flex><span>        <span style=color:#000>role</span> <span style=color:#000>=</span> <span style=color:#000>entry</span>.<span style=color:#836c28>key</span>
</span></span><span style=display:flex><span>        <span style=color:#000>users</span> <span style=color:#000>=</span> <span style=color:#000>entry</span>.<span style=color:#836c28>value</span>
</span></span><span style=display:flex><span>        <span style=color:#000>if</span> (<span style=color:#000>role</span>.<span style=color:#836c28>getName</span>().<span style=color:#836c28>equals</span>(<span style=color:#c41a16>&#34;tester&#34;</span>)) {
</span></span><span style=display:flex><span>            <span style=color:#a90d91>if</span> (<span style=color:#000>userId</span> <span style=color:#000>in</span> <span style=color:#000>users</span>) {
</span></span><span style=display:flex><span>                <span style=color:#000>jobs</span> <span style=color:#000>=</span> <span style=color:#000>[</span><span style=color:#c41a16>&#34;PROJECT_FOR_TESTERS1&#34;</span>, <span style=color:#c41a16>&#34;PROJECT_FOR_TESTERS2&#34;</span><span style=color:#000>]</span>
</span></span><span style=display:flex><span>                <span style=color:#a90d91>break</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        } <span style=color:#a90d91>else</span> <span style=color:#a90d91>if</span> (<span style=color:#000>role</span>.<span style=color:#836c28>getName</span>().<span style=color:#836c28>equals</span>(<span style=color:#c41a16>&#34;admin&#34;</span>)) {
</span></span><span style=display:flex><span>            <span style=color:#a90d91>if</span> (<span style=color:#000>userId</span> <span style=color:#000>in</span> <span style=color:#000>users</span>) {
</span></span><span style=display:flex><span>                <span style=color:#000>jobs</span> <span style=color:#000>=</span> <span style=color:#000>[</span><span style=color:#c41a16>&#34;PROJECT_FOR_ADMINS1&#34;</span>, <span style=color:#c41a16>&#34;PROJECT_FOR_ADMINS2&#34;</span><span style=color:#000>]</span>
</span></span><span style=display:flex><span>                <span style=color:#a90d91>break</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a90d91>return</span> <span style=color:#000>jobs</span>
</span></span><span style=display:flex><span><span style=color:#177500>// TODO: handle anonymous user ;-)</span>
</span></span></code></pre></div><p>The final part simply iterates through each existing role, and then through the
users in that role. I could not find a more elegant way of doing that, but in case
you would like to maybe optimize the code, here are the main classes that I
used from Jenkins to write the script.</p><ul><li><a href=https://github.com/jenkinsci/role-strategy-plugin/blob/b6dca7904ce1c83b3afef0995ef5f42823171b0b/src/main/java/com/michelin/cio/hudson/plugins/rolestrategy/RoleBasedAuthorizationStrategy.java>RoleBasedAuthorizationStrategy.java</a></li><li><a href=https://github.com/jenkinsci/role-strategy-plugin/blob/master/src/main/java/com/michelin/cio/hudson/plugins/rolestrategy/Role.java>Role.java</a></li><li><a href=https://github.com/jenkinsci/role-strategy-plugin/blob/b6dca7904ce1c83b3afef0995ef5f42823171b0b/src/main/java/com/michelin/cio/hudson/plugins/rolestrategy/RoleMap.java>RoleMap</a></li><li><a href=https://github.com/jenkinsci/jenkins/blob/f6e431b80c4d162560419fa51633224a9724bb0d/core/src/main/java/hudson/model/User.java>User.java</a></li></ul><p>Normally I either use my local working copy of Jenkins project imported in Eclipse, or use the
&ldquo;Find File&rdquo; feature in GitHub. Then remember a little bit about Jenkins Java API to walk
through the classes and write the Groovy code (I made a
<a href="https://www.youtube.com/watch?v=jmPJvJGEFb4">video</a> about writing Groovy with Auto Complete in
Eclipse, but that&rsquo;s in Portuguese only).</p><h2 id=what-the-result-looks-like-in-jenkins>What the result looks like in Jenkins</h2><p>In this section we have just simple screenshots, showing the script in the job configuration.</p><figure class=feature><img src=/assets/posts/2016-04-24-using-active-choices-with-role-strategy-plugin/screenshot01.png alt='Screenshot 01' title='Screenshot 01' width height><figcaption>Screenshot 01</figcaption></figure><p>And the resulting screen. The parameter <strong>DeployAPP</strong> will be available during the build,
and can be used to trigger other jobs or pipelines.</p><figure class=feature><img src=/assets/posts/2016-04-24-using-active-choices-with-role-strategy-plugin/screenshot02.png alt title width height><figcaption></figcaption></figure><h2 id=where-can-you-find-this-script>Where can you find this script?</h2><p>This blog post has a copy of the script, but I have also submitted
a pull request to a <a href=https://github.com/imoutsatsos/jenkins-scriptlets>repository</a>
maintained by another friend, <a href=https://github.com/imoutsatsos>Ioannis Moutsatsos</a>. Ioannis
maintains a Jenkins installation in Novartis, and is probably the most skillful user
of the Active Choices Plug-in.</p><p>Another advantage of this other copy, is that it may be updated with time, in case there are
bugs or improvements. So watch Ioannis&rsquo; repository for updates!</p><p>ps: I&rsquo;ve also met Ioannis through Open Source code, and have learned a lot by working with him.</p><p>â™¥ Open Source!</p><p>Categories:
<a href=/categories/blog.html>Blog</a></p><p>Tags:
<a href=/tags/jenkins.html>Jenkins</a></p><aside class=links><a class=previous href=https://kinoshita.eti.br/2016/04/19/drawing-kumamoto-kenjinkai-mascot.html>&#171; Previous</a><a class=next href=https://kinoshita.eti.br/2016/05/06/some-linux-commands-i-used-this-week.html>Next &#187;</a></aside></article></main><footer role=contentinfo><ul id=social-media-icons><li><a href=https://www.instagram.com/brunokinoshita/><img src=/assets/icons/instagram.png alt="Instagram link"></a></li><li><a href=https://bsky.app/profile/kinow.bsky.social><img src=/assets/icons/bluesky.png alt="BlueSky link"></a></li><li><a href=https://twitter.com/kinow/><img src=/assets/icons/twitter.png alt="Twitter link"></a></li><li><a href=https://github.com/kinow/><img src=/assets/icons/github.png alt="GitHub link"></a></li><li><a href=/feed.xml><img src=/assets/icons/news.png alt="RSS feed link"></a></li></ul></footer></body></html>