<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Using Active Choices with Role Strategy Plug-in | Bruno P. Kinoshita</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Using Active Choices with Role Strategy Plug-in" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Having worked in Open Source for a few years, one of my favorite things is when you can share experience with other people that you meet. Andrew Gray has worked with .NET and Jenkins for years, and we met through Open Source. He has helped me in the past with Jenkins and .NET, and also maintains the blog Jenkins.NET. A couple of days ago he sent me an interesting question. He asked me if that would be possible to use Active Choices Plug-in with the Role Strategy Plug-in. This plug-in lets you define roles, define which permissions a role has, and then assign users to the roles." />
<meta property="og:description" content="Having worked in Open Source for a few years, one of my favorite things is when you can share experience with other people that you meet. Andrew Gray has worked with .NET and Jenkins for years, and we met through Open Source. He has helped me in the past with Jenkins and .NET, and also maintains the blog Jenkins.NET. A couple of days ago he sent me an interesting question. He asked me if that would be possible to use Active Choices Plug-in with the Role Strategy Plug-in. This plug-in lets you define roles, define which permissions a role has, and then assign users to the roles." />
<link rel="canonical" href="https://kinoshita.eti.br/2016/04/23/using-active-choices-with-role-strategy-plugin.html" />
<meta property="og:url" content="https://kinoshita.eti.br/2016/04/23/using-active-choices-with-role-strategy-plugin.html" />
<meta property="og:site_name" content="Bruno P. Kinoshita" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2016-04-23T22:05:03-05:00" />
<script type="application/ld+json">
{"datePublished":"2016-04-23T22:05:03-05:00","headline":"Using Active Choices with Role Strategy Plug-in","description":"Having worked in Open Source for a few years, one of my favorite things is when you can share experience with other people that you meet. Andrew Gray has worked with .NET and Jenkins for years, and we met through Open Source. He has helped me in the past with Jenkins and .NET, and also maintains the blog Jenkins.NET. A couple of days ago he sent me an interesting question. He asked me if that would be possible to use Active Choices Plug-in with the Role Strategy Plug-in. This plug-in lets you define roles, define which permissions a role has, and then assign users to the roles.","mainEntityOfPage":{"@type":"WebPage","@id":"https://kinoshita.eti.br/2016/04/23/using-active-choices-with-role-strategy-plugin.html"},"@type":"BlogPosting","url":"https://kinoshita.eti.br/2016/04/23/using-active-choices-with-role-strategy-plugin.html","dateModified":"2016-04-23T22:05:03-05:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/main.css"><link type="application/atom+xml" rel="alternate" href="https://kinoshita.eti.br/feed.xml" title="Bruno P. Kinoshita" /></head>
<body>
<div id="wrapper">
  <div id="sidebar"><div id="menu">
  <ul class="menu">
    <li class="item">
      <a href="/" aria-label="Home page link">
        <svg id="svg8" version="1.1" viewBox="0 0 58.208 9.2604" xmlns="http://www.w3.org/2000/svg" role="img"
             aria-labelledby="svg-logo-title svg-logo-desc">
          <title id="svg-logo-title">KINOSHITA image</title>
          <desc id="svg-logo-desc">A logo with the word KINOSHITA</desc>
          <g id="layer1" transform="translate(0 -287.74)">
            <g id="text817" transform="translate(-2.4568 -.23624)">
              <g id="logo" transform="matrix(2.6585 0 0 2.5911 -63.587 100.56)" fill="#000000" stroke-width=".26458px">
                <path role="presentation" id="path819"
                      d="m25.178 72.637h0.54187v2.9633h-0.54187zm0.5842 1.397 1.0964-1.397h0.635l-1.1049 1.397 1.1049 1.5663h-0.635z"/>
                <path role="presentation" id="path821" d="m27.832 72.637h0.54187v2.9633h-0.54187z"/>
                <path role="presentation" id="path823"
                      d="m29.023 72.637h0.5334l1.2658 1.9135v-1.9135h0.54187v2.9633h-0.4445l-1.3547-2.032v2.032h-0.54187z"/>
                <path role="presentation" id="path825"
                      d="m33.298 75.66q-0.4191 0-0.75353-0.1905-0.3302-0.19473-0.5207-0.54187-0.18627-0.35137-0.18627-0.80857t0.18627-0.80433q0.1905-0.35137 0.5207-0.54187 0.33443-0.19473 0.75353-0.19473t0.7493 0.19473q0.33443 0.1905 0.5207 0.54187 0.1905 0.34713 0.1905 0.80433t-0.1905 0.80857q-0.18627 0.34713-0.5207 0.54187-0.3302 0.1905-0.7493 0.1905zm0-0.52493q0.4318 0 0.6604-0.2794 0.23283-0.2794 0.23283-0.7366t-0.23283-0.7366q-0.2286-0.2794-0.6604-0.2794t-0.66463 0.2794q-0.2286 0.2794-0.2286 0.7366t0.2286 0.7366q0.23283 0.2794 0.66463 0.2794z"/>
                <path role="presentation" id="path827"
                      d="m36.091 75.66q-0.24977 0-0.53763-0.06773-0.28363-0.06773-0.4445-0.14817l0.0635-0.57573q0.5588 0.27093 0.98213 0.27093 0.22437 0 0.35137-0.08467 0.127-0.0889 0.127-0.25823 0-0.127-0.07197-0.20743-0.06773-0.08467-0.19897-0.1397-0.13123-0.05927-0.4191-0.16087-0.27093-0.09313-0.44873-0.19473-0.1778-0.10583-0.28363-0.2667-0.1016-0.1651-0.1016-0.40217 0-0.381 0.2794-0.61383t0.8001-0.23283q0.24553 0 0.48683 0.05503 0.24553 0.05503 0.44873 0.13547l-0.05503 0.55457q-0.26247-0.1143-0.4826-0.16933-0.2159-0.05927-0.4318-0.05927-0.2413 0-0.3683 0.08043t-0.127 0.23283q0 0.11853 0.06773 0.19473t0.18203 0.127q0.11853 0.0508 0.34713 0.12277 0.51223 0.16087 0.74507 0.37253 0.23707 0.20743 0.23707 0.5715 0 0.34713-0.2413 0.60537t-0.90593 0.25823z"/>
                <path role="presentation" id="path829"
                      d="m37.688 72.637h0.54187v1.1726h1.3547v-1.1726h0.54187v2.9633h-0.54187v-1.2827h-1.3547v1.2827h-0.54187z"/>
                <path role="presentation" id="path831" d="m40.78 72.637h0.54187v2.9633h-0.54187z"/>
                <path role="presentation" id="path833"
                      d="m42.546 73.162h-0.8382v-0.52493h2.2183v0.52493h-0.8382v2.4384h-0.54187z"/>
                <path role="presentation" id="path835"
                      d="m45.632 74.898h-1.0795l-0.24553 0.70273h-0.52493l1.0541-2.9633h0.51223l1.0541 2.9633h-0.52493zm-0.16933-0.47413-0.3683-1.0583-0.37253 1.0583z"/>
              </g>
            </g>
          </g>
        </svg>
      </a>
    </li>
    <li class="item">
      <a href="/blog/" class="">Blog</a>
      <ul>
        <li class="item">
          <a href="/blog/drawing/">Drawing</a>
        </li>
        <li class="item">
          <a href="/blog/languages/">Languages</a>
        </li>
        <li class="item">
          <a href="/blog/music/">Music</a>
        </li>
        <li class="item">
          <a href="/blog/writing/">Writing</a>
        </li>
      </ul>
    </li>
    <li class="item">
      <a href="/art/" class="">Illustrations</a>
    </li>
    <li class="item">
      <a href="/maps/" class="">Maps</a>
    </li>
  </ul>
  <div id="menu-bottom">
    <p id="feed-subscribe">
      <a href="/feed.xml">
        <svg id="feed-icon" xmlns="http://www.w3.org/2000/svg" version="1.1" width="128px" height="128px"
             viewBox="0 0 256 256">
          <circle cx="68" cy="189" r="24" fill="rgba(255, 255, 255, .2)"/>
          <path d="M160 213h-34a82 82 0 0 0 -82 -82v-34a116 116 0 0 1 116 116z" fill="rgba(255, 255, 255, .2)"/>
          <path d="M184 213A140 140 0 0 0 44 73 V 38a175 175 0 0 1 175 175z" fill="rgba(255, 255, 255, .2)"/>
        </svg>
      </a>
    </p>
  </div>
</div>
</div>
  <div id="content">
    <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Using Active Choices with Role Strategy Plug-in</h1>
    <spab class="post-meta">
      <time class="dt-published" datetime="2016-04-23T22:05:03-05:00" itemprop="datePublished">Apr 23, 2016
      </time>
      21<span>&mdash; star date: -306612.02</span></spab>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>Having worked in Open Source for a few years, one of my favorite things is when you can
share experience with other people that you meet. <a href="https://github.com/agray">Andrew Gray</a>
has worked with .NET and Jenkins for years, and we met through Open Source. He has helped me
in the past with Jenkins and .NET, and also maintains the blog
<a href="http://jenkinsheaven.blogspot.co.nz/">Jenkins.NET</a>.</p>

<p>A couple of days ago he sent me an interesting question. He asked me if that would be possible
to use Active Choices Plug-in with the <a href="https://wiki.jenkins-ci.org/display/JENKINS/Role+Strategy+Plugin">Role Strategy Plug-in</a>.
This plug-in lets you define roles, define which permissions a role has, and then assign users to the roles.</p>

<!--more-->

<p>The idea was to show a set of parameters that would vary according to the user roles. So, say that the user
is a tester. Then s/he would see certain parameters. But if s/he was a manager, other parameters would be
displayed.</p>

<h2 id="to-the-code">To the code</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">hudson.model.User</span>
<span class="kn">import</span> <span class="nn">hudson.model.Hudson</span>
<span class="kn">import</span> <span class="nn">hudson.security.AuthorizationStrategy</span>
<span class="kn">import</span> <span class="nn">hudson.security.Permission</span>
<span class="kn">import</span> <span class="nn">com.michelin.cio.hudson.plugins.rolestrategy.RoleBasedAuthorizationStrategy</span>
<span class="kn">import</span> <span class="nn">com.michelin.cio.hudson.plugins.rolestrategy.RoleMap</span>

<span class="nc">AuthorizationStrategy</span> <span class="n">strategy</span> <span class="o">=</span> <span class="nc">Hudson</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">getAuthorizationStrategy</span><span class="o">();</span>

<span class="n">jobs</span> <span class="o">=</span> <span class="o">[]</span>
<span class="n">user</span> <span class="o">=</span> <span class="nc">User</span><span class="o">.</span><span class="na">current</span><span class="o">()</span>
<span class="n">userId</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">()</span>

<span class="k">if</span> <span class="o">(</span><span class="n">strategy</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">strategy</span> <span class="k">instanceof</span> <span class="n">com</span><span class="o">.</span><span class="na">michelin</span><span class="o">.</span><span class="na">cio</span><span class="o">.</span><span class="na">hudson</span><span class="o">.</span><span class="na">plugins</span><span class="o">.</span><span class="na">rolestrategy</span><span class="o">.</span><span class="na">RoleBasedAuthorizationStrategy</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">roleStrategy</span> <span class="o">=</span> <span class="o">(</span><span class="nc">RoleBasedAuthorizationStrategy</span><span class="o">)</span> <span class="n">strategy</span><span class="o">;</span>
    <span class="c1">// not very straightforward to get the groups for a given user</span>
    <span class="n">roles</span> <span class="o">=</span> <span class="n">roleStrategy</span><span class="o">.</span><span class="na">getGrantedRoles</span><span class="o">(</span><span class="s">"globalRoles"</span><span class="o">)</span>
    <span class="k">for</span> <span class="o">(</span><span class="n">entry</span> <span class="n">in</span> <span class="n">roles</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">role</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">key</span>
        <span class="n">users</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">value</span>
        <span class="nf">if</span> <span class="o">(</span><span class="n">role</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">"tester"</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">userId</span> <span class="n">in</span> <span class="n">users</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">jobs</span> <span class="o">=</span> <span class="o">[</span><span class="s">"PROJECT_FOR_TESTERS1"</span><span class="o">,</span> <span class="s">"PROJECT_FOR_TESTERS2"</span><span class="o">]</span>
                <span class="k">break</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">role</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">"admin"</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">userId</span> <span class="n">in</span> <span class="n">users</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">jobs</span> <span class="o">=</span> <span class="o">[</span><span class="s">"PROJECT_FOR_ADMINS1"</span><span class="o">,</span> <span class="s">"PROJECT_FOR_ADMINS2"</span><span class="o">]</span>
                <span class="k">break</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="k">return</span> <span class="n">jobs</span>
<span class="c1">// TODO: handle anonymous user ;-)</span>
</code></pre></div></div>

<p>And now let’s dissect the code.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">hudson.model.User</span>
<span class="kn">import</span> <span class="nn">hudson.model.Hudson</span>
<span class="kn">import</span> <span class="nn">hudson.security.AuthorizationStrategy</span>
<span class="kn">import</span> <span class="nn">hudson.security.Permission</span>
<span class="kn">import</span> <span class="nn">com.michelin.cio.hudson.plugins.rolestrategy.RoleBasedAuthorizationStrategy</span>
<span class="kn">import</span> <span class="nn">com.michelin.cio.hudson.plugins.rolestrategy.RoleMap</span>
</code></pre></div></div>

<p>You start by importing the classes that you need.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">AuthorizationStrategy</span> <span class="n">strategy</span> <span class="o">=</span> <span class="nc">Hudson</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">getAuthorizationStrategy</span><span class="o">();</span>

<span class="n">jobs</span> <span class="o">=</span> <span class="o">[]</span>
<span class="n">user</span> <span class="o">=</span> <span class="nc">User</span><span class="o">.</span><span class="na">current</span><span class="o">()</span>
<span class="n">userId</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">()</span>
</code></pre></div></div>

<p>The first line gets the current <a href="https://github.com/jenkinsci/jenkins/blob/f6e431b80c4d162560419fa51633224a9724bb0d/core/src/main/java/hudson/security/AuthorizationStrategy.java">AuthorizationStrategy</a>
used in Jenkins.</p>

<p>Then we create an empty array of jobs, which is the value returned by default. And get the current
logged in user ID.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="o">(</span><span class="n">strategy</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">strategy</span> <span class="k">instanceof</span> <span class="n">com</span><span class="o">.</span><span class="na">michelin</span><span class="o">.</span><span class="na">cio</span><span class="o">.</span><span class="na">hudson</span><span class="o">.</span><span class="na">plugins</span><span class="o">.</span><span class="na">rolestrategy</span><span class="o">.</span><span class="na">RoleBasedAuthorizationStrategy</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">roleStrategy</span> <span class="o">=</span> <span class="o">(</span><span class="nc">RoleBasedAuthorizationStrategy</span><span class="o">)</span> <span class="n">strategy</span><span class="o">;</span>
    <span class="c1">// not very straightforward to get the groups for a given user</span>
    <span class="n">roles</span> <span class="o">=</span> <span class="n">roleStrategy</span><span class="o">.</span><span class="na">getGrantedRoles</span><span class="o">(</span><span class="s">"globalRoles"</span><span class="o">)</span>
    <span class="k">for</span> <span class="o">(</span><span class="n">entry</span> <span class="n">in</span> <span class="n">roles</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">role</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">key</span>
        <span class="n">users</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">value</span>
        <span class="nf">if</span> <span class="o">(</span><span class="n">role</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">"tester"</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">userId</span> <span class="n">in</span> <span class="n">users</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">jobs</span> <span class="o">=</span> <span class="o">[</span><span class="s">"PROJECT_FOR_TESTERS1"</span><span class="o">,</span> <span class="s">"PROJECT_FOR_TESTERS2"</span><span class="o">]</span>
                <span class="k">break</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">role</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">"admin"</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">userId</span> <span class="n">in</span> <span class="n">users</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">jobs</span> <span class="o">=</span> <span class="o">[</span><span class="s">"PROJECT_FOR_ADMINS1"</span><span class="o">,</span> <span class="s">"PROJECT_FOR_ADMINS2"</span><span class="o">]</span>
                <span class="k">break</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="k">return</span> <span class="n">jobs</span>
<span class="c1">// TODO: handle anonymous user ;-)</span>
</code></pre></div></div>

<p>The final part simply iterates through each existing role, and then through the
users in that role. I could not find a more elegant way of doing that, but in case
you would like to maybe optimize the code, here are the main classes that I
used from Jenkins to write the script.</p>

<ul>
  <li><a href="https://github.com/jenkinsci/role-strategy-plugin/blob/b6dca7904ce1c83b3afef0995ef5f42823171b0b/src/main/java/com/michelin/cio/hudson/plugins/rolestrategy/RoleBasedAuthorizationStrategy.java">RoleBasedAuthorizationStrategy.java</a></li>
  <li><a href="https://github.com/jenkinsci/role-strategy-plugin/blob/master/src/main/java/com/michelin/cio/hudson/plugins/rolestrategy/Role.java">Role.java</a></li>
  <li><a href="https://github.com/jenkinsci/role-strategy-plugin/blob/b6dca7904ce1c83b3afef0995ef5f42823171b0b/src/main/java/com/michelin/cio/hudson/plugins/rolestrategy/RoleMap.java">RoleMap</a></li>
  <li><a href="https://github.com/jenkinsci/jenkins/blob/f6e431b80c4d162560419fa51633224a9724bb0d/core/src/main/java/hudson/model/User.java">User.java</a></li>
</ul>

<p>Normally I either use my local working copy of Jenkins project imported in Eclipse, or use the
“Find File” feature in GitHub. Then remember a little bit about Jenkins Java API to walk
through the classes and write the Groovy code (I made a
<a href="https://www.youtube.com/watch?v=jmPJvJGEFb4">video</a> about writing Groovy with Auto Complete in
Eclipse, but that’s in Portuguese only).</p>

<h2 id="what-the-result-looks-like-in-jenkins">What the result looks like in Jenkins</h2>

<p>In this section we have just simple screenshots, showing the script in the job configuration.</p>

<p><img class="ui fluid image" src="/assets/posts/2016-04-23-using-active-choices-with-role-strategy-plug-in/screenshot01.png" alt="Screenshot 01" /></p>

<p>And the resulting screen. The parameter <strong>DeployAPP</strong> will be available during the build,
and can be used to trigger other jobs or pipelines.</p>

<p><img class="ui fluid image" src="/assets/posts/2016-04-23-using-active-choices-with-role-strategy-plug-in/screenshot02.png" /></p>

<h2 id="where-can-you-find-this-script">Where can you find this script?</h2>

<p>This blog post has a copy of the script, but I have also submitted
a pull request to a <a href="https://github.com/imoutsatsos/jenkins-scriptlets">repository</a>
maintained by another friend, <a href="https://github.com/imoutsatsos">Ioannis Moutsatsos</a>. Ioannis
maintains a Jenkins installation in Novartis, and is probably the most skillful user
of the Active Choices Plug-in.</p>

<p>Another advantage of this other copy, is that it may be updated with time, in case there are
bugs or improvements. So watch Ioannis’ repository for updates!</p>

<p>ps: I’ve also met Ioannis through Open Source code, and have learned a lot by working with him.</p>

<p>♥ Open Source!</p>

  </div>

  <div class="tags"><a class="label" href="/tags#jenkins">jenkins</a></div>

  <a class="u-url" href="/2016/04/23/using-active-choices-with-role-strategy-plugin.html" hidden></a>
</article>

  </div>
</div>
</body>
</html>
