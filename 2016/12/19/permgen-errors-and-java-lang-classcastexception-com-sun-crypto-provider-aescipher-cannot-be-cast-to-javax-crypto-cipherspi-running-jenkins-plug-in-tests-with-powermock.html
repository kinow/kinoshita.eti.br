<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>PermGen errors and java.lang.ClassCastException: com.sun.crypto.provider.AESCipher cannot be cast to javax.crypto.CipherSpi running Jenkins plug-in tests with PowerMock | Bruno P. Kinoshita</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="PermGen errors and java.lang.ClassCastException: com.sun.crypto.provider.AESCipher cannot be cast to javax.crypto.CipherSpi running Jenkins plug-in tests with PowerMock" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Recently while working on a Jenkins plugin some tests were failing with PermGen errors. Even though it worked in my notebook at home (with Java 8, thus no Permgen), it failed in a CloudBees hosted Jenkins job, and also on my Mac (with Java 7) at work. As I could not change the settings in the CloudBees hosted Jenkins, I decided to spent some time investigating why these tests would require so much memory. Then I found this blog post about PowerMock. I was not using the @PrepareForTest annotation, but after adding it the issue was gone. So I assume it either prevents PowerMock from trying to dynamically load several classes, or instructs it to unload classes after the tests. But in anyway after adding it the issue was gone. Then I got the following exception. WARNING: Failed to instantiate Key[type=hudson.security.csrf.DefaultCrumbIssuer$DescriptorImpl, annotation=[none]]; skipping this component com.google.inject.ProvisionException: Guice provision errors: 1) Error injecting constructor, java.lang.ClassCastException: com.sun.crypto.provider.AESCipher cannot be cast to javax.crypto.CipherSpi at hudson.security.csrf.DefaultCrumbIssuer$DescriptorImpl.&lt;init&gt;(DefaultCrumbIssuer.java:127) 1 error at com.google.inject.internal.ProviderToInternalFactoryAdapter.get(ProviderToInternalFactoryAdapter.java:52) And then thanks to this issue I understood that PowerMock was mocking javax.crypto classes. Turns out it is quite easy to tell PowerMock to ignore certain classes from being mocked, with the @PowerMockIgnore annotation. // snip @RunWith(PowerMockRunner.class) @PowerMockIgnore({&quot;javax.crypto.*&quot; }) public class TestAbstractUnoChoiceParameter { // } // snip Added a couple of notes to this Jenkins Wiki page so that users facing similar issues can try these possible workarounds. Hope that helps someone!" />
<meta property="og:description" content="Recently while working on a Jenkins plugin some tests were failing with PermGen errors. Even though it worked in my notebook at home (with Java 8, thus no Permgen), it failed in a CloudBees hosted Jenkins job, and also on my Mac (with Java 7) at work. As I could not change the settings in the CloudBees hosted Jenkins, I decided to spent some time investigating why these tests would require so much memory. Then I found this blog post about PowerMock. I was not using the @PrepareForTest annotation, but after adding it the issue was gone. So I assume it either prevents PowerMock from trying to dynamically load several classes, or instructs it to unload classes after the tests. But in anyway after adding it the issue was gone. Then I got the following exception. WARNING: Failed to instantiate Key[type=hudson.security.csrf.DefaultCrumbIssuer$DescriptorImpl, annotation=[none]]; skipping this component com.google.inject.ProvisionException: Guice provision errors: 1) Error injecting constructor, java.lang.ClassCastException: com.sun.crypto.provider.AESCipher cannot be cast to javax.crypto.CipherSpi at hudson.security.csrf.DefaultCrumbIssuer$DescriptorImpl.&lt;init&gt;(DefaultCrumbIssuer.java:127) 1 error at com.google.inject.internal.ProviderToInternalFactoryAdapter.get(ProviderToInternalFactoryAdapter.java:52) And then thanks to this issue I understood that PowerMock was mocking javax.crypto classes. Turns out it is quite easy to tell PowerMock to ignore certain classes from being mocked, with the @PowerMockIgnore annotation. // snip @RunWith(PowerMockRunner.class) @PowerMockIgnore({&quot;javax.crypto.*&quot; }) public class TestAbstractUnoChoiceParameter { // } // snip Added a couple of notes to this Jenkins Wiki page so that users facing similar issues can try these possible workarounds. Hope that helps someone!" />
<link rel="canonical" href="https://kinoshita.eti.br/2016/12/19/permgen-errors-and-java-lang-classcastexception-com-sun-crypto-provider-aescipher-cannot-be-cast-to-javax-crypto-cipherspi-running-jenkins-plug-in-tests-with-powermock.html" />
<meta property="og:url" content="https://kinoshita.eti.br/2016/12/19/permgen-errors-and-java-lang-classcastexception-com-sun-crypto-provider-aescipher-cannot-be-cast-to-javax-crypto-cipherspi-running-jenkins-plug-in-tests-with-powermock.html" />
<meta property="og:site_name" content="Bruno P. Kinoshita" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2016-12-19T19:20:03+13:00" />
<script type="application/ld+json">
{"headline":"PermGen errors and java.lang.ClassCastException: com.sun.crypto.provider.AESCipher cannot be cast to javax.crypto.CipherSpi running Jenkins plug-in tests with PowerMock","dateModified":"2016-12-19T19:20:03+13:00","datePublished":"2016-12-19T19:20:03+13:00","description":"Recently while working on a Jenkins plugin some tests were failing with PermGen errors. Even though it worked in my notebook at home (with Java 8, thus no Permgen), it failed in a CloudBees hosted Jenkins job, and also on my Mac (with Java 7) at work. As I could not change the settings in the CloudBees hosted Jenkins, I decided to spent some time investigating why these tests would require so much memory. Then I found this blog post about PowerMock. I was not using the @PrepareForTest annotation, but after adding it the issue was gone. So I assume it either prevents PowerMock from trying to dynamically load several classes, or instructs it to unload classes after the tests. But in anyway after adding it the issue was gone. Then I got the following exception. WARNING: Failed to instantiate Key[type=hudson.security.csrf.DefaultCrumbIssuer$DescriptorImpl, annotation=[none]]; skipping this component com.google.inject.ProvisionException: Guice provision errors: 1) Error injecting constructor, java.lang.ClassCastException: com.sun.crypto.provider.AESCipher cannot be cast to javax.crypto.CipherSpi at hudson.security.csrf.DefaultCrumbIssuer$DescriptorImpl.&lt;init&gt;(DefaultCrumbIssuer.java:127) 1 error at com.google.inject.internal.ProviderToInternalFactoryAdapter.get(ProviderToInternalFactoryAdapter.java:52) And then thanks to this issue I understood that PowerMock was mocking javax.crypto classes. Turns out it is quite easy to tell PowerMock to ignore certain classes from being mocked, with the @PowerMockIgnore annotation. // snip @RunWith(PowerMockRunner.class) @PowerMockIgnore({&quot;javax.crypto.*&quot; }) public class TestAbstractUnoChoiceParameter { // } // snip Added a couple of notes to this Jenkins Wiki page so that users facing similar issues can try these possible workarounds. Hope that helps someone!","mainEntityOfPage":{"@type":"WebPage","@id":"https://kinoshita.eti.br/2016/12/19/permgen-errors-and-java-lang-classcastexception-com-sun-crypto-provider-aescipher-cannot-be-cast-to-javax-crypto-cipherspi-running-jenkins-plug-in-tests-with-powermock.html"},"@type":"BlogPosting","url":"https://kinoshita.eti.br/2016/12/19/permgen-errors-and-java-lang-classcastexception-com-sun-crypto-provider-aescipher-cannot-be-cast-to-javax-crypto-cipherspi-running-jenkins-plug-in-tests-with-powermock.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/main.css"><link type="application/atom+xml" rel="alternate" href="https://kinoshita.eti.br/feed.xml" title="Bruno P. Kinoshita" /></head>
<body>
<div id="mobile-menu"><div class="menu">
  <ul class="menu">
    <li class="item">
      <a href="/" aria-label="Home page link">
        <svg id="svg8" version="1.1" viewBox="0 0 58.208 9.2604" xmlns="http://www.w3.org/2000/svg" role="img"
             aria-labelledby="svg-logo-title svg-logo-desc">
          <title id="svg-logo-title">KINOSHITA image</title>
          <desc id="svg-logo-desc">A logo with the word KINOSHITA</desc>
          <g id="layer1" transform="translate(0 -287.74)">
            <g id="text817" transform="translate(-2.4568 -.23624)">
              <g id="logo" transform="matrix(2.6585 0 0 2.5911 -63.587 100.56)" fill="#000000" stroke-width=".26458px">
                <path role="presentation" id="path819"
                      d="m25.178 72.637h0.54187v2.9633h-0.54187zm0.5842 1.397 1.0964-1.397h0.635l-1.1049 1.397 1.1049 1.5663h-0.635z"/>
                <path role="presentation" id="path821" d="m27.832 72.637h0.54187v2.9633h-0.54187z"/>
                <path role="presentation" id="path823"
                      d="m29.023 72.637h0.5334l1.2658 1.9135v-1.9135h0.54187v2.9633h-0.4445l-1.3547-2.032v2.032h-0.54187z"/>
                <path role="presentation" id="path825"
                      d="m33.298 75.66q-0.4191 0-0.75353-0.1905-0.3302-0.19473-0.5207-0.54187-0.18627-0.35137-0.18627-0.80857t0.18627-0.80433q0.1905-0.35137 0.5207-0.54187 0.33443-0.19473 0.75353-0.19473t0.7493 0.19473q0.33443 0.1905 0.5207 0.54187 0.1905 0.34713 0.1905 0.80433t-0.1905 0.80857q-0.18627 0.34713-0.5207 0.54187-0.3302 0.1905-0.7493 0.1905zm0-0.52493q0.4318 0 0.6604-0.2794 0.23283-0.2794 0.23283-0.7366t-0.23283-0.7366q-0.2286-0.2794-0.6604-0.2794t-0.66463 0.2794q-0.2286 0.2794-0.2286 0.7366t0.2286 0.7366q0.23283 0.2794 0.66463 0.2794z"/>
                <path role="presentation" id="path827"
                      d="m36.091 75.66q-0.24977 0-0.53763-0.06773-0.28363-0.06773-0.4445-0.14817l0.0635-0.57573q0.5588 0.27093 0.98213 0.27093 0.22437 0 0.35137-0.08467 0.127-0.0889 0.127-0.25823 0-0.127-0.07197-0.20743-0.06773-0.08467-0.19897-0.1397-0.13123-0.05927-0.4191-0.16087-0.27093-0.09313-0.44873-0.19473-0.1778-0.10583-0.28363-0.2667-0.1016-0.1651-0.1016-0.40217 0-0.381 0.2794-0.61383t0.8001-0.23283q0.24553 0 0.48683 0.05503 0.24553 0.05503 0.44873 0.13547l-0.05503 0.55457q-0.26247-0.1143-0.4826-0.16933-0.2159-0.05927-0.4318-0.05927-0.2413 0-0.3683 0.08043t-0.127 0.23283q0 0.11853 0.06773 0.19473t0.18203 0.127q0.11853 0.0508 0.34713 0.12277 0.51223 0.16087 0.74507 0.37253 0.23707 0.20743 0.23707 0.5715 0 0.34713-0.2413 0.60537t-0.90593 0.25823z"/>
                <path role="presentation" id="path829"
                      d="m37.688 72.637h0.54187v1.1726h1.3547v-1.1726h0.54187v2.9633h-0.54187v-1.2827h-1.3547v1.2827h-0.54187z"/>
                <path role="presentation" id="path831" d="m40.78 72.637h0.54187v2.9633h-0.54187z"/>
                <path role="presentation" id="path833"
                      d="m42.546 73.162h-0.8382v-0.52493h2.2183v0.52493h-0.8382v2.4384h-0.54187z"/>
                <path role="presentation" id="path835"
                      d="m45.632 74.898h-1.0795l-0.24553 0.70273h-0.52493l1.0541-2.9633h0.51223l1.0541 2.9633h-0.52493zm-0.16933-0.47413-0.3683-1.0583-0.37253 1.0583z"/>
              </g>
            </g>
          </g>
        </svg>
      </a>
    </li>
    <li class="item">
      <a href="/blog/" class="">Blog</a>
      <ul>
        <li class="item">
          <a href="/blog/drawing/">Drawing</a>
        </li>
        <li class="item">
          <a href="/blog/languages/">Languages</a>
        </li>
        <li class="item">
          <a href="/blog/music/">Music</a>
        </li>
        <li class="item">
          <a href="/blog/writing/">Writing</a>
        </li>
      </ul>
    </li>
    <li class="item">
      <a href="/art/" class="">Illustrations</a>
    </li>
    <li class="item">
      <a href="/maps/" class="">Maps</a>
    </li>
  </ul>
  <div id="menu-bottom">
    <p id="feed-subscribe">
      <a href="/feed.xml">
        <svg id="feed-icon" xmlns="http://www.w3.org/2000/svg" version="1.1" width="128px" height="128px"
             viewBox="0 0 256 256">
          <circle cx="68" cy="189" r="24" fill="rgba(255, 255, 255, .2)"/>
          <path d="M160 213h-34a82 82 0 0 0 -82 -82v-34a116 116 0 0 1 116 116z" fill="rgba(255, 255, 255, .2)"/>
          <path d="M184 213A140 140 0 0 0 44 73 V 38a175 175 0 0 1 175 175z" fill="rgba(255, 255, 255, .2)"/>
        </svg>
      </a>
    </p>
  </div>
</div>
</div>
<div id="wrapper">
  <div id="sidebar"><div class="menu">
  <ul class="menu">
    <li class="item">
      <a href="/" aria-label="Home page link">
        <svg id="svg8" version="1.1" viewBox="0 0 58.208 9.2604" xmlns="http://www.w3.org/2000/svg" role="img"
             aria-labelledby="svg-logo-title svg-logo-desc">
          <title id="svg-logo-title">KINOSHITA image</title>
          <desc id="svg-logo-desc">A logo with the word KINOSHITA</desc>
          <g id="layer1" transform="translate(0 -287.74)">
            <g id="text817" transform="translate(-2.4568 -.23624)">
              <g id="logo" transform="matrix(2.6585 0 0 2.5911 -63.587 100.56)" fill="#000000" stroke-width=".26458px">
                <path role="presentation" id="path819"
                      d="m25.178 72.637h0.54187v2.9633h-0.54187zm0.5842 1.397 1.0964-1.397h0.635l-1.1049 1.397 1.1049 1.5663h-0.635z"/>
                <path role="presentation" id="path821" d="m27.832 72.637h0.54187v2.9633h-0.54187z"/>
                <path role="presentation" id="path823"
                      d="m29.023 72.637h0.5334l1.2658 1.9135v-1.9135h0.54187v2.9633h-0.4445l-1.3547-2.032v2.032h-0.54187z"/>
                <path role="presentation" id="path825"
                      d="m33.298 75.66q-0.4191 0-0.75353-0.1905-0.3302-0.19473-0.5207-0.54187-0.18627-0.35137-0.18627-0.80857t0.18627-0.80433q0.1905-0.35137 0.5207-0.54187 0.33443-0.19473 0.75353-0.19473t0.7493 0.19473q0.33443 0.1905 0.5207 0.54187 0.1905 0.34713 0.1905 0.80433t-0.1905 0.80857q-0.18627 0.34713-0.5207 0.54187-0.3302 0.1905-0.7493 0.1905zm0-0.52493q0.4318 0 0.6604-0.2794 0.23283-0.2794 0.23283-0.7366t-0.23283-0.7366q-0.2286-0.2794-0.6604-0.2794t-0.66463 0.2794q-0.2286 0.2794-0.2286 0.7366t0.2286 0.7366q0.23283 0.2794 0.66463 0.2794z"/>
                <path role="presentation" id="path827"
                      d="m36.091 75.66q-0.24977 0-0.53763-0.06773-0.28363-0.06773-0.4445-0.14817l0.0635-0.57573q0.5588 0.27093 0.98213 0.27093 0.22437 0 0.35137-0.08467 0.127-0.0889 0.127-0.25823 0-0.127-0.07197-0.20743-0.06773-0.08467-0.19897-0.1397-0.13123-0.05927-0.4191-0.16087-0.27093-0.09313-0.44873-0.19473-0.1778-0.10583-0.28363-0.2667-0.1016-0.1651-0.1016-0.40217 0-0.381 0.2794-0.61383t0.8001-0.23283q0.24553 0 0.48683 0.05503 0.24553 0.05503 0.44873 0.13547l-0.05503 0.55457q-0.26247-0.1143-0.4826-0.16933-0.2159-0.05927-0.4318-0.05927-0.2413 0-0.3683 0.08043t-0.127 0.23283q0 0.11853 0.06773 0.19473t0.18203 0.127q0.11853 0.0508 0.34713 0.12277 0.51223 0.16087 0.74507 0.37253 0.23707 0.20743 0.23707 0.5715 0 0.34713-0.2413 0.60537t-0.90593 0.25823z"/>
                <path role="presentation" id="path829"
                      d="m37.688 72.637h0.54187v1.1726h1.3547v-1.1726h0.54187v2.9633h-0.54187v-1.2827h-1.3547v1.2827h-0.54187z"/>
                <path role="presentation" id="path831" d="m40.78 72.637h0.54187v2.9633h-0.54187z"/>
                <path role="presentation" id="path833"
                      d="m42.546 73.162h-0.8382v-0.52493h2.2183v0.52493h-0.8382v2.4384h-0.54187z"/>
                <path role="presentation" id="path835"
                      d="m45.632 74.898h-1.0795l-0.24553 0.70273h-0.52493l1.0541-2.9633h0.51223l1.0541 2.9633h-0.52493zm-0.16933-0.47413-0.3683-1.0583-0.37253 1.0583z"/>
              </g>
            </g>
          </g>
        </svg>
      </a>
    </li>
    <li class="item">
      <a href="/blog/" class="">Blog</a>
      <ul>
        <li class="item">
          <a href="/blog/drawing/">Drawing</a>
        </li>
        <li class="item">
          <a href="/blog/languages/">Languages</a>
        </li>
        <li class="item">
          <a href="/blog/music/">Music</a>
        </li>
        <li class="item">
          <a href="/blog/writing/">Writing</a>
        </li>
      </ul>
    </li>
    <li class="item">
      <a href="/art/" class="">Illustrations</a>
    </li>
    <li class="item">
      <a href="/maps/" class="">Maps</a>
    </li>
  </ul>
  <div id="menu-bottom">
    <p id="feed-subscribe">
      <a href="/feed.xml">
        <svg id="feed-icon" xmlns="http://www.w3.org/2000/svg" version="1.1" width="128px" height="128px"
             viewBox="0 0 256 256">
          <circle cx="68" cy="189" r="24" fill="rgba(255, 255, 255, .2)"/>
          <path d="M160 213h-34a82 82 0 0 0 -82 -82v-34a116 116 0 0 1 116 116z" fill="rgba(255, 255, 255, .2)"/>
          <path d="M184 213A140 140 0 0 0 44 73 V 38a175 175 0 0 1 175 175z" fill="rgba(255, 255, 255, .2)"/>
        </svg>
      </a>
    </p>
  </div>
</div>
</div>
  <div id="content">
    <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">PermGen errors and java.lang.ClassCastException: com.sun.crypto.provider.AESCipher cannot be cast to javax.crypto.CipherSpi running Jenkins plug-in tests with PowerMock</h1>
    <spab class="post-meta">
      <time class="dt-published" datetime="2016-12-19T19:20:03+13:00" itemprop="datePublished">Dec 19, 2016
      </time>
      37<span>&mdash; star date: -306950.82</span></spab>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>Recently while working on a Jenkins plugin some tests were failing with PermGen errors.
Even though it worked in my notebook at home (with Java 8, thus no Permgen), it failed
in a CloudBees hosted Jenkins job, and also on my Mac (with Java 7) at work.</p>

<p>As I could not change the settings in the CloudBees hosted Jenkins, I decided to spent some
time investigating why these tests would require so much memory. Then I found
<a href="https://angus.nyc/2015/fixing-common-powermock-problems/">this blog post about PowerMock</a>.</p>

<p>I was not using the <em>@PrepareForTest</em> annotation, but after adding it the issue was gone. So I
assume it either prevents PowerMock from trying to dynamically load several classes, or instructs
it to unload classes after the tests. But in anyway after adding it the issue was gone.</p>

<p>Then I got the following exception.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>WARNING: Failed to instantiate Key[type<span class="o">=</span>hudson.security.csrf.DefaultCrumbIssuer<span class="nv">$DescriptorImpl</span>, <span class="nv">annotation</span><span class="o">=[</span>none]]<span class="p">;</span> skipping this component
com.google.inject.ProvisionException: Guice provision errors:

1<span class="o">)</span> Error injecting constructor, java.lang.ClassCastException: com.sun.crypto.provider.AESCipher cannot be cast to javax.crypto.CipherSpi
  at hudson.security.csrf.DefaultCrumbIssuer<span class="nv">$DescriptorImpl</span>.&lt;init&gt;<span class="o">(</span>DefaultCrumbIssuer.java:127<span class="o">)</span>

1 error
    at com.google.inject.internal.ProviderToInternalFactoryAdapter.get<span class="o">(</span>ProviderToInternalFactoryAdapter.java:52<span class="o">)</span>
</code></pre></div></div>

<p>And then thanks to <a href="https://github.com/powermock/powermock/issues/294">this issue</a> I understood
that PowerMock was mocking <em>javax.crypto</em> classes. Turns out it is quite easy to tell
PowerMock to ignore certain classes from being mocked, with the <em>@PowerMockIgnore</em> annotation.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// snip</span>
<span class="nd">@RunWith</span><span class="o">(</span><span class="nc">PowerMockRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@PowerMockIgnore</span><span class="o">({</span><span class="s">"javax.crypto.*"</span> <span class="o">})</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestAbstractUnoChoiceParameter</span> <span class="o">{</span>
<span class="c1">//</span>
<span class="o">}</span>
<span class="c1">// snip</span>
</code></pre></div></div>

<p>Added a couple of notes to this <a href="https://wiki.jenkins-ci.org/display/JENKINS/Mocking+in+Unit+Tests">Jenkins Wiki page</a>
so that users facing similar issues can try these possible workarounds.</p>

<p>Hope that helps someone!</p>

  </div>

  <div class="tags"><a class="label" href="/tags#jenkins">jenkins</a><a class="label" href="/tags#software quality">software quality</a></div>

  <a class="u-url" href="/2016/12/19/permgen-errors-and-java-lang-classcastexception-com-sun-crypto-provider-aescipher-cannot-be-cast-to-javax-crypto-cipherspi-running-jenkins-plug-in-tests-with-powermock.html" hidden></a>
</article>

  </div>
</div>
</body>
</html>
