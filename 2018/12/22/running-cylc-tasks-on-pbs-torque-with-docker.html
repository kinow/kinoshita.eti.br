<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1" /><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Running Cylc tasks on PBS Torque with Docker | kinow</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Running Cylc tasks on PBS Torque with Docker" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="A few days ago I saw a post at the Cylc Google Group, about file permissions for files generated by Cylc. The post was related to content created by Cylc, but in an environment with PBS. For context, Cylc is an Open Source meta-scheduler, written in Python, that allows you to define cycle points with dependencies. These cycle points can be simple incremental integer numbers, or ISO8601 periods or points (e.g. run every 5 minutes, from 10 days ago until the next year). Cylc takes care to create an execution schedule for you, and delegate that to a system that runs your workflow. I work full time on this amazing Open Source tool! Such system could be the local computer in background, batch systems such as at, or PBS. PBS was created for NASA, to manage executing jobs taking into consideration cluster resources, and also using queues, priorities, and other features useful for HPC programming. Later PBS was acquired by Altair, an Open Source version OpenPBS was created, and later abandoned. And there is another fork called PBS Torque. I first encountered PBS at the São Paulo University, in Brazil, where they had a PBS Torque cluster. Running PBS Torque with Docker Even though I have access to an environment with Cylc and with PBS, I decided to give it a try and see how hard it would be to reproduce it with Docker. One thing that I like about this approach is the possibility to share the work with others online. I believe it improves communication, agility, and can be useful for posterity." />
<meta property="og:description" content="A few days ago I saw a post at the Cylc Google Group, about file permissions for files generated by Cylc. The post was related to content created by Cylc, but in an environment with PBS. For context, Cylc is an Open Source meta-scheduler, written in Python, that allows you to define cycle points with dependencies. These cycle points can be simple incremental integer numbers, or ISO8601 periods or points (e.g. run every 5 minutes, from 10 days ago until the next year). Cylc takes care to create an execution schedule for you, and delegate that to a system that runs your workflow. I work full time on this amazing Open Source tool! Such system could be the local computer in background, batch systems such as at, or PBS. PBS was created for NASA, to manage executing jobs taking into consideration cluster resources, and also using queues, priorities, and other features useful for HPC programming. Later PBS was acquired by Altair, an Open Source version OpenPBS was created, and later abandoned. And there is another fork called PBS Torque. I first encountered PBS at the São Paulo University, in Brazil, where they had a PBS Torque cluster. Running PBS Torque with Docker Even though I have access to an environment with Cylc and with PBS, I decided to give it a try and see how hard it would be to reproduce it with Docker. One thing that I like about this approach is the possibility to share the work with others online. I believe it improves communication, agility, and can be useful for posterity." />
<link rel="canonical" href="https://kinoshita.eti.br/2018/12/22/running-cylc-tasks-on-pbs-torque-with-docker.html" />
<meta property="og:url" content="https://kinoshita.eti.br/2018/12/22/running-cylc-tasks-on-pbs-torque-with-docker.html" />
<meta property="og:site_name" content="kinow" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-12-22T00:00:00+13:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Running Cylc tasks on PBS Torque with Docker" />
<script type="application/ld+json">
{"description":"A few days ago I saw a post at the Cylc Google Group, about file permissions for files generated by Cylc. The post was related to content created by Cylc, but in an environment with PBS. For context, Cylc is an Open Source meta-scheduler, written in Python, that allows you to define cycle points with dependencies. These cycle points can be simple incremental integer numbers, or ISO8601 periods or points (e.g. run every 5 minutes, from 10 days ago until the next year). Cylc takes care to create an execution schedule for you, and delegate that to a system that runs your workflow. I work full time on this amazing Open Source tool! Such system could be the local computer in background, batch systems such as at, or PBS. PBS was created for NASA, to manage executing jobs taking into consideration cluster resources, and also using queues, priorities, and other features useful for HPC programming. Later PBS was acquired by Altair, an Open Source version OpenPBS was created, and later abandoned. And there is another fork called PBS Torque. I first encountered PBS at the São Paulo University, in Brazil, where they had a PBS Torque cluster. Running PBS Torque with Docker Even though I have access to an environment with Cylc and with PBS, I decided to give it a try and see how hard it would be to reproduce it with Docker. One thing that I like about this approach is the possibility to share the work with others online. I believe it improves communication, agility, and can be useful for posterity.","@type":"BlogPosting","url":"https://kinoshita.eti.br/2018/12/22/running-cylc-tasks-on-pbs-torque-with-docker.html","headline":"Running Cylc tasks on PBS Torque with Docker","datePublished":"2018-12-22T00:00:00+13:00","dateModified":"2018-12-22T00:00:00+13:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://kinoshita.eti.br/2018/12/22/running-cylc-tasks-on-pbs-torque-with-docker.html"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/main.css" /><link type="application/atom+xml" rel="alternate" href="https://kinoshita.eti.br/feed.xml" title="kinow" /><link href="https://unpkg.com/pattern.css" rel="stylesheet" />

</head>
<body>
<div id="mobile-menu"><div class="menu">
  <ul class="menu">
    <li class="item">
      <h1 id="kinow">KINOW</h1>
    </li>
    <li class="item">
      <a href="/" class="">About</a>
    </li>
    <li class="item">
      <a href="/blog/" class="current">Blog</a>
    </li>
    <li class="item">
      <a href="/portfolio/" class="">Portfolio</a>
    </li>
    <li class="item social-media-item">
      <a href="https://www.instagram.com/brunokinoshita/" class="inline-link">
        <img src="/assets/icons/instagram.png" class="inverted-image"  alt="Instagram link" />
      </a>
      <a href="https://twitter.com/kinow/" class="inline-link">
        <img src="/assets/icons/twitter.png" class="inverted-image" alt="Twitter link" />
      </a>
      <a href="https://github.com/kinow/" class="inline-link">
        <img src="/assets/icons/github.png" class="inverted-image" alt="GitHub link" />
      </a>
    </li>
  </ul>
</div>
</div>
<div id="wrapper">
  <div id="sidebar"><div class="menu">
  <ul class="menu">
    <li class="item">
      <h1 id="kinow">KINOW</h1>
    </li>
    <li class="item">
      <a href="/" class="">About</a>
    </li>
    <li class="item">
      <a href="/blog/" class="current">Blog</a>
    </li>
    <li class="item">
      <a href="/portfolio/" class="">Portfolio</a>
    </li>
    <li class="item social-media-item">
      <a href="https://www.instagram.com/brunokinoshita/" class="inline-link">
        <img src="/assets/icons/instagram.png" class="inverted-image"  alt="Instagram link" />
      </a>
      <a href="https://twitter.com/kinow/" class="inline-link">
        <img src="/assets/icons/twitter.png" class="inverted-image" alt="Twitter link" />
      </a>
      <a href="https://github.com/kinow/" class="inline-link">
        <img src="/assets/icons/github.png" class="inverted-image" alt="GitHub link" />
      </a>
    </li>
  </ul>
</div>
</div>
  <div id="content">
    <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Running Cylc tasks on PBS Torque with Docker</h1>
    <span class="post-meta">
      <time class="dt-published" datetime="2018-12-22T00:00:00+13:00" itemprop="datePublished">Dec 22, 2018
      </time>
      <span>&mdash; star date: -304942.47.</span>
      <span>
        Number of words: 2979.
      </span></span>
  </header>

  <ul>
  <li><a href="#running-pbs-torque-with-docker">Running PBS Torque with Docker</a></li>
  <li><a href="#running-cylc-with-docker">Running Cylc with Docker</a></li>
  <li><a href="#running-pbs-torque-and-cylc-together-with-docker">Running PBS Torque and Cylc together with Docker</a></li>
  <li><a href="#conclusion">Conclusion</a></li>
</ul>


  <div class="post-content e-content" itemprop="articleBody">
    <p>A few days ago I saw <a href="https://groups.google.com/forum/#!topic/cylc/dP2I1Gxqi20">a post</a> at the
Cylc Google Group, about file permissions for files generated by Cylc. The post was related to
content created by Cylc, but in an environment with PBS.</p>

<p>For context, Cylc is an Open Source meta-scheduler, written in Python, that allows you to
define cycle points with dependencies. These cycle points can be simple incremental integer
numbers, or ISO8601 periods or points (e.g. run every 5 minutes, from 10 days ago until the
next year). Cylc takes care to create an execution schedule for you, and delegate that to a
system that runs your workflow. I work full time on this amazing Open Source tool!</p>

<p>Such system could be the local computer in background, batch systems such as <code class="language-plaintext highlighter-rouge">at</code>, or PBS.
PBS was created for NASA, to manage executing jobs taking into consideration cluster resources,
and also using queues, priorities, and other features useful for HPC programming. Later PBS
was acquired by Altair, an Open Source version OpenPBS was created, and later abandoned. And
there is another fork called PBS Torque. I first encountered PBS at the São Paulo
University, in Brazil, where they had a <a href="http://www.usp.br/hpc/puma.php">PBS Torque cluster</a>.</p>

<h3 id="running-pbs-torque-with-docker">Running PBS Torque with Docker</h3>

<p>Even though I have access to an environment with Cylc and with PBS, I decided to give it a try
and see how hard it would be to reproduce it with Docker. One thing that I like about this
approach is the possibility to share the work with others online. I believe it improves
communication, agility, and can be useful for posterity.</p>

<!--more-->

<p>I had some experience with PBS Torque on Docker, because of some
<a href="https://github.com/biouno/pbs-plugin/wiki">old work</a> for another Open Source project called
BioUno. So I started testing the image I used before,
<a href="https://hub.docker.com/r/agaveapi/torque/">agaveapi/torque</a>.</p>

<p>You can get PBS Torque up and running with one line if you have Docker and a good Internet
connection - Docker is in the same category as NPM, Maven, etc (though I find the way Maven
manages common dependencies <a href="https://dev.to/leoat12/the-nodemodules-problem-29dc">saner</a>).</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker run <span class="nt">-d</span> <span class="nt">-h</span> docker.example.com <span class="nt">-p</span> 10022:22 <span class="nt">--privileged</span> <span class="nt">--name</span> torque agaveapi/torque
f18f2cc2a2f90f56d1b74370060a272d5faf5b39dfc295a2025c78e469950194
</code></pre></div></div>

<p>And from here you can submit a job after having access to the <code class="language-plaintext highlighter-rouge">testuser</code> user in the container.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-t</span> <span class="nt">-i</span> torque /bin/bash
bash-4.1# su - testuser
<span class="o">[</span>testuser@docker ~]<span class="nv">$ </span>qsub /home/testuser/torque.submit
0.docker.example.com
</code></pre></div></div>

<h3 id="running-cylc-with-docker">Running Cylc with Docker</h3>

<p>You can also start an Ubuntu container with Cylc in one line.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker run <span class="nt">-t</span> <span class="nt">-i</span> <span class="nt">-v</span> ~/Development/python/workspace/cylc-docker/standalone/cylc:/opt/cylc <span class="nt">--entrypoint</span> /bin/bash kinow/cylc-standalone:0.1 
root@58118e44f171:/opt/cylc# cylc check-software
Checking your software...

Individual results:
<span class="o">==========================================================================================</span>
Package <span class="o">(</span>version requirements<span class="o">)</span>                                     Outcome <span class="o">(</span>version found<span class="o">)</span>
<span class="o">==========================================================================================</span>
                                   <span class="k">*</span>REQUIRED SOFTWARE<span class="k">*</span>                                   
Python <span class="o">(</span>2.6+, &lt;3<span class="o">)</span>................................FOUND &amp; min. version MET <span class="o">(</span>2.7.12.final.0<span class="o">)</span>

             <span class="k">*</span>OPTIONAL SOFTWARE <span class="k">for </span>the GUI &amp; dependency graph visualisation<span class="k">*</span>             
/usr/lib/python2.7/dist-packages/gtk-2.0/gtk/__init__.py:57: GtkWarning: could not open display
  warnings.warn<span class="o">(</span>str<span class="o">(</span>e<span class="o">)</span>, _gtk.Warning<span class="o">)</span>
Python:pygtk <span class="o">(</span>2.0+<span class="o">)</span>......................................FOUND &amp; min. version MET <span class="o">(</span>2.24.0<span class="o">)</span>
graphviz <span class="o">(</span>any<span class="o">)</span>..............................................................FOUND <span class="o">(</span>2.38.0<span class="o">)</span>
Python:pygraphviz <span class="o">(</span>any<span class="o">)</span>......................................................FOUND <span class="o">(</span>1.3.1<span class="o">)</span>

                       <span class="k">*</span>OPTIONAL SOFTWARE <span class="k">for </span>the HTML User Guide<span class="k">*</span>                       
ImageMagick <span class="o">(</span>any<span class="o">)</span>............................................................NOT FOUND <span class="o">(</span>-<span class="o">)</span>

                  <span class="k">*</span>OPTIONAL SOFTWARE <span class="k">for </span>the HTTPS communications layer<span class="k">*</span>                  
Python:urllib3 <span class="o">(</span>any<span class="o">)</span>.........................................................NOT FOUND <span class="o">(</span>-<span class="o">)</span>
Python:OpenSSL <span class="o">(</span>any<span class="o">)</span>........................................................FOUND <span class="o">(</span>18.0.0<span class="o">)</span>
Python:requests <span class="o">(</span>2.4.2+<span class="o">)</span>.....................................................NOT FOUND <span class="o">(</span>-<span class="o">)</span>

                       <span class="k">*</span>OPTIONAL SOFTWARE <span class="k">for </span>the LaTeX User Guide<span class="k">*</span>                       
TeX:framed <span class="o">(</span>any<span class="o">)</span>.............................................................NOT FOUND <span class="o">(</span>-<span class="o">)</span>
TeX <span class="o">(</span>3.0+<span class="o">)</span>...........................................FOUND &amp; min. version MET <span class="o">(</span>3.14159265<span class="o">)</span>
TeX:preprint <span class="o">(</span>any<span class="o">)</span>...........................................................NOT FOUND <span class="o">(</span>-<span class="o">)</span>
TeX:tex4ht <span class="o">(</span>any<span class="o">)</span>.............................................................NOT FOUND <span class="o">(</span>-<span class="o">)</span>
TeX:tocloft <span class="o">(</span>any<span class="o">)</span>............................................................NOT FOUND <span class="o">(</span>-<span class="o">)</span>
TeX:texlive <span class="o">(</span>any<span class="o">)</span>............................................................NOT FOUND <span class="o">(</span>-<span class="o">)</span>
<span class="o">==========================================================================================</span>

Summary:
                               <span class="k">****************************</span>                               
                                  Core requirements: ok                                  
                                Full-functionality: not ok                                
                               <span class="k">****************************</span> 
</code></pre></div></div>

<h3 id="running-pbs-torque-and-cylc-together-with-docker">Running PBS Torque and Cylc together with Docker</h3>

<p>The repository <a href="https://github.com/kinow/cylc-docker">https://github.com/kinow/cylc-docker</a>
contains some Dockerfile’s for running Cylc, including a new one where I combined
the PBS Torque image, with the Cylc standalone image, with SSH between both. There is a
<code class="language-plaintext highlighter-rouge">docker-compose.yml</code> configuration to initialize a mini cluster of two computers, with
SSH and trusted configured, and shared volume/file system.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cd </span>cylc-docker/pbs
<span class="nv">$ </span>ssh-keygen <span class="nt">-t</span> rsa <span class="nt">-f</span> ./id_rsa <span class="nt">-N</span> <span class="s2">""</span> <span class="nt">-q</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">CYLC_SSH_PUBKEY</span><span class="o">=</span><span class="si">$(</span><span class="nb">cat </span>id_rsa.pub<span class="si">)</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"CYLC_SSH_PUBKEY=</span><span class="k">${</span><span class="nv">CYLC_SSH_PUBKEY</span><span class="k">}</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> .env
<span class="nv">$ </span>docker-compose up
Creating pbs  ... <span class="k">done
</span>Creating cylc ... <span class="k">done
</span>Attaching to cylc, pbs
cylc    | /usr/lib/python2.7/dist-packages/supervisor/options.py:297: UserWarning: Supervisord is running as root and it is searching <span class="k">for </span>its configuration file <span class="k">in </span>default locations <span class="o">(</span>including its current working directory<span class="o">)</span><span class="p">;</span> you probably want to specify a <span class="s2">"-c"</span> argument specifying an absolute path to a configuration file <span class="k">for </span>improved security.
cylc    |   <span class="s1">'Supervisord is running as root and it is searching '</span>
cylc    | 2018-12-22 02:29:06,526 CRIT Supervisor running as root <span class="o">(</span>no user <span class="k">in </span>config file<span class="o">)</span>
cylc    | 2018-12-22 02:29:06,526 WARN No file matches via include <span class="s2">"/etc/supervisor/conf.d/*.conf"</span>
pbs     | /usr/lib/python2.6/site-packages/supervisor/options.py:295: UserWarning: Supervisord is running as root and it is searching <span class="k">for </span>its configuration file <span class="k">in </span>default locations <span class="o">(</span>including its current working directory<span class="o">)</span><span class="p">;</span> you probably want to specify a <span class="s2">"-c"</span> argument specifying an absolute path to a configuration file <span class="k">for </span>improved security.
pbs     |   <span class="s1">'Supervisord is running as root and it is searching '</span>
cylc    | 2018-12-22 02:29:06,535 INFO RPC interface <span class="s1">'supervisor'</span> initialized
cylc    | 2018-12-22 02:29:06,535 CRIT Server <span class="s1">'unix_http_server'</span> running without any HTTP authentication checking
cylc    | 2018-12-22 02:29:06,535 INFO supervisord started with pid 1
pbs     | 2018-12-22 02:29:07,480 CRIT Supervisor running as root <span class="o">(</span>no user <span class="k">in </span>config file<span class="o">)</span>
pbs     | 2018-12-22 02:29:07,483 INFO supervisord started with pid 1
pbs     | 2018-12-22 02:29:08,487 INFO spawned: <span class="s1">'pbsmom'</span> with pid 10
pbs     | 2018-12-22 02:29:08,490 INFO spawned: <span class="s1">'sshd'</span> with pid 11
pbs     | 2018-12-22 02:29:08,493 INFO spawned: <span class="s1">'pbssched'</span> with pid 12
pbs     | 2018-12-22 02:29:08,497 INFO spawned: <span class="s1">'pbsserver'</span> with pid 13
pbs     | 2018-12-22 02:29:08,499 INFO spawned: <span class="s1">'trqauthd'</span> with pid 14
pbs     | 2018-12-22 02:29:08,761 INFO exited: pbssched <span class="o">(</span><span class="nb">exit </span>status 0<span class="p">;</span> not expected<span class="o">)</span>
pbs     | 2018-12-22 02:29:08,794 INFO gave up: pbssched entered FATAL state, too many start retries too quickly
pbs     | 2018-12-22 02:29:10,078 INFO success: pbsmom entered RUNNING state, process has stayed up <span class="k">for</span> <span class="o">&gt;</span> than 1 seconds <span class="o">(</span>startsecs<span class="o">)</span>
pbs     | 2018-12-22 02:29:10,079 INFO success: sshd entered RUNNING state, process has stayed up <span class="k">for</span> <span class="o">&gt;</span> than 1 seconds <span class="o">(</span>startsecs<span class="o">)</span>
pbs     | 2018-12-22 02:29:10,079 INFO success: pbsserver entered RUNNING state, process has stayed up <span class="k">for</span> <span class="o">&gt;</span> than 1 seconds <span class="o">(</span>startsecs<span class="o">)</span>
pbs     | 2018-12-22 02:29:10,079 INFO success: trqauthd entered RUNNING state, process has stayed up <span class="k">for</span> <span class="o">&gt;</span> than 1 seconds <span class="o">(</span>startsecs<span class="o">)</span>

</code></pre></div></div>

<p>This should start two containers, <code class="language-plaintext highlighter-rouge">cylc</code>, and <code class="language-plaintext highlighter-rouge">pbs</code>, and with an example <code class="language-plaintext highlighter-rouge">suite.rc</code>.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker-compose <span class="nb">exec </span>cylc /bin/bash
bash-4.1# su - testuser
testuser@f85bd666bced:~<span class="nv">$ </span>cylc register pbs1 ./suites/pbs1/
REGISTER pbs1: ./suites/pbs1/
</code></pre></div></div>

<p>The example suite has one task that runs on a PBS remote node. In the output of running the suite
below, you can tell the tasks are being executed in different computers, by different owners, through
Cylc and PBS.</p>

<p>The task <code class="language-plaintext highlighter-rouge">a</code> has <code class="language-plaintext highlighter-rouge">[a.1] -submit-num=1, owner@host=pbs</code> in the logs, and <code class="language-plaintext highlighter-rouge">b</code> has
<code class="language-plaintext highlighter-rouge">[b.1] -submit-num=1, owner@host=7ce742eb050c</code>.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>testuser@7ce742eb050c:~<span class="nv">$ </span>cylc run <span class="nt">--no-detach</span> pbs1
            ._.                                                       
            | |              The Cylc Suite Engine <span class="o">[</span>7.8.0-dirty]      
._____._. ._| |_____.           Copyright <span class="o">(</span>C<span class="o">)</span> 2008-2018 NIWA          
| .___| | | | | .___|   &amp; British Crown <span class="o">(</span>Met Office<span class="o">)</span> &amp; Contributors.  
| <span class="o">!</span>___| <span class="o">!</span>_! | | <span class="o">!</span>___.  _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
<span class="o">!</span>_____!___. |_!_____!  This program comes with ABSOLUTELY NO WARRANTY<span class="p">;</span>
      .___! |          see <span class="sb">`</span>cylc warranty<span class="sb">`</span><span class="nb">.</span>  It is free software, you 
      <span class="o">!</span>_____!           are welcome to redistribute it under certain  
2018-12-22T02:36:36Z INFO - Suite server: <span class="nv">url</span><span class="o">=</span>https://7ce742eb050c:43037/ <span class="nv">pid</span><span class="o">=</span>90
2018-12-22T02:36:36Z INFO - Run: <span class="o">(</span>re<span class="o">)</span><span class="nv">start</span><span class="o">=</span>0 <span class="nv">log</span><span class="o">=</span>1
2018-12-22T02:36:36Z INFO - Cylc version: 7.8.0-dirty
2018-12-22T02:36:36Z INFO - Run mode: live
2018-12-22T02:36:36Z INFO - Initial point: 1
2018-12-22T02:36:36Z INFO - Final point: 1
2018-12-22T02:36:36Z INFO - Cold Start 1
2018-12-22T02:36:38Z INFO - <span class="o">[</span>a.1] <span class="nt">-submit-num</span><span class="o">=</span>1, owner@host<span class="o">=</span>pbs
2018-12-22T02:36:39Z INFO - <span class="o">[</span>a.1] -<span class="o">(</span>current:ready<span class="o">)</span> submitted at 2018-12-22T02:36:39Z
2018-12-22T02:36:39Z INFO - <span class="o">[</span>a.1] <span class="nt">-health</span> check settings: submission <span class="nb">timeout</span><span class="o">=</span>None
2018-12-22T02:36:40Z INFO - <span class="o">[</span>a.1] -<span class="o">(</span>current:submitted<span class="o">)&gt;</span> started at 2018-12-22T02:36:39Z
2018-12-22T02:36:40Z INFO - <span class="o">[</span>a.1] <span class="nt">-health</span> check settings: execution <span class="nb">timeout</span><span class="o">=</span>None
2018-12-22T02:36:40Z INFO - <span class="o">[</span>a.1] -<span class="o">(</span>current:running<span class="o">)&gt;</span> succeeded at 2018-12-22T02:36:40Z
2018-12-22T02:36:41Z INFO - <span class="o">[</span>b.1] <span class="nt">-submit-num</span><span class="o">=</span>1, owner@host<span class="o">=</span>7ce742eb050c
2018-12-22T02:36:42Z INFO - <span class="o">[</span>client-command] poll_tasks testuser@7ce742eb050c:cylc-poll d03e9798-14bb-4ef3-86a6-c01ea3a380ee
2018-12-22T02:36:42Z INFO - Command succeeded: poll_tasks<span class="o">([</span>u<span class="s1">'a'</span><span class="o">]</span>, <span class="nv">poll_succ</span><span class="o">=</span>False<span class="o">)</span>
2018-12-22T02:36:42Z INFO - Processing 1 queued <span class="nb">command</span><span class="o">(</span>s<span class="o">)</span>
	+	poll_tasks<span class="o">([</span>u<span class="s1">'a'</span><span class="o">]</span>, <span class="nv">poll_succ</span><span class="o">=</span>False<span class="o">)</span>
2018-12-22T02:36:42Z INFO - <span class="o">[</span>b.1] -<span class="o">(</span>current:ready<span class="o">)</span> submitted at 2018-12-22T02:36:42Z
2018-12-22T02:36:42Z INFO - <span class="o">[</span>b.1] <span class="nt">-health</span> check settings: submission <span class="nb">timeout</span><span class="o">=</span>None
2018-12-22T02:36:42Z INFO - <span class="o">[</span>b.1] -<span class="o">(</span>current:submitted<span class="o">)&gt;</span> started at 2018-12-22T02:36:42Z
2018-12-22T02:36:42Z INFO - <span class="o">[</span>b.1] <span class="nt">-health</span> check settings: execution <span class="nb">timeout</span><span class="o">=</span>None
2018-12-22T02:36:43Z INFO - <span class="o">[</span>b.1] -<span class="o">(</span>current:running<span class="o">)&gt;</span> succeeded at 2018-12-22T02:36:43Z
2018-12-22T02:36:43Z INFO - Suite shutting down - AUTOMATIC
2018-12-22T02:36:44Z INFO - DONE
</code></pre></div></div>

<p><img class="ui fluid image" src="/assets/posts/2018-12-22-running-cylc-tasks-on-pbs-torque-with-docker/cylcpbs-screenshot.png" /></p>

<h2 id="reproducing-the-issue">Reproducing the issue</h2>

<p>All right, so by now we have a working cluster of two computers, that share <code class="language-plaintext highlighter-rouge">~/cylc-run</code> via
Docker volumes (in the real world this is normally done via NFS).</p>

<p>The issue was related to the retrieval of remote logs. So we need to change <code class="language-plaintext highlighter-rouge">~/.cylc/global.rc</code>
in order to get it working.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># File: global.rc</span>

<span class="o">[</span>hosts]
<span class="o">[[</span>pbs]]
retrieve job logs <span class="nb">command</span> <span class="o">=</span> rsync <span class="nt">-v</span> <span class="nt">-rltgoD</span> <span class="nt">--chmod</span><span class="o">=</span><span class="nv">Du</span><span class="o">=</span>rwx,Dgo<span class="o">=</span>rx,Fu<span class="o">=</span>rw,Fgo<span class="o">=</span>r
</code></pre></div></div>

<p>The first thing I noticed debugging it, was that when I copied the command it had an
extra space, and it failed to execute. However, nothing appeared in the logs (!).</p>

<p>Then I managed to print the <code class="language-plaintext highlighter-rouge">rsync</code> command executed.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sync</span> <span class="nt">-v</span> <span class="nt">-rltgoD</span> <span class="nt">--chmod</span><span class="o">=</span><span class="nv">Du</span><span class="o">=</span>rwx,Dgo<span class="o">=</span>rx,Fu<span class="o">=</span>rw,Fgo<span class="o">=</span>r <span class="s1">'--rsh=ssh -oBatchMode=yes -oConnectTimeout=10'</span> <span class="nt">-v</span> <span class="nt">--include</span><span class="o">=</span>/1 <span class="nt">--include</span><span class="o">=</span>/1/a <span class="nt">--include</span><span class="o">=</span>/1/a/01 <span class="s1">'--include=/1/a/01/**'</span> <span class="s1">'--exclude=/**'</span> <span class="s1">'pbs:$HOME/cylc-run/pbs1/log/job/'</span> /home/testuser/cylc-run/pbs1/log/job/
</code></pre></div></div>

<p>The thing that got me here as that it wasn’t <code class="language-plaintext highlighter-rouge">rsync</code>‘ing the logs from PBS Torque spool, but rather
the logs that were already synced via Docker shared volume (or NFS in other environments).</p>

<p>The Cylc suite contains a PBS directive <code class="language-plaintext highlighter-rouge">-W umask=0077</code>, which forces the logs
to be readable only by the owner. It is possible to confirm it in the output
logs. But only because it is using an empty directory.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>testuser@7ce742eb050c:~<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-lah</span> /home/testuser/cylc-run/pbs1/log/job/1/a/01/
total 24K
drwxrwxr-x 2 testuser testuser 4.0K Dec 22 02:36 <span class="nb">.</span>
drwxrwxr-x 3 testuser testuser 4.0K Dec 22 02:34 ..
<span class="nt">-rwxrwxr-x</span> 1 testuser testuser 1.3K Dec 22 02:36 job
<span class="nt">-rw-rw-r--</span> 1 testuser testuser  266 Dec 22 02:36 job-activity.log
<span class="nt">-rw-------</span> 1 testuser testuser    0 Dec 22 02:36 job.err
<span class="nt">-rw-------</span> 1 testuser testuser  147 Dec 22 02:36 job.out
<span class="nt">-rw-rw-r--</span> 1 testuser testuser  231 Dec 22 02:36 job.status
</code></pre></div></div>

<p>Even though the <code class="language-plaintext highlighter-rouge">rsync</code> command was executed, it had no effect. We can confirm it by running it
in the <code class="language-plaintext highlighter-rouge">cylc</code> node.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>testuser@7ce742eb050c:~<span class="nv">$ </span>rsync <span class="nt">-v</span> <span class="nt">-rltgoD</span> <span class="nt">--chmod</span><span class="o">=</span><span class="nv">Du</span><span class="o">=</span>rwx,Dgo<span class="o">=</span>rx,Fu<span class="o">=</span>rw,Fgo<span class="o">=</span>r <span class="s1">'--rsh=ssh -oBatchMode=yes -oConnectTimeout=10'</span> <span class="nt">-v</span> <span class="nt">--include</span><span class="o">=</span>/1 <span class="nt">--include</span><span class="o">=</span>/1/a <span class="nt">--include</span><span class="o">=</span>/1/a/01 <span class="s1">'--include=/1/a/01/**'</span> <span class="s1">'--exclude=/**'</span> <span class="s1">'pbs:$HOME/cylc-run/pbs1/log/job/'</span> /home/testuser/cylc-run/pbs1/log/job/
opening connection using: ssh <span class="nt">-oBatchMode</span><span class="o">=</span><span class="nb">yes</span> <span class="nt">-oConnectTimeout</span><span class="o">=</span>10 pbs rsync <span class="nt">--server</span> <span class="nt">--sender</span> <span class="nt">-vvlogDtre</span>.iLsfx <span class="nb">.</span> <span class="s2">"</span><span class="nv">$HOME</span><span class="s2">/cylc-run/pbs1/log/job/"</span>  <span class="o">(</span>10 args<span class="o">)</span>
receiving incremental file list
<span class="o">[</span>sender] showing directory 1 because of pattern /1
delta-transmission enabled
<span class="o">[</span>sender] showing directory 1/a because of pattern /1/a
<span class="o">[</span>sender] hiding directory 1/b because of pattern /<span class="k">**</span>
<span class="o">[</span>sender] showing directory 1/a/01 because of pattern /1/a/01
<span class="o">[</span>sender] hiding file 1/a/NN because of pattern /<span class="k">**</span>
<span class="o">[</span>sender] showing file 1/a/01/job.out because of pattern /1/a/01/<span class="k">**</span>
<span class="o">[</span>sender] showing file 1/a/01/job-activity.log because of pattern /1/a/01/<span class="k">**</span>
<span class="o">[</span>sender] showing file 1/a/01/job.status because of pattern /1/a/01/<span class="k">**</span>
<span class="o">[</span>sender] showing file 1/a/01/job because of pattern /1/a/01/<span class="k">**</span>
<span class="o">[</span>sender] showing file 1/a/01/job.err because of pattern /1/a/01/<span class="k">**</span>
1/a/01/job is uptodate
1/a/01/job-activity.log is uptodate
1/a/01/job.err is uptodate
1/a/01/job.out is uptodate
1/a/01/job.status is uptodate
total: <span class="nv">matches</span><span class="o">=</span>0  <span class="nv">hash_hits</span><span class="o">=</span>0  <span class="nv">false_alarms</span><span class="o">=</span>0 <span class="nv">data</span><span class="o">=</span>0

sent 97 bytes  received 935 bytes  688.00 bytes/sec
total size is 1,888  speedup is 1.83
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">rsync</code> realizes that the files are already up to date, and does not change the permission
of the files. If we run this against a different empty folder, <code class="language-plaintext highlighter-rouge">rsync</code> will adjust the
permissions. In the next example first a directory <code class="language-plaintext highlighter-rouge">test</code> is created, and <code class="language-plaintext highlighter-rouge">rsync</code> command
is changed to use this new local folder.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>testuser@7ce742eb050c:~<span class="nv">$ </span><span class="nb">mkdir</span> ~/test
testuser@7ce742eb050c:~<span class="nv">$ </span>rsync <span class="nt">-v</span> <span class="nt">-rltgoD</span> <span class="nt">--chmod</span><span class="o">=</span><span class="nv">Du</span><span class="o">=</span>rwx,Dgo<span class="o">=</span>rx,Fu<span class="o">=</span>rw,Fgo<span class="o">=</span>r <span class="s1">'--rsh=ssh -oBatchMode=yes -oConnectTimeout=10'</span> <span class="nt">-v</span> <span class="nt">--include</span><span class="o">=</span>/1 <span class="nt">--include</span><span class="o">=</span>/1/a <span class="nt">--include</span><span class="o">=</span>/1/a/01 <span class="s1">'--include=/1/a/01/**'</span> <span class="s1">'--exclude=/**'</span> <span class="s1">'pbs:$HOME/cylc-run/pbs1/log/job/'</span> /home/testuser/test                  
opening connection using: ssh <span class="nt">-oBatchMode</span><span class="o">=</span><span class="nb">yes</span> <span class="nt">-oConnectTimeout</span><span class="o">=</span>10 pbs rsync <span class="nt">--server</span> <span class="nt">--sender</span> <span class="nt">-vvlogDtre</span>.iLsfx <span class="nb">.</span> <span class="s2">"</span><span class="nv">$HOME</span><span class="s2">/cylc-run/pbs1/log/job/"</span>  <span class="o">(</span>10 args<span class="o">)</span>
receiving incremental file list
<span class="o">[</span>sender] showing directory 1 because of pattern /1
delta-transmission enabled
<span class="o">[</span>sender] showing directory 1/a because of pattern /1/a
<span class="o">[</span>sender] hiding directory 1/b because of pattern /<span class="k">**</span>
<span class="o">[</span>sender] showing directory 1/a/01 because of pattern /1/a/01
<span class="o">[</span>sender] hiding file 1/a/NN because of pattern /<span class="k">**</span>
<span class="o">[</span>sender] showing file 1/a/01/job.out because of pattern /1/a/01/<span class="k">**</span>
<span class="o">[</span>sender] showing file 1/a/01/job-activity.log because of pattern /1/a/01/<span class="k">**</span>
<span class="o">[</span>sender] showing file 1/a/01/job.status because of pattern /1/a/01/<span class="k">**</span>
<span class="o">[</span>sender] showing file 1/a/01/job because of pattern /1/a/01/<span class="k">**</span>
<span class="o">[</span>sender] showing file 1/a/01/job.err because of pattern /1/a/01/<span class="k">**</span>
./
1/
1/a/
1/a/01/
1/a/01/job
1/a/01/job-activity.log
1/a/01/job.err
1/a/01/job.out
1/a/01/job.status
total: <span class="nv">matches</span><span class="o">=</span>0  <span class="nv">hash_hits</span><span class="o">=</span>0  <span class="nv">false_alarms</span><span class="o">=</span>0 <span class="nv">data</span><span class="o">=</span>1888

sent 177 bytes  received 3,022 bytes  6,398.00 bytes/sec
total size is 1,888  speedup is 0.59
testuser@7ce742eb050c:~<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-lah</span> <span class="nb">test</span>/1/a/01/
total 24K
drwxr-xr-x 2 testuser testuser 4.0K Dec 22 02:36 <span class="nb">.</span>
drwxr-xr-x 3 testuser testuser 4.0K Dec 22 02:34 ..
<span class="nt">-rw-r--r--</span> 1 testuser testuser 1.3K Dec 22 02:36 job
<span class="nt">-rw-r--r--</span> 1 testuser testuser  266 Dec 22 02:36 job-activity.log
<span class="nt">-rw-r--r--</span> 1 testuser testuser    0 Dec 22 02:36 job.err
<span class="nt">-rw-r--r--</span> 1 testuser testuser  147 Dec 22 02:36 job.out
<span class="nt">-rw-r--r--</span> 1 testuser testuser  231 Dec 22 02:36 job.status
</code></pre></div></div>

<p>It is possible now to confirm that <code class="language-plaintext highlighter-rouge">rsync</code> has synced the folders, and instead of the
previous <code class="language-plaintext highlighter-rouge">-rw-------</code> permissions, both <code class="language-plaintext highlighter-rouge">job.out</code> and <code class="language-plaintext highlighter-rouge">job.err</code> have <code class="language-plaintext highlighter-rouge">-rw-r--r--</code> now.</p>

<h3 id="conclusion">Conclusion</h3>

<p>This was a good experiment, where I managed to publish some images to DockerHub for Cylc,
though they still lack maturity, and are probably not suitable for production use. There
are two other images in the same GitHub repository for Cylc, but these are even less mature.</p>

<p>The Cylc PBS image can be used by people familiar with Docker (i.e. who know what and how
to kick). It provides a quick way to test and troubleshoot issues with Cylc and PBS.</p>

<p>One <a href="https://github.com/cylc/cylc/pull/2911">issue</a> identified during this analysis is that
the log retrieval command may fail in Cylc, but without any output in the logs.</p>

<p>I believe the problem reported in the Google Groups could be due to <code class="language-plaintext highlighter-rouge">rsync</code> not
 applying the new <code class="language-plaintext highlighter-rouge">chmod</code> values on existing values, but only on new ones. The documentation
 for <code class="language-plaintext highlighter-rouge">--chmod</code> does not say much, however, if you look under <code class="language-plaintext highlighter-rouge">--permissions</code>:</p>

<blockquote>
  <p>In summary: to give destination files (both old and new) the source permissions, use –perms.  To give new files the destination-default permissions (while leaving existing files
             unchanged),  make  sure  that  the –perms option is off and use –chmod=ugo=rwX (which ensures that all non-masked bits get enabled).</p>
</blockquote>

<p>My understanding is that there is a difference on how some settings in <code class="language-plaintext highlighter-rouge">rsync</code> work
for new files, and for existing files. I think the documentation could be clearer about it.
The <code class="language-plaintext highlighter-rouge">cylc</code> container’s <code class="language-plaintext highlighter-rouge">rsync</code> version was 3.1.1. I compiled the latest version (3.1.3) on
my Ubuntu LTS, and copied it across to the container, and confirmed the behaviour is the
same (might message the <code class="language-plaintext highlighter-rouge">rsync</code> devs later to confirm).</p>

<p>Finally, I think there is room for improvement in the current log retrieval strategies
in Cylc, and hopefully I will be able to later translate the fuzzy ideas I have in my
mind right now to a simple description to discuss it with other developers, and maybe
improve this feature in the future.</p>

<p>Live long and prosper!</p>

<p>♥ Open Source</p>

  </div>

  <div class="tags"><p>Tags:&nbsp;<a class="label" href="/tag/cylc">cylc</a>,&nbsp;<a class="label" href="/tag/python">python</a>,&nbsp;<a class="label" href="/tag/hpc">hpc</a>,&nbsp;<a class="label" href="/tag/docker">docker</a>.<br/></p></div>

  <a class="u-url" href="/2018/12/22/running-cylc-tasks-on-pbs-torque-with-docker.html" hidden></a>
</article>

  </div>
</div>
</body>
</html>
