<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta property="og:title" content="Running Cylc tasks on PBS Torque with Docker">
<meta property="og:description" content="A few days ago I saw a post at the
Cylc Google Group, about file permissions for files generated by Cylc. The post was related to
content created by Cylc, but in an environment with PBS.
For context, Cylc is an Open Source meta-scheduler, written in Python, that allows you to
define cycle points with dependencies. These cycle points can be simple incremental integer
numbers, or ISO8601 periods or points (e.g. run every 5 minutes, from 10 days ago until the
next year). Cylc takes care to create an execution schedule for you, and delegate that to a
system that runs your workflow. I work full time on this amazing Open Source tool!
Such system could be the local computer in background, batch systems such as at, or PBS.
PBS was created for NASA, to manage executing jobs taking into consideration cluster resources,
and also using queues, priorities, and other features useful for HPC programming. Later PBS
was acquired by Altair, an Open Source version OpenPBS was created, and later abandoned. And
there is another fork called PBS Torque. I first encountered PBS at the São Paulo
University, in Brazil, where they had a PBS Torque cluster.
Running PBS Torque with Docker
Even though I have access to an environment with Cylc and with PBS, I decided to give it a try
and see how hard it would be to reproduce it with Docker. One thing that I like about this
approach is the possibility to share the work with others online. I believe it improves
communication, agility, and can be useful for posterity.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://kinoshita.eti.br/2018/12/22/running-cylc-tasks-on-pbs-torque-with-docker.html"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2018-12-22T00:00:00+00:00">
<meta property="article:modified_time" content="2024-04-07T22:23:11+02:00">
<link rel=alternate type=application/rss+xml href=https://kinoshita.eti.br/2018/12/22/running-cylc-tasks-on-pbs-torque-with-docker/feed.xml title=kinow>
<link rel=stylesheet type=text/css href=https://kinoshita.eti.br/sass/main.09b56b6037e962b67cf7a7701bf2a9ee5da840a4f74b74139c4731f2156a5917.css integrity="sha256-CbVrYDfpYrZ896dwG/Kp7l2oQKT3S3QTnEcx8hVqWRc=">
<title>kinow | Running Cylc tasks on PBS Torque with Docker</title>
</head>
<body>
<header role=banner class=content>
<nav id=nav aria-label=Main role=navigation class=content>
<ul><li>
<a href=/><i data-feather=about></i> About</a>
</li><li>
<a href=/blog/><i data-feather=blog></i> Blog</a>
</li><li>
<a href=/portfolio/><i data-feather=portfolio></i> Portfolio</a>
</li>
</ul>
</nav>
</header>
<main>
<article class=content>
<h1>Running Cylc tasks on PBS Torque with Docker</h1><div class=metadata>
<i data-feather=calendar></i>
<time datetime=2018-12-22>Dec 22, 2018</time>
</div>
<aside>
<nav id=TableOfContents>
<ul>
<li>
<ul>
<li><a href=#running-pbs-torque-with-docker>Running PBS Torque with Docker</a></li>
<li><a href=#running-cylc-with-docker>Running Cylc with Docker</a></li>
<li><a href=#running-pbs-torque-and-cylc-together-with-docker>Running PBS Torque and Cylc together with Docker</a></li>
</ul>
</li>
<li><a href=#reproducing-the-issue>Reproducing the issue</a>
<ul>
<li><a href=#conclusion>Conclusion</a></li>
</ul>
</li>
</ul>
</nav>
</aside>
<p>A few days ago I saw <a href=https://groups.google.com/forum/#!topic/cylc/dP2I1Gxqi20>a post</a> at the
Cylc Google Group, about file permissions for files generated by Cylc. The post was related to
content created by Cylc, but in an environment with PBS.</p>
<p>For context, Cylc is an Open Source meta-scheduler, written in Python, that allows you to
define cycle points with dependencies. These cycle points can be simple incremental integer
numbers, or ISO8601 periods or points (e.g. run every 5 minutes, from 10 days ago until the
next year). Cylc takes care to create an execution schedule for you, and delegate that to a
system that runs your workflow. I work full time on this amazing Open Source tool!</p>
<p>Such system could be the local computer in background, batch systems such as <code>at</code>, or PBS.
PBS was created for NASA, to manage executing jobs taking into consideration cluster resources,
and also using queues, priorities, and other features useful for HPC programming. Later PBS
was acquired by Altair, an Open Source version OpenPBS was created, and later abandoned. And
there is another fork called PBS Torque. I first encountered PBS at the São Paulo
University, in Brazil, where they had a <a href=http://www.usp.br/hpc/puma.php>PBS Torque cluster</a>.</p>
<h3 id=running-pbs-torque-with-docker>Running PBS Torque with Docker</h3>
<p>Even though I have access to an environment with Cylc and with PBS, I decided to give it a try
and see how hard it would be to reproduce it with Docker. One thing that I like about this
approach is the possibility to share the work with others online. I believe it improves
communication, agility, and can be useful for posterity.</p>
<p>I had some experience with PBS Torque on Docker, because of some
<a href=https://github.com/biouno/pbs-plugin/wiki>old work</a> for another Open Source project called
BioUno. So I started testing the image I used before,
<a href=https://hub.docker.com/r/agaveapi/torque/>agaveapi/torque</a>.</p>
<p>You can get PBS Torque up and running with one line if you have Docker and a good Internet
connection - Docker is in the same category as NPM, Maven, etc (though I find the way Maven
manages common dependencies <a href=https://dev.to/leoat12/the-nodemodules-problem-29dc>saner</a>).</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ docker run -d -h docker.example.com -p 10022:22 --privileged --name torque agaveapi/torque
f18f2cc2a2f90f56d1b74370060a272d5faf5b39dfc295a2025c78e469950194
</code></pre></div><p>And from here you can submit a job after having access to the <code>testuser</code> user in the container.</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ docker <span style=color:#a90d91>exec</span> -t -i torque /bin/bash
bash-4.1# su - testuser
<span style=color:#000>[</span>testuser@docker ~<span style=color:#000>]</span>$ qsub /home/testuser/torque.submit
0.docker.example.com
</code></pre></div><h3 id=running-cylc-with-docker>Running Cylc with Docker</h3>
<p>You can also start an Ubuntu container with Cylc in one line.</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ docker run -t -i -v ~/Development/python/workspace/cylc-docker/standalone/cylc:/opt/cylc --entrypoint /bin/bash kinow/cylc-standalone:0.1 
root@58118e44f171:/opt/cylc# cylc check-software
Checking your software...

Individual results:
<span style=color:#000>==========================================================================================</span>
Package <span style=color:#000>(</span>version requirements<span style=color:#000>)</span>                                     Outcome <span style=color:#000>(</span>version found<span style=color:#000>)</span>
<span style=color:#000>==========================================================================================</span>
                                   *REQUIRED SOFTWARE*                                   
Python <span style=color:#000>(</span>2.6+, &lt;3<span style=color:#000>)</span>................................FOUND &amp; min. version MET <span style=color:#000>(</span>2.7.12.final.0<span style=color:#000>)</span>

             *OPTIONAL SOFTWARE <span style=color:#a90d91>for</span> the GUI &amp; dependency graph visualisation*             
/usr/lib/python2.7/dist-packages/gtk-2.0/gtk/__init__.py:57: GtkWarning: could not open display
  warnings.warn<span style=color:#000>(</span>str<span style=color:#000>(</span>e<span style=color:#000>)</span>, _gtk.Warning<span style=color:#000>)</span>
Python:pygtk <span style=color:#000>(</span>2.0+<span style=color:#000>)</span>......................................FOUND &amp; min. version MET <span style=color:#000>(</span>2.24.0<span style=color:#000>)</span>
graphviz <span style=color:#000>(</span>any<span style=color:#000>)</span>..............................................................FOUND <span style=color:#000>(</span>2.38.0<span style=color:#000>)</span>
Python:pygraphviz <span style=color:#000>(</span>any<span style=color:#000>)</span>......................................................FOUND <span style=color:#000>(</span>1.3.1<span style=color:#000>)</span>

                       *OPTIONAL SOFTWARE <span style=color:#a90d91>for</span> the HTML User Guide*                       
ImageMagick <span style=color:#000>(</span>any<span style=color:#000>)</span>............................................................NOT FOUND <span style=color:#000>(</span>-<span style=color:#000>)</span>

                  *OPTIONAL SOFTWARE <span style=color:#a90d91>for</span> the HTTPS communications layer*                  
Python:urllib3 <span style=color:#000>(</span>any<span style=color:#000>)</span>.........................................................NOT FOUND <span style=color:#000>(</span>-<span style=color:#000>)</span>
Python:OpenSSL <span style=color:#000>(</span>any<span style=color:#000>)</span>........................................................FOUND <span style=color:#000>(</span>18.0.0<span style=color:#000>)</span>
Python:requests <span style=color:#000>(</span>2.4.2+<span style=color:#000>)</span>.....................................................NOT FOUND <span style=color:#000>(</span>-<span style=color:#000>)</span>

                       *OPTIONAL SOFTWARE <span style=color:#a90d91>for</span> the LaTeX User Guide*                       
TeX:framed <span style=color:#000>(</span>any<span style=color:#000>)</span>.............................................................NOT FOUND <span style=color:#000>(</span>-<span style=color:#000>)</span>
TeX <span style=color:#000>(</span>3.0+<span style=color:#000>)</span>...........................................FOUND &amp; min. version MET <span style=color:#000>(</span>3.14159265<span style=color:#000>)</span>
TeX:preprint <span style=color:#000>(</span>any<span style=color:#000>)</span>...........................................................NOT FOUND <span style=color:#000>(</span>-<span style=color:#000>)</span>
TeX:tex4ht <span style=color:#000>(</span>any<span style=color:#000>)</span>.............................................................NOT FOUND <span style=color:#000>(</span>-<span style=color:#000>)</span>
TeX:tocloft <span style=color:#000>(</span>any<span style=color:#000>)</span>............................................................NOT FOUND <span style=color:#000>(</span>-<span style=color:#000>)</span>
TeX:texlive <span style=color:#000>(</span>any<span style=color:#000>)</span>............................................................NOT FOUND <span style=color:#000>(</span>-<span style=color:#000>)</span>
<span style=color:#000>==========================================================================================</span>

Summary:
                               ****************************                               
                                  Core requirements: ok                                  
                                Full-functionality: not ok                                
                               **************************** 
</code></pre></div><h3 id=running-pbs-torque-and-cylc-together-with-docker>Running PBS Torque and Cylc together with Docker</h3>
<p>The repository <a href=https://github.com/kinow/cylc-docker>https://github.com/kinow/cylc-docker</a>
contains some Dockerfile&rsquo;s for running Cylc, including a new one where I combined
the PBS Torque image, with the Cylc standalone image, with SSH between both. There is a
<code>docker-compose.yml</code> configuration to initialize a mini cluster of two computers, with
SSH and trusted configured, and shared volume/file system.</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ <span style=color:#a90d91>cd</span> cylc-docker/pbs
$ ssh-keygen -t rsa -f ./id_rsa -N <span style=color:#c41a16>&#34;&#34;</span> -q
$ <span style=color:#a90d91>export</span> <span style=color:#000>CYLC_SSH_PUBKEY</span><span style=color:#000>=</span><span style=color:#a90d91>$(</span>cat id_rsa.pub<span style=color:#a90d91>)</span>
$ <span style=color:#a90d91>echo</span> <span style=color:#c41a16>&#34;CYLC_SSH_PUBKEY=</span><span style=color:#c41a16>${</span><span style=color:#000>CYLC_SSH_PUBKEY</span><span style=color:#c41a16>}</span><span style=color:#c41a16>&#34;</span> &gt;&gt; .env
$ docker-compose up
Creating pbs  ... <span style=color:#a90d91>done</span>
Creating cylc ... <span style=color:#a90d91>done</span>
Attaching to cylc, pbs
cylc    | /usr/lib/python2.7/dist-packages/supervisor/options.py:297: UserWarning: Supervisord is running as root and it is searching <span style=color:#a90d91>for</span> its configuration file in default locations <span style=color:#000>(</span>including its current working directory<span style=color:#000>)</span>; you probably want to specify a <span style=color:#c41a16>&#34;-c&#34;</span> argument specifying an absolute path to a configuration file <span style=color:#a90d91>for</span> improved security.
cylc    |   <span style=color:#c41a16>&#39;Supervisord is running as root and it is searching &#39;</span>
cylc    | 2018-12-22 02:29:06,526 CRIT Supervisor running as root <span style=color:#000>(</span>no user in config file<span style=color:#000>)</span>
cylc    | 2018-12-22 02:29:06,526 WARN No file matches via include <span style=color:#c41a16>&#34;/etc/supervisor/conf.d/*.conf&#34;</span>
pbs     | /usr/lib/python2.6/site-packages/supervisor/options.py:295: UserWarning: Supervisord is running as root and it is searching <span style=color:#a90d91>for</span> its configuration file in default locations <span style=color:#000>(</span>including its current working directory<span style=color:#000>)</span>; you probably want to specify a <span style=color:#c41a16>&#34;-c&#34;</span> argument specifying an absolute path to a configuration file <span style=color:#a90d91>for</span> improved security.
pbs     |   <span style=color:#c41a16>&#39;Supervisord is running as root and it is searching &#39;</span>
cylc    | 2018-12-22 02:29:06,535 INFO RPC interface <span style=color:#c41a16>&#39;supervisor&#39;</span> initialized
cylc    | 2018-12-22 02:29:06,535 CRIT Server <span style=color:#c41a16>&#39;unix_http_server&#39;</span> running without any HTTP authentication checking
cylc    | 2018-12-22 02:29:06,535 INFO supervisord started with pid <span style=color:#1c01ce>1</span>
pbs     | 2018-12-22 02:29:07,480 CRIT Supervisor running as root <span style=color:#000>(</span>no user in config file<span style=color:#000>)</span>
pbs     | 2018-12-22 02:29:07,483 INFO supervisord started with pid <span style=color:#1c01ce>1</span>
pbs     | 2018-12-22 02:29:08,487 INFO spawned: <span style=color:#c41a16>&#39;pbsmom&#39;</span> with pid <span style=color:#1c01ce>10</span>
pbs     | 2018-12-22 02:29:08,490 INFO spawned: <span style=color:#c41a16>&#39;sshd&#39;</span> with pid <span style=color:#1c01ce>11</span>
pbs     | 2018-12-22 02:29:08,493 INFO spawned: <span style=color:#c41a16>&#39;pbssched&#39;</span> with pid <span style=color:#1c01ce>12</span>
pbs     | 2018-12-22 02:29:08,497 INFO spawned: <span style=color:#c41a16>&#39;pbsserver&#39;</span> with pid <span style=color:#1c01ce>13</span>
pbs     | 2018-12-22 02:29:08,499 INFO spawned: <span style=color:#c41a16>&#39;trqauthd&#39;</span> with pid <span style=color:#1c01ce>14</span>
pbs     | 2018-12-22 02:29:08,761 INFO exited: pbssched <span style=color:#000>(</span><span style=color:#a90d91>exit</span> status 0; not expected<span style=color:#000>)</span>
pbs     | 2018-12-22 02:29:08,794 INFO gave up: pbssched entered FATAL state, too many start retries too quickly
pbs     | 2018-12-22 02:29:10,078 INFO success: pbsmom entered RUNNING state, process has stayed up <span style=color:#a90d91>for</span> &gt; than <span style=color:#1c01ce>1</span> seconds <span style=color:#000>(</span>startsecs<span style=color:#000>)</span>
pbs     | 2018-12-22 02:29:10,079 INFO success: sshd entered RUNNING state, process has stayed up <span style=color:#a90d91>for</span> &gt; than <span style=color:#1c01ce>1</span> seconds <span style=color:#000>(</span>startsecs<span style=color:#000>)</span>
pbs     | 2018-12-22 02:29:10,079 INFO success: pbsserver entered RUNNING state, process has stayed up <span style=color:#a90d91>for</span> &gt; than <span style=color:#1c01ce>1</span> seconds <span style=color:#000>(</span>startsecs<span style=color:#000>)</span>
pbs     | 2018-12-22 02:29:10,079 INFO success: trqauthd entered RUNNING state, process has stayed up <span style=color:#a90d91>for</span> &gt; than <span style=color:#1c01ce>1</span> seconds <span style=color:#000>(</span>startsecs<span style=color:#000>)</span>

</code></pre></div><p>This should start two containers, <code>cylc</code>, and <code>pbs</code>, and with an example <code>suite.rc</code>.</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ docker-compose <span style=color:#a90d91>exec</span> cylc /bin/bash
bash-4.1# su - testuser
testuser@f85bd666bced:~$ cylc register pbs1 ./suites/pbs1/
REGISTER pbs1: ./suites/pbs1/
</code></pre></div><p>The example suite has one task that runs on a PBS remote node. In the output of running the suite
below, you can tell the tasks are being executed in different computers, by different owners, through
Cylc and PBS.</p>
<p>The task <code>a</code> has <code>[a.1] -submit-num=1, owner@host=pbs</code> in the logs, and <code>b</code> has
<code>[b.1] -submit-num=1, owner@host=7ce742eb050c</code>.</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>testuser@7ce742eb050c:~$ cylc run --no-detach pbs1
            ._.                                                       
            | |              The Cylc Suite Engine <span style=color:#000>[</span>7.8.0-dirty<span style=color:#000>]</span>      
._____._. ._| |_____.           Copyright <span style=color:#000>(</span>C<span style=color:#000>)</span> 2008-2018 NIWA          
| .___| | | | | .___|   &amp; British Crown <span style=color:#000>(</span>Met Office<span style=color:#000>)</span> &amp; Contributors.  
| !___| !_! | | !___.  _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
!_____!___. |_!_____!  This program comes with ABSOLUTELY NO WARRANTY;
      .___! |          see <span style=color:#c41a16>`</span>cylc warranty<span style=color:#c41a16>`</span>.  It is free software, you 
      !_____!           are welcome to redistribute it under certain  
2018-12-22T02:36:36Z INFO - Suite server: <span style=color:#000>url</span><span style=color:#000>=</span>https://7ce742eb050c:43037/ <span style=color:#000>pid</span><span style=color:#000>=</span><span style=color:#1c01ce>90</span>
2018-12-22T02:36:36Z INFO - Run: <span style=color:#000>(</span>re<span style=color:#000>)</span><span style=color:#000>start</span><span style=color:#000>=</span><span style=color:#1c01ce>0</span> <span style=color:#000>log</span><span style=color:#000>=</span><span style=color:#1c01ce>1</span>
2018-12-22T02:36:36Z INFO - Cylc version: 7.8.0-dirty
2018-12-22T02:36:36Z INFO - Run mode: live
2018-12-22T02:36:36Z INFO - Initial point: <span style=color:#1c01ce>1</span>
2018-12-22T02:36:36Z INFO - Final point: <span style=color:#1c01ce>1</span>
2018-12-22T02:36:36Z INFO - Cold Start <span style=color:#1c01ce>1</span>
2018-12-22T02:36:38Z INFO - <span style=color:#000>[</span>a.1<span style=color:#000>]</span> -submit-num<span style=color:#000>=</span>1, owner@host<span style=color:#000>=</span>pbs
2018-12-22T02:36:39Z INFO - <span style=color:#000>[</span>a.1<span style=color:#000>]</span> -<span style=color:#000>(</span>current:ready<span style=color:#000>)</span> submitted at 2018-12-22T02:36:39Z
2018-12-22T02:36:39Z INFO - <span style=color:#000>[</span>a.1<span style=color:#000>]</span> -health check settings: submission <span style=color:#000>timeout</span><span style=color:#000>=</span>None
2018-12-22T02:36:40Z INFO - <span style=color:#000>[</span>a.1<span style=color:#000>]</span> -<span style=color:#000>(</span>current:submitted<span style=color:#000>)</span>&gt; started at 2018-12-22T02:36:39Z
2018-12-22T02:36:40Z INFO - <span style=color:#000>[</span>a.1<span style=color:#000>]</span> -health check settings: execution <span style=color:#000>timeout</span><span style=color:#000>=</span>None
2018-12-22T02:36:40Z INFO - <span style=color:#000>[</span>a.1<span style=color:#000>]</span> -<span style=color:#000>(</span>current:running<span style=color:#000>)</span>&gt; succeeded at 2018-12-22T02:36:40Z
2018-12-22T02:36:41Z INFO - <span style=color:#000>[</span>b.1<span style=color:#000>]</span> -submit-num<span style=color:#000>=</span>1, owner@host<span style=color:#000>=</span>7ce742eb050c
2018-12-22T02:36:42Z INFO - <span style=color:#000>[</span>client-command<span style=color:#000>]</span> poll_tasks testuser@7ce742eb050c:cylc-poll d03e9798-14bb-4ef3-86a6-c01ea3a380ee
2018-12-22T02:36:42Z INFO - Command succeeded: poll_tasks<span style=color:#000>([</span>u<span style=color:#c41a16>&#39;a&#39;</span><span style=color:#000>]</span>, <span style=color:#000>poll_succ</span><span style=color:#000>=</span>False<span style=color:#000>)</span>
2018-12-22T02:36:42Z INFO - Processing <span style=color:#1c01ce>1</span> queued command<span style=color:#000>(</span>s<span style=color:#000>)</span>
	+	poll_tasks<span style=color:#000>([</span>u<span style=color:#c41a16>&#39;a&#39;</span><span style=color:#000>]</span>, <span style=color:#000>poll_succ</span><span style=color:#000>=</span>False<span style=color:#000>)</span>
2018-12-22T02:36:42Z INFO - <span style=color:#000>[</span>b.1<span style=color:#000>]</span> -<span style=color:#000>(</span>current:ready<span style=color:#000>)</span> submitted at 2018-12-22T02:36:42Z
2018-12-22T02:36:42Z INFO - <span style=color:#000>[</span>b.1<span style=color:#000>]</span> -health check settings: submission <span style=color:#000>timeout</span><span style=color:#000>=</span>None
2018-12-22T02:36:42Z INFO - <span style=color:#000>[</span>b.1<span style=color:#000>]</span> -<span style=color:#000>(</span>current:submitted<span style=color:#000>)</span>&gt; started at 2018-12-22T02:36:42Z
2018-12-22T02:36:42Z INFO - <span style=color:#000>[</span>b.1<span style=color:#000>]</span> -health check settings: execution <span style=color:#000>timeout</span><span style=color:#000>=</span>None
2018-12-22T02:36:43Z INFO - <span style=color:#000>[</span>b.1<span style=color:#000>]</span> -<span style=color:#000>(</span>current:running<span style=color:#000>)</span>&gt; succeeded at 2018-12-22T02:36:43Z
2018-12-22T02:36:43Z INFO - Suite shutting down - AUTOMATIC
2018-12-22T02:36:44Z INFO - DONE
</code></pre></div>
<figure class=feature>
<img src=/assets/posts/2018-12-22-running-cylc-tasks-on-pbs-torque-with-docker/cylcpbs-screenshot.png alt title width height>
<figcaption></figcaption>
</figure>
<h2 id=reproducing-the-issue>Reproducing the issue</h2>
<p>All right, so by now we have a working cluster of two computers, that share <code>~/cylc-run</code> via
Docker volumes (in the real world this is normally done via NFS).</p>
<p>The issue was related to the retrieval of remote logs. So we need to change <code>~/.cylc/global.rc</code>
in order to get it working.</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#177500># File: global.rc</span>

<span style=color:#000>[</span>hosts<span style=color:#000>]</span>
<span style=color:#000>[[</span>pbs<span style=color:#000>]]</span>
retrieve job logs <span style=color:#a90d91>command</span> <span style=color:#000>=</span> rsync -v -rltgoD --chmod<span style=color:#000>=</span><span style=color:#000>Du</span><span style=color:#000>=</span>rwx,Dgo<span style=color:#000>=</span>rx,Fu<span style=color:#000>=</span>rw,Fgo<span style=color:#000>=</span>r
</code></pre></div><p>The first thing I noticed debugging it, was that when I copied the command it had an
extra space, and it failed to execute. However, nothing appeared in the logs (!).</p>
<p>Then I managed to print the <code>rsync</code> command executed.</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>sync -v -rltgoD --chmod<span style=color:#000>=</span><span style=color:#000>Du</span><span style=color:#000>=</span>rwx,Dgo<span style=color:#000>=</span>rx,Fu<span style=color:#000>=</span>rw,Fgo<span style=color:#000>=</span>r <span style=color:#c41a16>&#39;--rsh=ssh -oBatchMode=yes -oConnectTimeout=10&#39;</span> -v --include<span style=color:#000>=</span>/1 --include<span style=color:#000>=</span>/1/a --include<span style=color:#000>=</span>/1/a/01 <span style=color:#c41a16>&#39;--include=/1/a/01/**&#39;</span> <span style=color:#c41a16>&#39;--exclude=/**&#39;</span> <span style=color:#c41a16>&#39;pbs:$HOME/cylc-run/pbs1/log/job/&#39;</span> /home/testuser/cylc-run/pbs1/log/job/
</code></pre></div><p>The thing that got me here as that it wasn&rsquo;t <code>rsync</code>&lsquo;ing the logs from PBS Torque spool, but rather
the logs that were already synced via Docker shared volume (or NFS in other environments).</p>
<p>The Cylc suite contains a PBS directive <code>-W umask=0077</code>, which forces the logs
to be readable only by the owner. It is possible to confirm it in the output
logs. But only because it is using an empty directory.</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>testuser@7ce742eb050c:~$ ls -lah /home/testuser/cylc-run/pbs1/log/job/1/a/01/
total 24K
drwxrwxr-x <span style=color:#1c01ce>2</span> testuser testuser 4.0K Dec <span style=color:#1c01ce>22</span> 02:36 .
drwxrwxr-x <span style=color:#1c01ce>3</span> testuser testuser 4.0K Dec <span style=color:#1c01ce>22</span> 02:34 ..
-rwxrwxr-x <span style=color:#1c01ce>1</span> testuser testuser 1.3K Dec <span style=color:#1c01ce>22</span> 02:36 job
-rw-rw-r-- <span style=color:#1c01ce>1</span> testuser testuser  <span style=color:#1c01ce>266</span> Dec <span style=color:#1c01ce>22</span> 02:36 job-activity.log
-rw------- <span style=color:#1c01ce>1</span> testuser testuser    <span style=color:#1c01ce>0</span> Dec <span style=color:#1c01ce>22</span> 02:36 job.err
-rw------- <span style=color:#1c01ce>1</span> testuser testuser  <span style=color:#1c01ce>147</span> Dec <span style=color:#1c01ce>22</span> 02:36 job.out
-rw-rw-r-- <span style=color:#1c01ce>1</span> testuser testuser  <span style=color:#1c01ce>231</span> Dec <span style=color:#1c01ce>22</span> 02:36 job.status
</code></pre></div><p>Even though the <code>rsync</code> command was executed, it had no effect. We can confirm it by running it
in the <code>cylc</code> node.</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>testuser@7ce742eb050c:~$ rsync -v -rltgoD --chmod<span style=color:#000>=</span><span style=color:#000>Du</span><span style=color:#000>=</span>rwx,Dgo<span style=color:#000>=</span>rx,Fu<span style=color:#000>=</span>rw,Fgo<span style=color:#000>=</span>r <span style=color:#c41a16>&#39;--rsh=ssh -oBatchMode=yes -oConnectTimeout=10&#39;</span> -v --include<span style=color:#000>=</span>/1 --include<span style=color:#000>=</span>/1/a --include<span style=color:#000>=</span>/1/a/01 <span style=color:#c41a16>&#39;--include=/1/a/01/**&#39;</span> <span style=color:#c41a16>&#39;--exclude=/**&#39;</span> <span style=color:#c41a16>&#39;pbs:$HOME/cylc-run/pbs1/log/job/&#39;</span> /home/testuser/cylc-run/pbs1/log/job/
opening connection using: ssh -oBatchMode<span style=color:#000>=</span>yes -oConnectTimeout<span style=color:#000>=</span><span style=color:#1c01ce>10</span> pbs rsync --server --sender -vvlogDtre.iLsfx . <span style=color:#c41a16>&#34;</span><span style=color:#000>$HOME</span><span style=color:#c41a16>/cylc-run/pbs1/log/job/&#34;</span>  <span style=color:#000>(</span><span style=color:#1c01ce>10</span> args<span style=color:#000>)</span>
receiving incremental file list
<span style=color:#000>[</span>sender<span style=color:#000>]</span> showing directory <span style=color:#1c01ce>1</span> because of pattern /1
delta-transmission enabled
<span style=color:#000>[</span>sender<span style=color:#000>]</span> showing directory 1/a because of pattern /1/a
<span style=color:#000>[</span>sender<span style=color:#000>]</span> hiding directory 1/b because of pattern /**
<span style=color:#000>[</span>sender<span style=color:#000>]</span> showing directory 1/a/01 because of pattern /1/a/01
<span style=color:#000>[</span>sender<span style=color:#000>]</span> hiding file 1/a/NN because of pattern /**
<span style=color:#000>[</span>sender<span style=color:#000>]</span> showing file 1/a/01/job.out because of pattern /1/a/01/**
<span style=color:#000>[</span>sender<span style=color:#000>]</span> showing file 1/a/01/job-activity.log because of pattern /1/a/01/**
<span style=color:#000>[</span>sender<span style=color:#000>]</span> showing file 1/a/01/job.status because of pattern /1/a/01/**
<span style=color:#000>[</span>sender<span style=color:#000>]</span> showing file 1/a/01/job because of pattern /1/a/01/**
<span style=color:#000>[</span>sender<span style=color:#000>]</span> showing file 1/a/01/job.err because of pattern /1/a/01/**
1/a/01/job is uptodate
1/a/01/job-activity.log is uptodate
1/a/01/job.err is uptodate
1/a/01/job.out is uptodate
1/a/01/job.status is uptodate
total: <span style=color:#000>matches</span><span style=color:#000>=</span><span style=color:#1c01ce>0</span>  <span style=color:#000>hash_hits</span><span style=color:#000>=</span><span style=color:#1c01ce>0</span>  <span style=color:#000>false_alarms</span><span style=color:#000>=</span><span style=color:#1c01ce>0</span> <span style=color:#000>data</span><span style=color:#000>=</span><span style=color:#1c01ce>0</span>

sent <span style=color:#1c01ce>97</span> bytes  received <span style=color:#1c01ce>935</span> bytes  688.00 bytes/sec
total size is 1,888  speedup is 1.83
</code></pre></div><p><code>rsync</code> realizes that the files are already up to date, and does not change the permission
of the files. If we run this against a different empty folder, <code>rsync</code> will adjust the
permissions. In the next example first a directory <code>test</code> is created, and <code>rsync</code> command
is changed to use this new local folder.</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>testuser@7ce742eb050c:~$ mkdir ~/test
testuser@7ce742eb050c:~$ rsync -v -rltgoD --chmod<span style=color:#000>=</span><span style=color:#000>Du</span><span style=color:#000>=</span>rwx,Dgo<span style=color:#000>=</span>rx,Fu<span style=color:#000>=</span>rw,Fgo<span style=color:#000>=</span>r <span style=color:#c41a16>&#39;--rsh=ssh -oBatchMode=yes -oConnectTimeout=10&#39;</span> -v --include<span style=color:#000>=</span>/1 --include<span style=color:#000>=</span>/1/a --include<span style=color:#000>=</span>/1/a/01 <span style=color:#c41a16>&#39;--include=/1/a/01/**&#39;</span> <span style=color:#c41a16>&#39;--exclude=/**&#39;</span> <span style=color:#c41a16>&#39;pbs:$HOME/cylc-run/pbs1/log/job/&#39;</span> /home/testuser/test                  
opening connection using: ssh -oBatchMode<span style=color:#000>=</span>yes -oConnectTimeout<span style=color:#000>=</span><span style=color:#1c01ce>10</span> pbs rsync --server --sender -vvlogDtre.iLsfx . <span style=color:#c41a16>&#34;</span><span style=color:#000>$HOME</span><span style=color:#c41a16>/cylc-run/pbs1/log/job/&#34;</span>  <span style=color:#000>(</span><span style=color:#1c01ce>10</span> args<span style=color:#000>)</span>
receiving incremental file list
<span style=color:#000>[</span>sender<span style=color:#000>]</span> showing directory <span style=color:#1c01ce>1</span> because of pattern /1
delta-transmission enabled
<span style=color:#000>[</span>sender<span style=color:#000>]</span> showing directory 1/a because of pattern /1/a
<span style=color:#000>[</span>sender<span style=color:#000>]</span> hiding directory 1/b because of pattern /**
<span style=color:#000>[</span>sender<span style=color:#000>]</span> showing directory 1/a/01 because of pattern /1/a/01
<span style=color:#000>[</span>sender<span style=color:#000>]</span> hiding file 1/a/NN because of pattern /**
<span style=color:#000>[</span>sender<span style=color:#000>]</span> showing file 1/a/01/job.out because of pattern /1/a/01/**
<span style=color:#000>[</span>sender<span style=color:#000>]</span> showing file 1/a/01/job-activity.log because of pattern /1/a/01/**
<span style=color:#000>[</span>sender<span style=color:#000>]</span> showing file 1/a/01/job.status because of pattern /1/a/01/**
<span style=color:#000>[</span>sender<span style=color:#000>]</span> showing file 1/a/01/job because of pattern /1/a/01/**
<span style=color:#000>[</span>sender<span style=color:#000>]</span> showing file 1/a/01/job.err because of pattern /1/a/01/**
./
1/
1/a/
1/a/01/
1/a/01/job
1/a/01/job-activity.log
1/a/01/job.err
1/a/01/job.out
1/a/01/job.status
total: <span style=color:#000>matches</span><span style=color:#000>=</span><span style=color:#1c01ce>0</span>  <span style=color:#000>hash_hits</span><span style=color:#000>=</span><span style=color:#1c01ce>0</span>  <span style=color:#000>false_alarms</span><span style=color:#000>=</span><span style=color:#1c01ce>0</span> <span style=color:#000>data</span><span style=color:#000>=</span><span style=color:#1c01ce>1888</span>

sent <span style=color:#1c01ce>177</span> bytes  received 3,022 bytes  6,398.00 bytes/sec
total size is 1,888  speedup is 0.59
testuser@7ce742eb050c:~$ ls -lah test/1/a/01/
total 24K
drwxr-xr-x <span style=color:#1c01ce>2</span> testuser testuser 4.0K Dec <span style=color:#1c01ce>22</span> 02:36 .
drwxr-xr-x <span style=color:#1c01ce>3</span> testuser testuser 4.0K Dec <span style=color:#1c01ce>22</span> 02:34 ..
-rw-r--r-- <span style=color:#1c01ce>1</span> testuser testuser 1.3K Dec <span style=color:#1c01ce>22</span> 02:36 job
-rw-r--r-- <span style=color:#1c01ce>1</span> testuser testuser  <span style=color:#1c01ce>266</span> Dec <span style=color:#1c01ce>22</span> 02:36 job-activity.log
-rw-r--r-- <span style=color:#1c01ce>1</span> testuser testuser    <span style=color:#1c01ce>0</span> Dec <span style=color:#1c01ce>22</span> 02:36 job.err
-rw-r--r-- <span style=color:#1c01ce>1</span> testuser testuser  <span style=color:#1c01ce>147</span> Dec <span style=color:#1c01ce>22</span> 02:36 job.out
-rw-r--r-- <span style=color:#1c01ce>1</span> testuser testuser  <span style=color:#1c01ce>231</span> Dec <span style=color:#1c01ce>22</span> 02:36 job.status
</code></pre></div><p>It is possible now to confirm that <code>rsync</code> has synced the folders, and instead of the
previous <code>-rw-------</code> permissions, both <code>job.out</code> and <code>job.err</code> have <code>-rw-r--r--</code> now.</p>
<h3 id=conclusion>Conclusion</h3>
<p>This was a good experiment, where I managed to publish some images to DockerHub for Cylc,
though they still lack maturity, and are probably not suitable for production use. There
are two other images in the same GitHub repository for Cylc, but these are even less mature.</p>
<p>The Cylc PBS image can be used by people familiar with Docker (i.e. who know what and how
to kick). It provides a quick way to test and troubleshoot issues with Cylc and PBS.</p>
<p>One <a href=https://github.com/cylc/cylc/pull/2911>issue</a> identified during this analysis is that
the log retrieval command may fail in Cylc, but without any output in the logs.</p>
<p>I believe the problem reported in the Google Groups could be due to <code>rsync</code> not
applying the new <code>chmod</code> values on existing values, but only on new ones. The documentation
for <code>--chmod</code> does not say much, however, if you look under <code>--permissions</code>:</p>
<blockquote>
<p>In summary: to give destination files (both old and new) the source permissions, use &ndash;perms. To give new files the destination-default permissions (while leaving existing files
unchanged), make sure that the &ndash;perms option is off and use &ndash;chmod=ugo=rwX (which ensures that all non-masked bits get enabled).</p>
</blockquote>
<p>My understanding is that there is a difference on how some settings in <code>rsync</code> work
for new files, and for existing files. I think the documentation could be clearer about it.
The <code>cylc</code> container&rsquo;s <code>rsync</code> version was 3.1.1. I compiled the latest version (3.1.3) on
my Ubuntu LTS, and copied it across to the container, and confirmed the behaviour is the
same (might message the <code>rsync</code> devs later to confirm).</p>
<p>Finally, I think there is room for improvement in the current log retrieval strategies
in Cylc, and hopefully I will be able to later translate the fuzzy ideas I have in my
mind right now to a simple description to discuss it with other developers, and maybe
improve this feature in the future.</p>
<p>Live long and prosper!</p>
<p>♥ Open Source</p>
<p>
Categories:
<a href=/categories/blog.html>blog</a>
</p>
<p>
Tags:
<a href=/tags/cylc.html>cylc</a>,
<a href=/tags/python.html>python</a>,
<a href=/tags/hpc.html>hpc</a>,
<a href=/tags/docker.html>docker</a>,
<a href=/tags/workflows.html>workflows</a>,
<a href=/tags/programming.html>programming</a>
</p>
<aside class=links>
<a class=previous href=https://kinoshita.eti.br/2018/10/25/what-the-weather-forecast-looks-like-in-sao-paulo-brazil.html>&#171; Previous</a>
<a class=next href=https://kinoshita.eti.br/2018/12/24/how-the-skosmos-widget-wiki-plugin-works.html>Next &#187;</a>
</aside>
</article>
</main>
<footer role=contentinfo>
<ul id=social-media-icons>
<li>
<a href=https://www.instagram.com/brunokinoshita/>
<img src=/assets/icons/instagram.png alt="Instagram link">
</a>
</li>
<li>
<a href=https://twitter.com/kinow/>
<img src=/assets/icons/twitter.png alt="Twitter link">
</a>
</li>
<li>
<a href=https://github.com/kinow/>
<img src=/assets/icons/github.png alt="GitHub link">
</a>
</li>
<li>
<a href=/feed.xml>
<img src=/assets/icons/news.png alt="RSS feed link">
</a>
</li>
</ul>
</footer>
</body>
</html>