<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:url" content="https://kinoshita.eti.br/2018/05/27/what-happens-when-you-upload-a-turtle-file-in-apache-jena-fuseki.html"><meta property="og:site_name" content="kinow"><meta property="og:title" content="What happens when you upload a Turtle file in Apache Jena Fuseki"><meta property="og:description" content="I am working on an issue for Skosmos that involves preparing some Turtle files and uploading them using Apache Jena Fuseki&amp;rsquo;s web interface.
The issue is now pending feedback, which gives me a moment to have fun with something else. So I decided to dig down the rabbit hole and start learning more about certain parts of the Apache Jena code base.
This post will be useful to myself in the future, as a note-taking in a series, so that I remember how things work - you never know right?"><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-05-27T00:00:00+00:00"><meta property="article:modified_time" content="2024-07-31T22:18:18+02:00"><meta property="article:tag" content="Apache Software Foundation"><meta property="article:tag" content="Jena"><meta property="article:tag" content="Opensource"><meta property="article:tag" content="Programming"><meta property="og:image" content="https://kinoshita.eti.br/assets/photos/about/2023-me-closeup.png"><meta property="fb:admins" content="bruno.kinoshita"><meta name=twitter:title content="What happens when you upload a Turtle file in Apache Jena Fuseki"><meta name=twitter:description content="I am working on an issue for Skosmos that involves preparing some Turtle files and uploading them using Apache Jena Fuseki&rsquo;s web interface.
The issue is now pending feedback, which gives me a moment to have fun with something else. So I decided to dig down the rabbit hole and start learning more about certain parts of the Apache Jena code base.
This post will be useful to myself in the future, as a note-taking in a series, so that I remember how things work - you never know right?"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://kinoshita.eti.br/assets/photos/about/2023-me-closeup.png"><meta name=twitter:site content="@kinow"><link rel=alternate type=application/rss+xml href=https://kinoshita.eti.br/2018/05/27/what-happens-when-you-upload-a-turtle-file-in-apache-jena-fuseki/feed.xml title=kinow><link rel=stylesheet type=text/css href=https://kinoshita.eti.br/sass/main.84655682aa42a26b14ea59649da35e622383c94bca7a62d17b2cc6c559ed1efb.css integrity="sha256-hGVWgqpComsU6llknaNeYiODyUvKemLReyzGxVntHvs="><title>kinow | What happens when you upload a Turtle file in Apache Jena Fuseki</title><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","articleSection":"posts","name":"What happens when you upload a Turtle file in Apache Jena Fuseki","headline":"What happens when you upload a Turtle file in Apache Jena Fuseki","alternativeHeadline":"","description":"I am working on an issue for Skosmos that involves preparing some Turtle files and uploading them using Apache Jena Fuseki\u0026rsquo;s web interface.\nThe issue is now pending feedback, which gives me a moment to have fun with something else. So I decided to dig down the rabbit hole and start learning more about certain parts of the Apache Jena code base.\nThis post will be useful to myself in the future, as a note-taking in a series, so that I remember how things work - you never know right?","inLanguage":"en-us","isFamilyFriendly":"true","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/kinoshita.eti.br\/2018\/05\/27\/what-happens-when-you-upload-a-turtle-file-in-apache-jena-fuseki.html"},"author":{"@type":"Person","name":""},"creator":{"@type":"Person","name":""},"accountablePerson":{"@type":"Person","name":""},"copyrightHolder":"kinow","copyrightYear":"2018","dateCreated":"2018-05-27T00:00:00.00Z","datePublished":"2018-05-27T00:00:00.00Z","dateModified":"2024-07-31T22:18:18.00Z","publisher":{"@type":"Organization","name":"kinow","url":"https://kinoshita.eti.br/","logo":{"@type":"ImageObject","url":"https:\/\/kinoshita.eti.br\/","width":"32","height":"32"}},"image":"https://kinoshita.eti.br/","url":"https:\/\/kinoshita.eti.br\/2018\/05\/27\/what-happens-when-you-upload-a-turtle-file-in-apache-jena-fuseki.html","wordCount":"699","genre":["apache software foundation","jena","opensource","programming"],"keywords":[]}</script></head><body><header role=banner class=content><nav id=nav aria-label=Main role=navigation class=content><ul><li><a href=/><i data-feather=about></i> About</a></li><li><a href=/blog/><i data-feather=blog></i> Blog</a></li><li><a href=/portfolio/><i data-feather=portfolio></i> Portfolio</a></li></ul></nav></header><main><article class=content><h1>What happens when you upload a Turtle file in Apache Jena Fuseki</h1><div class=metadata><i data-feather=calendar></i>
<time datetime=2018-05-27>May 27, 2018</time></div><aside><nav id=TableOfContents><ul><li><ul><li><a href=#where-upload-happens---sparql_upload-and-upload-fuseki-core>Where upload happens - SPARQL_Upload and Upload (Fuseki Core)</a></li><li><a href=#uploadincomingdata-fuseki-core>Upload#incomingData() (Fuseki Core)</a></li><li><a href=#actionlibparse-fuseki-core>ActionLib#parse() (Fuseki Core)</a></li><li><a href=#langturtle-arq>LangTurtle (ARQ)</a></li><li><a href=#conclusion>Conclusion</a></li></ul></li></ul></nav></aside><p>I am working on <a href=https://github.com/NatLibFi/Skosmos/issues/738>an issue for Skosmos</a>
that involves preparing some <a href=https://www.w3.org/TR/turtle/>Turtle</a> files and uploading
them using Apache Jena Fuseki&rsquo;s web interface.</p><p>The issue is now pending feedback, which gives me a moment to have fun with
something else. So I decided to dig down the rabbit hole and start learning more
about certain parts of the Apache Jena code base.</p><p style=text-align:center><figure class=feature><img src=/assets/posts/2018-05-27-what-happens-when-you-upload-a-turtle-file-in-apache-jena-fuseki/browser.png alt title style=display:inline;width:600px width height><figcaption></figcaption></figure></p><p>This post will be useful to myself in the future, as a note-taking in a series, so that I
remember how things work - you never know right? But hopefully this will be useful
to other wanting to understand more about the code of Apache Jena.</p><h3 id=where-upload-happens---sparql_upload-and-upload-fuseki-core>Where upload happens - SPARQL_Upload and Upload (Fuseki Core)</h3><p>Knowing a bit of the code base, I went straight to the <code>SPARQL_Upload</code> class,
from the Fuseki Core module. Set up a couple of breakpoints, uploaded my file,
but nothing. Then tried on its package-neighbour class, <code>Upload</code>.</p><p>Actually, it is easier to understand seeing the class hierarchy, and knowing
that when I run the application in Eclipse, it is running with Jetty, serving
servlets (there is no framework like Wicket, Struts, etc, involved).</p><p style=text-align:center><figure class=feature><img src=/assets/posts/2018-05-27-what-happens-when-you-upload-a-turtle-file-in-apache-jena-fuseki/class-hierarchy.png alt title style=display:inline;width:600px width height><figcaption></figcaption></figure></p><p>Several filters are applied to the HTTP request too, like Cross Origin, Shiro, and
the <code>FusekiFilter</code>. The latter looks at the requests to see if it includes a dataset.
If a dataset is found - it is in our case - then it hands the request over to
the right class to handle it.</p><p>REST_Quads_RW will take care of the upload action, using the <code>Upload</code> class where my
breakpoint stopped.</p><h3 id=uploadincomingdata-fuseki-core>Upload#incomingData() (Fuseki Core)</h3><p><code>Upload#incomingData()</code> starts by checking the Content Type from the request. In my case
it is a <code>multipart/form-data</code>. Then it calls its other method <code>#fileUploadWorker()</code>.</p><p><code>#fileUploadWorker()</code> creates a <code>ServletFilterUpload</code>, from Apache Commons FileUpload.
With that, it opens a stream for the file, retrieves its name and other information,
such as the content type.</p><p>Ah, the content type is interesting too. It defaults to <code>RDFXML</code>, but what&rsquo;s interesting
is the comment.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>if</span> ( <span style=color:#000>lang</span> <span style=color:#000>==</span> <span style=color:#a90d91>null</span> )
</span></span><span style=display:flex><span>    <span style=color:#177500>// Desperate.</span>
</span></span><span style=display:flex><span>    <span style=color:#000>lang</span> <span style=color:#000>=</span> <span style=color:#000>RDFLanguages</span>.<span style=color:#836c28>RDFXML</span> ;
</span></span></code></pre></div><p>Well, in this case we are getting a <code>Lang:Turtle</code>. So it now knows that it has a Turtle
file, but it still needs to parse it.</p><h3 id=actionlibparse-fuseki-core>ActionLib#parse() (Fuseki Core)</h3><p><code>Upload</code> calls <code>ActionLib#parse()</code>, which uses <code>RDFParserBuilder</code> to build a parser.
It applies a nice fluent API design when doing that.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>RDFParser</span>.<span style=color:#836c28>create</span>()
</span></span><span style=display:flex><span>    .<span style=color:#836c28>errorHandler</span>(<span style=color:#000>errorHandler</span>)
</span></span><span style=display:flex><span>    .<span style=color:#836c28>source</span>(<span style=color:#000>input</span>)
</span></span><span style=display:flex><span>    .<span style=color:#836c28>lang</span>(<span style=color:#000>lang</span>)
</span></span><span style=display:flex><span>    .<span style=color:#836c28>base</span>(<span style=color:#000>base</span>)
</span></span><span style=display:flex><span>    .<span style=color:#836c28>parse</span>(<span style=color:#000>dest</span>);
</span></span></code></pre></div><blockquote>Side note to self: the `RDFParser` has a `canUse` flag. It seems to indicate
the parser can be used just once. Though it looks actually it works until the stream
is closed...</blockquote><p>So <code>RDFParserBuilder</code> will call <code>RDFParser</code>, which in turn will use the
classes <code>LangTurtle</code> and <code>LangTurtleBase</code>.</p><h3 id=langturtle-arq>LangTurtle (ARQ)</h3><p>ARQ is a low level module in Jena, responsible for parsing queries, and also
some of the interaction with graphs and datasets.</p><p><code>LangTurtle</code> extends <code>LangTurtleBase</code>. Their task starts by populating
the <code>prefixMap</code>, which contains all those prefixes used in queries like
<code>rdfs</code>, <code>void</code>, <code>skos</code>, <code>etc</code>.</p><p>Then it will keep parsing <strong>triples</strong> until it finds an <code>EOF</code>. For every
triple, after the <em>Predicate-Object-List</em> is found, it calls
<code>LangTurtle#emit()</code>.</p><p>The <code>#emit()</code>method creates a <code>Triple</code> object (Jena Core, graph package).
And also a <code>StreamRDFCountingBase</code> to keep track of statistics to display
back to the user.</p><p style=text-align:center><figure class=feature><img src=/assets/posts/2018-05-27-what-happens-when-you-upload-a-turtle-file-in-apache-jena-fuseki/eclipse.png alt title style=display:inline;width:600px width height><figcaption></figcaption></figure></p><p><code>StreamRDFCountingBase</code> extends <code>StreamRDFWrapper</code>, and wraps - as per name -
other <code>StreamRDF</code>&rsquo;s, such as <code>ParserOutputDataset</code>.</p><p><code>ParserOutputDataset</code> holds a reference to the <code>DatasetGraph</code> and also to the
<code>prefixMap</code> populated earlier in <code>LangTurtle</code>. For each <code>Triple</code> that we have
it will call the <code>DatasetGraph#add</code> method, creating a new <em>Quad</em> with the
default graph name.</p><h3 id=conclusion>Conclusion</h3><p>Finally, readers and streams are closed. An <code>UploadDetails</code> object is created
holding stats collected in <code>StreamRDFCountingBase</code>, which are also used for
logging.</p><p><code>Upload#incomingPath()</code> will return the <code>UploadDetails</code>. If there are no errors
then the transaction will be committed. It involves again classes from ARQ and
TDB (for journaling), but that will be for another post.</p><p>The final method called in the <code>Upload</code> class will be <code>detailsJson()</code>, which
returns the object as JSON. This JSON string is then finally returned to the
user.</p><p>So that&rsquo;s it. Probably the next step will be to learn how <code>DatasetGraph</code> works,
or maybe more about transactions in Jena.</p><p>Happy hacking !</p><p>Categories:
<a href=/categories/blog.html>Blog</a></p><p>Tags:
<a href=/tags/apache-software-foundation.html>Apache Software Foundation</a>,
<a href=/tags/jena.html>Jena</a>,
<a href=/tags/opensource.html>Opensource</a>,
<a href=/tags/programming.html>Programming</a></p><aside class=links><a class=previous href=https://kinoshita.eti.br/2018/05/13/drawing-santos-dumonts-encantada-in-krita.html>&#171; Previous</a><a class=next href=https://kinoshita.eti.br/2018/05/29/what-happens-when-you-create-a-new-dataset-in-apache-jena-fuseki.html>Next &#187;</a></aside></article></main><footer role=contentinfo><ul id=social-media-icons><li><a href=https://www.instagram.com/brunokinoshita/><img src=/assets/icons/instagram.png alt="Instagram link"></a></li><li><a href=https://twitter.com/kinow/><img src=/assets/icons/twitter.png alt="Twitter link"></a></li><li><a href=https://github.com/kinow/><img src=/assets/icons/github.png alt="GitHub link"></a></li><li><a href=/feed.xml><img src=/assets/icons/news.png alt="RSS feed link"></a></li></ul></footer></body></html>