<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta property="og:title" content="Multithreaded code and Pandas">
<meta property="og:description" content="

  
  Woman looking




Pandas provides high-performance data structures in Python. I think in Java there are
similar data structures in projects like Apache Commons Collections,
Google Guava, and also Trove.
In the Java libraries thread-safety is always a must-have feature. Probably as it is quite
common for a Java program to have more than one thread, especially if the code runs in some
sort of web container.
I recently learned that Pandas, on the other hand, does not guarantee any thread-safety.
I found that while reading an
issue about race condition in the IndexEngine,
and after preparing a pull request for that.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://kinoshita.eti.br/2018/07/22/multithreaded-code-and-pandas.html"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2018-07-22T00:00:00+00:00">
<meta property="article:modified_time" content="2024-04-06T20:52:43+02:00">
<link rel=alternate type=application/rss+xml href=https://kinoshita.eti.br/2018/07/22/multithreaded-code-and-pandas/feed.xml title=kinow>
<link rel=stylesheet type=text/css href=https://kinoshita.eti.br/sass/main.09b56b6037e962b67cf7a7701bf2a9ee5da840a4f74b74139c4731f2156a5917.css integrity="sha256-CbVrYDfpYrZ896dwG/Kp7l2oQKT3S3QTnEcx8hVqWRc=">
<title>kinow | Multithreaded code and Pandas</title>
</head>
<body>
<header role=banner class=content>
<nav id=nav aria-label=Main role=navigation class=content>
<ul><li>
<a href=/><i data-feather=about></i> About</a>
</li><li>
<a href=/blog/><i data-feather=blog></i> Blog</a>
</li><li>
<a href=/portfolio/><i data-feather=portfolio></i> Portfolio</a>
</li>
</ul>
</nav>
</header>
<main>
<article class=content>
<h1>Multithreaded code and Pandas</h1><div class=metadata>
<i data-feather=calendar></i>
<time datetime=2018-07-22>Jul 22, 2018</time>
</div>
<aside>
<nav id=TableOfContents></nav>
</aside>
<figure class=feature>
<img src=/assets/posts/2018-07-22-multithreaded-code-and-pandas/woman-looking-01.png alt="Woman looking" title="Woman looking" style=float:left;height:300px width height>
<figcaption>Woman looking</figcaption>
</figure>
<p>Pandas provides high-performance data structures in Python. I think in Java there are
similar data structures in projects like Apache Commons Collections,
Google Guava, and also Trove.</p>
<p>In the Java libraries thread-safety is always a must-have feature. Probably as it is quite
common for a Java program to have more than one thread, especially if the code runs in some
sort of web container.</p>
<p>I recently learned that Pandas, on the other hand, does not guarantee any thread-safety.
I found that while reading an
<a href=https://github.com/pandas-dev/pandas/issues/21150>issue about race condition in the <code>IndexEngine</code></a>,
and after preparing a pull request for that.</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#a90d91>from</span> <span style=color:#000>concurrent.futures</span> <span style=color:#a90d91>import</span> <span style=color:#000>ThreadPoolExecutor</span>
<span style=color:#a90d91>import</span> <span style=color:#000>pandas</span> <span style=color:#a90d91>as</span> <span style=color:#000>pd</span>

<span style=color:#000>x</span> <span style=color:#000>=</span> <span style=color:#000>pd</span><span style=color:#000>.</span><span style=color:#000>date_range</span>(<span style=color:#c41a16>&#39;2001&#39;</span>, <span style=color:#c41a16>&#39;2020&#39;</span>)
<span style=color:#a90d91>with</span> <span style=color:#000>ThreadPoolExecutor</span>(<span style=color:#1c01ce>2</span>) <span style=color:#a90d91>as</span> <span style=color:#000>p</span>:
    <span style=color:#a90d91>assert</span> <span style=color:#a90d91>all</span>(<span style=color:#000>p</span><span style=color:#000>.</span><span style=color:#000>map</span>(<span style=color:#a90d91>lambda</span> <span style=color:#000>x</span>: <span style=color:#000>x</span><span style=color:#000>.</span><span style=color:#000>is_unique</span>, [<span style=color:#000>x</span>]<span style=color:#000>*</span><span style=color:#1c01ce>2</span>))
</code></pre></div><p>When you create an index like that, it will delegate most of the hard work to the <code>IndexEngine</code>.
Inside the <code>IndexEngine</code>, the values passed for the index are stored, and then an empty
<code>Hashtable</code> is created (as well as several flags for the state of the object, such as
<code>unique</code>, which defines whether the index has unique elements or not).</p>
<p>Once a user calls a method like <code>is_unique</code>, then the flags are updated, the <code>Hashtable</code>
mapping is populated, and while doing so, if not all elements are unique, the flag for
<code>unique</code> is set to <code>false</code>, or <code>true</code> otherwise. But if the user does not need that
operation, we will avoid populating the mapping until we really need it.</p>
<p>I believe it is done that way for performance. However, at the cost that the state is shared
among calls, which makes it harder to use this API in a multithreaded environment - though
still possible by moving the synchronization to your caller code.</p>
<p>Some Apache software also do the same, asking users to synchronize, serialize, or handle
certain corner cases on their side. There is a huge cost associated with maintaining an Open
Source project that promises thread-safety.</p>
<p>But maybe <a href=http://dask.pydata.org/en/latest/>Dask</a> provides an alternative to use Pandas
with multiple threads. But I have not used that yet.</p>
<p>â™¥ Open Source</p>
<p><em>NB: even though Pandas is not thread-safe, it does not mean you should not use it. Just use
with care when using multiple threads</em></p>
<p>
Categories:
<a href=/categories/blog.html>blog</a>
</p>
<p>
Tags:
<a href=/tags/python.html>python</a>,
<a href=/tags/pandas.html>pandas</a>,
<a href=/tags/opensource.html>opensource</a>
</p>
<aside class=links>
<a class=previous href=https://kinoshita.eti.br/2018/07/14/cylc-scheduler-internals-part-1.html>&#171; Previous</a>
<a class=next href=https://kinoshita.eti.br/2018/07/27/cylc-scheduler-internals-part-2.html>Next &#187;</a>
</aside>
</article>
</main>
<footer role=contentinfo>
<ul id=social-media-icons>
<li>
<a href=https://www.instagram.com/brunokinoshita/>
<img src=/assets/icons/instagram.png alt="Instagram link">
</a>
</li>
<li>
<a href=https://twitter.com/kinow/>
<img src=/assets/icons/twitter.png alt="Twitter link">
</a>
</li>
<li>
<a href=https://github.com/kinow/>
<img src=/assets/icons/github.png alt="GitHub link">
</a>
</li>
<li>
<a href=/feed.xml>
<img src=/assets/icons/news.png alt="RSS feed link">
</a>
</li>
</ul>
</footer>
</body>
</html>