<!doctype html><html lang=en><head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<link rel=stylesheet type=text/css href=https://kinoshita.eti.br/sass/main.e392e97e7e5991e363403c494b51d829efa207842d755622976c2537d0509be0.css integrity="sha256-45Lpfn5ZkeNjQDxJS1HYKe+iB4QtdVYil2wlN9BQm+A=">
<title>kinow | Creating a Docker container to run as a command</title>
</head>
<body><header role=banner class=content>
<nav id=nav aria-label=Main role=navigation class=content>
<ul><li>
<a href=/>
<i data-feather=about></i> About</a>
</li><li>
<a href=/blog/>
<i data-feather=blog></i> Blog</a>
</li><li>
<a href=/portfolio/>
<i data-feather=portfolio></i> Portfolio</a>
</li><li></li>
</ul>
</nav>
</header>
<main>
<article class=content>
<h2>Creating a Docker container to run as a command</h2><div class=metadata>
<i data-feather=calendar></i>
<time datetime=2018-08-04>Aug 4, 2018</time>
</div>
<p>For the past two weeks at work I have been assigned to work on PHP projects. Though I used
PHP some time ago - especially with Code Igniter and Laravel - I have not used it in a few
years. And have been doing mostly Java nowadays.</p>
<p>The complete project setup was done by co-workers. I had a PHP project, using Symfony, several
bundles and libraries, and Postgres. But it required just running a few commands to set up
AWS settings, and then fire up Docker Compose.</p>
<p>Besides Docker Compose starting a web container, and another Postgres container, we used the
web container to run <a href=https://getcomposer.org/>Composer</a>. In the past, I would see the PHP
project mapped as a folder in the running container, and then composer would be executed
in the host.</p>
<p>I noticed then that I could do the same to an image I created in 2016 to run
<a href=https://cylc.github.io/cylc/>Cylc</a>. The <a href=https://github.com/kinow/docker/blob/d1cc1771ac53b8efd37b5e4c4401b74ebd294a2b/cylc/Dockerfile>previous version</a>
would be used to start a container in a terminal, then run some commands
while maintaining the state within the container.</p>
<p>The <a href=https://github.com/kinow/cylc-docker>new version</a>
now maps a volume to the version of cylc, installs the dependencies, and
then allows the state to be maintained solely in the mapped volume.</p>
<p>Furthermore, the entrypoint of the image is the <code>cylc</code> command. Which means that
you do not have to execute a terminal in order to run commands to the container
(or change the command/entrypoint).</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>...
VOLUME <span style=color:#00f>&#34;/opt/cylc&#34;</span> <span style=color:#00f>&#34;/tmp&#34;</span> <span style=color:#00f>&#34;/run&#34;</span> <span style=color:#00f>&#34;/var/run&#34;</span> <span style=color:#080;font-style:italic># we have the state stored only in /opt/cylc</span>
WORKDIR <span style=color:#00f>&#34;/opt/cylc&#34;</span>
ENV PATH /opt/cylc/bin:$PATH
WORKDIR /opt/cylc
ENTRYPOINT [<span style=color:#00f>&#34;cylc&#34;</span>] <span style=color:#080;font-style:italic># here&#39;s the trick!</span>
</code></pre></div><p>It uses the same approach from the PHP image I am using for Composer, with a few
additional improvements from the <a href=https://docs.docker.com/develop/develop-images/dockerfile_best-practices/>Best practices for writing Dockerfiles</a> documentation.</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ docker run -ti -v <span style=color:#00f>&#34;</span><span style=color:navy;font-weight:700>$(</span>pwd -P<span style=color:navy;font-weight:700>)</span><span style=color:#00f>&#34;</span>/cylc:/opt/cylc cylc validate /opt/cylc/etc/examples/tutorial/oneoff/basic/
Valid <span style=color:navy;font-weight:700>for</span> cylc-7.7.2
$ docker run -ti -v <span style=color:#00f>&#34;</span><span style=color:navy;font-weight:700>$(</span>pwd -P<span style=color:navy;font-weight:700>)</span><span style=color:#00f>&#34;</span>/cylc:/opt/cylc cylc register /opt/cylc/etc/examples/tutorial/oneoff/basic/
REGISTER /opt/cylc/etc/examples/tutorial/oneoff/basic/
$ docker run -ti -v <span style=color:#00f>&#34;</span><span style=color:navy;font-weight:700>$(</span>pwd -P<span style=color:navy;font-weight:700>)</span><span style=color:#00f>&#34;</span>/cylc:/opt/cylc cylc start --non-daemon --debug /opt/cylc/etc/examples/tutorial/oneoff/basic/
            ._.                                                       
            | |                 The Cylc Suite Engine [7.7.2]         
._____._. ._| |_____.           Copyright (C) 2008-2018 NIWA          
| .___| | | | | .___|  _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
| !___| !_! | | !___.  This program comes with ABSOLUTELY NO WARRANTY;
!_____!___. |_!_____!  see <span style=color:#00f>`</span>cylc warranty<span style=color:#00f>`</span>.  It is free software, you 
      .___! |           are welcome to redistribute it under certain  
      !_____!                conditions; see <span style=color:#00f>`</span>cylc conditions<span style=color:#00f>`</span>.       
2018-07-30T12:10:32Z INFO - Suite starting: server=3714d1a17999:43040 pid=<span style=color:#00f>1</span>
2018-07-30T12:10:32Z INFO - Cylc version: 7.7.2
2018-07-30T12:10:32Z INFO - Run mode: live
2018-07-30T12:10:32Z INFO - Initial point: <span style=color:#00f>1</span>
2018-07-30T12:10:32Z INFO - Final point: <span style=color:#00f>1</span>
2018-07-30T12:10:32Z INFO - Cold Start <span style=color:#00f>1</span>
2018-07-30T12:10:32Z DEBUG - [hello.1] -released to the task pool
2018-07-30T12:10:32Z DEBUG - BEGIN TASK PROCESSING
2018-07-30T12:10:32Z DEBUG - [hello.1] -waiting =&gt; queued
2018-07-30T12:10:32Z DEBUG - <span style=color:#00f>1</span> task(s) de-queued
2018-07-30T12:10:32Z INFO - [hello.1] -submit-num=1, owner@host=localhost
2018-07-30T12:10:32Z DEBUG - [hello.1] -queued =&gt; ready
2018-07-30T12:10:32Z DEBUG - END TASK PROCESSING (took 0.00642895698547 seconds)
2018-07-30T12:10:32Z DEBUG - [<span style=color:#00f>&#39;cylc&#39;</span>, <span style=color:#00f>&#39;jobs-submit&#39;</span>, <span style=color:#00f>&#39;--debug&#39;</span>, <span style=color:#00f>&#39;--&#39;</span>, <span style=color:#00f>&#39;/opt/cylc/etc/examples/tutorial/oneoff/basic/log/job&#39;</span>, <span style=color:#00f>&#39;1/hello/01&#39;</span>]
2018-07-30T12:10:33Z DEBUG - [client-connect] root@3714d1a17999:cylc-message privilege=<span style=color:#00f>&#39;full-control&#39;</span> 7b05596a-5971-4733-82de-28528f702ff0
2018-07-30T12:10:33Z INFO - [client-command] put_messages root@3714d1a17999:cylc-message 7b05596a-5971-4733-82de-28528f702ff0
2018-07-30T12:10:33Z DEBUG - [jobs-submit cmd] cylc jobs-submit --debug -- /opt/cylc/etc/examples/tutorial/oneoff/basic/log/job 1/hello/01
	[jobs-submit ret_code] <span style=color:#00f>0</span>
	[jobs-submit out]
	[TASK JOB SUMMARY]2018-07-30T12:10:32Z|1/hello/01|0|<span style=color:#00f>61</span>
	[TASK JOB COMMAND]2018-07-30T12:10:32Z|1/hello/01|[STDOUT] <span style=color:#00f>61</span>
2018-07-30T12:10:33Z INFO - [hello.1] -(current:ready) submitted at 2018-07-30T12:10:32Z
2018-07-30T12:10:33Z INFO - [hello.1] -job[01] submitted to localhost:background[61]
2018-07-30T12:10:33Z DEBUG - [hello.1] -ready =&gt; submitted
2018-07-30T12:10:33Z INFO - [hello.1] -health check settings: submission timeout=None
2018-07-30T12:10:33Z DEBUG - BEGIN TASK PROCESSING
2018-07-30T12:10:33Z DEBUG - <span style=color:#00f>0</span> task(s) de-queued
2018-07-30T12:10:33Z DEBUG - [hello.1] -forced spawning
2018-07-30T12:10:33Z DEBUG - END TASK PROCESSING (took 0.000992059707642 seconds)
2018-07-30T12:10:33Z INFO - [hello.1] -(current:submitted)&gt; started at 2018-07-30T12:10:33Z
2018-07-30T12:10:33Z DEBUG - [hello.1] -submitted =&gt; running
2018-07-30T12:10:33Z INFO - [hello.1] -health check settings: execution timeout=None
2018-07-30T12:10:34Z DEBUG - BEGIN TASK PROCESSING
2018-07-30T12:10:34Z DEBUG - <span style=color:#00f>0</span> task(s) de-queued
2018-07-30T12:10:34Z DEBUG - END TASK PROCESSING (took 0.000984191894531 seconds)
2018-07-30T12:10:43Z DEBUG - [client-connect] root@3714d1a17999:cylc-message privilege=<span style=color:#00f>&#39;full-control&#39;</span> 524d658e-9932-4135-9523-3c2ace3990cf
2018-07-30T12:10:43Z INFO - [client-command] put_messages root@3714d1a17999:cylc-message 524d658e-9932-4135-9523-3c2ace3990cf
2018-07-30T12:10:43Z INFO - [hello.1] -(current:running)&gt; succeeded at 2018-07-30T12:10:43Z
2018-07-30T12:10:43Z DEBUG - [hello.1] -running =&gt; succeeded
2018-07-30T12:10:43Z INFO - Suite shutting down - AUTOMATIC
2018-07-30T12:10:44Z INFO - DONE
$
</code></pre></div><p>If you have a utility in your computer that requires a few dependencies, but that
can store the state/data in a mapped volume, the same kind of container may be
useful.</p>
<aside class=links>
<a class=previous href=https://kinoshita.eti.br/2018/07/27/cylc-scheduler-internals-part-2.html>&#171; Previous</a>
<a class=next href=https://kinoshita.eti.br/2018/08/11/uuids-in-apache-jena.html>Next &#187;</a>
</aside>
</article>
</main>
<footer role=contentinfo>
<ul id=social-media-icons>
<li>
<a href=https://www.instagram.com/brunokinoshita/>
<img src=/assets/icons/instagram.png alt="Instagram link">
</a>
</li>
<li>
<a href=https://twitter.com/kinow/>
<img src=/assets/icons/twitter.png alt="Twitter link">
</a>
</li>
<li>
<a href=https://github.com/kinow/>
<img src=/assets/icons/github.png alt="GitHub link">
</a>
</li>
</ul>
</footer>
</body>
</html>